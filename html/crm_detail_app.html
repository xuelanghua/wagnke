<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../iconfont/iconfont.css" rel="stylesheet" />
		<style>
			.clearfix{
				clear: both;
			}
			.mui-title{
				color: #FFFFFF;
			}
			.mui-bar{
				box-shadow: none;
			}
			.title{
				height: 60px;
				background-color: #2289FF;
			}
			.info{
				box-shadow: 0 0 5px 0 #DDDEDE;
				padding: 0 10px 15px 10px;
				color: #999999;
				background-color: #FFFFFF;
			}
			.head{
				width: 40%;
				text-align: center;
				margin: 0 auto;
			}
			.chart{
				width: 70px;
				height: 70px;
				margin: 0 auto;
				border-radius: 50%;
			}
			.chart img{
				width: 100%;
				height: 100%;
				margin-top: -30px;
				border-radius: 50%;
			}
			.name{
				font-size: 17px;
				color: #333333;
				margin-top: -15px;
			}
			.company{
				/* width: 60%; */
				overflow: hidden;
				text-overflow:ellipsis;
				white-space: nowrap;
				padding: 0 10px;
				display: block;
				border-radius: 10px;
				background-color: #68B0FF;
			}
			.position{
				padding: 0 10px;
				border-radius: 10px;
				margin-left: 15px;
				background-color: #F9D05E;
			}
			.function{
				padding: 26px 10px;
				font-size: 12px;
				color: #999999;
				background-color: #FFFFFF;
			}
			.button{
				width: 100%;
				color: #2188FF;
				margin-top: 25px;
				padding: 10px 0;
				border: 1px solid #2188FF;
			}
			
			*{
				padding: 0;
				margin: 0;
			}
			.example{
				padding-bottom: 20px;
				margin-top: 8px;
				background-color: #FFFFFF;
			}
			.example_title{
				padding: 20px 10px 10px 10px;
				border-bottom: 1px solid #F2F2F2;
			}
			.example_title p{
				width: 5px;
				height: 15px;
				margin-right: 10px;
				background-color: #2188FF;
			}
			.comment-input{
				width: 100%;
				position: fixed;
				bottom: 0;
				padding: 10px;
				border-top: 1px solid #F2F2F2;
				background-color: #FFFFFF;
			}
			.input{
				width: 40%;
				background-color: #F5F6F8;
				padding: 7px 0 7px 11px;
				color: #999999;
				font-size: 15px;
				margin-top: 4px;
				border-radius: 25px;
			}
			.input img{
				width: 17px;
				height: 18px;
			}
			.comment-inputr{
				width: 60%;
				font-size: 12px;
				display: flex;
			}
			.comment-inputr div{
				width: auto;
				float: left;
				padding: 0 10px;
				text-align: center;
			}
			.comment-inputr button{
				color: #FFFFFF;
				border: none;
				font-size: 15px;
				border-radius: 5px;
				padding:0 10px;
				margin-top: 5px;
				margin-right: 12px;
				height: 30px;
				color: #2289FF;
				border: 1px solid #2289FF;
			}
			.comment-inputr button:active{
				color: #2289FF;
				border: 1px solid #2289FF;
				background-color: #ffffff;
			}
			.comment-inputr button:last-of-type{
				margin-right: 0;
				color: #FFFFFF;
				background-color: #2289FF;
			}
			.comment-inputr img{
				height: 21px;
			}
			.comment-inputr span{
				display: block;
				color: #999999;
				margin-top: -5px;
			}
			.comment-content{
				margin-bottom: 50px;
				padding-bottom: 20px;
			}
			/* 
			.comment-input{
				width: 100%;
				position: fixed;
				bottom: 0;
				padding: 10px 15px 8px 15px;
				border-top: 1px solid #F2F2F2;
				background-color: #FFFFFF;
			}
			.input{
				width: 50%;
				background-color: #F5F6F8;
				padding: 7px 0 7px 11px;
				color: #999999;
				font-size: 15px;
				margin-top: 4px;
				border-radius: 25px;
			}
			.input img{
				width: 17px;
				height: 18px;
			}
			.comment-inputr{
				width: 50%;
				font-size: 12px;
			}
			.comment-inputr div{
				width: 33.33%;
				float: left;
				text-align: center;
			}
			.comment-inputr button{
				color: #FFFFFF;
				border: none;
				font-size: 15px;
				border-radius: 5px;
				margin-top: 5px;
				background-color: #2289FF;
			}
			.comment-inputr img{
				height: 21px;
			}
			.comment-inputr span{
				display: block;
				color: #999999;
				margin-top: -5px;
			}
			.comment-content{
				margin-bottom: 50px;
				padding-bottom: 20px;
			} */
			
			.guaih{
				border-radius: 8px;
				background-color: #FFFFFF;
				position: fixed;
				z-index: 99999;
				width: 92%;
				top: 25%;
				left: 4%;
				right: 4%;
				display: none;
			}
			.tanchu-title{
				text-align: center;
				padding: 15px 0;
				border-bottom: 1px solid #F2F2F2;
			}
			.tanchu_content{
				font-size: 14px;
				padding: 20px 10px 40px 10px;
				color: #999999;
				border-bottom: 1px solid #F2F2F2;
			}
			.tanchu_content p{
				width: 4px;
				height: 4px;
				margin-top: 8px;
				border-radius: 50%;
				margin-right: 10px;
				background-color: #2289FF;
			}
			.tibu{
				padding: 15px 0;
			}
			.tibu button{
				width: 40%;
				text-align: center;
			}
			.buttonL{
				color: #2289FF;
				margin-left: 5%;
				border: 1px solid #2289FF;
			}
			.buttonR{
				background-color: #2289FF;
				color: #FFFFFF;
				margin-right: 5%;
				border: 1px solid #2289FF;
			}
			#cover{
			    position: fixed;
				z-index: 9999;
				top: 0;
				left: 0;
				display: none;
				width: 100%;
				height: 100%;
				opacity: 0.5;
				background: #333333 none repeat scroll 0% 0%;
			}
			
			.tanchu{
				padding: 19px;
				border-radius: 8px;
				background-color: #FFFFFF;
				position: fixed;
				z-index: 99999;
				width: 92%;
				top: 25%;
				left: 4%;
				right: 4%;
				display: none;
			}
			.tanchu textarea{
				border: none;
				font-size: 15px;
				background-color: #F5F6F8;
			}
			.tanchu button, .guaih button{
				width: 30%;
				background-color: #2289FF;
				color: #FFFFFF;
				border: none;
				margin: 0 auto;
				display: block;
				font-size: 15px;
				border-radius: 5px;
			}
			
			.Record_list{
				padding: 15px;
				border-bottom: 1px solid #DDDEDE;
			}
			.current_chart{
				width: 40px;
				height: 40px;
				border-radius: 50%;
			}
			.current_chart img{
				width: 100%;
				height: 100%;
				margin-top: 15px;
				border-radius: 50%;
			}
			
			.shuj span{
				color: #2289FF;
			}
			
			.xinahsi{
				color: #6fb2ff;
				display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2;
				overflow: hidden;
				float: left;
				padding: 5px 6px;
				margin-top: 10px;
				background-color: #F7F7F7;
			}
			
			.jilu{
				padding: 0 0 0 10px;
				margin-bottom: 60px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav" style="background-color: #2289FF;color: #FFFFFF;">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: #FFFFFF;"></a>
			<h1 class="mui-title">客户详情</h1>
			<div class="mui-pull-right" style="margin-top: 10px;font-size: 15px;" id="crm_edit">编辑</div>
		</header>

		<div class="mui-content">
			<div class="title"></div>
			<div class="info">
				<div class="head">
					<div class="chart">
						<img src="../image/touxiang.png" id="crm_avatar">
					</div>
					<div class="name" id="crm_name">
						万贤
					</div>
				</div>
				<div class="function">
					<div>
						<span>电话</span>
						<span style="color: #000000;margin-left: 62px;" id="crm_mobile">13888888888</span>
					</div>
					<div style="margin-top: 15px;">
						<span class="mui-pull-left">公司&职位</span>
						<span class="mui-pull-left" style="margin-left: 32px;color: #FFFFFF;font-size: 10px;">
							<span class="company mui-pull-left" id="crm_company">万贤科技</span>
							<span class="position mui-pull-left" id="crm_job">总经理</span>
						</span>
						<div class="clearfix"></div>
					</div>
					<div style="margin-top: 15px;">
						<span>设置标签</span>
						<span style="margin-left: 40px;color: #2289FF;" id="crm_label">[朋友]</span>
					</div>
					<button class="button">客情关怀</button>
				</div>
			</div>

			<div class="example">
				<div class="example_title">
					<p class="mui-pull-left"></p>
					<span class="mui-pull-left">跟进记录</span>
					<div class="clearfix"></div>
				</div>
				<div class="jilu">
					<!-- <div class="current_chart mui-pull-left">
						<img src="../image/activation.png" >
					</div>
					<div class="Record_list mui-pull-right"style="width: 85%;">
						<div class="mui-pull-left"style="width: 60%;margin-top: 5px;">
							<span>新增记录:</span>
							<span style="color: #2289FF;">已成交</span>
						</div>
						<div class="mui-pull-right" style="font-size: 14px;color: #999999;margin-top: 5px;">
							<span>02-28</span>
							<span>09:58</span>
						</div>
					</div>
					<div class="clearfix"></div>
					<div class="current_chart mui-pull-left">
						<img src="../image/activation.png" >
					</div>
					<div class="Record_list mui-pull-right"style="width: 85%;">
						<div class="mui-pull-left"style="width: 60%;margin-top: 5px;">
							<span class="mui-pull-left">新增记录:</span>
						</div>
						<div class="mui-pull-right" style="font-size: 14px;color: #999999;margin-top: 5px;">
							<span>02-28</span>
							<span>09:58</span>
						</div>
						<div class="xinahsi">已成交萨芬士大夫十大撒打发是大方式打</div>
					</div>
					<div class="clearfix"></div>
					<div class="current_chart mui-pull-left">
						<img src="../image/activation.png" >
					</div>
					<div class="Record_list mui-pull-right"style="width: 85%;">
						<div class="mui-pull-left"style="width: 60%;margin-top: 5px;">
							<span>新增记录:</span>
							<span style="color: #2289FF;">已成交</span>
						</div>
						<div class="mui-pull-right" style="font-size: 14px;color: #999999;margin-top: 5px;">
							<span>02-28</span>
							<span>09:58</span>
						</div>
					</div>
					<div class="clearfix"></div> -->
				</div>
			</div>

			<div class="comment-input">
				<div class="input mui-pull-left">
					<img src="../image/shuru.png">
					<span style="margin-left: 10px;">跟进记录...</span>
				</div>
				<div class="comment-inputr mui-pull-right">
					<div id="deal_flag">
						<span id="deal_icon" style="margin-top: 3px;margin-bottom: 2px;"><i class="iconfont icon-user-flag" style="font-size: 23px;"></i></span>
						<span id="deal_title">未成交</span>
					</div>
					<button id="share_card">分享名片</button>
					<button id="call_up">电话</button>
				</div>
				<div class="clearfix"></div>
			</div>

			<!-- 客情关怀 弹出框 -->
			<div id="cover"></div>
			<div class="guaih">
				<div class="tanchu-title">
					客情关怀
				</div>
				<div class="tanchu_content">
					<div style="color: #000000;margin-bottom: 10px;">开启客情关怀将在以下特定日期进行消息提示</div>
					<div>
						<p class="mui-pull-left"></p>
						<span class="mui-pull-left">
							<span>生日：</span>
							<span id="birthday">12-28</span>
						</span>
						<div class="clearfix"></div>
					</div>
					<div>
						<p class="mui-pull-left"></p>
						<span class="mui-pull-left">
							<span>纪念日：</span>
							<span id="anniversary">12-28</span>
						</span>
						<div class="clearfix"></div>
					</div>
				</div>
				<div class="tibu">
					<!-- <button class="buttonL mui-pull-left">放弃</button> -->
					<!-- <button class="buttonR mui-pull-right">开启</button> -->
					<button class="button" id="notice_button">开启</button>
					<div class="clearfix"></div>
				</div>
			</div>

			<!-- 跟进记录弹出框 -->
			<div class="tanchu">
				<textarea rows="8" name="content" placeholder="请输入..." /></textarea>
				<button class="button" id="follow_publish">发 布</button>
			</div>
		</div>
	</body>
	<script src="../js/mui.js"></script>
	<script src="../js/util.js"></script>
	<script src="../js/Zepto.min.js"></script>
	<script type="text/javascript">
		mui.init({
			swipeBack: true
		})

		var cid = 0;
		var customerInfo = null;
		var dealFlag = 0;
		var noticeStatus = 0;
		var userInfo = getUserInfo();
		mui.plusReady(function() {
			var self = plus.webview.currentWebview();
			cid = self.cid;

			getCustomerInfo();
			
			window.addEventListener('editCustomer', function() {
				getCustomerInfo();
			})

			document.getElementById('call_up').addEventListener('tap', function() {
				var phone = this.dataset.phone;
				if(phone){
					plus.device.dial(phone);
				} else {
					message('该客户很神秘，没有电话哟！')
				}
			})

			document.querySelector('.input').addEventListener('tap', function() {
				document.getElementById('cover').style.display = 'block';
				document.querySelector('.tanchu').style.display = 'block';
			})

			document.querySelector('.button').addEventListener('tap', function() {
				document.getElementById('cover').style.display = 'block';
				document.querySelector('.guaih').style.display = 'block';
			})

			document.getElementById('cover').addEventListener('tap', function() {
				this.style.display = 'none';
				document.querySelector('.guaih').style.display = 'none';
				document.querySelector('.tanchu').style.display = 'none';
			})

			mui('.mui-content').on('tap', '#deal_flag', function() {
				if (dealFlag == 1) {
					mui.post($ajaxUrl + 'customer', {
						action: 'mark',
						cid: cid,
						token: userInfo.token,
						mark: 1
					}, function(res) {
						if (res.errno == 0) {
							getCustomerInfo();
							document.getElementById('deal_icon').style.color = '#999';
							document.getElementById('deal_title').innerText = '未成交';
							document.getElementById('deal_title').style.color = '#999';
							dealFlag = 0;
						}
					}, 'json')
				} else {
					mui.post($ajaxUrl + 'customer', {
						action: 'mark',
						cid: cid,
						token: userInfo.token,
						mark: 2
					}, function(res) {
						if (res.errno == 0) {
							getCustomerInfo();
							document.getElementById('deal_icon').style.color = 'red';
							document.getElementById('deal_title').innerText = '已成交';
							document.getElementById('deal_title').style.color = 'red';
							dealFlag = 1;
						}
					}, 'json')
				}
			})

			mui('.mui-content').on('tap', '#follow_publish', function() {
				var content = document.querySelector('textarea[name=content]').value;
				content = content.replace(/^\s*|\s*$/g, "");
				if (content.length == 0) {
					message('请输入跟进内容!');
					return;
				}
				document.getElementById('cover').style.display = 'none';
				document.querySelector('.tanchu').style.display = 'none';
				mui.post($ajaxUrl + 'customer', {
					action: 'follow',
					cid: cid,
					token: userInfo.token,
					content: content
				}, function(res) {
					if (res.errno == 0) {
						message('跟进成功!');
						getCustomerInfo();
					} else {
						message(res.message);
					}
				}, 'json')
			})

			mui('.mui-content').on('tap', '#notice_button', function() {
				document.getElementById('cover').style.display = 'none';
				document.querySelector('.guaih').style.display = 'none';
				if (noticeStatus == 1) {
					mui.post($ajaxUrl + 'customer', {
						action: 'notice',
						cid: cid,
						token: userInfo.token,
						notice: 0
					}, function(res) {
						if (res.errno == 0) {
							message('关闭成功!');
							getCustomerInfo();
							noticeStatus = 0;
						} else {
							message('关闭失败!');
						}
					}, 'json')
				} else {
					mui.post($ajaxUrl + 'customer', {
						action: 'notice',
						cid: cid,
						token: userInfo.token,
						notice: 1
					}, function(res) {
						logs(res);
						if (res.errno == 0) {
							message('开启成功!');
							getCustomerInfo();
							noticeStatus = 1;
						} else {
							message('开启失败!');
						}
					}, 'json')
				}
			})
			
			mui('header').on('tap', '#crm_edit', function() {
				fnOpenWin('customer_edit.html', 'customer_edit', {statusbar: {background: '#FFF'}}, {cid: cid}, 'slide-in-right');
				plus.navigator.setStatusBarStyle('dark');
			})
			
			// 分享
			document.getElementById('share_card').addEventListener('tap', function(e) {
				shareToMiniprogram({
					title: customerInfo.name + '的旺客名片',
					content: '王天下之客,让营销更简单!',
					thumbs: ['../image/app_logo.png'],
					miniProgram: {
						id: 'gh_9fa5f42ab939',
						path: '/longbing_card/pages/index/index?to_uid=' + cid + '&is_qr=1&currentTabBar=toCustomer',
						webUrl: 'https://app.wangkeapp.cn/'
					}
				}, 'miniProgram');
				// share({
				// 	title: '旺客',
				// 	content: '旺天下之客,让营销更简单!',
				// 	thumbs: ['https://app.wangkeapp.cn/attachment/headimg_6.jpg'],
				// 	href: $ajaxUrl + 'download'
				// }, 'web');
				e.stopPropagation();
			})
		})

		function getCustomerInfo() {
			plus.nativeUI.showWaiting();
			mui.post($ajaxUrl + 'customer', {
				action: 'detail',
				token: userInfo.token,
				id: cid,
				type: 'crm'
			}, function(res) {
				if (res.errno == 0) {
					var data = res.data;
					customerInfo = res.data;
					if (data.headimgurl.length != 0) {
						document.getElementById('crm_avatar').src = data.headimgurl;
					}
					document.getElementById('crm_name').innerText = data.name;
					document.getElementById('crm_mobile').innerText = data.mobile;
					document.getElementById('call_up').dataset.phone = data.mobile;
					document.getElementById('crm_company').innerText = data.company;
					document.getElementById('crm_job').innerText = data.job;
					var follow = data.follow || new Array();
					var html = '';
					if (follow.length > 0) {
						for (var i in follow) {
							if (follow[i].mark == 1 || follow[i].mark == 2) {
								html += '<div class="current_chart mui-pull-left">';
								if (data.headimgurl.length != 0) {
									html += '<img src="' + data.headimgurl + '" >';
								} else {
									html += '<img src="../image/user_default.png" >';
								}
								html += '</div>';
								html += '<div class="Record_list mui-pull-right"style="width: 85%;">';
								html += '<div class="mui-pull-left"style="width: 60%;margin-top: 5px;">';
								html += '<span>新增记录:</span>';
								if (follow[i].mark == 1) {
									html += '<span style="color: #2289FF;">开始跟进</span>';
								} else {
									html += '<span style="color: #2289FF;">已成交</span>';
								}
								html += '</div>';
								html += '<div class="mui-pull-right" style="font-size: 14px;color: #999999;margin-top: 5px;">';
								html += '<span>' + follow[i].create_time + '</span>';
								html += '</div>';
								html += '</div>';
								html += '<div class="clearfix"></div>';
							} else {
								html += '<div class="current_chart mui-pull-left">';
								if (data.headimgurl.length != 0) {
									html += '<img src="' + data.headimgurl + '" >';
								} else {
									html += '<img src="../image/user_default.png" >';
								}
								html += '</div>';
								html += '<div class="Record_list mui-pull-right"style="width: 85%;">';
								html += '<div class="mui-pull-left"style="width: 60%;margin-top: 5px;">';
								html += '<span class="mui-pull-left">新增记录:</span>';
								html += '</div>';
								html += '<div class="mui-pull-right" style="font-size: 14px;color: #999999;margin-top: 5px;">';
								html += '<span>' + follow[i].create_time + '</span>';
								html += '</div>';
								html += '<div class="xinahsi">' + follow[i].content + '</div>';
								html += '</div>';
								html += '<div class="clearfix"></div>';
							}
						}
					} else {
						html += '<div style="padding: 30px 15px;text-align: center;color: #ccc;padding-right: 45px;">没有数据</div>';
					}
					document.querySelector('.jilu').innerHTML = html;

					if (data.mark == 2) {
						document.getElementById('deal_icon').style.color = 'red';
						document.getElementById('deal_title').innerText = '已成交';
						document.getElementById('deal_title').style.color = 'red';
						dealFlag = 1;
					}

					if (data.birthday.length != 0) {
						document.getElementById('birthday').innerText = data.birthday;
					} else {
						document.getElementById('birthday').innerText = '未填写';
					}
					if (data.anniversary.length != 0) {
						document.getElementById('anniversary').innerText = data.anniversary;
					} else {
						document.getElementById('anniversary').innerText = '未填写';
					}
					if (data.is_notice == 1) {
						document.getElementById('notice_button').innerText = '关闭';
						noticeStatus = 1;
					}
				} else {
					message(res.message);
					setTimeout(function() {
						plus.webview.close('crm_detail_app');
					}, 2000)
				}
				plus.nativeUI.closeWaiting();
			}, 'json')
		}
	</script>
</html>
