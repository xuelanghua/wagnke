<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
		<style type="text/css">
			.mui-bar {
				background-color: #FFFFFF;
			}

			.header {
				padding-top: 3.3rem;
				background: url("../image/group_booking_create_bg.jpg")center top no-repeat;
				background-size: cover;
				overflow: hidden;
				padding-bottom: 0.8rem;
			}

			.mini-card {
				width: 90%;
				border-radius: 10px;
				background-color: #FFFFFF;
				margin-left: 5%;
				position: relative;
				padding-top: 30px;
				padding-bottom: 0.2rem;
				box-shadow: 0 3px 2px 2px #dc1214;
			}

			.decorate-img {
				top: -6px;
				position: absolute;
				display: block;
				width: 4.82rem;
				height: auto;
				left: 50%;
				margin-left: -2.41rem;
			}

			.goods-section {
				width: 100%;
				overflow: hidden;
				position: relative;
				padding: 0.2rem;
				box-sizing: border-box;
				color: #333333;
			}

			.goods-section::after {
				content: '';
				position: absolute;
				display: block;
				bottom: 0;
				left: 0;
				right: 0;
				height: 1px;
				background-color: #dddddd;
				transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
			}

			.goods-section p {
				font-size: 0.3rem;
				color: #333333;
				max-width: 4.82rem;
			}

			.goods-img {
				width: 50px;
				height: 50px;
				object-fit: cover;
				flex-shrink: 0;
				margin-right: 0.36rem;
			}

			.title-img {
				display: flex;
				align-items: flex-start;
			}

			.record-info {
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding-top: 0.2rem;
			}

			.record-info .item-info {
				width: 50%;
				font-size: 0.24rem;
				color: #999999;
			}

			.goods-detail {
				width: 100%;
				display: flex;
				align-items: center;
				justify-content: space-between;
				font-size: 0.3rem;
				color: #333333;
				padding: 0.3rem 0.2rem 0.2rem;
			}

			.body-container {
				height: auto;
				background: linear-gradient(to bottom, #fe0c10, #ff734c);
				margin-top: -2px;
				padding-bottom: 100px;
			}

			.option-items {
				display: flex;
				align-items: center;
				margin-bottom: 0.5rem;
			}

			.option-items .opction-title {
				font-size: 0.3rem;
				color: #333333;
			}

			.opction-title.light {
				min-width: 3.41rem;
			}

			.option-items .opction-title.deep {
				width: 1.28rem;
			}

			.body-card {
				padding: 0.24rem;
			}

			.opction-body.deep {
				width: 4.98rem;
				height: 0.98rem;
				padding: 0.24rem;
				overflow: hidden;
				position: relative;
				box-sizing: border-box;
				display: flex;
				align-items: center;
				background-color: #f2f2f2;
				border-radius: 0.2rem;
				color: #999999;
				line-height: 1;
			}

			.opction-body.deep .mui-icon-arrowright {
				position: absolute;
				right: 0.1rem;
				top: 27%;
			}

			.option-items input {
				margin-bottom: 0;
				padding: 0;
				width: 100%;
				line-height: 1;
				border: none;
				background: #f2f2f2;
				color: #333;
			}

			.option-items input::-webkit-input-placeholder {
				color: #999999;
				font-size: 0.3rem;
			}

			.spec-info {
				color: #333333;
			}

			.operating-btn {
				display: inline-flex;
				background-color: #c4c4c4;
				width: 0.41rem;
				height: 0.41rem;
				border-radius: 50%;
				line-height: 1;
				font-size: 0.42rem;
				align-items: center;
				justify-content: center;
				border: none;
				position: relative;
				color: #999999;
				font-weight: bold;
				flex-shrink: 0;
			}

			.operating-btn.subtract:after {
				content: "";
				width: 0.2rem;
				height: 1.5px;
				background-color: #999999;
			}

			.opction-body .number-input {
				background-color: #f2f2f2;
				flex-grow: 1;
				border-radius: 0.2rem;
				text-align: center;
				padding: 0 0.2rem;
				box-sizing: border-box;
				width: 1.4rem;
			}


			.opction-title p {
				margin: 0;
				font-size: 0.24rem;
				color: #999999;
			}

			.opction-body {
				display: flex;
				align-items: center;
			}

			.btn-section {
				position: fixed;
				display: flex;
				align-items: center;
				z-index: 199;
				background-color: #f8144d;
				height: 1.09rem;
				bottom: 0;
				width: 100%;
				box-shadow: -3px 1px 2px 1px rgba(0, 0, 0, .3);
			}

			.btn-section div {
				color: #FFFFFF;
				width: 100%;
				height: 100%;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				position: relative;
			}

			.btn-cont {
				height: 100%;
				padding:0.2rem;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			[v-cloak] {
				display: none;
			}
		</style>
	</head>

	<body>
		<div id="mui-content" v-cloak>
			<header class="mui-bar mui-bar-nav">
				<span class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></span>
				<h1 class="mui-title">添加规则</h1>
			</header>
			<div class="mui-content">
				<div class="header">
					<div class="mini-card ">
						<img class="decorate-img" src="../image/group_booking_create_top.png" alt="">
						<div class="goods-section">
							<div class="title-img">
								<img class="goods-img" :src="goods_detail.cover">
								<p class="mui-ellipsis-2">{{goods_detail.name}}</p>
							</div>
							<div class="record-info">
								<div class="item-info">销量：{{goods_detail.sale_count}}</div>
								<div class="item-info">浏览量：{{goods_detail.view_count}}</div>
							</div>
						</div>
						<div class="goods-detail" @tap="openGoodsDetail(goods_detail.id,goods_detail.is_team_goods)">
							<span>产品详情</span><span class="mui-icon mui-icon-arrowright"></span>
						</div>
					</div>
				</div>
				<div class="body-container">
					<div class="mini-card">
						<img class="decorate-img" src="../image/group_booking_create_top.png" alt="">
						<div class="body-card">
							<div class="option-items">
								<div class="opction-title deep">规格</div>
								<div class="opction-body deep" id="showUserPicker">
									<span class="spec-info">{{size_text}}</span>
									<span class="mui-icon mui-icon-arrowright"></span>
								</div>
							</div>
							<div class="option-items">
								<div class="opction-title light">
									<span>成团人数</span>
									<p class="tips">达到数量拼团成功</p>
								</div>
								<div class="opction-body">
									<div class="btn-cont" @tap="subtract('t_number')">
										<span class="operating-btn subtract"></span>
									</div>
									<input class="number-input" v-model="t_number" type="number">
									<div class="btn-cont" @tap="add('t_number')">
										<span class="operating-btn mui-icon mui-icon-plusempty"></span>
									</div>
								</div>
							</div>
							<div class="option-items">
								<div class="opction-title light">
									<span>起购数量</span>
									<p class="tips">一人最少购买数量</p>
								</div>
								<div class="opction-body">
									<div class="btn-cont" @tap="subtract('quantity')">
										<span class="operating-btn subtract"></span>
									</div>
									<input class="number-input" v-model="quantity" type="number">
									<div class="btn-cont" @tap="add('quantity')">
										<span class="operating-btn mui-icon mui-icon-plusempty"></span>
									</div>
								</div>
							</div>
							<div class="option-items">
								<div class="opction-title light">
									<span>拼团时间</span>
									<p class="tips">开团到结束的有效时间（小时）</p>
								</div>
								<div class="opction-body">
									<div class="btn-cont" @tap="subtract('timer')">
										<span class="operating-btn subtract"></span>
									</div>
									<input class="number-input" v-model="timer" type="number">
									<div class="btn-cont" @tap="add('timer')">
										<span class="operating-btn mui-icon mui-icon-plusempty"></span>
									</div>
								</div>
							</div>
							<div class="option-items">
								<div class="opction-title deep">单价</div>
								<div class="opction-body deep">
									<input type="number" v-model="unit_cost" :placeholder="priceTips">
								</div>
							</div>
							<div class="option-items">
								<div class="opction-title deep">团长价</div>
								<div class="opction-body deep">
									<input type="number" v-model="captain_price" placeholder="设置团长单独价格（选填）">
								</div>
							</div>
							<div class="option-items">
								<div class="opction-title deep">排序</div>
								<div class="opction-body deep">
									<input type="number" v-model="sort" placeholder="序号越大显示越靠前">
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="btn-section">
					<div class="putaway-btn option-btn" data-status="1">
						保存
					</div>
				</div>
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/mui.picker.js"></script>
		<script src="../js/mui.poppicker.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo();
			var app = new Vue({
				el: "#mui-content",
				data: {
					goods_detail: {},
					size: 0,
					t_number: 1,
					quantity: 1,
					timer: 1,
					unit_cost: '',
					collage_id: '',
					size_text: '请选择...',
					rule: {},
					sort:'',
					captain_price:'',
					priceTips:''
				},
				created: function() {
					// 初始化字体大小
					var viewport = document.documentElement.clientWidth;
					if (viewport > 750) {
						viewport = 750
					}
					document.documentElement.style.fontSize = viewport / 7.5 + "px";
					// 初始化字体大小结束	
				},
				methods: {
					subtract: function(e) {
						if (this[e] <= 1) {
							this[e] = 1;
							return false;
						}
						this[e]--;
					},
					add: function(e) {
						if (this[e] < 1) {
							this[e] = 1;
							return false;
						}
						this[e]++;
					},
					openGoodsDetail: function(gid, type) {
						if (type == 0) {
							openPage('distributor_goods_detail_bio.html', 'distributor_goods_detail_bio', '#f7f7f7', {
								gid: gid
							})
						} else if (type == 1) {
							openPage('distributor_goods_detail_mine.html', 'distributor_goods_detail_mine', '#f7f7f7', {
								gid: gid
							})
						} else {
							openPage('wangke_distributor_goods_detail_mine.html', 'wangke_distributor_goods_detail_mine', '#f7f7f7', {
								gid: gid
							})
						}
					}
				},
				mounted: function() {
					var userPicker = new mui.PopPicker();
					var _this = this;
					mui.plusReady(function() {
						plus.navigator.setStatusBarStyle("dark");
						var self = plus.webview.currentWebview();
						var parentLevel = plus.webview.currentWebview().opener();
						_this.goods_detail = self.goods;
						// logs(_this.goods_detail);
						_this.priceTips="拼团价格不得低于"+self.goods.protect_price;
						getQuantity();
						if (self.rule) {
							_this.rule = self.rule;
							_this.quantity = self.rule.number;
							_this.t_number = self.rule.people;
							_this.unit_cost = self.rule.price;
							_this.timer = self.rule.expire_time;
							_this.collage_id = self.rule.id;
							_this.captain_price=self.rule.captain_price;
							_this.sort=self.rule.sort;
						}
						// 提交
						mui(".mui-content").on("tap", ".option-btn", function() {
							document.activeElement.blur();
							if (app.size == '') {
								message("请选择规格！")
								return false;
							}
							if (app.t_number == '') {
								message("请填写成团人数！")
								return false;
							}
							if (app.quantity == '') {
								message("请填写起购数量！")
								return false;
							}
							if (app.timer == '') {
								message("请填拼团超时时间！")
								return false;
							}
							if (app.unit_cost == '') {
								message("请填写单价！")
								return false;
							}
							if (app.rank == '') {
								message("请填排序值！")
								return false;
							}
							// 提交
							mui.post($ajaxUrl + 'marketing&action=add_collage_goods', {
								token: userInfo.token,
								goods_id: app.goods_detail.id,
								spe_price_id: app.size,
								number: app.quantity,
								people: app.t_number,
								price: app.unit_cost,
								expire_time: app.timer,
								collage_id: app.collage_id,
								// 排序
								sort: app.sort,
								// 团长价格
								captain_price: app.captain_price
							}, function(res) {
								// logs(res);
								if (res.errno == 0) {
									// success
									mui.fire(plus.webview.getWebviewById('group_booking'), 'reloadMyself');
									mui.fire(plus.webview.getWebviewById('group_booking_detail_left'), 'reloadMyself');
									if (_this.rule.price) {
										plus.nativeUI.alert("修改成功！", function() {
											mui.back();
										})
									} else {
										plus.nativeUI.alert("创建成功！", function() {
											parentLevel.hide();parentLevel.close();mui.back();
										})
									}
								} else {
									// loser
									message(res.message);
								}
							}, 'json');
						})
					})
					// 选择参数
					mui(".mui-content").on("tap", "#showUserPicker", function() {
						userPicker.show(function(items) {
							app.size_text = items[0].text;
							app.size = items[0].value;
						});
					})
					// 获取规格
					function getQuantity() {
						mui.post($ajaxUrl + 'marketing&action=goods_spe', {
							token: userInfo.token,
							goods_id: app.goods_detail.id,
						}, function(res) {
							if (res.errno == 0) {
								userPicker.setData(res.data);
								if (app.rule) {
									userPicker.pickers[0].setSelectedValue(app.rule.spe_price_id, 500);
									mui.each(res.data, function(index, item) {
										if (item.value == app.rule.spe_price_id) {
											app.size_text = item.text;
											app.size = item.value;
										}
									})
								}
							} else {
								// loser
								message(res.message);
							}
						}, 'json');
					}
				},
			})
		</script>
	</body>

</html>
