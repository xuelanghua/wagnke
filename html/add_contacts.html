<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>添加好友</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/vip-page.css" />
		<style type="text/css">
			#search {
				display: inline-flex;
				flex-grow: 1;
				background-color: #FFFFFF;
				text-align: left;
			}

			.void-tips {
				margin-left: 0.15rem;
			}
			.lately-add-cont .between-info .user-name{
				color:#333333;
			}
		</style>
	</head>

	<body class="mui-hidden">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">添加好友</h1>
		</header>
		<div id="add-contacts-container" class="mui-content add-contacts-container">
			<div class="mui-input-row search-cont">
				<span class="mui-icon mui-icon-search"></span>
				<input type="search" id="search" name="cont" class="mui-input-clear" placeholder="用户名/手机号搜索好友">
			</div>
			<div class="mui-row activation-container mui-hidden">
				<div id="scan" class="mui-col-xs-6 activation-list">
					<img src="../image/icon/scan-icon.png">
					<span>扫名片码添加好友</span>
				</div>
				<div id="myQrCode" class="mui-col-xs-6 activation-list">
					<img src="../image/icon/my-qr-code-icon.png">
					<span>我的名片码</span>
				</div>
			</div>
			<div class="lately-add-cont" id="history">
				<h5 @tap="handle(3,1)">最近添加</h5>
				<ul v-if="result">
					<li class="mui-table-view-cell" v-for="user in lists" v-on:click.stop="toDetail(user.fid)">
						<div class="head-img">
							<img :src="user.avatar">
						</div>
						<div class="between-info">
							<p class="user-name">{{user.name}}</p>
							<p class="desc">{{user.remark}}</p>
						</div>
						<button v-if="user.apply_status==0" id="disAgree" class="mui-popup-button-bold mui-btn-blue" v-on:click.stop="handle(user.fid,-1)">拒绝</button>
						<button v-if="user.apply_status==0" id="agreeAdd" class="mui-popup-button-bold mui-btn-blue" v-on:click.stop="handle(user.fid,1)">同意</button>
						<span v-if="user.apply_status==1" class="add-after">已添加</span>
						<span v-if="user.apply_status==-1" class="add-after">已拒绝</span>
					</li>
				</ul>
				<p v-else class="void-tips">暂无申请记录</p>
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script src="../js/Zepto.min.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true,
				beforeback: function() {
					plus.navigator.setStatusBarStyle('light');
				}
			});
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
			document.querySelector(".mui-hidden").classList.remove("mui-hidden");
			var userInfo = getUserInfo();
			var token = userInfo.token;
			var app = new Vue({
				el: "#history",
				data() {
					return {
						lists: [],
						result: true
					}
				},
				created: function() {
					// 不要在created中使用plus相关接口,基座还未加载完成
					createlist();
				},
				methods: {
					toDetail:function(fid){
						openPage('friends_detail.html','friends_detail','#f7f7f7',{
							fid:fid
						});
					}
				}
			})
			document.getElementById('myQrCode').addEventListener('tap', function() {
				// 我的名片码
			});
			// 获取最近添加列表
			function createlist(){
				mui.post($ajaxUrl + 'customer&action=friend_apply', {
					token: token
				}, function(res) {
					logs(res);
					if (res.errno == 0) {
						app.lists = res.data;
						app.result = true;
					} else {
						app.result = false;
					}
				}, 'json')
			}
			// 添加拒绝操作
			function handle(id, status) {
				logs(status);
				logs(id);
				logs(token);
				mui.post($ajaxUrl + 'customer&action=friend_confirm', {
					token: token,
					fid: id,
					status: status
				}, function(res) {
					logs(res);
					if (res.errno == 0 && status == 1) {
						message("添加成功");
						mui.fire(plus.webview.getWebviewById('chat'), 'addCustomer');
						createlist();
					} else if (res.errno == 0 && status == -1) {
						message("已拒绝");
						mui.fire(plus.webview.getWebviewById('chat'), 'addCustomer');
						createlist();
					} else {
						message("请求失败，稍后重试");
						createlist();
					}
				}, 'json')
			}
			// 搜索好友
			mui.plusReady(function() {
				document.getElementById("search").addEventListener("keypress", function(event) {
					var search = document.querySelector('input[name=cont]').value;
					var keyword = search.replace(/^\s*|\s*$/g, "");
					if (event.keyCode == "13" && keyword != '') {
						plus.key.hideSoftKeybord();
						openPage('friend_search_result.html', 'friend_search_result', '#F7F7F7', {
							keyword: keyword
						})
						// 阻止默认事件---阻止页面刷新
						event.preventDefault();
					} else {
						message("请输入用户名或者电话");
					}
				});
				//打开扫一扫
				var scan = document.getElementById('scan');
				scan.addEventListener('tap', function() {
					var paymentPage = plus.webview.create('scan.html', 'scan', {
						top: '0',
						bottom: '0',
						scrollIndicator: 'none',
						statusbar: {
							background: '#000'
						}
					});
					paymentPage.show('slide-in-right');
					setStatusBar('#2289FF', 'light');
				});
			})
		</script>
	</body>
</html>
