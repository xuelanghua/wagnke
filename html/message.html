<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.css" rel="stylesheet" />
		<style>
			.clearfix{
				clear: both;
			}
			header img{
				height: 17px;
				margin-top: 13px;
				margin-right: 10px;
			}
			.mui-bar{
				height: 80px;
				padding: 0;
				background-color: #FFFFFF;
			}
			
			.example{
				width: 100%;
				padding-top: 42px;
				background-color: #FFFFFF;
			}
			.hd{
				font-size: 15px;
				margin-top: 38px;
			}
			.hd li{
				display: block;
				width: 45%;
				float: left;
				padding: 10px 0;
				text-align: center;
				position: relative;
				overflow: hidden;
			}
			
			.hd li.current{
				color: #2289FF;
				border-bottom: 2px solid #2289FF;
			}
			.bd{
				position: relative;
			}
			.bd .tab-container{
				display: none;
			}
			.bd .tab-container.current{
				display: block;
			}
			.Record_listL{
				width: 48px;
				height: 48px;
				border-radius: 50%;
				margin-right: 10px;
				flex-shrink: 0;
				overflow: hidden;
			}
			.Record_listL img{
				width: 48px;
				height: 48px;
			}
			.Record_listR{
				flex-grow: 1;
				height: auto;
				max-width: 82%;
			}
			.Label img{
				position: relative;
				top: 2px;
				width: 15px;
				margin-right:4px;
			}
			.tishi{
				font-size: 12px;
				color: #999999;
				margin-top: 5px;
			}
			.mui-badge{
				color: #FFFFFF;
				background-color: #F93B2E;
			}
			
			.date{
				font-size: 14px;
				color: #999999;
			}
			
			.mui-badge{
				margin-bottom: 0px;
			}
			.user-name{
				max-width: 86%;
				overflow: hidden;
			}
			li{
				list-style-type: none;
			}
			.mui-table-view-cell.mui-active{
				background: #FFFFFF;
			}
			.mui-table-view-cell{
				padding: 10px;
			}
			.mui-table-view-cell:after{
				right: 0;
				left: 70px;
				bottom: 0;
				height: 1px;
				background-color: #f2f2f2;
			}
			.mui-table-view-cell:last-child:after{
				height: 1px;
			}
			.last-message{
				max-width: 86%;
			}
			.mui-slider-handle{
				display: flex;
				align-items: center;
				width: 100%;
			}
			/* 清除聊天记录 */
			.join-team-verify {
				position: fixed;
				z-index: 996;
				top: 0;
				bottom: 0;
				width: 100%;
				background: rgba(0, 0, 0, 0);
				display: none;
				/* display: flex; */
				align-items: center;
				justify-content: center;
				flex-direction: column;
			}
			.verift-body {
				width: 80%;
				background-color: #ffffff;
				border-radius: 10px;
				position: relative;
				overflow: hidden;
				padding-top: 5px;
				box-shadow: 0 0 10px 2px rgba(0,0,0,0.2);
			}
			
			.verift-body .tips {
				width: 100%;
				padding: 20px 10px 15px;
				text-align: justify;
			}
			
			.verift-footer:before {
				content: '';
				display: block;
				height: 1px;
				width: 100%;
				top: 0;
				left: 0;
				position: absolute;
				background-color: #dddddd;
				transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
			}
			
			.verift-footer {
				position: relative;
				display: flex;
				justify-content: center;
			}
			
			.verift-footer .mui-btn {
				width: 100%;
				height: 100%;
				padding: 15px 10px;
			}
			
			.close-verify-window:before {
				content: '';
				display: block;
				height: 100%;
				width: 1PX;
				top: 0;
				bottom: 0;
				right: 0;
				position: absolute;
				background-color: #dddddd;
				transform: scaleX(0.5);
				-webkit-transform: scaleX(0.5);
			}
			.mui-table-view:before,.mui-table-view:after{
				height: 0;
			}
			.mui-table-view-cell:last-child:after{
				height: 1px;
			}
			.Record_list{
				display: flex;
			}
			.chat-red-tips,.system-red-tips{
				position: relative;
				width: 6px;
				height: 6px;
				background-color: #FF0000;
				border-radius: 50%;
				top: -2px;
				display: none;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">消息</h1>
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<!-- <img id="back_chat" class="mui-pull-right" src="../image/newsh.png"> -->
			<div class="hd mui-clearfix">
				<li class="current" data-type="chat">
					<span>
						<span class="chat-red-tips"></span>
						<span>聊天</span>
						<span id="chat_total">(0)</span>
					</span>
				</li>
				<li data-type="system">
					<span>
						<span class="system-red-tips"></span>
						<span>通知消息</span>
						<span id="systemMsg_total">(0)</span>
					</span>
				</li>
			</div>
		</header>

		<div class="mui-content">
			<div class="example">
				<div class="bd">
					<div class="current tab-container chat-cont" id="chat_message" data-type="chat">
						<!-- <div class="Record_list">
							<div class="Record_listL mui-pull-left">
								<img src="../image/Alipay.png">
							</div>
							<div class="Record_listR mui-pull-right">
								<div>
									<span class="mui-pull-left">
										<span class="Label">
											<img src="../image/newsb2.png">
										</span>
										<span style="font-size: 15px;">小飞飞</span>
									</span>
									<span class="mui-pull-right date">19:10</span>
									<div class="clearfix"></div>
								</div>
								<div class="tishi">
									<span class="mui-pull-left">欧尼酱,僵尸</span>
									<p class="mui-badge mui-pull-right">1</p>
									<div class="clearfix"></div>
								</div>
							</div>
							<div class="clearfix"></div>
						</div>
						<div class="Record_list">
							<div class="Record_listL mui-pull-left">
								<img src="../image/Alipay.png">
							</div>
							<div class="Record_listR mui-pull-right">
								<div>
									<span class="mui-pull-left">
										<span class="Label">
											<img src="../image/newsb1.png">
										</span>
										<span style="font-size: 15px;">小飞飞</span>
										<span style="color: #2289FF;font-size: 15px;">(张飞)</span>
									</span>
									<span class="mui-pull-right date">19:10</span>
									<div class="clearfix"></div>
								</div>
								<div class="tishi">
									<span class="mui-pull-left">欧尼酱,僵尸</span>
									<p class="mui-badge mui-pull-right">1</p>
									<div class="clearfix"></div>
								</div>
							</div>
							<div class="clearfix"></div>
						</div>
						<div class="Record_list">
							<div class="Record_listL mui-pull-left">
								<img src="../image/Alipay.png">
							</div>
							<div class="Record_listR mui-pull-right">
								<div>
									<span class="mui-pull-left">
										<span class="Label">
											<img src="../image/newsb3.png">
										</span>
										<span style="font-size: 15px;">小飞飞</span>
									</span>
									<span class="mui-pull-right date">19:10</span>
									<div class="clearfix"></div>
								</div>
								<div class="tishi">
									<span class="mui-pull-left">欧尼酱,僵尸</span>
									<p class="mui-badge mui-pull-right">1</p>
									<div class="clearfix"></div>
								</div>
							</div>
							<div class="clearfix"></div>
						</div> -->
					</div>
					<div class="tab-container system-cont" id="system_message" data-type="system">
						<ul class="mui-table-view">
							<li class="Record_list mui-table-view-cell target-assistant" :data-genre="list.type" v-for="(list,index) in systemMsg"
							 :key="index">
								<div class="Record_listL mui-pull-left">
									<img v-if="list.type==1" src="../image/target-icon.png">
									<img v-else-if="list.type==2" src="../image/news1.png">
									<img v-else-if="list.type==3" src="../image/news2.png">
									<img v-else-if="list.type==4" src="../image/news3.png">
									<img v-else-if="list.type==5" src="../image/news4.png">
									<img v-else src="../image/news5.png">
								</div>
								<div class="Record_listR mui-pull-right">
									<div class="mui-clearfix">
										<span class="mui-pull-left">
											<span style="font-size: 15px;">目标助理</span>
										</span>
										<span class="mui-pull-right date">{{list.time}}</span>
									</div>
									<div class="tishi mui-clearfix" style="margin-top: 5px;">
										<span class="mui-pull-left mui-ellipsis last-message">{{list.title}}</span>
										<p v-if="list.count>0" class="mui-badge mui-pull-right">{{list.count}}</p>
									</div>
								</div>
							</li>
							<!-- <li class="Record_list mui-table-view-cell">
								<div class="Record_listL mui-pull-left">
									<img src="../image/news1.png">
								</div>
								<div class="Record_listR mui-pull-right">
									<div>
										<span class="mui-pull-left">
											<span style="font-size: 15px;">新的好友</span>
										</span>
										<span class="mui-pull-right date">19:10</span>
										<div class="clearfix"></div>
									</div>
									<div class="tishi" style="margin-top: 5px;">
										<span class="mui-pull-left">[小飞飞]添加你为好友</span>
										<p class="mui-badge mui-pull-right">1</p>
										<div class="clearfix"></div>
									</div>
								</div>
							</li>
							<li class="Record_list mui-table-view-cell">
								<div class="Record_listL mui-pull-left">
									<img src="../image/news2.png">
								</div>
								<div class="Record_listR mui-pull-right">
									<div>
										<span class="mui-pull-left">
											<span style="font-size: 15px;">商城提醒</span>
										</span>
										<span class="mui-pull-right date">19:10</span>
										<div class="clearfix"></div>
									</div>
									<div class="tishi" style="margin-top: 5px;">
										<span class="mui-pull-left">你的客户[头强光]下单成功（未支付）</span>
										<p class="mui-badge mui-pull-right">1</p>
										<div class="clearfix"></div>
									</div>
								</div>
							</li>
							<li class="Record_list mui-table-view-cell">
								<div class="Record_listL mui-pull-left">
									<img src="../image/news3.png">
								</div>
								<div class="Record_listR mui-pull-right">
									<div>
										<span class="mui-pull-left">
											<span style="font-size: 15px;">客情关怀</span>
										</span>
										<span class="mui-pull-right date">18/12/25</span>
										<div class="clearfix"></div>
									</div>
									<div class="tishi" style="margin-top: 5px;">
										<span class="mui-pull-left">你的客户[强光头]后天生日，送个祝福吧</span>
									</div>
								</div>
							</li>
							<li class="Record_list mui-table-view-cell">
								<div class="Record_listL mui-pull-left">
									<img src="../image/news4.png">
								</div>
								<div class="Record_listR mui-pull-right">
									<div>
										<span class="mui-pull-left">
											<span style="font-size: 15px;">升级</span>
										</span>
										<span class="mui-pull-right date">18/12/25</span>
										<div class="clearfix"></div>
									</div>
									<div class="tishi" style="margin-top: 5px;">
										<span class="mui-pull-left">旺客2.1版本升级提醒</span>

										<div class="clearfix"></div>
									</div>
								</div>
							</li>
							<li class="Record_list mui-table-view-cell">
								<div class="Record_listL mui-pull-left">
									<img src="../image/news5.png">
								</div>
								<div class="Record_listR mui-pull-right">
									<div>
										<span class="mui-pull-left">
											<span style="font-size: 15px;">余额提现</span>
										</span>
										<span class="mui-pull-right date">18/12/25</span>
										<div class="clearfix"></div>
									</div>
									<div class="tishi" style="margin-top: 5px;">
										<span class="mui-pull-left">你的余额提现已到账</span>
										<div class="clearfix"></div>
									</div>
								</div>
							</li> -->
						</ul>
						<div v-if="systemMsg==undefined||systemMsg==''" style="padding: 15px;text-align: center;color: #ccc;padding-right: 45px;">没有数据</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 删除聊天记录确认弹窗 -->
		<div class="join-team-verify">
			<div class="verift-body">
				<div class="tips">
					<span>删除聊天记录后将无法找回，是否继续？</span>
				</div>
				<div class="verift-footer">
					<button type="button" class="mui-btn mui-btn-link close-verify-window">取消</button>
					<button type="button" class="mui-btn mui-btn-link send-verify">确定</button>
				</div>
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo();
			var chatId = '';
			var refresh = false;
			var app = new Vue({
				el: "#system_message",
				data: {
					systemMsg: []
				},
				mounted: function() {
					mui.init({
						swipeBack: true,
						beforeback: function() {
							var self = plus.webview.currentWebview();
							if (self.prePage == 'chat' || self.prePage == 'member') {
								plus.navigator.setStatusBarStyle(plus.webview.barStyle);
							}
						}
					})

					mui.plusReady(function() {
						window.addEventListener('refreshNotice', function(e) {
							refresh = true;
							getChatList();
							getSystemMsg();
						})
						getChatList();
						mui('#chat_message').on('tap', '.Record_list', function() {
							var cid = this.dataset.cid;
							var chatName = this.dataset.name;
							var avatar = this.dataset.avatar;
							// 关闭左滑菜单才能跳转
							var swipemenu = mui('.mui-selected')[0];
							if (swipemenu) {
								mui.swipeoutClose(swipemenu);
								setTimeout(function() {
									fnOpenWin('dialog.html', 'dialog', {
										statusbar: {
											background: '#F7F7F7'
										}
									}, {
										cid: cid,
										chatName: chatName,
										barStyle: 'dark',
										avatar: avatar
									}, 'slide-in-right');
								}, 300);
							} else {
								fnOpenWin('dialog.html', 'dialog', {
									statusbar: {
										background: '#F7F7F7'
									}
								}, {
									cid: cid,
									chatName: chatName,
									barStyle: 'dark',
									avatar: avatar
								}, 'slide-in-right');
							}
						})

						mui('header').on('tap', 'li', function() {
							var type = this.dataset.type;
							this.className = 'current';
							if (type == 'system') {
								document.querySelector('.hd li[data-type=chat]').className = '';
								document.querySelector('.chat-cont').classList.remove('current');
								document.querySelector('.system-cont').classList.add("current");
							} else {
								document.querySelector('.hd li[data-type=system]').className = '';
								document.querySelector('.system-cont').classList.remove('current');
								document.querySelector('.chat-cont').classList.add("current");
							}
						})

						//document.getElementById('back_chat').addEventListener('tap', function() {
						//	mui.fire(plus.webview.getWebviewById('H54F3E71F'), 'showChat');
						//	plus.webview.close('message');
						//})
						getSystemMsg();
					})
				}
			})

			// 获取系统消息
			function getSystemMsg() {
				mui.post($ajaxUrl + 'chat&action=notice_list', {
					token: userInfo.token
				}, function(res) {
					if (res.errno == 0) {
						app.systemMsg = res.data;
						for (var i = 0; i < res.data.length; i++) {
							if (res.data[i].count > 0) {
								document.querySelector('.system-red-tips').style.display = "inline-block";
							} else {
								document.querySelector('.system-red-tips').style.display = "none";
							}
						}
						document.getElementById("systemMsg_total").innerText='('+res.data.length+')';
					} else {
						// message(res.message, "center");
					}
				}, 'json')
			}
			// 获取消息列表
			function getChatList() {
				if (!refresh) {
					plus.nativeUI.showWaiting();
				}
				mui.post($ajaxUrl + 'chat', {
					action: 'list',
					token: userInfo.token
				}, function(res) {
					var html = '';
					if (res.errno == 0) {
						if (res.message == true) {
							document.querySelector('.chat-red-tips').style.display = "inline-block";
						} else {
							document.querySelector('.chat-red-tips').style.display = "none";
						}
						var chatList = res.data;
						var total = chatList.length;
						document.getElementById('chat_total').innerText = '(' + total + ')';
						html += '<ul class="mui-table-view">';
						for (var i = 0; i < total; i++) {
							html += '<li class="Record_list mui-table-view-cell mui-transitioning" data-avatar="' + chatList[
									i].user.avatarUrl + '" data-cid="' + chatList[i].user
								.id + '" data-name="' + chatList[i].user.nickName +
								'">';
							html += '<div class="mui-slider-right mui-disabled">';
							html += '<span class="mui-btn mui-btn-red" data-chatid=' + chatList[i].id + '>删除</span>';
							html += '</div>';
							html += '<div class="mui-slider-handle mui-clearfix">';
							html += '<div class="Record_listL mui-pull-left">';
							if (!chatList[i].user.avatarUrl) {
								html += '<img src="../image/user_default.png">';
							} else {
								html += '<img src="' + chatList[i].user.avatarUrl + '">';
							}

							html += '</div>';
							html += '<div class="Record_listR mui-pull-right">';
							html += '<div class="mui-clearfix">';
							html += '<span class="mui-pull-left user-name  mui-ellipsis">';
							html += '<span class="Label">';
							if (chatList[i].type == 'friend') {
								html += '<img src="../image/newsb3.png">';
							} else if (chatList[i].type == 'customer') {
								html += '<img src="../image/newsb2.png">';
							} else {
								html += '<img src="../image/newsb1.png">';
							}
							html += '</span>';
							html += '<span style="font-size: 15px;">' + chatList[i].user.nickName + '</span>';
							if (chatList[i].name) {
								html += '<span style="color: #2289FF;font-size: 15px;">(' + chatList[i].name + ')</span>';
							}
							html += '</span>';
							html += '<span class="mui-pull-right date">' + chatList[i].time + '</span>';
							html += '</div>';
							html += '<div class="tishi mui-clearfix">';
							if (chatList[i].message !== 'empty') {
								if (chatList[i].message.message_type == 'text') {
									html += '<span class="mui-pull-left mui-ellipsis last-message">' + chatList[i].message.content + '</span>';
								} else {
									html += '<span class="mui-pull-left">[图片]</span>';
								}
								if (chatList[i].message.count > 0) {
									html += '<p class="mui-badge mui-pull-right">' + chatList[i].message.count + '</p>';
								}
								html += '<div class="clearfix"></div>';
							} else {
								html += '<span class="mui-pull-left">  </span>';
								// html += '<p class="mui-badge mui-pull-right"></p>';
								html += '<div class="clearfix"></div>';
							}
							html += '</div>';
							html += '</div>';
							html += '</li>';
						}
						html += '</ul>';
						html += '</div>';
					} else {
						html += '<div style="padding: 15px;text-align: center;color: #ccc;padding-right: 45px;">没有数据</div>';
					}
					document.getElementById('chat_message').innerHTML = html;
					if (!refresh) {
						plus.nativeUI.closeWaiting();
					} else {
						refresh = false;
					}
				}, 'json')
			}
			var listel = '';
			// 删除聊天
			mui(".mui-content").on("tap", ".mui-btn-red", function() {
				mui('.join-team-verify')[0].style.display = "flex";
				chatId = this.dataset.chatid;
				listel = this.parentNode.parentNode;
			})
			// 跳转目标助理
			mui(".mui-content").on("tap", ".target-assistant", function() {
				var genre = this.dataset.genre;
				openPage('target_assistant.html', 'target_assistant', '#f7f7f7', {
					genre: genre
				});
			})
			// 确认删除聊天
			mui('.join-team-verify').on("tap", ".send-verify", function() {
				mui.post($ajaxUrl + 'chat&action=delete_chat', {
					token: userInfo.token,
					chat_id: chatId
				}, function(res) {
					mui('.join-team-verify')[0].style.display = "none";
					if (res.errno == 0) {
						getChatList();
						message('已删除');
					} else {
						message('删除失败，请稍后重试');
					}
				}, 'json');
			})
			// 取消删除聊天记录
			mui('.join-team-verify').on("tap", ".close-verify-window", function() {
				mui('.join-team-verify')[0].style.display = "none";
				// var li=document.getElementById
				mui.swipeoutClose(listel);
			})
		</script>
	</body>
</html>
