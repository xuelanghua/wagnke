<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="referrer" content="no-referrer">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.css" rel="stylesheet" />
		<style>
			.mui-bar{
				height: 90px;
				background-color: #FFFFFF;
			}
			.nav-section{
				height: 45px;
			}
			.tab-container{
				display: flex;
				align-items: center;
				height: 45px;
			}
			.tab-item{
				width: 50%;
				text-align: center;
				height: 45px;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 16px;
			}
			.tab-item.active{
				color: #2289FF;
				border-bottom: 1px solid #2289FF;
			}
			.chat-red-tips,
			.system-red-tips{
				position: relative;
				width: 6px;
				height: 6px;
				background-color: #FF0000;
				border-radius: 50%;
				display: inline-block;
				margin-right: 1px;
				display: inline-block;
			}
			[v-cloak] {
				display: none;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<div class="nav-section">
				<h1 class="mui-title">消息</h1>
				<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			</div>
			<div class="tab-container mui-clearfix">
				<div :class="desc=='message_list'?'tab-item active':'tab-item'" data-type="message_list">
					<span v-show="chatNew" class="chat-red-tips"></span>
					<span>聊天</span>
					<span id="chat_total">(0)</span>
				</div>
				<div :class="desc=='message_inform'?'tab-item active':'tab-item'" data-type="message_inform">
					<span v-show="systemNew" class="system-red-tips"></span>
					<span>通知消息</span>
					<span id="systemMsg_total">(0)</span>
				</div>
			</div>
		</header>

		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo();
			var chatId = '';
			var chatType = '';
			var refresh = false;
			var app = new Vue({
				el: ".mui-bar",
				data: {
					chatNew: false,
					systemNew: false,
					desc: 'message_list'
				},
				mounted: function() {
					var styles = {
						backButtonAutoControl: "none",
						bottom: "0px",
						top: "118px",
						width: "100%",
						hardwareAccelerated: true,
						popGesture: "none",
						scrollIndicator: "none"
					}
					mui.plusReady(function() {
						mui.init({
							gestureConfig: {
								doubletap: true,
							}
						});
						var message_list = plus.webview.create("message_list.html", "message_list", styles);
						var message_inform = plus.webview.create("message_inform.html", "message_inform", styles);
						message_list.show();
						getChatList();
						getSystemMsg();
						window.addEventListener('refreshNotice', function(e) {
							refresh = true;
							getChatList(false);
							getSystemMsg();
						})

						mui('.mui-bar').on('tap', '.tab-item', function() {
							var type = this.dataset.type;
							app.desc = type;
							plus.webview.show(type);
						})
					})
				},
				methods: {

				}
			})

			// 获取系统消息
			function getSystemMsg() {
				mui.post($ajaxUrl + 'chat&action=notice_list', {
					token: userInfo.token
				}, function(res) {
					if (res.errno == 0) {
						app.systemMsg = res.data;
						cacheData('systemMsg', res.data);
						var flag = false;
						for (var i = 0; i < res.data.length; i++) {
							if (res.data[i].count > 0) {
								flag = true;
							}
						}
						if (flag) {
							document.querySelector('.system-red-tips').style.display = "inline-block";
						} else {
							document.querySelector('.system-red-tips').style.display = "none";
						}
						document.getElementById("systemMsg_total").innerText = '(' + res.data.length + ')';
					} else {
						// message(res.message, "center");
					}
				}, 'json')
			}

			// 获取消息列表
			function getChatList() {
				mui.post($ajaxUrl + 'chat', {
					action: 'list',
					token: userInfo.token
				}, function(res) {
					if (res.errno == 0) {
						document.getElementById('chat_total').innerText = '(' + res.data.length + ')';
						if (res.message) {
							document.querySelector('.chat-red-tips').style.display = "inline-block";
						} else {
							document.querySelector('.chat-red-tips').style.display = "none";
						}
						cacheData('msglist', res.data);
					} else {
						app.voidmsg = true;
					}
				}, 'json')
			}
			// 双击导航返回顶部
			mui(".mui-bar").on("doubletap", ".mui-title", function() {
				mui.fire(plus.webview.getWebviewById('message_list'),'backTop');
			})
		</script>
	</body>
</html>
