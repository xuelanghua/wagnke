<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/mui.picker.css" rel="stylesheet" />
		<link href="../css/mui.dtpicker.css" rel="stylesheet" />
		<style>
			.clearfix{
				clear: both;
			}
			.mui-bar,.mui-content,body{
				background-color: #FFFFFF;
			}
			.customer_title{
				padding: 10px 0;
				font-size: 14px;
				text-align: center;
			}
			.mui-input-row label{
				width: 50%;
				padding: 11px 10px;
				text-align: left;
			}
			/* .customer_title div{
				width: 50%;
			}
			.customer_title img{
				height: 19px;
			} */
			.customer_title span{
				display: block;
			}
			.nr,.nrs{
				padding: 5px 0;
			}
			.nr{
				border-right: 1px solid #F2F2F2;
			}
			
			.title_name{
				padding: 12px 10px;
				color: #2289FF;
				background-color: #F5F5F5;
			}
			.conetnt_list{
				padding: 5px 0;
				margin-left: 10px;
				font-size: 15px;
				border-bottom: 1px solid #F2F2F2;
			}
			.name{
				margin-top: 10px;
			}
			.conetnt_list input{
				width: 95%;
				padding: 0 5px 0 0;
				margin: 0;
				border: none;
				font-size: 15px;
				text-align: right;
				color: #999999;
			}
			.conetnt_list1{
				padding: 6px 10px 6px 0;
				margin-left: 10px;
				font-size: 15px;
				border-bottom: 1px solid #F2F2F2;
			}
			.conetnt_list1 input{
				width: 95%;
				padding: 0 5px 0 0;
				margin: 0;
				border: none;
				font-size: 15px;
				text-align: right;
				color: #999999;
			}
			.conetnt_list1 img{
				width: 7px;
				height: 12px;
				margin-top: 15px;
			}
			
			.conetnt_list input {
				width: 200px;
				margin-right: 8px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<h1 class="mui-title">客户编辑</h1>
			<span class="mui-pull-right" style="margin-top: 11px;font-size: 15px;" id="save">保存</span>
		</header>

		<div class="mui-content">
			<!-- <div class="customer_title">
				<div class="mui-input-row">
					<label>屏蔽Ta的消息推送</label>
					<div class="mui-switch mui-switch-blue" id="notice_switch">
						<div class="mui-switch-handle"></div>
					</div>
				</div>
			</div> -->
			<!-- <div class="customer_title">
				<div class="mui-pull-left nr">
					<img src="../image/customerL.png">
					<span>通讯录录入</span>
				</div>
				<div class="mui-pull-right nrs">
					<img src="../image/customerR.png">
					<span>扫名片</span>
				</div>
				<div class="clearfix"></div>
			</div> -->

			<div class="title_name">
				联系信息
			</div>
			<div class="conetnt_list">
				<span class="mui-pull-left name">客户姓名*</span>
				<span class="mui-pull-right">
					<input type="text" name="name" />
				</span>
				<div class="clearfix"></div>
			</div>
			<div class="conetnt_list">
				<span class="mui-pull-left name">电话*</span>
				<span class="mui-pull-right">
					<input type="text" name="mobile" />
				</span>
				<div class="clearfix"></div>
			</div>
			<div class="conetnt_list">
				<span class="mui-pull-left name">地址</span>
				<span class="mui-pull-right">
					<input type="text" name="address" />
				</span>
				<div class="clearfix"></div>
			</div>

			<div class="title_name">
				基本信息
			</div>
			<div class="conetnt_list">
				<span class="mui-pull-left name">公司名称*</span>
				<span class="mui-pull-right">
					<input type="text" name="company" />
				</span>
				<div class="clearfix"></div>
			</div>
			<div class="conetnt_list">
				<span class="mui-pull-left name">职位*</span>
				<span class="mui-pull-right">
					<input type="text" name="job" />
				</span>
				<div class="clearfix"></div>
			</div>
			<div class="conetnt_list">
				<span class="mui-pull-left name">所属行业</span>
				<span class="mui-pull-right">
					<input type="text" name="industry" />
				</span>
				<div class="clearfix"></div>
			</div>
			<div class="conetnt_list1" data-type="birthday">
				<span class="mui-pull-left name">生日</span>
				<span class="mui-pull-right">
					<img src="../image/Marketing-codea.png">
				</span>
				<input type="text" name="birthday" class="mui-pull-right" style="width: 120px;" readonly value="">
				<div class="clearfix"></div>
			</div>
			<div class="conetnt_list1" data-type="anniversary">
				<span class="mui-pull-left name">纪念日</span>
				<span class="mui-pull-right">
					<img src="../image/Marketing-codea.png">
				</span>
				<input type="text" name="anniversary" class="mui-pull-right" style="width: 120px;" readonly value="">
				<div class="clearfix"></div>
			</div>

		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/mui.picker.js"></script>
		<script src="../js/mui.dtpicker.js"></script>
		<script src="../js/util.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true,
				beforeback: function() {
					plus.navigator.setStatusBarStyle('light');
				}
			})

			var cid = 0;
			var submitFlag = true;
			var userInfo = null;
			// var notice = 0;
			mui.plusReady(function() {
				userInfo = getUserInfo();
				var self = plus.webview.currentWebview();
				cid = self.cid;
				getCustomerInfo();

				mui('.mui-content').on('tap', '.conetnt_list1', function() {
					var type = this.dataset.type;
					var dt = datePick(function(e) {
						document.querySelector('input[name=' + type + ']').value = e.value;
					})
				})

				document.getElementById('save').addEventListener('tap', function() {
					if (!submitFlag) return;
					var submitData = {
						name: document.querySelector('input[name=name]').value,
						mobile: document.querySelector('input[name=mobile]').value,
						address: document.querySelector('input[name=address]').value,
						company: document.querySelector('input[name=company]').value,
						job: document.querySelector('input[name=job]').value,
						industry: document.querySelector('input[name=industry]').value,
						birthday: document.querySelector('input[name=birthday]').value,
						anniversary: document.querySelector('input[name=anniversary]').value,
					}
					if (submitData.name.length == 0) {
						message('请输入姓名!');
						return;
					}
					if (submitData.mobile.length == 0) {
						message('请输入电话!');
						return;
					}
					if (!/^1[\d]{10}$/.test(submitData.mobile)) {
						message('电话输入错误!');
						return;
					}
					if (submitData.company.length == 0) {
						message('请输入公司名称!');
						return;
					}
					if (submitData.job.length == 0) {
						message('请输入职位!');
						return;
					}
					submitData.cid = cid;
					logs(submitData);
					fnSubmit(submitData);
				})
			})

			function getCustomerInfo() {
				plus.nativeUI.showWaiting();
				mui.post($ajaxUrl + 'customer', {
					action: 'info',
					token: userInfo.token,
					cid: cid,
				}, function(res) {
					if (res.errno == 0) {
						var data = res.data;
						for (var index in data) {
							document.querySelector('input[name=' + index + ']').value = data[index];
						}
					} else {
						message(res.message);
						setTimeout(function() {
							plus.webview.close('customer_edit');
						}, 2000)
					}
					plus.nativeUI.closeWaiting();
				}, 'json')
			}

			function datePick(callback) {
				var dtpicker = new mui.DtPicker({
					type: "date", //设置日历初始视图模式
					value: "1990-09-16",
					beginDate: new Date(1930, 01, 01), //设置开始日期 
					endDate: new Date(2018, 12, 31), //设置结束日期 
					labels: ['年', '月', '日'], //设置默认标签区域提示语 
				})
				dtpicker.show(function(e) {
					callback(e);
				})
			}

			//获取通讯录
			function getContacts() {
				var content = "";
				try {
					plus.contacts.getAddressBook(plus.contacts.ADDRESSBOOK_PHONE, function(addressbook) {
						addressbook.find(["displayName", "phoneNumbers"], function(contacts) {
							content = "联系人数量：" + contacts.length;
							content += "<br>";
							for (var i = 0; i < contacts.length; i++) {
								for (var j = 0; j < contacts[i].phoneNumbers.length; j++) {
									var str = "<p><span style='display:inline_block';width:120px;'>姓名:" + contacts[i].displayName +
										"</span>号码:" + contacts[i].phoneNumbers[j].value + "</p>";
								}
								content += str;
							}
						}, function() {
							content = "error";
						}, {
							multiple: true
						});
					}, function(e) {
						content = "Get address book failed: " + e.message;
					});
				} catch (e) {
					content += e.message;
				}
			}

			//提交数据
			function fnSubmit(data) {
				submitFlag = false;
				// plus.nativeUI.showWaiting('数据处理中!', 'div');
				mui.post($ajaxUrl + 'customer', {
					action: 'add',
					type: 2,
					token: userInfo.token,
					data: data
				}, function(res) {
					// logs(res);
					if (res.errno == 0) {
						mui.fire(plus.webview.getWebviewById('crm_detail_app'), 'editCustomer');
						mui.fire(plus.webview.getWebviewById('crm_detail_miniapp'), 'editCustomer');
						mui.fire(plus.webview.getWebviewById('chat'), 'addCrm');
						message('编辑成功!');
						setTimeout(function() {
							plus.webview.close('customer_edit');
						}, 2000);
					} else {
						message(res.message);
						submitFlag = true;
					}
					// plus.nativeUI.closeWaiting();
				}, 'json')
			}
		</script>
	</body>
</html>
