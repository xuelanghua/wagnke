<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/showLoading.css" rel="stylesheet" />
		<style>
			body{
				background-color: #FFFFFF;
			}
			.clearfix {
				clear: both;
			}
			ul,li{
				list-style: none;
			}
			.mui-content{
				background-color: #FFFFFF;
			}
			.article{
				padding: 0 15px;
			}
			.article-title h1{
				font-size: 22px;
				line-height: 30px;
			}
			.author{
				font-size: 15px;
				margin-top: 25px;
				color: #999999;
			}
			.visit{
				padding: 15px 0;
			}
			.visitl img{
				width: 27px;
				height: 27px;
				display: block;
				margin: 4px auto;
			}
			.fw{
				width: 36px;
				height: 36px;
				background-color: #FFFFFF;
				border-radius: 50%;
				float: left;
			}
			.fw1{
				width: 36px;
				height: 36px;
				background-color: #FFFFFF;
				border-radius: 50%;
				float: left;
				margin-left: -8px;
			}
			.visitr{
				font-size: 15px;
				color: #999999;
				margin-top: 5px;
			}
			.chart{
				margin-bottom: 10px;
			}
			.chart img{
				width: 100%;
				height: 100%;
			}
			.article-content p{
				color: #000000;
				font-size: 15px;
			}
			.comment-title p{
				float: left;
				font-size: 15px;
				color: #999999;
				padding-left: 15px;
			}
			.biaotix{
				width: 80%;
				height: 1px;
				float: right;
				margin-top: 9px;
				background-color: #F2F2F2;
			}
			.comment1{
				padding: 20px 15px 5px 0;
				padding-left: 15px;
			}
			.commentl{
				width: 38px;
				height: 38px;
			}
			.commentl img{
				width: 100%;
				height: 100%;
			}
			.commentr{
				width: 85%;
			}
			.commentr-title{
				font-size: 13px;
			}
			.time{
				margin-top: 5px;
				font-size: 12px;
			}

				.feed{
					margin-top: -40px;
					float: right;
				}
				.comment-input{
					width: 100%;
					position: fixed;
					bottom: 0;
					padding: 8px 15px;
					border-top: 1px solid #F2F2F2;
					background-color: #FFFFFF;
				}
				.input{
					width: 50%;
					background-color: #F5F6F8;
					padding: 7px 0 7px 11px;
					color: #999999;
					font-size: 15px;
					border-radius: 25px;
				}
				.input img{
					width: 17px;
					height: 18px;
				}
				.comment-inputr{
					width: 50%;
					font-size: 12px;
				}
				.comment-inputr div{
					width: 33.33%;
					float: left;
					text-align: center;
				}
				.comment-inputr img{
					height: 16px;
				}
				.comment-inputr span{
					display: block;
					color: #999999;
				}
				.comment-content{
					margin-bottom: 50px;
					padding-bottom: 20px;
				}
				.tanchu{
					padding: 19px;
					border-radius: 8px;
					background-color: #FFFFFF;
					position: fixed;
					z-index: 99999;
					width: 92%;
					top: 25%;
					left: 4%;
					right: 4%;
					display: none;
				}
				.tanchu textarea{
					border: none;
					font-size: 15px;
					background-color: #F5F6F8;
				}
				.tanchu button{
					width: 30%;
					background-color: #2289FF;
					color: #FFFFFF;
					border: none;
					margin: 0 auto;
					display: block;
					font-size: 15px;
					border-radius: 5px;
				}
				#cover{
				    position: fixed;
					z-index: 9999;
					top: 0;
					left: 0;
					display: none;
					width: 100%;
					height: 100%;
					opacity: 0.5;
					background: #333333 none repeat scroll 0% 0%;
				}
				#article_content img{
					max-width: 100% !important;
					height: auto !important;
				}
		</style>
	</head>

	<body>

		<header class="mui-bar mui-bar-nav" style="background-color: #FFFFFF;">
			<div class="mui-icon mui-icon-left-nav mui-pull-left" id="back_icon"></div>
			<h1 class="mui-title" id="article_top"></h1>
		</header>

		<div class="mui-content mui-hidden">
			<div class="article">
				<div class="article-title">
					<h1 style="margin-top: 20px;" id="article_title"></h1>
					<div class="author">
						<span id="article_author"></span>
						<span style="margin-left: 10px;" id="article_addtime"></span>
					</div>
					<div class="visit">
						<div class="visitl mui-pull-left" id="read_headimg">
							<div class="fw">
								<!-- <img src="../image//visit1.png" alt=""> -->
							</div>
							<!-- <div class="fw1">
									<img src="../image//visit2.png" alt="">
								</div> 
								<div class="fw1">
									<img src="../image//visit1.png" alt="">
								</div>
								<div class="fw1">
									<img src="../image//visit2.png" alt="">
								</div>
								<div class="fw1">
									<img src="../image//visit1.png" alt="">
								</div>
								<div class="fw1">
									<img src="../image//visit2.png" alt="">
								</div>
								<div class="fw1">
									<img src="../image//visit1.png" alt="">
								</div>
								<div class="fw1">
									<img src="../image//visit2.png" alt="">
								</div> -->
							<!-- <div class="fw1">
									<img src="../image//visit3.png" alt="">
								</div> -->
						</div>
						<div class="visitr mui-pull-right">
							<span>阅读：</span>
							<span id="article_click"></span>
						</div>
						<div class="clearfix"></div>
					</div>
				</div>
				<div class="article-content">
					<div class="chart" id="top_adv">
						<!-- <a><img src="../image//guangao.jpg" alt=""></a> -->
					</div>
					<div id="article_content">
						<!-- <p>
								或许大家看到这个标题会联想到市面上的一些远程控制软件，诸如：TeamViewer、AnyDesk等。这一次笔者想推荐的并不是一
							</p>
							<p>
								或许大家看到这个标题会联想到市面上的一些远程控制软件，诸如：TeamViewer、AnyDesk等。这一次笔者想推荐的并不是一
							</p> -->
					</div>
					<div class="chart" id="bottom_adv">
						<!-- <img src="../image//guangao.jpg" alt=""> -->
					</div>
				</div>
			</div>

			<!-- 评论 -->
			<div class="comment">
				<div class="comment-title">
					<p>最新评论</p>
					<div class="biaotix"></div>
					<div class="clearfix"></div>
				</div>
				<div class="comment-content" id="comment_list">
					<!-- <div class="comment1">
						<div class="commentl mui-pull-left">
							<img src="../image//visit2.png" >
						</div>
						<div class="commentr mui-pull-right">
							<div class="commentr-title">
								<span style="color: #2C8EFF;">钟山商</span>
							</div>
							<div style="line-height: 25px;font-size: 15px;margin-top: 5px;">
								这里的是评论内容，就是评论内容，评论内自动换行
							</div>
							<div class="time">
								<span>11-20</span>
								<span>18:20</span>
							</div>
						</div>
						<div class="clearfix"></div>
					</div>
					<div class="comment1">
						<div class="commentl mui-pull-left">
							<img src="../image//visit2.png" >
						</div>
						<div class="commentr mui-pull-right">
							<div class="commentr-title">
								<span style="color: #2C8EFF;">钟山商</span>
							</div>
							<div style="line-height: 25px;font-size: 15px;margin-top: 5px;">
								这里的是评论内容，就是评论内容，评论内自动换行
							</div>
							<div class="time">
								<span>11-20</span>
								<span>18:20</span>
							</div>
						</div>
						<div class="clearfix"></div>
					</div>
				 -->
				</div>

				<div class="comment-input">
					<div class="input mui-pull-left" id="read_comment">
						<img src="../image//shuru.png">
						<span style="margin-left: 10px;">写评论...</span>
					</div>
					<input id="sharehref" type="hidden" value="http://www.baidu.com/" />
					<!-- <p>链接标题：</p> -->
					<input id="sharehrefTitle" type="hidden" value="title" />
					<!-- <p>链接描述：</p> -->
					<input id="sharehrefDes" type="hidden" value="desc" />
					<!-- <p>链接描述：</p> -->
					<input id="sharehrefImg" type="hidden" value="../image/user_default.png" />
					<div class="comment-inputr mui-pull-right">
						<div id="read_share">
							<img src="../image//fenxiang.png">
							<span>分享</span>
						</div>
						<!-- //red_envelopes.html -->
						<div id="adv_setting">
							<img src="../image//guangaowe.png">
							<span>广告位</span>
						</div>
						<div id="read_volume">
							<img src="../image//yudu.png">
							<span>阅读量</span>
						</div>
						<div class="clearfix"></div>
					</div>
					<div class="clearfix"></div>
				</div>
			</div>

			<!-- 弹出框 -->
			<div id="cover"></div>
			<div class="tanchu" id="tanchu">
				<textarea rows="8" placeholder="说说你的看法..." id="release_content"></textarea>
				<button class="button" id="read_release">发 布</button>
			</div>
		</div>
	</body>
	<!-- <script>
			$(document).ready(function(){
			$("#cover").click(function(){
				$(".tanchu").hide();
				$(this).hide;
				$("#cover").hide();
			});
			$(".input").click(function(){
				$("#read_comment").show();
				$(this).show;
				$("#cover").show();
			});
		  });
		</script> -->

</html>
<script src="../js/mui.js"></script>
<script src="../js/util.js"></script>
<script src="../js/showLoading.js"></script>
<script>
	mui.init({
		swipeBack: false,
		beforeback: function() {
			var view = plus.webview.currentWebview().opener();
			if (view.id == 'discover') {
				setStatusBar('', 'light');
			}
		}
	});

	var article_id = '', //文章id
		time = 0, //停留时间
		rid = 0,
		shares = null,
		Intent = null,
		File = null,
		Uri = null,
		main = null,
		userInfo = getUserInfo();
	var articleUid = 0;
	mui.plusReady(function() {
		// mui.showLoading("正在加载..", "div");
		showload(false, false, '加载中...', "rgba(0,0,0,0.5)");
		updateSerivces();
		if (plus.os.name == "Android") {
			main = plus.android.runtimeMainActivity();
			Intent = plus.android.importClass("android.content.Intent");
			File = plus.android.importClass("java.io.File");
			Uri = plus.android.importClass("android.net.Uri");
		}
		plus.navigator.setStatusBarStyle("dark");
		article_id = plus.webview.currentWebview().article_id;
		article_info();
		article_read();
		adv_list();

		window.addEventListener('articleinfo', function(event) {
			adv_list();
		});

		//返回监听
		var back = document.getElementById('back_icon');
		back.addEventListener('tap', function() {
			article_stay();
			setTimeout(function() {
				plus.webview.currentWebview().close();
				mui.fire(plus.webview.getWebviewById('media'), 'resizeWindow');
			}, 200);
		})
		setInterval('addtime()', 1000);

		//分享
		var read_share = document.getElementById('read_share');
		read_share.addEventListener('tap', function() {
			shareHref();
		})

		//阅读量
		var read_volume = document.getElementById('read_volume');
		read_volume.addEventListener('tap', function() {
			// w.show(); // 显示窗口
			openPage('visitor.html', 'visitor', '#f7f7f7', {
				article_id: article_id
			});
		})

		//广告位设置
		var adv_setting = document.getElementById('adv_setting');
		adv_setting.addEventListener('tap', function() {
			var styles = {
				top: 0,
				bottom: 0,
				statusbar: {
					background: '#FFF'
				}
			};
			var extras = {
				article_id: article_id
			};
			var w = plus.webview.create('adv_setting.html', 'adv_setting', styles, extras);
			w.show(); // 显示窗口
		})

		document.addEventListener("pause", function() {
			article_stay();
		}, false);
		document.addEventListener("resume", function() {
			time = 0;
		}, false);

		plus.key.addEventListener('backbutton', function() {
			article_stay();
		})

		//写评论
		var read_comment = document.getElementById('read_comment');
		read_comment.addEventListener('tap', function() {
			document.getElementById('cover').style.display = "block";
			document.getElementById('tanchu').style.display = "block";
			setTimeout(function() {
				try {
					document.getElementById('release_content').focus();
				} catch (e) {}
			}, 100);
		})

		var cover = document.getElementById('cover');
		cover.addEventListener('tap', function() {
			document.getElementById('cover').style.display = "none";
			document.getElementById('tanchu').style.display = "none";
		})

		var read_release = document.getElementById('read_release');
		read_release.addEventListener('tap', function() {
			var release_content = document.getElementById('release_content');
			if (release_content.value == '') {
				mui.toast('内容不能为空!');
				return;
			}
			read_released(release_content.value);
			document.getElementById('cover').style.display = "none";
			document.getElementById('tanchu').style.display = "none";
		})
	});

	function addtime() {
		time++;
	}

	function article_read() {
		var url = $ajaxUrl + 'article';
		mui.post(url, {
			token: userInfo.token,
			action: 'article_read',
			id: article_id,
			type: 'record'
		}, function(data) {
			if (data.errno == '0') {
				rid = data.data.rid;
			}
		}, 'json');
	}

	function article_stay() {
		var url = $ajaxUrl + 'article';
		mui.post(url, {
			token: userInfo.token,
			action: 'article_read',
			rid: rid,
			type: 'stay',
			stay_time: time,
			id: article_id
		}, function(data) {
			console.log(JSON.stringify(data));
		}, 'json');
	}
	//文章详情
	function article_info() {
		var str = '';
		var url = $ajaxUrl + 'article';
		mui.post(url, {
			token: userInfo.token,
			action: 'article_info',
			id: article_id
		}, function(data) {
			logs(data);
			if (data.errno == '0') {
				articleUid = data.data.uid;
				document.getElementById('article_top').innerHTML = data.data.title;
				document.getElementById('article_title').innerHTML = data.data.title;
				document.getElementById('article_author').innerHTML = data.data.author;
				document.getElementById('article_addtime').innerHTML = data.data.add_time;
				document.getElementById('article_content').innerHTML = data.data.content;
				document.getElementById('article_click').innerHTML = data.data.click;
				document.getElementById('sharehref').value = data.data.share_link;
				document.getElementById('sharehrefTitle').value = data.data.title;
				document.getElementById('sharehrefDes').value = data.data.desc;
				document.getElementById('sharehrefImg').value = data.data.thumb;

				var str = '';
				if (data.data.read_img.length < 8) {
					for (i in data.data.read_img) {
						str += '<div class="fw"><img src="' + data.data.read_img[i].headimgurl + '" alt=""></div>';
					}
				} else {
					for (i = 0; i < 8; i++) {
						str += '<div class="fw"><img src="' + data.data.read_img[i].headimgurl + '" alt=""></div>';
					}
					str += '<div class="fw"><img src="../image//visit3.png" alt=""></div>';
				}
				document.getElementById('read_headimg').innerHTML = str;
				if (data.data.comment.length > 0) {
					var commentStr = '';
					for (i in data.data.comment) {
						commentStr += '<div class="comment1"><div class="commentl mui-pull-left"><img src="' + data.data.comment[i].headimgurl +
							'" ></div><div class="commentr mui-pull-right"><div class="commentr-title"><span style="color: #2C8EFF;">' +
							data.data.comment[i].nickname +
							'</span></div><div style="line-height: 25px;font-size: 15px;margin-top: 5px;">' +
							data.data.comment[i].comment + '</div><div class="time"><span>' + data.data.comment[i].add_time +
							'</span></div></div><div class="clearfix"></div></div>';
					}
					document.getElementById('comment_list').innerHTML = commentStr;
				}
				// comment_list(data.data.comment);
			} else {
				mui.toast(data.message, {
					duration: 'long',
					type: 'div'
				});
				setTimeout(function() {
					var ws = plus.webview.currentWebview();
					plus.webview.close(ws);
				}, 2000);
			}

			document.querySelector('.mui-content').classList.remove('mui-hidden');
		}, 'json');
	}

	function adv_list() {
		var str = '';
		var url = $ajaxUrl + 'article';
		mui.post(url, {
			token: userInfo.token,
			action: 'article_info',
			id: article_id
		}, function(data) {
			if (data.errno == '0') {
				var str = '';
				var str1 = '';
				if (data.data.is_me_adv == '1') {
					//console.log(JSON.stringify(data.data.adv_info));
					if (data.data.adv_info.top_pic) {
						str = '<img src="' + data.data.adv_info.top_pic + '" alt="">';
					}
					if (data.data.adv_info.bottom_pic) {
						str1 = '<img src="' + data.data.adv_info.bottom_pic + '" alt="">';
					}
				} else {
					if (data.data.top_adv != '0') {
						str = '<img src="' + data.data.top_adv.pic + '" alt="">';
					}
					if (data.data.bottom_adv != '0') {
						str1 = '<img src="' + data.data.bottom_adv.pic + '" alt="">';
					}
				}
				document.getElementById('top_adv').innerHTML = str;
				document.getElementById('bottom_adv').innerHTML = str1;
				setTimeout(function() {
					// mui.hideLoading();
					showload(1);
				}, 500);
			}
		}, 'json');
	}

	function comment_list(comment) {
		var str = '';
		var url = $ajaxUrl + 'article';
		mui.post(url, {
			token: userInfo.token,
			action: 'article_info',
			id: article_id
		}, function(data) {
			if (data.errno == '0') {
				var str = '';
				for (i in data.data.comment) {
					str += '<div class="comment1"><div class="commentl mui-pull-left"><img src="' + data.data.comment[i].headimgurl +
						'" ></div><div class="commentr mui-pull-right"><div class="commentr-title"><span style="color: #2C8EFF;">' +
						data.data.comment[i].nickname + '</span></div><div style="line-height: 25px;font-size: 15px;margin-top: 5px;">' +
						data.data.comment[i].comment + '</div><div class="time"><span>' + data.data.comment[i].add_time +
						'</span></div></div><div class="clearfix"></div></div>';
				}
				document.getElementById('comment_list').innerHTML = str;
			}
		}, 'json');
	}

	function read_released(content) {
		var url = $ajaxUrl + 'article';
		mui.post(url, {
			token: userInfo.token,
			action: 'article_comment',
			content: content,
			id: article_id
		}, function(data) {
			if (data.errno == '0') {
				comment_list();
				mui.toast(data.message);

			}
		}, 'json');
	}

	/**
	 * 
	 * 更新分享服务
	 */
	function updateSerivces() {
		plus.share.getServices(function(s) {
			shares = {};
			for (var i in s) {
				var t = s[i];
				shares[t.id] = t;
			}
		}, function(e) {
			message("获取分享服务列表失败：" + e.message);
		});
	}



	/**
	 * 分享操作
	 * @param {JSON} sb 分享操作对象s.s为分享通道对象(plus.share.ShareService)
	 * @param {Boolean} bh 是否分享链接
	 */
	function shareAction(sb, bh) {
		if (!sb || !sb.s) {
			message("无效的分享服务！");
			return;
		}
		
		if (sb.s == 'APPTimeline') {
			logs(sb);
			return;
		}

		var sharehref = document.getElementById('sharehref');
		var sharehrefDes = document.getElementById('sharehrefDes');
		var sharehrefTitle = document.getElementById('sharehrefTitle');
		var sharehrefImg = document.getElementById('sharehrefImg');

		var msg = {
			content: sharehrefDes.value,
			extra: {
				scene: sb.x
			}
		};
		if (bh) {
			msg.href = sharehref.value;
			if (sharehrefTitle && sharehrefTitle.value != "") {
				msg.title = sharehrefTitle.value;
			}
			if (sharehrefDes && sharehrefDes.value != "") {
				msg.content = sharehrefDes.value;
			}
			msg.thumbs = [sharehrefImg.value];
			msg.pictures = [sharehrefImg.value];
		} else {
			msg.pictures = [sharehrefImg.value];
		}

		// 发送分享
		if (sb.s.authenticated) {
			//alert("---已授权---");
			shareMessage(msg, sb.s);
		} else {
			//alert("---未授权---");
			sb.s.authorize(function() {
				shareMessage(msg, sb.s);
			}, function(e) {
				alert("认证授权失败：" + e.code + " - " + e.message);
			});
		}
	}
	/**
	 * 发送分享消息
	 * @param {JSON} msg
	 * @param {plus.share.ShareService} s
	 */
	function shareMessage(msg, s) {
		var imgpath = '';
		var imgDtask = plus.downloader.createDownload(msg.thumbs[0], {
			method: 'GET'
		}, function(d, status) {
			if (status == 200) {
				plus.zip.compressImage({
						src: d.filename,
						dst: d.filename,
						overwrite: true,
						width: '300px',
						height: 'auto',
						format: 'jpg',
						quality: 80,
						clip: {
							width: "300px",
							height: "300px"
						}
					},
					function(e) {
						imgpath = e.target;
						if (imgpath) {
							msg.thumbs = [imgpath];
							s.send(msg, function() {
								//alert("分享到\""+s.description+"\"成功！ " );
								share_success();
							}, function(e) {
								alert("分享到\"" + s.description + "\"失败: " + JSON.stringify(e));
							});
						} else {
							s.send(msg, function() {
								//alert("分享到\""+s.description+"\"成功！ " );
								share_success();
							}, function(e) {
								alert("分享到\"" + s.description + "\"失败: " + JSON.stringify(e));
							});
						}
					},
					function(error) {
						logs("图片压缩失败！");
					});
			} else {
				logs('保存失败')
			}
		});
		imgDtask.start();
		//alert(JSON.stringify(msg));
	}
	// 分析链接
	function shareHref() {
		var shareBts = [];
		// 更新分享列表
		var ss = shares['weixin'];
		ss && ss.nativeClient && (shareBts.push({
				title: '微信朋友圈',
				s: ss,
				x: 'WXSceneTimeline'
			}),
			shareBts.push({
				title: '微信好友',
				s: ss,
				x: 'WXSceneSession'
			}));
		ss = shares['qq'];
		ss && ss.nativeClient && shareBts.push({
			title: 'QQ',
			s: ss
		});
		articleUid == userInfo.id && shareBts.push({
			title: '好友动态',
			s: 'APPTimeline'
		});
		
		// 弹出分享列表
		shareBts.length > 0 ? plus.nativeUI.actionSheet({
			title: '分享链接',
			cancel: '取消',
			buttons: shareBts
		}, function(e) {
			(e.index > 0) && shareAction(shareBts[e.index - 1], true);
		}) : plus.nativeUI.alert('当前环境无法支持分享链接操作!');
	}

	//分享成功提交数据
	function share_success() {
		var url = $ajaxUrl + 'article';
		mui.post(url, {
			token: userInfo.token,
			action: 'article_read',
			id: article_id,
			type: 'share',
			rid: rid
		}, function(data) {
			console.log(JSON.stringify(data));
		}, 'json');
	}
</script>
