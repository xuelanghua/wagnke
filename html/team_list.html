<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>团队列表</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../iconfont/iconfont.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/vip-page.css" />
		<style type="text/css">
			[v-cloak] {
				display: none;
			}

			.team-list {
				position: relative;
			}

			.sign-tags {
				position: absolute;
				right: 0;
				top: 0;
				z-index: 9;
				width: 0.75rem;
				height: auto;
			}

			.rank-num {
				font-size: 0.24rem;
				color: #333333;
				display: inline-flex;
				align-items: center;
			}

			.rank-sign {
				width: 0.27rem;
				margin-right: 5px;
			}

			.mui-content.team-list-container {
				padding-bottom: 100px;
			}

			.opction-cont {
				position: relative;
				display: flex;
				justify-content: space-between;
				height: 0.85rem;
				margin-top: 0.1rem;
			}

			.opction-cont:before {
				content: "";
				display: block;
				width: 100%;
				height: 1px;
				background-color: #DDDDDD;
				top: 0;
				left: 0;
				position: absolute;
				-webkit-transform: scaleY(0.5);
				transform: scaleY(0.5);
			}

			.opction-btn {
				height: 100%;
				flex-grow: 1;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				font-size: 0.24rem;
				position: relative;
			}

			.opction-btn.grayness {
				opacity: 0.3;
			}

			.opction-btn:nth-of-type(2):after,
			.opction-btn:last-of-type:after {
				content: "";
				display: inline-block;
				width: 1px;
				height: 40%;
				background-color: #DDDDDD;
				top: 30%;
				left: 0;
				position: absolute;
				-webkit-transform: scaleX(0.5);
				transform: scaleX(0.5);
			}

			.opction-cont img {
				height: 0.29rem;
				margin-right: 0.13rem;
			}

			.inside-top {
				padding: 0.2rem 0.3rem 0;
			}

			.team-list-container .operation-section {
				z-index: 6;
			}

			/* 搜索框 */
			.search-cont.active .search-input {
				border-radius: 14px;
				flex-grow: 1;
				-webkit-transition: all 0.25s ease-in-out;
				transition: all 0.25s ease-in-out;
			}

			.search-cont {
				width: 30px;
				display: flex;
				align-items: center;
				position: relative;
				overflow: hidden;
				-webkit-transition: all 0.25s ease-in-out;
				transition: all 0.25s ease-in-out;
			}

			.search-cont.active {
				overflow: hidden;
				width: 100%;
				-webkit-transition: all 0.25s ease-in-out;
				transition: all 0.25s ease-in-out;
			}

			.search-cont .mui-icon-search {
				position: absolute;
				left: 5px;
				font-size: 22px;
			}

			.search-cont .search-input {
				border-radius: 14px;
				text-align: left;
				width: 20px;
				position: relative;
				height: 28px;
				flex-shrink: 0;
				-webkit-transition: all 0.25s ease-in-out;
				transition: all 0.25s ease-in-out;
			}

			input[type=search] {
				background-color: #e8e8e8;
			}

			.search-cont.active .search-input {
				padding-left: 40px;
				padding-right: 30px;
				background-color: #e8e8e8;
				flex-shrink: 0;
				border-radius: 14px;
				flex-grow: 1;
			}

			.search-cont.active:after {
				content: '';
				background-color: rgba(0, 0, 0, 0.1);
				width: 1px;
				height: auto;
				bottom: 30%;
				top: 30%;
				left: 32px;
				position: absolute;
				-webkit-transform: scaleX(0.5);
				transform: scaleX(0.5);
			}

			.search-cont input::-webkit-input-placeholder {
				color: #999999;
				font-size: 0.24rem;
			}

			.search-cont .form-container {
				height: 100%;
				display: flex;
				position: relative;
				width: 100%;
				justify-content: flex-end;
				overflow: hidden;
			}

			.search-cont .mui-icon-clear {
				right: 48px;
				position: absolute;
				font-size: 20px;
				color: #999999;
				margin-top: 1px;
			}

			.mui-action-back.mui-icon.mui-icon-left-nav {
				margin-left: 0;
			}

			.mui-bar-nav {
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.mui-bar-nav.mui-bar .mui-action-back {
				padding-left: 0;
				padding-right: 20px;
			}

			.mui-bar .mui-title {
				position: relative;
				flex-grow: 1;
				margin: 0;
				left: 0;
				right: 0;
				-webkit-transition: all 0.25s ease-in-out;
				transition: all 0.25s ease-in-out;
			}

			.mui-bar .mui-title.active {
				width: 0;
				flex-grow: 0;
				display: none;
				overflow: hidden;
				-webkit-transition: all 0.25s ease-in-out;
				transition: all 0.25s ease-in-out;
			}

			.mui-bar-nav.mui-bar .mui-icon-search {
				margin: 10px 0 0;
				padding: 0;
			}

			.cancel-btn {
				align-items: center;
				justify-content: center;
				font-size: 16px;
				color: #666666;
				display: inline-flex;
				overflow: hidden;
				height: 0;
				width: 0;
				flex-shrink: 0;
			}

			.search-cont.active .cancel-btn {
				height: 44px;
				width: 44px;
				-webkit-transition: all 0.1s ease-in-out;
				transition: all 0.1s ease-in-out;
			}

			.void-data-tips {
				padding: 20%;
				text-align: center;
			}

			.void-data-tips img {
				width: 100%;
			}

			.mui-backdrop {
				position: fixed;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				z-index: 998;
				background-color: rgba(0, 0, 0, .3);
			}

			/* 新的 */
			.team-select {
				top: -280px;
				position: absolute;
				left: 0;
				width: 100%;
				background-color: #F9F9F9;
				height: 210px;
				padding: 0;
				overflow: hidden;
				-webkit-transition: all 0.25s ease-in-out;
				transition: all 0.25s ease-in-out;
				display: block;
				padding-bottom: 44px;
				z-index: 9;
				border-bottom-left-radius: 10px;
				border-bottom-right-radius: 10px;
			}

			.team-select.active {
				top: 44px;
				padding-top: 5px;
			}

			.team-select:before {
				content: '';
				width: 100%;
				/* box-shadow: 0 1px 5px 1px rgba(0, 0, 0, .2); */
				-webkit-box-shadow: 0 1px 6px 1px #ccc;
				box-shadow: 0 1px 6px 1px #ccc;
				height: 0;
				display: block;
				background: #0062CC;
				position: absolute;
				top: 0;
				left: 0;
				z-index: 9;
			}

			.team-select .mui-table-view {
				background: transparent;
			}

			.mui-table-view:before,
			.team-select .mui-table-view:after {
				height: 0;
			}

			.team-select .mui-table-view-cell {
				text-align: center;
			}

			.team-select .mui-table-view-cell.mui-active {
				background-color: #f2f2f2;
			}

			.team-select .mui-table-view-cell:after {
				left: 10px;
				right: 0;
				background-color: #F1F1F1;
			}

			.mui-backdrop {
				z-index: 9;
			}

			.team-list {
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 14px;
				position: relative;
				padding: 10px;
				background-color: #F9F9F9;
			}

			.team-list.active {
				color: #F5CA3A;
			}

			.team-list.active span {
				display: inline-flex;
				position: relative;
				font-size: 14px;
			}

			.team-list.active span:after {
				content: '';
				display: inline-block;
				width: 18px;
				height: 15px;
				position: absolute;
				background: url('../image/icon/draw-icono.png')center center no-repeat;
				background-size: contain;
				right: -25px;
			}

			.bottom-btn {
				position: absolute;
				bottom: 0;
				width: 100%;
				height: 44px;
				background-color: #FFFFFF;
				display: flex;
				align-items: center;
				justify-content: space-between;
				z-index: 10;
			}

			.bottom-btn:after {
				content: '';
				position: absolute;
				display: block;
				bottom: 0;
				width: 100%;
				height: 1px;
				background-color: #DDDDDD;
				transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
			}

			.bottom-btn div {
				width: 50%;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				position: relative;
				color: #333333;
				font-size: 0.3rem;
			}

			.mui-scroll-wrapper {
				bottom: 44px;
			}

			.bottom-btn .right-btn {
				color: #F5CA3A;
			}

			.bottom-btn .right-btn:before {
				content: '';
				position: absolute;
				display: block;
				bottom: 0;
				left: 0;
				width: 1px;
				height: 80%;
				background-color: #DDDDDD;
				transform: scaleX(0.5);
				-webkit-transform: scaleX(0.5);
			}

			.mui-bar {
				z-index: 1045;
				padding: 0;
			}
		</style>
		<script>
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
		</script>
	</head>

	<body>
		<div id="mui-content" v-cloak>
			<header class="mui-bar mui-bar-nav">
				<div style="display: flex;position: relative; padding: 0 10px; z-index: 1045; background: #F7F7F7; align-items: center ;height: 44px; width: 100%;justify-content: space-between;">
					<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
					<div class="mui-title choice-team" :class="[isSearch?'active':'']">
						<span id="team_name">{{teamName}}</span>
						<span class="mui-icon" :class="clsName"></span>
					</div>
					<div class="mui-input-row search-cont" :class="[isSearch?'active':'']"> 
						<form class="form-container" action="" onsumit="return false" >
							<span class="mui-icon mui-icon-search"></span>
							<input class="search-input" v-model="keyword" type="search" id="search" placeholder="输入团队名称">
							<span class="mui-icon mui-icon-clear" v-show="keyword" @tap="keyword=''"></span>
							<span class="cancel-btn">取消</span>
						</form>
					</div>
				</div>
				<!-- 下拉仓库选择 -->
				<div class="team-select" :class="teamShow?'active':''">
					<div class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view">
								<li class="mui-table-view-cell team-list" :class="c.is_default==1?'active':''" v-for="(c,i) in allTeam"
								 @tap="changeTeam(c,i)">
									<span>{{c.name}}</span>
								</li>
							</ul>
						</div>
					</div>
					<div class="bottom-btn">
						<div class="left-btn">取消</div>
						<div class="right-btn">确定</div>
					</div>
				</div>
			</header>

			<div class="mui-content team-list-container">
				<div class="my-join-team" v-if="joinFlag">
					<h2><i></i>正式团队</h2>
					<ul>
						<li class="team-list" v-for="(list, index) in joinList" :key="index">
							<!-- <img class="sign-tags" src="../image/icon/sign-tags-data-b.png" @tap="teamDetail(list.team_id,list.data_status,list.is_captain)"> -->
							<div class="inside">
								<i class="adorn"></i>
								<div class="inside-top" @tap="detail(list.team_id,list.type)">
									<div class="team-title">
										{{list.name}}
										<span class="mui-badge mui-badge-primary">
											<span class="iconfont icon-friends"></span>
											{{list.current_number}} 人
										</span>
									</div>
									<div class="time-person">
										<span class="rank-num">
											<img class="rank-sign" :src="'../image/icon/rank'+list.level+'.png'">
											<span v-if="list.level==0">佰级别收入</span>
											<span v-if="list.level==1">仟级别收入</span>
											<span v-if="list.level==2">萬级别收入</span>
											<span v-if="list.level==3">拾萬级别收入</span>
											<span v-if="list.level==4">佰萬级别收入</span>
											<span v-if="list.level==5">仟萬级别收入</span>
										</span>
										<span v-if="list.rank>0" class="rank-num">排名：{{list.rank}}</span>
										<span v-else class="rank-num">暂无排名</span>
										<span class="create-person">创建人：{{list.captain_name.name || list.captain_name.nickName}}</span>
									</div>
								</div>
								<div class="opction-cont">
									<div class="opction-btn" @tap="groupsChat(list.team_id, list.name,list.type)">
										<img src="../image/icon/team-list-opction02.png">
										<span>群聊</span>
									</div>
									<div class="opction-btn" @tap="courseList(list.team_id,list.is_captain)">
										<img src="../image/icon/team-list-opction03.png">
										<span>团队课程</span>
									</div>
									<div class="opction-btn" :class="list.data_status==0&&list.is_captain==0?'grayness':''" @tap="teamDetail(list.team_id,list.data_status,list.is_captain)">
										<img src="../image/icon/team-list-opction01.png">
										<span>数据</span>
									</div>
								</div>
							</div>
						</li>
					</ul>
				</div>
				<div class="my-team" v-if="createFlag">
					<h2><i></i>数据团队</h2>
					<ul>
						<li class="team-list" v-for="(list, index) in createList" :key="index">
							<!-- <img class="sign-tags" :src="list.data_status==1?'../image/icon/sign-tags-data-y.png':'../image/icon/sign-tags-detail-y.png'"
						 @tap="teamDetail(list.team_id,list.data_status,list.is_captain)"> -->
							<div class="inside">
								<i class="adorn"></i>
								<div class="inside-top" @tap="detail(list.team_id,list.type)">
									<div class="team-title">
										{{list.name}}
										<span class="mui-badge mui-badge-primary">
											<span class="iconfont icon-friends"></span>
											{{list.current_number}} 人
										</span>
									</div>
									<div class="time-person">
										<span class="create-time">创建时间：{{list.create_time}}</span>
										<span class="create-time">创建人：{{list.captain_name.name||list.captain_name.nickName}}</span>
									</div>
								</div>
								<div class="opction-cont">
									<div class="opction-btn" @tap="groupsChat(list.team_id, list.name,list.type)">
										<img src="../image/icon/team-list-opction02.png">
										<span>群聊</span>
									</div>
									<div class="opction-btn" @tap="teamDetail(list.team_id,list.data_status,list.is_captain)">
										<img src="../image/icon/team-list-opction01.png">
										<span>数据</span>
									</div>
								</div>
							</div>
						</li>
					</ul>
					<div v-else>
						暂未创建团队
					</div>
				</div>
				<div class="void-data-tips" v-if="void_seach">
					<img src="../image/icon/void-seach-result.png">
					<p>没有搜索到相关团队~</p>
				</div>
				<div class="operation-section" v-show="!isSearch">
					<span class="create-team">创建团队</span>
					<span class="join-team">加入团队</span>
				</div>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var team_list = [],
				teams = null,
				team_type = "",
				selsctName = '',
				mask = mui.createMask(function() {
					app.teamShow = false;
				});
			mui.init({
				swipeBack: true,
				beforeback: function() {
					var per = plus.webview.currentWebview().opener();
					if (per.id == "user") {
						setStatusBar('', 'light');
					}
				}
			});

			var userInfo = getUserInfo();
			var app = new Vue({
				el: '#mui-content',
				data: {
					createList: [],
					joinList: [],
					createFlag: false,
					joinFlag: false,
					teamLists: {},
					userSelf: "",
					clsName: 'mui-icon mui-icon-arrowdown',
					teamName: '旺客',
					keyword: '',
					isSearch: false,
					void_seach: false,
					// userSelf:userInfo.nickName
					teamShow: false,
					allTeam: [],
					currentId: '',
				},
				mounted: function() {
					mui.plusReady(function() {
						var self = plus.webview.currentWebview();
						getTeamList();
						getPersonTeam();
						mui('.mui-content').on('tap', '.create-team', function() {
							if (userInfo.group_id < 2) {
								message('您没有创建团队的权限!');
								return;
							}
							openPage('create_team.html', 'create_team', '#f7f7f7', '')
						})

						mui('.mui-content').on('tap', '.join-team', function() {
							openPage('join_team.html', 'join_team', '#f7f7f7', '')
						})
					})
					mui(".mui-scroll-wrapper").scroll().refresh();
				},
				methods: {
					// 团队详情
					detail: function(team_id, type) {
						// 1正式团队 2数据团队
						if (type == 1) {
							openPage('team_detail.html', 'team_detail', '#f7f7f7', {
								teamid: team_id
							});
						} else {
							openPage('other_team_detail.html', 'other_team_detail', '#f7f7f7', {
								teamid: team_id
							});
						}
					},
					teamDetail: function(team_id, data_status, is_captain) {
						if (data_status == 1 || is_captain == 1) {
							fnOpenWin('webview.html', 'webview', {
								statusbar: {
									background: '#FFFFFF'
								}
							}, {
								tid: team_id,
								title: '团队',
								statusBarStyle: 'dark',
								url: 'https://app.wangkeapp.cn/addons/wangke/dist?uniacid=6&id=' + team_id +
									'&m=wangke'
							}, 'slide-in-right');
						} else {
							// 不做跳转
						}
					},
					// 群聊
					groupsChat: function(id, name, type) {
						openPage('team_chat.html', 'team_chat', '#f7f7f7', {
							tid: id,
							teamName: name,
							teamType: type
						});
					},
					// 切换团队
					changeTeam: function(t,idx) {
						for(var i=0; i<app.allTeam.length;i++){
							if(app.allTeam[i].is_default==1){
								app.allTeam[i].is_default=0;
								break;
							}
						}
						app.allTeam[idx].is_default=1;
						app.currentId = t.team_id;
						selsctName = t.name;
					}
				}
			})

			// 获取团队列表
			function getTeamList() {
				mui.post($ajaxUrl + 'team&action=team_list', {
					token: userInfo.token,
					team_name: app.keyword
				}, function(res) {
					logs(res);
					if (res.errno == 0) {
						var teamList = res.data;
						var createList = new Array();
						var joinList = new Array();
						mui.each(teamList, function(index, item) {
							if (item.type == 2) {
								createList.push(item);
							} else {
								joinList.push(item);
							}
						});
						app.createList = createList;
						app.joinList = joinList;
						if (createList.length > 0) {
							app.createFlag = true;
						} else {
							app.createFlag = false;
						}
						if (joinList.length > 0) {
							app.joinFlag = true;
						} else {
							app.joinFlag = false;
						}
						app.void_seach = false;
					} else {
						if (app.keyword) {
							app.createFlag = false;
							app.joinFlag = false;
							app.void_seach = true;
						} else {
							app.void_seach = false;
						}
					}
				}, 'json');
			}
			window.addEventListener('refreshTeamList', function() {
				getTeamList();
			});

			// 课程列表
			function courseList(tid, role) {
				openPage('team_course_list.html', 'team_course_list', '#f7f7f7', {
					tid: tid,
					role: role
				});
			}
			//获取团队名称列表
			var teamchange = true;

			function getPersonTeam() {
				mui.post($ajaxUrl + 'team&action=personal_team_list', {
					token: userInfo.token,
				}, function(res) {
					logs(res); 
					if (res.errno == 0) {
						var data = res.data;
						if (data.length > 1) {
							app.allTeam = res.data;
							teamchange = true;
							for (var i = 0; i < data.length; i++) {
								if (data[i].is_default == 1) {
									app.teamName = data[i].name;
									app.currentId=data[i].team_id;
									break;
								}
							}
						} else if (data.length == 1 && data != "") {
							app.currentId=data[0].team_id;
							app.teamName = data[0].name;
							mui(".choice-team .mui-icon")[0].style.display = "none";
							teamchange = false;
						} else {
							app.teamName = "旺客"
							mui(".choice-team .mui-icon")[0].style.display = "none";
							teamchange = false;
						}
					} else {
						app.teamName = "旺客"
						mui(".choice-team .mui-icon")[0].style.display = "none";
						teamchange = false;
					}
				}, 'json');
			}
			//切换团队
			mui('.mui-bar').on('tap', '.choice-team', function() {
				if (!app.teamShow&&teamchange) {
					app.teamShow = true;
					mask.show();
				} else {
					mask.close();
				}
			})
			window.addEventListener('choiceName', function(e) {
				if (e.detail.names) {
					app.teamName = e.detail.names;
				}
				app.clsName = 'mui-icon mui-icon-arrowdown';
				mask.close();
			})
			// 点击搜索按钮
			mui(".mui-bar").on('tap', ".mui-icon-search", function() {
				app.isSearch = true;
				mui(".search-cont input")[0].focus();
			})
			// 点击取消
			mui(".mui-bar").on('tap', ".cancel-btn", function() {
				app.keyword = '';
				getTeamList();
				app.isSearch = false;
				mui(".search-cont input")[0].blur();
			})
			// 点击键盘的搜索
			document.getElementById("search").addEventListener("keypress", function(event) {
				if (event.keyCode == "13" && app.keyword != '') {
					document.activeElement.blur();
					getTeamList();
					event.preventDefault();
				} else {
					message("请输入团队名称！");
					event.preventDefault();
				}
			});
			// 切换团队
			function changeTeams(tid) {
				mui.post($ajaxUrl + 'team&action=set_default_team', {
					token: userInfo.token,
					team_id: app.currentId
				}, function(res) {
					if (res.errno == 0) {
						app.teamName = selsctName;
						logs("切换成功！");
					} else {
						message("切换失败，请稍后重试");
					}
				}, 'json');
			}
			// 取消团队选择
			mui(".mui-bar").on('tap', ".left-btn", function(e) {
				mask.close();
			})
			// 确认团队选择
			mui(".mui-bar").on('tap', ".right-btn", function(e) {
				mask.close();
				if(app.teamName == selsctName){
					return;
				}
				changeTeams();
			})
		</script>
	</body>

</html>
