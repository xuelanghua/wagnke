<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/swiper.min.css">
		<style type="text/css">
			.goods-images {
				width: 7.5rem;
				height: 7.5rem;
				background-color: #FFFFFF;
				position: relative;
				overflow: hidden;
			}

			.swiper-pagination {
				position: absolute;
				left: auto;
				right: 10px;
				bottom: 10px;
				background-color: rgba(0, 0, 0, 0.5);
				width: auto;
				display: inline-flex;
				align-items: baseline;
				justify-content: center;
				border-radius: 0.6rem;
				padding: 0 8px;
				color: #DDDDDD;
				z-index: 9;
				line-height: 1.2;
				font-size: 0.24rem;
			}

			.swiper-pagination-current {
				font-size: 16px;
			}

			.goods-images img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			.goods-title {
				padding-top: 0.2rem;
				overflow: hidden;
			}

			.goods-title p {
				margin-bottom: 0.2rem;
				font-size: 0.32rem;
				color: #333333;
				line-height: 1.4;
				text-align: justify;
			}

			.main-container {
				padding: 0.2rem;
				margin-bottom: 0.2rem;
				background-color: #FFFFFF;
			}

			.hot-sign {
				height: 0.28rem;
				width: auto;
				margin-right: 0.2rem;
			}

			.profit-cont {
				display: flex;
				align-items: center;
				justify-content: space-between;
				color: #F52E20;
				font-size: 0.3rem;
			}

			.price-cont {
				font-size: 0.24rem;
				color: #333333;
				padding: 0.2rem 0;
			}

			.price-cont span:last-of-type {
				color: #F4CA3A;
				margin-left: 1.03rem;
			}

			.top-info-cont {
				padding-top: 0.2rem;
				font-size: 0.24rem;
				color: #999999;
				display: flex;
				align-items: center;
				justify-content: space-between;
				position: relative;
			}

			.parameter-cont {
				margin-bottom: 10px;
				background-color: #FFFFFF;
			}

			.parameter-cont .mui-table-view-cell.mui-active {
				background-color: #FFFFFF;
			}

			.parameter-cont .mui-table-view:after,
			.parameter-cont .mui-table-view:before {
				height: 0;
			}

			.parameter-cont a {
				font-size: 0.3rem;
				color: #333333;
			}

			.parameter-cont .mui-table-view-cell.mui-collapse.mui-active a:before {
				position: absolute;
				right: 0.3rem;
				bottom: 0;
				left: 0.3rem;
				height: 1px;
				content: '';
				-webkit-transform: scaleY(.5);
				transform: scaleY(.5);
				background-color: #DDDDDD;
			}

			.parameter-list {
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding: 0.1rem 0;
			}

			.mui-table-view-cell.mui-collapse .mui-collapse-content {
				padding: 0;
			}

			.parameter-list:nth-of-type(even) {
				background-color: #f9f9f9;
			}

			.parameter-items {
				width: 17.5%;
				font-size: 0.24rem;
				color: #333333;
				text-align: center;
			}

			.parameter-items:first-of-type {
				width: 30%;
			}

			.team-name-cont {
				background-color: #FFFFFF;
				padding: 0.2rem;
				display: flex;
				align-items: center;
				margin: 0.2rem 0;
			}

			.team-name-cont img {
				width: 0.88rem;
				height: 0.88rem;
				border-radius: 0.1rem;
				object-fit: cover;
				margin-right: 0.4rem;
			}

			.team-name-cont .mui-icon {
				position: absolute;
				right: 0.2rem;
				color: #999999;
			}

			.goods-detail-container {
				background-color: #FFFFFF;
				padding: 0.2rem;
			}

			.goods-detail-container h4.title {
				font-size: 0.32rem;
				color: #333333;
				padding: 0.4rem 0 0.2rem;
				font-weight: normal;
				position: relative;
				display: flex;
				align-items: center;
			}

			.goods-detail-container h4.title:before {
				content: '';
				display: inline-block;
				position: relative;
				bottom: 0;
				left: 0;
				height: 0.3rem;
				width: 4px;
				margin-right: 5px;
				background-color: #333333;
			}

			.goods-detail-container img {
				max-width: 100% !important;
				height: auto;
			}

			.bottom-section {
				position: fixed;
				display: flex;
				align-items: center;
				z-index: 199;
				background-color: #FFFFFF;
				height: 1.09rem;
				bottom: 0;
				width: 100%;
				box-shadow: 1px 0 2px 0 rgba(220, 220, 220, .5);
			}

			.bottom-section .option-btn {
				color: #333333;
				height: 100%;
				display: inline-flex;
				align-items: center;
				position: relative;
				flex-grow: 1;
				font-size: 0.3rem;
				justify-content: center;
			}

			.bottom-section .option-btn:last-of-type:before {
				content: "";
				width: 1px;
				height: 0.5rem;
				background-color: #F2F2F2;
				position: absolute;
				left: 0;
				top: 0.255rem;
			}

			.bottom-section .option-btn img {
				height: 0.36rem;
				margin-right: 0.1rem;
				width: auto;
			}

			.btn-section {
				position: fixed;
				display: flex;
				align-items: center;
				z-index: 199;
				background-color: #FFFFFF;
				height: 1.09rem;
				bottom: 0;
				width: 100%;
				box-shadow: 1px 0 2px 0 rgba(220, 220, 220, .5);
			}

			.btn-section div {
				color: #333333;
				width: 100%;
				height: 100%;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				position: relative;
			}

			.btn-section .the-warehouse {
				color: #CC9C2D;
			}

			.btn-section .the-gray-warehouse {
				color: #a7a7a7;
			}

			.goods-detail-container img {
				line-height: 0;
				margin: -4px 0;
				padding: 0;
				max-width: 100% !important;
				height: auto;
			}

			.goods-detail-container img:first-of-type {
				margin-top: 0;
			}

			.goods-detail-container {
				padding-bottom: 1.3rem;
			}

			.goods-detail-container p {
				line-height: 1.4;
			}

			.goods-detail-container div {
				line-height: 1.8;
			}

			.nav-right-btn {
				height: 44px;
				position: relative;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 0 0.2rem;
				z-index: 16;
				font-size: 14px;
				color: #999999;
				margin-right: -10px;
			}

			.group-booking-rules {
				width: 100%;
				padding: 0 10px;
			}

			.group-booking-rules h4 {
				font-size: 0.3rem;
				margin: 0;
				font-weight: normal;
			}

			.group-booking-rules .mini-card {
				width: 100%;
				padding: 10px;
				box-sizing: border-box;
				background-color: #ffffff;
				border-radius: 10px;
				margin: 10px 0;
				overflow: hidden;
			}

			.mini-card-head {
				justify-content: space-between;
				font-size: 0.3rem;
				padding: 5px 0;
			}

			.mini-card-head img {
				height: 0.3rem;
				width: auto;
				margin-right: 3px;
			}

			.flex-center {
				display: flex;
				align-items: center;
			}

			.del-btn {
				margin-right: 0.3rem;
				padding-right: 0.3rem;
				position: relative;
			}

			.del-btn:after {
				content: "";
				width: 1px;
				height: 70%;
				background-color: #eaeaea;
				position: absolute;
				right: 0;
				top: 15%;
			}

			.mini-card-body {
				padding: 5px 0;
			}

			.mini-card-body .mui-badge {
				background-color: #bdbdbd;
				color: #FFFFFF;
				margin-right: 5px;
				font-size: 0.24rem;
			}

			.mini-card-head .price {
				color: #f52e20;
				margin-left: 10px;
			}

			.change-container {
				display: flex;
				align-items: center;
				justify-content: space-between;
				width: 100%;
				-webkit-transition: display 0.5s ease-in-out;
				transition: display 0.5s ease-in-out;
			}

			.order-type {
				width: 6.56rem;
				height: 1.1rem;
				border: 1px solid #000000;
				display: flex;
				align-items: center;
				justify-content: space-between;
				border-radius: 0.2rem;
				-webkit-transform: scale(0.5);
				transform: scale(0.5);
				overflow: hidden;
				margin: 0 auto;
				position: relative;
			}

			.order-type span {
				width: 50%;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				font-size: 0.56rem;
				color: #333333;
				height: 100%;
				background: rgba(0, 0, 0, 0);
				z-index: 3;
				-webkit-transition: all 0.0.3 s ease-in-out;
				transition: all 0.0.3 s ease-in-out;
			}

			.order-type .bg-full {
				position: absolute;
				left: 0;
				top: 0;
				height: 100%;
				width: 50%;
				background-color: #333333;
				z-index: 1;
				-webkit-transition: all 0.2s ease-in-out;
				transition: all 0.2s ease-in-out;
			}

			.order-type.active .bg-full {
				left: 50%;
			}

			.order-type .order-type-item:first-of-type,
			.order-type.active .order-type-item:last-of-type {
				color: #FFFFFF;
				-webkit-transition: all 0.2s ease-in-out;
				transition: all 0.2s ease-in-out;
			}

			.order-type.active .order-type-item:first-of-type {
				color: #333333;
				-webkit-transition: all 0.2s ease-in-out;
				transition: all 0.2s ease-in-out;
			}

			.mui-bar.mui-bar-nav {
				display: flex;
				align-items: center;
			}

			/* 选项卡二 */
			.last-container .goods-img {
				width: 0.96rem;
				height: 0.96rem;
				overflow: hidden;
				border-radius: 50%;
				margin-right: 10px;
				flex-shrink: 0;
			}

			.last-container .goods-img img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			.last-container .group-booking-rules {
				padding: 0;
			}

			.last-container {
				background-color: #FFFFFF;
			}

			.last-container .group-booking-rules .mini-card {
				border-radius: 0;
				background-color: #ffffff;
				position: relative;
				padding: 0.3rem 0 0.3rem 0.15rem;
				margin: 0;
			}

			.last-container .group-booking-rules .mini-card:after {
				content: "";
				width: 80%;
				height: 1px;
				background-color: #F2F2F2;
				position: absolute;
				bottom: 0;
				right: 0;
			}

			.last-container .group-status p {
				margin-bottom: 0;
				font-size: 0.3rem;
				padding-right: 0.15rem;
				box-sizing: border-box;
			}

			.last-container .group-status span {
				color: #f5ca3a;
			}

			.last-container .count-down {
				font-size: 0.24rem;
				color: #999999;
				margin-right: 0.1rem;
			}

			.last-container .mini-card-body {
				justify-content: space-between;
				line-height: 1;
			}

			.mui-bar-nav~.mui-content.white {
				min-height: 100vh;
				background-color: #FFFFFF;
				box-sizing: border-box;
				margin: 0;
			}

			[v-cloak] {
				display: none;
			}
		</style>
	</head>

	<body class="mui-plus mui-statusbar mui-statusbar-offset">
		<div id="mui-content" v-cloak>
			<!-- <header class="mui-bar mui-bar-nav">
				<span class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="position: absolute;"></span>
				<div class="change-container">
					<div class="order-type" :class="sales==2?'active':''">
						<i id="bg_full" class="bg-full"></i>
						<span class="order-type-item" data-order="1">产品详情</span>
						<span class="order-type-item" data-order="2">拼团情况</span>
					</div>
				</div>
			</header> -->
			<div class="mui-content" :class="sales==2?'white':''">
				<div v-show="sales==1">
					<div class="swiper-container goods-images">
						<div class="swiper-wrapper">
							<div class="swiper-slide" v-for="(img,i) in images">
								<img :data-idx="i" :src="img">
							</div>
						</div>
						<!-- Add Pagination -->
						<div class="swiper-pagination"></div>
					</div>
					<div class="top-container main-container">
						<div class="goods-title">
							<p>{{goods_detail.name}}</p>
						</div>
						<div class="profit-cont">
							<span>&yen;{{goods_detail.price}}</span>
							<img v-if="goods_detail.is_team_goods>0" class="hot-sign" src="../image/icon/distributor_goods_detail_mine_sign.png">
						</div>
						<div class="top-info-cont">
							<span v-if="goods_detail.is_team_goods>0">快递：{{goods_detail.express_name}}&nbsp;&nbsp;&yen;{{goods_detail.freight}}</span>
							<span>销量：{{goods_detail.sale_count}}</span>
							<span>浏览：{{goods_detail.view_count}}</span>
						</div>
					</div>
					<!-- 拼团规则 -->
					<div class="group-booking-rules" v-if="collage_list.length>0">
						<h4 class="title">拼团规则</h4>
						<div class="mini-card" v-for="(g,idx) in collage_list">
							<div class="mini-card-head flex-center">
								<div class="flex-center">
									<span>{{g.spe_title}}</span>
									<span class="price">&yen;{{g.price}}</span>
								</div>
								<div class="flex-center">
									<div class="flex-center del-btn" @tap="add_rule(g.id,'del',idx)">
										<img src="../image/icon/bottom-section-04.png" />
										<span>删除</span>
									</div>
									<div class="flex-center" @tap="add_rule(g)">
										<img src="../image/icon/bottom-section-01.png" />
										<pan>编辑</pan>
									</div>
								</div>
							</div>
							<div class="mini-card-body">
								<span class="mui-badge">每人{{g.number}}件起</span>
								<span class="mui-badge">{{g.people}}人拼团</span>
								<span class="mui-badge">{{g.expire_time}}小时</span>
							</div>
						</div>
					</div>
					<div class="parameter-cont" v-if="spec.length>0">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell mui-collapse">
								<a class="mui-navigate-right" href="#">查看规格</a>
								<div class="mui-collapse-content">
									<div class="parameter-list">
										<div class="parameter-items">规格</div>
										<div class="parameter-items">库存</div>
										<div class="parameter-items">供货价</div>
										<div class="parameter-items">售价</div>
										<div class="parameter-items">提成</div>
									</div>
									<div class="parameter-list" v-for="(c,idx) in spec">
										<div class="parameter-items">{{c.title}}</div>
										<div class="parameter-items">{{c.stock}}</div>
										<div class="parameter-items">{{c.settlement_price}}</div>
										<div class="parameter-items">{{c.price}}</div>
										<div class="parameter-items">{{c.commission}}</div>
									</div>
								</div>
							</li>
						</ul>
					</div>
					<div class="goods-detail-container">
						<h4 class="title">商品详情</h4>
						<div id="content" v-html="goods_detail.content"></div>
					</div>
					<div class="bottom-section">
						<div class="option-btn" @tap="add_rule">
							<img src="../image/icon/bottom-section-05.png" />
							<span>添加规则</span>
						</div>
						<div class="option-btn" @tap="delGroupBooking">
							<img src="../image/icon/bottom-section-04.png" />
							<span>删除拼团</span>
						</div>
					</div>
				</div>
				<div v-show="sales==2" class="last-container">
					<!-- 拼团规则 -->
					<div v-if="!order_status" class="group-booking-rules">
						<div class="mini-card  flex-center" v-for="(o,ix) in order_list" @tap="groupBooking(o.id)">
							<div class="goods-img">
								<img :src="o.initiator.avatar">
							</div>
							<div style="display: flex;flex-grow: 1;flex-direction: column;">
								<div class="mini-card-head flex-center">
									<div class="flex-center">
										<span>{{o.spe.title}}</span>
										<span class="price">&yen;{{o.price}}</span>
									</div>
									<div class="flex-center group-status">
										<p v-if="o.collage_status==1">还差<span>{{o.left_number}}人</span>成团</p>
										<p v-else-if="o.collage_status==2||o.collage_status==3"><span>已成团</span></p>
										<p v-else-if="o.collage_status==4">拼团失败</p>
									</div>
								</div>
								<div class="mini-card-body flex-center">
									<div>
										<span class="mui-badge">每人{{o.number}}件起</span>
										<span class="mui-badge">{{o.people}}人拼团</span>
									</div>
									<span class="count-down" v-if="o.collage_status==1">剩余 {{o.timer }}</span>
									<span class="count-down" v-else-if="o.collage_status==4">剩余 00:00</span>
								</div>
							</div>
						</div>
					</div>
					<div v-else class="mui-text-center">
						<img src="../image/icon/void-data.png" alt="" style="width: 50%;padding-top: 20%;">
						<p>暂无拼团~</p>
					</div>
				</div>
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/swiper.min.js"></script>
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo();
			var app = new Vue({
				el: "#mui-content",
				data: {
					goods_id: '',
					goods_detail: {
						name: ''
					},
					images: [],
					spec: [],
					sales: 1,
					collage_list: [],
					order_list: [],
					order_status: false
				},
				created: function() {
					// 初始化字体大小
					var viewport = document.documentElement.clientWidth;
					if (viewport > 750) {
						viewport = 750
					}
					document.documentElement.style.fontSize = viewport / 7.5 + "px";
					// 初始化字体大小结束	
				},
				methods: {
					// 拼团详情
					groupBooking: function(id) {
						openPage('group_booking_detail_card.html', 'group_booking_detail_card', '#f7f7f7', {
							collage_id: id
						})
					}
				},
				mounted: function() {
					mui.init({
						keyEventBind: {
							backbutton: false,
							menubutton: false
						}
					});
					var _self = this;
					mui.plusReady(function() {
						var self = plus.webview.currentWebview();
						app.goods_id = self.gid;
						getData();
						getOrderList();
						// 预览图片
						mui('.mui-content').on('tap', '.swiper-slide img', function() {
							var index = this.dataset.idx;
							plus.nativeUI.previewImage(app.images, {
								current: index,
								loop: true,
								indicator: 'default',
								onLongPress: function(event) {

								}
							});
						});
					})
					// 初始化两次防止页面乱
					var viewport = document.documentElement.clientWidth;
					if (viewport > 750) {
						viewport = 750
					}
					document.documentElement.style.fontSize = viewport / 7.5 + "px";
					// 初始化字体大小结束
				},
			})
			// 初始化轮播
			function swiperInint() {
				var swiper = new Swiper('.swiper-container', {
					loop: true,
					autoplay: {
						delay: 3000,
						stopOnLastSlide: false,
						disableOnInteraction: false,
					},
					pagination: {
						el: '.swiper-pagination',
						type: 'fraction',
					}
				});
			}
			// 添加规则 编辑规则
			function add_rule(rule, del, idx) {
				logs(rule);
				if (del) {
					plus.nativeUI.confirm("确认删除该规则？", function(e) {
						if (e.index == 1) {
							return false;
						}
						mui.post($ajaxUrl + 'marketing', {
							action: 'delete_collage',
							token: userInfo.token,
							collage_id: rule
						}, function(res) {
							// logs(res);
							if (res.errno == 0) {
								app.collage_list.splice(idx, 1);
								message("删除成功！");
								if (app.collage_list.length == 0) {
									mui.fire(plus.webview.getWebviewById('group_booking'), 'reloadMyself');
									mui.later(function() {
										mui.back();
									}, 1000);
								}
							} else {
								message(res.message);
							}
						}, 'json');
					})
					return false;
				}
				openPage('group_booking_create.html', 'group_booking_create', '#ffffff', {
					goods: app.goods_detail,
					rule: rule || false
				})
			}
			// 删除拼团
			function delGroupBooking() {
				plus.nativeUI.confirm("确认删除该拼团？", function(e) {
					if (e.index == 1) {
						return false;
					}
					mui.post($ajaxUrl + 'marketing', {
						action: 'delete_collage_all',
						token: userInfo.token,
						goods_id: app.goods_id
					}, function(res) {
						// logs(res);
						if (res.errno == 0) {
							message("删除成功！");
							mui.fire(plus.webview.getWebviewById('group_booking'), 'reloadMyself');
							mui.later(function() {
								mui.back();
							}, 1000)
						} else {
							message(res.message);
						}
					}, 'json');
				})
			}
			// 切换详情和拼团情况
			mui('.mui-bar').on('tap', '.order-type-item', function() {
				if (app.sales == 1) {
					app.sales = 2;
				} else {
					app.sales = 1;
				}
			})
			// 获取数据
			function getData() {
				mui.post($ajaxUrl + 'marketing&action=collage_goods_detail', {
					token: userInfo.token,
					goods_id: app.goods_id
				}, function(res) {
					// logs(res);
					if (res.errno == 0) {
						app.goods_detail = res.data;
						app.images = res.data.images;
						app.collage_list = res.data.collage_list;
						// logs(app.collage_list);
						if (app.images.length > 1) {
							setTimeout(function() {
								swiperInint();
							}, 500);
						}
					} else {

					}
				}, 'json');
			}
			// 拼团订单列表
			function getOrderList() {
				mui.post($ajaxUrl + 'marketing&action=collage_goods_order', {
					token: userInfo.token,
					goods_id: app.goods_id
				}, function(res) {
					// logs(res);
					if (res.errno == 0) {
						var lists = res.data;
						lists.map(function(obj, index) {
							app.$set(
								obj, "timer", InitTime(obj.end_time)
							);
						})
						app.order_list = lists;
						setInterval(function() {
							for (var key in app.order_list) {
								var aaa = parseInt(app.order_list[key]["end_time"]);
								var bbb = new Date().getTime();
								var rightTime = aaa - bbb;
								if (rightTime > 0) {
									var dd = fmt(Math.floor(rightTime / 1000 / 60 / 60 / 24));
									var hh = fmt(Math.floor((rightTime / 1000 / 60 / 60) % 24));
									var mm = fmt(Math.floor((rightTime / 1000 / 60) % 60));
									var ss = fmt(Math.floor((rightTime / 1000) % 60));
									var current_time = dd + "天" + hh + "小时" + mm + "分" + ss + "秒";
									app.order_list[key]["timer"] = current_time;
								} else {

								}
							}
						}, 1000);
					} else {
						// loser
						app.order_status = true;
					}
				}, 'json');
			}
			// 倒计时
			function InitTime(endtime) {
				var dd, hh, mm, ss = null;
				var time = parseInt(endtime) - new Date().getTime();
				if (time <= 0) {
					return '剩余 00:00'
				} else {
					var dd = fmt(Math.floor(time / 1000 / 60 / 60 / 24));
					var hh = fmt(Math.floor((time / 1000 / 60 / 60) % 24));
					var mm = fmt(Math.floor((time / 1000 / 60) % 60));
					var ss = fmt(Math.floor((time / 1000) % 60));
					var str = dd + "天" + hh + "小时" + mm + "分" + ss + "秒";
					return str;
				}
			}
			// 补位
			function fmt(n) {
				if (n < 10) {
					return '0' + n;
				} else {
					return n;
				}
			}
			window.addEventListener('reloadMyself', function() {
				getData();
			})
		</script>
	</body>
</html>
