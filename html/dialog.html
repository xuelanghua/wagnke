<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<title></title>
		<link rel="stylesheet" href="../css/mui.min.css" />
		<link rel="stylesheet" href="../css/mui.imageviewer.css" />
		<style>
			html,
			body {
				height: 100%;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
			}
			footer {
				position: fixed;
				width: 100%;
				height: 50px;
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				overflow: hidden;
				padding: 0px 50px;
				background-color: #fafafa;
			}
			.footer-left {
				position: absolute;
				width: 50px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 4px;
			}
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			.footer-center {
				height: 100%;
				padding: 5px 0px;
			}
			.footer-center [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			.footer-center .input-text {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				line-height: 18px !important;
				font-family: verdana !important;
				overflow: hidden;
				position:relative;
				z-index: 9999;
			}
			.footer-center .input-sound {
				background-color: #eee;
			}
			.mui-content {
				height: 100%;
				padding: 44px 0px 50px 0px;
				overflow: auto;
				background-color: #eaeaea;
			}
			#msg-list {
				height: 100%;
				overflow: auto;
				-webkit-overflow-scrolling: touch;
			}
			.msg-item {
				padding: 8px;
				clear: both;
			}
			.msg-item .mui-item-clear {
				clear: both;
			}
			.msg-item .msg-user {
				width: 38px;
				height: 38px;
				border: solid 1px #d3d3d3;
				display: inline-block;
				background: #fff;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				/* padding: 3px; */
				color: #ddd;
			}
			
			.msg-item .msg-user-img{
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				color: #ddd;
			}
			
			.msg-item .msg-content {
				display: inline-block;
				border-radius: 5px;
				border: solid 1px #d3d3d3;
				background-color: #FFFFFF;
				color: #333;
				padding: 8px;
				vertical-align: top;
				font-size: 15px;
				position: relative;
				margin: 0px 8px;
				max-width: 75%;
				min-width: 35px;
				float: left;
			}
			.msg-item .msg-content .msg-content-inner {
				overflow-x: hidden;
			}
			.msg-item .msg-content .msg-content-arrow {
				position: absolute;
				border: solid 1px #d3d3d3;
				border-right: none;
				border-top: none;
				background-color: #FFFFFF;
				width: 10px;
				height: 10px;
				left: -5px;
				top: 12px;
				-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);
			}
			.msg-item-self .msg-user,
			.msg-item-self .msg-content {
				float: right;
			}
			.msg-item-self .msg-content .msg-content-arrow {
				left: auto;
				right: -5px;
				-webkit-transform: rotateZ(225deg);
				transform: rotateZ(225deg);
			}
			.msg-item-self .msg-content,
			.msg-item-self .msg-content .msg-content-arrow {
				background-color: #4CD964;
				color: #fff;
				border-color: #2AC845;
			}
			footer .mui-icon {
				color: #000;
			}
			footer .mui-icon:active {
				color: #007AFF !important;
			}
			footer .mui-icon-paperplane:before {
				content: "发送";
			}
			footer .mui-icon-paperplane {
				/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}
			#msg-sound {
				-webkit-user-select: none !important;
				user-select: none !important;
			}
			.rprogress {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 140px;
				height: 140px;
				margin-left: -70px;
				margin-top: -70px;
				background-image: url(../images/arecord.png);
				background-repeat: no-repeat;
				background-position: center center;
				background-size: 30px 30px;
				background-color: rgba(0, 0, 0, 0.7);
				border-radius: 5px;
				display: none;
				-webkit-transition: .15s;
			}
			.rschedule {
				background-color: rgba(0, 0, 0, 0);
				border: 5px solid rgba(0, 183, 229, 0.9);
				opacity: .9;
				border-left: 5px solid rgba(0, 0, 0, 0);
				border-right: 5px solid rgba(0, 0, 0, 0);
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			.r-sigh{
				display: none;
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				text-align: center;
				line-height: 46px;
				font-size: 40px;
				font-weight: bold;
				color: #2187e7;
			}
			.rprogress-sigh{
				background-image: none !important;
			}
			.rprogress-sigh .rschedule{
				display: none !important;
			}
			.rprogress-sigh .r-sigh{
				display: block !important;
			}
			.rsalert {
				font-size: 12px;
				color: #bbb;
				text-align: center;
				position: absolute;
				border-radius: 5px;
				width: 130px;
				margin: 5px 5px;
				padding: 5px;
				left: 0px;
				bottom: 0px;
			}
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			#h {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				font-family: verdana !important;
				line-height: 18px !important;
				overflow: visible;
				position: absolute;
				left: -1000px;
				right: 0px;
				word-break: break-all;
				word-wrap: break-word;
			}
			.cancel {
				background-color: darkred;
			}
			.clear-chatting-records{
				display: none;
				height: 44px;
				width: 60px;
				z-index: 999;
				position: relative;
				/* background-color: #007AFF; */
				align-items: center;
				justify-content: center;
				margin-right: -15px;
			}
			.clear-chatting-records img{
				width: 20px;
				height: auto;
			}
			/* 清除聊天记录 */
			.join-team-verify {
				position: fixed;
				z-index: 996;
				top: 0;
				bottom: 0;
				width: 100%;
				background: rgba(0, 0, 0, 0.6);
				display: none;
				align-items: center;
				justify-content: center;
				flex-direction: column;
			}
			
			
			.verift-body {
				width: 80%;
				background-color: #ffffff;
				border-radius: 10px;
				position: relative;
				overflow: hidden;
				padding-top: 5px;
			}
			
			.verift-body .tips {
				width: 100%;
				padding: 20px 10px 15px;
				text-align: justify;
			}
			
			.verift-footer:before {
				content: '';
				display: block;
				height: 1px;
				width: 100%;
				top: 0;
				left: 0;
				position: absolute;
				background-color: #dddddd;
				transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
			}
			
			.verift-footer {
				position: relative;
				display: flex;
				justify-content: center;
			}
			
			.verift-footer .mui-btn {
				width: 100%;
				height: 100%;
				padding: 15px 10px;
			}
			
			.close-verify-window:before {
				content: '';
				display: block;
				height: 100%;
				width: 1PX;
				top: 0;
				bottom: 0;
				right: 0;
				position: absolute;
				background-color: #dddddd;
				transform: scaleX(0.5);
				-webkit-transform: scaleX(0.5);
			}
			/* 操作菜单样式 */
			.mui-backdrop.mui-active{
				background-color: rgba(0,0,0,0);
			}
			.mui-table-view:before,.mui-table-view:after{
				height: 0;
			}
			.mui-table-view-cell{
				font-size: 14px;
				color: #333333;
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.mui-table-view-cell:after{
				left: 0;
			}
			.mui-popover.mui-active{
				/* min-width: 90px; */
				box-shadow: 0 0 5px 0 rgba(0,0,0,0.1);
			}
			.mui-popover-arrow.mui-bottom{
				transform: translateX(-25%);
				-webkit-transform: translateX(-25%);
			}
			#inner-editor{
				position: absolute !important;
				z-index: -999 !important;
				display: none !important;
			}
			.mui-table-view-cell:after{
				background-color: #DDDDDD;
			}
			.del-btn,.copy-btn{
				display: block;
				min-width: 90px;
				text-align: center;
			}
			.red-dot{
				position: absolute;
				top: 1px;
				right: 1px;
				display: inline-block;
				border-radius: 50%;
				background-color: #FF0000;
				width: 6px;
				height: 6px;
			}
			
			.msg-item-self .red-dot{
				left: 1px;
				right: auto;
			}
		</style>
	</head>

	<body contextmenu="return false;">
		<header class="mui-bar mui-bar-nav">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<h1 class="mui-title" id="dialog_name">聊天</h1>
			<div class="clear-chatting-records mui-pull-right">
				<img src="../image/icon/clear-chatting-records-icon.png">
			</div>
		</header>
		<pre id="h"></pre>
		<script id="msg-template" type="text/template">
			<div class="msg-container" id="msg-container">
				<% var avatar = recordData.avatar, record = recordData.data; for(var index in record){ %>
					<div class="data-time" style="padding: 5px 0;text-align: center;font-size: 14px;color: #999;"><%= (index) %></div>
					<% for (var i in record[index]) { var item = record[index][i]; %>
					<div id="<%= ('parent'+item.message_id) %>" class="msg-item <%= (item.sender=='self'?' msg-item-self':'') %>" msg-type='<%=(item.type)%>' msg-content='<%=(item.content)%>' msg-index='<%=(index)%>' msg-idx='<%=(i)%>' msg-id='<%=(item.message_id)%>' msg-status='<%=(item.is_read)%>'>
						<% if(item.sender=='self' ) { %>
							<img class="msg-user-img msg-user my-chat-header"  src="<%= (avatar.user) %>" alt="" />
						<% } else { %>
							<img class="msg-user-img target-chat-header" src="<%= (avatar.target) %>"  alt="" />
						<% } %>
						<div class="msg-content"   msg-type='<%=(item.type)%>' msg-content='<%=(item.content)%>' msg-index='<%=(index)%>' msg-idx='<%=(i)%>' msg-id='<%=(item.message_id)%>' msg-status='<%=(item.is_read)%>' data-sender="<%=(item.sender) %>" data-types="<%=(item.type) %>" data-copytext="<%=( item.content|| '&nbsp;&nbsp;') %>" id="<%= ('message'+item.message_id) %>" data-tag="<%= (item.message_id) %>">
							<% if(item.type=='audio'&&item.is_read==0&&item.sender!='self') { %>
								<i class="<%=('red-dot red-dot'+item.message_id)%>"></i>
							<% } %>
							<div class="msg-content-inner">
								<% if(item.type=='text' ) { %>
									<%=( item.content|| '&nbsp;&nbsp;') %>
								<% } else if(item.type=='image' ) { %>
									<img class="msg-content-image" src="<%=(item.content)%>" style="max-width: 100px;" />
								<% } else if(item.type=='audio' ) { %>
									<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
									<span class="<%=('play-state play-state'+item.message_id)%>">点击播放</span>
								<% } %>
							</div>
							<div class="msg-content-arrow"></div>
						</div>
						<div class="mui-item-clear"></div>
					</div>
					<% } %>
				<% } %>
			</div>
		</script>
		<div class="mui-content">
			<div id="msg-list">
			</div>
		</div>
		<!-- 清除聊天记录确认弹窗 -->
		<div class="join-team-verify">
			<div class="verift-body">
				<div class="tips">
					<span>清除聊天记录后将无法找回，是否继续？</span>
				</div>
				<div class="verift-footer">
					<button type="button" class="mui-btn mui-btn-link close-verify-window">取消</button>
					<button type="button" class="mui-btn mui-btn-link send-verify">确定</button>
				</div>
			</div>
		</div>
		<!-- 操作菜单 -->
		<div id="middlePopover" class="mui-popover">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell copy-btn">复 制</li>
				<li class="mui-table-view-cell recall-btn">撤 回</li>
				<li class="mui-table-view-cell del-btn">删 除</li>
			</ul>
		</div>
		<footer>
			<div class="footer-left">
				<i id="msg-image" class="mui-icon mui-icon-camera" style="font-size: 28px;"></i>
			</div>
			<div class="footer-center">
				<textarea id="msg-text" type="text" class="input-text"></textarea>
				<button id="msg-sound" type="button" class="input-sound" style="display: none;">按住说话</button>
			</div>
			<label for="" class="footer-right">
				<i id="msg-type" class="mui-icon mui-icon-mic"></i>
				<!-- <i id="msg-type" class="mui-icon mui-icon-paperplane"></i> -->
			</label>
		</footer>
		<div id="sound-alert" class="rprogress">
			<div class="rschedule"></div>
			<div class="r-sigh">!</div>
			<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/upload.js"></script>
		<script src="../js/mui.imageViewer.js"></script>
		<script src="../js/arttmpl.js"></script>
		<script type="text/javascript" charset="utf-8">
			var MIN_SOUND_TIME = 800;
			mui.init({
				gestureConfig: {
					tap: true, //默认为true
					doubletap: true, //默认为false
					longtap: true, //默认为false
					swipe: true, //默认为true
					drag: true, //默认为true
					hold: true, //默认为false，不监听
					release: true //默认为false，不监听
				},
				beforeback: function() {
					mui.fire(plus.webview.getWebviewById('message'), 'refreshNotice');
					mui.fire(plus.webview.getWebviewById('H54F3E71F'), 'refreshNotice');
					plus.navigator.setStatusBarStyle(plus.webview.currentWebview().barStyle);
					cacheData('recorddata' + chatId, recordData);
				}
			});

			var chatId = 0;
			var chatAvatar = '';
			var userInfo = getUserInfo();
			var ws = null;
			var chatData = null;
			var skip = 1;
			var limit = 15;
			var recordData = {
				avatar: null,
				data: null
			};
			var lastIndex = '';
			var msgHeight = 0;
			var message_id = '';
			var sender = "1";
			var player = null;
			var playStatus = false;

			mui.plusReady(function() {
				//模板配置
				template.config('escape', false);
				if (mui.os.ios) {
					// 解决在ios上fixed元素focusin时位置出现错误的问题 
					document.addEventListener('DOMContentLoaded', function() {
						var footerDom = document.querySelector('footer');
						document.addEventListener('focusin', function() {
							footerDom.style.position = 'absolute';
						});
						document.addEventListener('focusout', function() {
							footerDom.style.position = 'fixed';
						});
					});
				}

				WebSocketInit();
				// scrollInit(); //滚动优化从scroll着手

				//滚动初始化
				function scrollInit() {
					mui('.mui-scroll-wrapper').scroll({
						scrollY: true, //是否竖向滚动
						scrollX: false, //是否横向滚动
						startX: 0, //初始化时滚动至x
						startY: 0, //初始化时滚动至y
						indicators: true, //是否显示滚动条
						deceleration: 0.0006, //阻尼系数,系数越小滑动越灵敏
						bounce: true //是否启用回弹
					});
				}

				var self = plus.webview.currentWebview();
				if (mui.os.ios) {
					self.setStyle({
						softinputMode: "adjustResize"
					});
				}

				var chatName = self.chatName;
				chatId = self.cid;
				chatAvatar = self.avatar;
				document.getElementById('dialog_name').innerText = chatName;
				var mod = getcache('recorddata' + chatId);
				if (mod) {
					recordData = mod;
				}
				// logs(mod);
				// logs(recordData);
				var avatar = {
					user: userInfo.avatarUrl,
					target: chatAvatar
				};
				recordData.avatar = avatar;
				chatData = {
					client_type: 'app',
					user_id: userInfo.id,
					target_id: chatId,
					type: 'text',
					content: '',
					uniacid: userInfo.uniacid
				};
				getRecordList(false);
				readMessage();

				document.addEventListener("pause", function() {
					heartCheck.reset();
				}, false);

				document.addEventListener("resume", function() {
					WebSocketInit();
				}, false);

				document.getElementById('msg-list').addEventListener('scroll', function(e) {
					var top = this.scrollTop;
					if (top < 100) {
						getRecordList(true);
					}
				}, false);

				var showKeyboard = function() {
					if (mui.os.ios) {
						var webView = plus.webview.currentWebview().nativeInstanceObject();
						webView.plusCallMethod({
							"setKeyboardDisplayRequiresUserAction": false
						});
					} else {
						var Context = plus.android.importClass("android.content.Context");
						var InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
						var main = plus.android.runtimeMainActivity();
						var imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
						imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
						//var view = ((ViewGroup)main.findViewById(android.R.id.content)).getChildAt(0);
						imm.showSoftInput(main.getWindow().getDecorView(), InputMethodManager.SHOW_IMPLICIT);
					}
				};

				var ui = {
					body: document.querySelector('body'),
					footer: document.querySelector('footer'),
					footerRight: document.querySelector('.footer-right'),
					footerLeft: document.querySelector('.footer-left'),
					btnMsgType: document.querySelector('#msg-type'),
					boxMsgText: document.querySelector('#msg-text'),
					boxMsgSound: document.querySelector('#msg-sound'),
					btnMsgImage: document.querySelector('#msg-image'),
					areaMsgList: document.querySelector('#msg-list'),
					boxSoundAlert: document.querySelector('#sound-alert'),
					h: document.querySelector('#h'),
					content: document.querySelector('.mui-content')
				};

				ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
				var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;
				// 标记语音已读 
				var priorId = null;
				var msgItemTap = function(msgItem, event) {
					var msgType = msgItem.getAttribute('msg-type');
					var msgContent = msgItem.getAttribute('msg-content');
					var aid = msgItem.getAttribute('msg-id');
					var status = msgItem.getAttribute('msg-status');
					var index = msgItem.getAttribute('msg-index');
					var idx = msgItem.getAttribute('msg-idx');
					if (msgType == 'audio') {
						var playState = document.querySelector(".play-state" + aid);
						var audios = document.querySelectorAll(".play-state");
						for (var i = audios.length - 1; i > -1; i--) {
							if (audios[i].innerText == '正在播放...') {
								audios[i].innerText = '点击播放';
								break;
							}
						}
						if (aid == priorId && player) {
							if (player) {
								player.stop();
								player.close();
								player = null;
								// logs(player);
							}
							playState.innerText = '点击播放';
						} else {
							if (player) {
								player.stop();
								player.close();
								player = null;
								// logs(player);
							}
							player = plus.audio.createPlayer(msgContent);
							playState.innerText = '正在播放...';
							priorId = aid;
							player.play(function() {
								player.stop();
								player.close();
								playState.innerText = '点击播放';
								player = null;
							}, function(e) {
								player.close();
								playState.innerText = '点击播放';
								player = null;
							});
						}
						if (status == 0) {
							mui.get($ajaxUrl + 'chat&action=play_audio', {
								token: userInfo.token,
								audio_id: aid
							}, function(res) {
								recordData.data[index][parseInt(idx)].is_read = "1";
								document.querySelector(".red-dot" + aid).style.display = "none";
							}, 'json');
						}
					}
				};

				var imageViewer = new mui.ImageViewer('.msg-content-image', {
					dbl: false
				});

				var bindMsgList = function() {
					ui.areaMsgList.innerHTML = template('msg-template', {
						"recordData": recordData
					});
					var msgItems = ui.areaMsgList.querySelectorAll('.msg-content');
					[].forEach.call(msgItems, function(item, index) {
						item.addEventListener('tap', function(event) {
							msgItemTap(item, event);
						}, false);
					});
					imageViewer.findAllImage();
					ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					// mui('.mui-scroll-wrapper').scroll().scrollToBottom();
				};

				bindMsgList();

				window.addEventListener('resize', function() {
					ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
				}, false);

				var send = function(msg) {
					recordData.data[lastIndex].push(msg);
					bindMsgList();
				};

				function msgTextFocus() {
					ui.boxMsgText.focus();
					setTimeout(function() {
						ui.boxMsgText.focus();
					}, 150);
				}

				//解决长按“发送”按钮，导致键盘关闭的问题；
				ui.footerRight.addEventListener('touchstart', function(event) {
					if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
						msgTextFocus();
						event.preventDefault();
					}
				});

				//解决长按“发送”按钮，导致键盘关闭的问题；
				ui.footerRight.addEventListener('touchmove', function(event) {
					if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
						msgTextFocus();
						event.preventDefault();
					}
				});
				ui.footerRight.addEventListener('touchcancel', function(event) {
					if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
						msgTextFocus();
						event.preventDefault();
					}
				});
				ui.footerRight.addEventListener('touchend', function(event) {
					if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
						msgTextFocus();
						event.preventDefault();
					}
				});

				ui.footerRight.addEventListener('release', function(event) {
					if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
						if (ui.boxMsgText.value.length == 0) {
							// message('发送内容不能为空!');
							return;
						}
						// showKeyboard();
						ui.boxMsgText.focus();
						setTimeout(function() {
							ui.boxMsgText.focus();
						}, 150);
						// send({
						// 	sender: 'self',
						// 	type: 'text',
						// 	content: ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '<br/>')
						// });
						chatData.content = ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '<br/>');
						chatData.type = 'text';
						ws.send(JSON.stringify(chatData)); //向服务器发送消息
						ui.boxMsgText.value = '';
						mui.trigger(ui.boxMsgText, 'input', null);
						// getRecordList();
					} else if (ui.btnMsgType.classList.contains('mui-icon-mic')) {
						ui.btnMsgType.classList.add('mui-icon-compose');
						ui.btnMsgType.classList.remove('mui-icon-mic');
						ui.boxMsgText.style.display = 'none';
						ui.boxMsgSound.style.display = 'block';
						ui.boxMsgText.blur();
						document.body.focus();
						// getRecordList();
					} else if (ui.btnMsgType.classList.contains('mui-icon-compose')) {
						ui.btnMsgType.classList.add('mui-icon-mic');
						ui.btnMsgType.classList.remove('mui-icon-compose');
						ui.boxMsgSound.style.display = 'none';
						ui.boxMsgText.style.display = 'block';
						// showKeyboard();
						ui.boxMsgText.focus();
						setTimeout(function() {
							ui.boxMsgText.focus();
						}, 150);
						// getRecordList();
					}
				}, false);

				ui.footerLeft.addEventListener('tap', function(event) {
					imageUpload(function(res) {
						// var imgMsg = {
						// 	sender: "self",
						// 	content: res.url,
						// 	type: "image"
						// }
						// send(imgMsg);
						chatData.type = 'image';
						chatData.content = res.url;
						ws.send(JSON.stringify(chatData));
					})
					//	var btnArray = [{
					//		title: "拍照"
					//	}, {
					//		title: "从相册选择"
					//	}];
					//	plus.nativeUI.actionSheet({
					//		title: "选择照片",
					//		cancel: "取消",
					//		buttons: btnArray
					//	}, function(e) {
					//		var index = e.index;
					//		switch (index) {
					//			case 0:
					//				break;
					//			case 1:
					//				var cmr = plus.camera.getCamera();
					//				cmr.captureImage(function(path) {
					//					send({
					//						sender: 'self',
					//						type: 'image',
					//						content: "file://" + plus.io.convertLocalFileSystemURL(path)
					//					});
					//				}, function(err) {});
					//				break;
					//			case 2:
					//				plus.gallery.pick(function(path) {
					//					send({
					//						sender: 'self',
					//						type: 'image',
					//						content: path
					//					});
					//				}, function(err) {}, null);
					//				break;
					//		}
					//	});
				}, false);

				var setSoundAlertVisable = function(show) {
					if (show) {
						ui.boxSoundAlert.style.display = 'block';
						ui.boxSoundAlert.style.opacity = 1;
					} else {
						ui.boxSoundAlert.style.opacity = 0;
						//fadeOut 完成再真正隐藏
						setTimeout(function() {
							ui.boxSoundAlert.style.display = 'none';
						}, 200);
					}
				};

				var recordCancel = false;
				var recorder = null;
				var audio_tips = document.getElementById("audio_tips");
				var startTimestamp = null;
				var stopTimestamp = null;
				var stopTimer = null;
				ui.boxMsgSound.addEventListener('hold', function(event) {
					recordCancel = false;
					if (stopTimer) clearTimeout(stopTimer);
					audio_tips.innerHTML = "手指上划，取消发送";
					ui.boxSoundAlert.classList.remove('rprogress-sigh');
					setSoundAlertVisable(true);
					recorder = plus.audio.getRecorder();
					if (recorder == null) {
						plus.nativeUI.toast("不能获取录音对象");
						return;
					}
					startTimestamp = (new Date()).getTime();
					recorder.record({
						filename: "_doc/audio/",
						format: "mp3"
					}, function(path) {
						if (recordCancel) return;
						voiceUpload(path);
						// send({
						// 	sender: 'self',
						// 	type: 'audio',
						// 	content: path
						// });
					}, function(e) {
						plus.nativeUI.toast("录音时出现异常: " + e.message);
					});
				}, false);

				ui.body.addEventListener('drag', function(event) {
					//console.log('drag');
					if (Math.abs(event.detail.deltaY) > 50) {
						if (!recordCancel) {
							recordCancel = true;
							if (!audio_tips.classList.contains("cancel")) {
								audio_tips.classList.add("cancel");
							}
							audio_tips.innerHTML = "松开手指，取消发送";
						}
					} else {
						if (recordCancel) {
							recordCancel = false;
							if (audio_tips.classList.contains("cancel")) {
								audio_tips.classList.remove("cancel");
							}
							audio_tips.innerHTML = "手指上划，取消发送";
						}
					}
				}, false);

				ui.boxMsgSound.addEventListener('release', function(event) {
					if (audio_tips.classList.contains("cancel")) {
						audio_tips.classList.remove("cancel");
						audio_tips.innerHTML = "手指上划，取消发送";
					}
					//
					stopTimestamp = (new Date()).getTime();
					if (stopTimestamp - startTimestamp < MIN_SOUND_TIME) {
						audio_tips.innerHTML = "录音时间太短";
						ui.boxSoundAlert.classList.add('rprogress-sigh');
						recordCancel = true;
						stopTimer = setTimeout(function() {
							setSoundAlertVisable(false);
						}, 800);
					} else {
						setSoundAlertVisable(false);
					}
					recorder.stop();
				}, false);
				ui.boxMsgSound.addEventListener("touchstart", function(e) {
					// console.log("start....");
					e.preventDefault();
				});
				ui.boxMsgText.addEventListener('input', function(event) {
					ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'remove' : 'add']('mui-icon-paperplane');
					ui.btnMsgType.setAttribute("for", ui.boxMsgText.value == '' ? '' : 'msg-text');
					ui.h.innerText = ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '\n-') || '-';
					ui.footer.style.height = (ui.h.offsetHeight + footerPadding) + 'px';
					ui.content.style.paddingBottom = ui.footer.style.height;
				});

				// var focus = false;
				// ui.boxMsgText.addEventListener('tap', function(event) {
				// 	ui.boxMsgText.focus();
				// 	setTimeout(function() {
				// 		ui.boxMsgText.focus();
				// 	}, 0);
				// 	focus = true;
				// 	setTimeout(function() {
				// 		focus = false;
				// 	}, 1000);
				// 	event.detail.gesture.preventDefault();
				// }, false);
				//点击消息列表，关闭键盘
				ui.areaMsgList.addEventListener('tap', function(event) {
					// if (!focus) {
					ui.boxMsgText.blur();
					// }
				})
				// 清除全部聊天记录
				mui('.join-team-verify').on("tap", ".send-verify", function() {
					// logs(userInfo.id);
					// logs(userInfo.token);
					mui.post($ajaxUrl + 'chat&action=delete_all', {
						token: userInfo.token,
						user_id: chatId
					}, function(res) {
						// logs(res);
						mui('.join-team-verify')[0].style.display = "none";
						if (res.errno == 0) {
							window.location.reload();
							getRecordList();
							message('已清除');
							document.querySelector('.clear-chatting-records').style.display = "none";
						} else {
							message('清除失败，请稍后重试');
						}
					}, 'json');
				})
				// 跳转ta到名片
				mui('.mui-content').on("tap", ".target-chat-header", function() {
					openPage('friends_detail.html', 'friends_detail', '#f7f7f7', {
						fid: chatId
					});
				})
				// 跳转到自己名片
				mui('.mui-content').on("tap", ".my-chat-header", function() {
					openPage('friends_detail.html', 'friends_detail', '#f7f7f7', {
						fid: userInfo.id
					});
				})
				// 删除单条聊天记录
				mui(".mui-popover").on("tap", ".del-btn", function() {
					mui.post($ajaxUrl + 'chat&action=delete', {
						token: userInfo.token,
						message_id: message_id
					}, function(res) {
						if (res.errno == 0) {
							var mols = document.getElementById('parent' + message_id).previousElementSibling;
							var brother = document.getElementById('parent' + message_id).nextElementSibling;
							var selfDom = document.getElementById('parent' + message_id);
							var mcls = mols.className;
							var bcls = '';
							if (brother) {
								bcls = brother.className;
							} else {
								bcls = 'data-time';
							}
							if (bcls == 'data-time' && mcls == 'data-time') {
								mols.parentNode.removeChild(mols);
								selfDom.parentNode.removeChild(selfDom);
							} else {
								selfDom.parentNode.removeChild(selfDom);
							}
							message('已删除');
							getRecordList();
						} else {
							message('删除失败，请稍后重试');
						}
					}, 'json');
					mui('#middlePopover').popover('hide');
				})
				// 聊天记录撤回
				mui(".mui-popover").on("tap", ".recall-btn", function() {
					// alert('撤回');
					mui.post($ajaxUrl + 'chat&action=cancel', {
						token: userInfo.token,
						message_id: message_id
					}, function(res) {
						// logs(res);
						if (res.errno == 0) {
							var mols = document.getElementById('parent' + message_id).previousElementSibling;
							var brother = document.getElementById('parent' + message_id).nextElementSibling;
							var selfDom = document.getElementById('parent' + message_id);
							var mcls = mols.className;
							var bcls = '';
							if (brother) {
								bcls = brother.className;
							} else {
								bcls = 'data-time';
							}
							if (bcls == 'data-time' && mcls == 'data-time') {
								mols.parentNode.removeChild(mols);
								selfDom.parentNode.removeChild(selfDom);
							} else {
								// selfDom.style.display="none";
								selfDom.parentNode.removeChild(selfDom);
							}
							message('撤回成功');
							getRecordList();
						} else if (res.errno == 2) {
							message("超过三分钟，无法撤回");
						} else {
							message(res.message);
						}
					}, 'json');
					mui('#middlePopover').popover('hide');
				})
				//获取聊天记录
				function getRecordList(loadMore) {
					if (loadMore) {
						skip++;
						limit = 6;
					} else {
						skip = 1;
						limit = 15;
					}
					mui.post($ajaxUrl + 'chat', {
						action: 'record_list',
						token: userInfo.token,
						user_id: userInfo.id,
						target_id: chatId,
						skip: skip,
						limit: limit
					}, function(res) {
						// logs(res);
						cacheData('recorddata' + chatId, res.data);
						if (res.errno == 0) {
							if (loadMore) {
								var moreData = res.data;
								var temp = recordData.data;
								Object.assign(moreData, temp);
								recordData.data = moreData;
								bindMsgList();
								ui.areaMsgList.scrollTop = 300;
							} else {
								recordData.data = [];
								recordData.data = res.data;
								for (var index in res.data) {
									lastIndex = index;
								}
								bindMsgList();
								// scrollInit();
							}
							document.querySelector('.clear-chatting-records').style.display = "inline-flex";
						} else {
							if (recordData.data == '') {
								document.querySelector('.clear-chatting-records').style.display = "none";
							}
							if (!loadMore) {
								recordData.data = [];
								recordData.data = res.data;
								for (var index in res.data) {
									lastIndex = index;
								}
							}
						}
					}, 'json');
				}

				var timer = 0
				//websocket 心跳检测
				var heartCheck = {
					timeout: 3e3,
					timeoutObj: null,
					serverTimeoutObj: null,
					reset: function() {
						clearTimeout(timer);
						clearTimeout(this.serverTimeoutObj);
						clearTimeout(this.timeoutObj);
						// console.log("heartCheck.reset.timer");
						return;
					},
					start: function() {
						this.timeoutObj = setTimeout(function() {
							var t = {
								ping: !0,
								user_id: userInfo.id,
								target_id: chatId
							};
							// logs(t);
							ws.send(JSON.stringify(t));
						}, this.timeout);
					},

				};

				//socket初始化
				function WebSocketInit() {
					if ("WebSocket" in window) {
						// 打开一个 web socket
						ws = new WebSocket("wss://app.wangkeapp.cn/wss");
						ws.onopen = function() {
							if (ws.readyState == WebSocket.OPEN) {
								// console.log("连接已打开...");
								heartCheck.reset();
								heartCheck.start();
							}
						};
						ws.onmessage = function(event) {
							var data = event.data;
							if (data == 'pong') {
								// console.log('websocket连接正常...');
								heartCheck.reset();
								heartCheck.start();
							} else {
								data = JSON.parse(data);
								logs(data);
								if (data.data2) {
									if (data.data2.user_id == chatId) {
										logs(data);
										var message = {
											sender: chatId,
											type: data.data2.message_type,
											content: data.data2.content,
											message_id: data.message_id,
											is_read: 0,
										}
										send(message);
									}
								}
								if (data.data) {
									if (data.data.user_id == userInfo.id) {
										var message = {
											sender: "self",
											type: data.data.message_type,
											content: data.data.content,
											message_id: data.data.id,
											is_read: 1,
										}
										send(message);
									}
								}
								if (data.data) {
									if (data.data.user_id == userInfo.id) {
										var message = {
											sender: "self",
											type: data.data.message_type,
											content: data.data.content,
											message_id: data.data.id,
											is_read: 1,
										}
										send(message);
									} else {
										mui.post($ajaxUrl + 'chat&action=unread_message', {
											token: userInfo.token,
											message_id: data.data2.id
										}, function(res) {
											if (res.errno == 0) {
												// mui.fire(plus.webview.getWebviewById('chat'), 'refreshNotice');
												// mui.fire(plus.webview.getWebviewById('home'), 'refreshNotice');
												// mui.fire(plus.webview.getWebviewById('user'), 'refreshNotice');
												// mui.fire(plus.webview.getWebviewById('message'), 'refreshNotice');
											}
										}, 'json')
									}
								}
							}
						};
						ws.onclose = function(e) {
							// 关闭 websocket
							console.log("连接已关闭...");
						};
						ws.onerror = function(e) {
							logs(e);
						}
					} else {
						message("您的手机不支持 WebSocket!");
					}
				}

				//文件上传
				function voiceUpload(file) {
					var task = plus.uploader.createUpload($voiceUrl, {
							method: "POST",
							blocksize: 614400,
							priority: 100
						},
						function(t, status) { //上传完成
							if (status == 200) {
								var res = JSON.parse(t.responseText);
								if (res.errno == 1) {
									message(res.message);
								} else {
									// 									var imgMsg = {
									// 										sender: "self",
									// 										content: res.data.path,
									// 										type: "audio",
									// 
									// 									}
									// 									send(imgMsg);
									chatData.type = 'audio';
									chatData.content = res.data.path;
									ws.send(JSON.stringify(chatData));
									// getRecordList();
									// message("上传成功");
								}
							} else {
								message('发送失败!');
								// console.log("上传失败：" + status);
							}
						}
					);
					// 页面中要上传的 图片路径
					task.addFile(file, {
						key: 'upfile'
					});
					task.start();
				}


				//修改当前聊天消息状态
				function readMessage() {
					mui.post($ajaxUrl + 'chat', {
						action: 'read_message',
						user_id: chatId,
						token: userInfo.token
					}, function(res) {
						if (res.errno == 0) {
							mui.fire(plus.webview.getWebviewById('chat'), 'refreshNotice');
							mui.fire(plus.webview.getWebviewById('home'), 'refreshNotice');
							mui.fire(plus.webview.getWebviewById('user'), 'refreshNotice');
							mui.fire(plus.webview.getWebviewById('message'), 'refreshNotice');
						}
					}, 'json');
				}
				// 长按保存图片咯
				mui(".mui-imageviewer").on("longtap", "img", function() {
					var urls = this.src;
					plus.nativeUI.confirm("保存图片到系统相册", function(e) {
						if (e.index == 0) {
							showload('', '', '保存中···', 'rgba(0,0,0,0.5)');
							plus.gallery.save(urls, function() {
								showload(1);
								plus.nativeUI.toast("保存成功!");
							}, function() {
								showload(1);
								plus.nativeUI.toast("保存失败!");
							});
						} else {
							//plus.nativeUI.toast("取消");
						}
					});
				})
			});

			// 长按显示操作菜单
			var copytext = '';
			var types = '';
			var isFocus = null;
			// 获取原来的高度
			var oglHeight = document.querySelector("body").offsetHeight;
			//显示操作菜单
			mui('.mui-content').on("longtap", ".msg-content", function() {
				// 获取高度
				copytext = this.dataset.copytext;
				types = this.dataset.types;
				sender = this.dataset.sender;
				message_id = this.dataset.tag;
				var tempHeight = document.querySelector("body").offsetHeight;
				// 高度差
				var gap = oglHeight - tempHeight;

				if (types == "text") {
					document.querySelector(".copy-btn").style.display = "flex";
				} else {
					document.querySelector(".copy-btn").style.display = "none";
				}

				if (sender == "self") {
					document.querySelector(".recall-btn").style.display = "flex";
				} else {
					document.querySelector(".recall-btn").style.display = "none";
				}

				if (gap < 55) {
					mui('#middlePopover').popover('hide');
					mui("#middlePopover").popover('toggle', document.getElementById(this.id));
				} else {
					// var input = document.getElementById("msg-text");
					// input.focus();
					// mui("#middlePopover").popover('toggle', document.getElementById(this.id));
					plus.key.hideSoftKeybord();
					// message('再按一次哟~','center');
				}
			})

			// 复制单条聊天记录
			mui(".mui-popover").on("tap", ".copy-btn", function() {
				//判断是安卓还是ios
				if (mui.os.ios) {
					//ios
					var UIPasteboard = plus.ios.importClass("UIPasteboard");
					var generalPasteboard = UIPasteboard.generalPasteboard();
					//设置/获取文本内容:
					generalPasteboard.plusCallMethod({
						setValue: copytext,
						forPasteboardType: "public.utf8-plain-text"
					});
					generalPasteboard.plusCallMethod({
						valueForPasteboardType: "public.utf8-plain-text"
					});
					message("复制成功");
				} else {
					//安卓
					var context = plus.android.importClass("android.content.Context");
					var main = plus.android.runtimeMainActivity();
					var clip = main.getSystemService(context.CLIPBOARD_SERVICE);
					plus.android.invoke(clip, "setText", copytext);
					message("复制成功");
				}
				mui('#middlePopover').popover('hide');
			})

			// 显示清除消息弹窗
			mui('.mui-bar-nav').on("tap", ".clear-chatting-records", function() {
				mui('.join-team-verify')[0].style.display = "flex";
				var input = document.getElementById("msg-text");
				input.blur();
			})
			// 取消清除聊天记录
			mui('.join-team-verify').on("tap", ".close-verify-window", function() {
				mui('.join-team-verify')[0].style.display = "none";
			})
			// 标记语音已读
			function readAudio(aid, status, index, idx) {
				if (status == 0) {
					mui.get($ajaxUrl + 'chat&action=play_audio', {
						token: userInfo.token,
						audio_id: aid
					}, function(res) {
						recordData.data[index][parseInt(idx)].is_read = "1";
						document.querySelector(".red-dot" + aid).style.display = "none";
					}, 'json');
				}
			}
		</script>
	</body>
</html>
