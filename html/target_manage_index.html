<!DOCTYPE html>
<!-- 我的目标页面 -->
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<style>
			.clearfix{
				clear: both;
			}
			.mui-bar,body,.mui-content{
				background-color: #FFFFFF;
			}
			.title img{
				width: 100%;
				height: 210px;
			}
			.title_content{
				font-size: 13px;
				width: 80%;
				color: #FFFFFF;
				margin: -43% auto 0;
			}
			
			.target{
				padding: 23px 10px 27px 10px;
				margin: 0 10px 20px;
				font-size: 15px;
				border-radius: 5px;
				box-shadow: 0 0 15px 0 #DDDDDD;
			}
			.target input{
				font-size: 14px;
				margin: 15px 0;
				border: none;
				border-radius: 5px;
				background-color: #F5F5F5;
			}
			.hold_down{
				width: 48%;
				color: #2798FE;
				border: 1px solid #2798FE;
				display: block;
				font-size: 14px;
				border-radius: 5px;
				padding: 7px 0;
				background-color: #EDF5FF;
			}
			.voice{
				width: 48%;
				padding: 1px 10px;
				border-radius: 5px;
				background-color: #F5F5F5;
			}
			.voice img{
				width: 20px;
				height: 20px;
				margin-top: 7px;
			}
			
			.voiceR{
				font-size: 12px;
			}
			
			.voiceR p{
				width: 6px;
				height: 6px;
				margin-bottom: 2px;
				margin-top: 5px;
				background-color: #F21515;
				border-radius: 50%;
			}
			
			/* 录音 */
			.showArea{
				width:120px;
				height:120px;
				background-color:#999999;
				font-size:15px;
				position: fixed;
				bottom: 55%;
				left: 35%;
				color: #FFFFFF;
				border-radius: 5px;
				display: none;
				text-align: center;
			}
			.showArea img{
				width: 80px;
				display: block;
				margin: 0 auto;
			}
			
			.target_date{
				width: 100%;
				font-size: 15px;
				margin: 15px 0;
				border: none;
				color: #999999;
				border-radius: 5px;
				padding: 11px 10px;
				background-color: #F5F5F5;
			}
			.target_date .mui-icon{
				font-size: 18px;
			}
			
			.next_step{
				margin: 30px 10px;
			}
			.next_step button{
				background-color: #2489FF;
				width: 100%;
				border: none;
				color: #FFFFFF;
				border-radius: 5px;
				padding: 17px 0;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">目标设定</h1>
		</header>
		<div class="mui-content">
			<div class="title">
				<img src="../image/target/goal_seting1b.png">
				<div class="title_content">
					成功的唯一秘诀就是持之以恒，不忘初心的完成自己设定的目标，如果遇到困难也不要怕，俗话说的好你的能力不足以支撑你的梦想的时候，就静下来学习吧。营销码为您提供了商业课程，让你快速学习如何获客成交、演讲、变现。 </div>
			</div>
			<div style="margin-top: 100px;">
				<div class="target">
					<div>大声告诉我你的目标是什么</div>
					<input type="text" placeholder="输入内容" />
					<div class="sound_recording">
						<button id="touchArea" class="hold_down mui-pull-left">开始录音，按住说话</button>
						<div class="voice mui-pull-right" onclick="play_record();">
							<input type="hidden" name="voice" value="" />
							<img class="mui-pull-left" src="../image/target/sound_recording.png">
							<div class="voiceR mui-pull-right">
								<p></p>
								<div>9</div>
							</div>
							<div class="clearfix"></div>
						</div>
						<div class="clearfix"></div>
					</div>
				</div>
				<div class="target">
					<div>这些目标需要多少钱可以实现</div>
					<input type="text" placeholder="输入金额" />
				</div>
				<div class="target">
					<div>目标说明</div>
					<input type="text" placeholder="输入内容" />
				</div>
				<div class="target">
					<div>实现目标需要多少时间</div>
					<button class="target_date">
						<div class="mui-pull-left">选择时间</div>
						<div class="mui-icon mui-icon-arrowright mui-pull-right"></div>
						<div class="clearfix"></div>
					</button>
				</div>
			</div>
			<div class="next_step" id="next_step_container">
				<a id="next_step">
					<button>下一步</button>
				</a>
			</div>
			<div class="showArea">
				<img src="../image/luyin.gif">
				<div>松开结束录音</div>
				<!-- <p style="text-align: center; color: white;"><span id="record_sec">1</span>秒</p> -->
			</div>
		</div>
	</body>
</html>
<script src="../js/upload.js"></script>
<script src="../js/mui.js"></script>
<!-- <script src="../js/jquery-1.11.0.min.js"></script> -->
<script src="../js/Zepto.min.js"></script>
<script src="../js/util.js"></script>
<script src="../js/mui.js"></script>
<script src="../js/mui.zoom.js"></script>
<script src="../js/mui.previewimage.js"></script>
<script>
	//初始化页面 对页面进行相关的设置
	mui.init({
		swipeBack: true
	});
	//获取用户信息
	var userInfo = getUserInfo();
	//获取时间
	var date = formatDate('y-m-d', '');
	//mui框架加载完成后进行什么操作
	mui.plusReady(function() {
		//检查该用户是否设定个人目标
		check_user_target_state();
	});
	mui('#next_step_container').on('tap', '#next_step', function() {
		// 		fnOpenWin('target_manage_detail.html', 'target_manage_detail', {
		// 			statusbar: {
		// 				background: '#FFF'
		// 			}
		// 		}, '', 'slide-in-right');
		mui.openWindow({
			url: "target_manage_detail.html",
			id: "target_manage_detail",
			createNew: false, //是否重复创建同样id的webview，默认为false:不重复创建，直接显示
			show: {
				autoShow: true, //页面loaded事件发生后自动显示，默认为true
			},
			styles: {
				statusbar: {
					background: '#FFF'
				}
			},
			waiting: {
				autoShow: true, //自动显示等待框，默认为true
				title: '正在加载...', //等待对话框上显示的提示内容
			},
		});
	});
	var url = $ajaxUrl + "target";
	//
	function check_user_target_state() {
		var userInfo = getUserInfo();
		mui.post($ajaxUrl + 'target', {
			action: 'check_user_target_state',
			token: userInfo.token
		}, function(res) {
			console.log(JSON.stringify(res));
		});
	}
</script>
<script type="text/javascript">
	//初始化录音对象
	var r = null;
	//
	//初始化计时器
	var timeOutEvent = 0;
	//
	$(function() {
		$(document).click(function() {
			$(".showArea").css("display", "none");
		})
		//录音键的页面交互触发块
		$("#touchArea").on({
			touchstart: function(e) {
				//触摸开始 获取录音对象
				start_record();
				window.setTimeout("longPress()", 100);
				window.setInterval(function() { 
					timeOutEvent = timeOutEvent++;
					$('#record_sec').html(timeOutEvent);
				}, 1000);
				// e.preventDefault();
				return false;
			},
			touchmove: function() {
				// clearTimeout(timeOutEvent);
				// timeOutEvent = 0; 
			},
			touchend: function(e) {
				clearTimeout(timeOutEvent);
				ShortLeave();
				e.preventDefault();
				stopRecord()
				return false;
			}
		})
	});

	function longPress() {
		
		$(".showArea").css("display", "block");
		//触摸开始
	}

	function ShortLeave() {
		timeOutEvent = 0;
		$(".showArea").css("display", "none");
	}
	/**
	 * 录音的方法
	 */
	function start_record() {
		//创建录音对象
		r = plus.audio.getRecorder();
		//检查录音对象
		if (r == null) {
			message("Device not ready!");
			return;
		}
		//调用录音对象录音
		r.record({
			filename: "_doc/audio/",
			format: 'mp3'
		}, function(e) {
			console.log(JSON.stringify(e));
			//回调函数返回录音对象
			//将但会的对象传给文件上传方法
			voiceUpload(e);
		}, function(e) {
			message("Audio record failed: " + e.message);
		});
	}
	/**
	 * 结束录音
	 */
	function stopRecord() {
		// clearInterval(timer);
		r.stop();
	}
	/**
	 * 文件上传
	 */
	function voiceUpload(file) {
		console.log('开始上传');
		plus.nativeUI.showWaiting();
		//创建文件上传对象
		var task = plus.uploader.createUpload($voiceUrl, {
			method: "POST",
			blocksize: 614400,
			priority: 100
		}, function(t, status) { //上传完成
			if (status == 200) {
				var res = JSON.parse(t.responseText);
				if (res.error) {
					plus.nativeUI.alert(res.error.message, waiting.close(), '提示', 'OK');
				} else {
					//设置相关的input 将上传成功的音频的地址赋值给value
					document.querySelector('input[name=voice]').value = res.data.path;
					message("上传完成");
				}
			} else {
				console.log("上传失败：" + status);
				plus.nativeUI.alert('上传失败!', waiting.close(), '提示', 'OK');
			}
		});
		//关闭等待框
		plus.nativeUI.closeWaiting();
		// 页面中要上传的 图片路径
		task.addFile(file, {
			key: 'upfile'
		});
		//开始上传
		task.start();
	}
	/**
	 * 点击播放按钮的方法
	 */
	function play_record() {
		console.log('播放');
		//获取到隐藏的input中的value 
		var rec_path = document.querySelector('input[name=voice]').value;
		if (rec_path == '') {
			message("你还没有录制哦");
			return false;
		}
		console.log(rec_path);
		//先清除之前遗留下来的播放对象
		$('audio').remove();
		// 创建htnl音频播放对象
		var audio = document.createElement("audio");
		audio.src = rec_path;
		audio.play();
	}
</script>
