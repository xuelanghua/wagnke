<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title></title>
		<link rel="stylesheet" href="../css/mui.min.css">
		<style type="text/css">
			html,
			body {
				height: 100%;
			}

			.mui-bar {
				background-color: #FFFFFF;
			}

			.mui-content {
				height: 100% !important;
				/* padding-top: 60% !important; */
			}

			.location-list {
				position: absolute;
				top: 60%;
				background-color: #FFFFFF;
				height: 40%;
				width: 100%;
				overflow-x: hidden;
				overflow-y: scroll;
			}

			.mui-table-view:after {
				opacity: 0.6;
				left: 15px;
			}

			.mui-table-view-cell {
				position: relative;
			}

			.mui-icon-checkmarkempty {
				position: absolute;
				right: 10px;
				top: 0;
				font-size: 42px;
				color: #2289FF;
				/* background-color: #007AFF; */
			}

			#bmap {
				width: 100%;
				height: 60%;
			}

			[v-cloak] {
				display: none;
			}
		</style>
	</head>
	<body>
		<div class="mui-content" id="mui_content" v-cloak>
			<div id="bmap">
			</div>
			<div class="location-list">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell" v-for="(items,index) in 8" :key="index" @tap="checkLocation(index)">
						地址{{index}}
						<span class="mui-icon mui-icon-checkmarkempty" v-show="checkIndex==index"></span>
					</li>
				</ul>
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var bMap = null;
			var bMarker = null;
			var bPoint = null;
			var bSearch = null;
			var longitude = '';
			var latitude = '';
			var app = new Vue({
				el: '#mui_content',
				data: {
					checkIndex: 0
				},
				methods: {
					checkLocation: function(idx) {
						this.checkIndex = idx;
					}
				},
				mounted() {
					var pullDirection = null,
						skip = 1;
					mui.init({
						gestureConfig: {
							tap: true,
							doubletap: true,
							longtap: true,
							swipe: true,
							drag: true,
							hold: false,
							release: false
						},
						pullRefresh: {
							container: ".location-list",
							up: {
								height: 50,
								auto: false,
								contentrefresh: "正在加载...",
								contentnomore: '没有更多数据了',
								callback: function() {
									pullDirection = "up";
									skip += 1;
									setTimeout(function() {
										mui('.location-list').pullRefresh().endPullupToRefresh(false);
									}, 1500);
								}
							}
						}
					});
					mui.plusReady(function() {
						var ws = plus.webview.currentWebview();
						var mapsBtns = plus.webview.create("map_btns.html", "map_btns", {
							top: '50px',
							left: '50px',
							width: '100px',
							height: '45px',
							scrollIndicator: 'none',
							background: 'transparent'
						});
						ws.append(mapsBtns);
						createMap();
					})
				}
			})
			
			//创建地图
			function createMap() {
				bMap = new plus.maps.Map("bmap", {
					top: '0',
					left: '0',
					width: '100%',
					height: '60%',
					position: 'static',
					zoom: 15
				});
				getCurrentLocation();
				bMap.onstatuschanged = function(e) {
					logs(e.center);
					var center = e.center;
					clearOverlays();
					createOverlay(createMarker(createPoint(center.longitude, center.latitude), "../image/choice_address.png"));
					searchNearby(center.longitude, center.latitude);
				}
			}
			
			//获取当前位置
			function getCurrentLocation() {
				bMap.getUserLocation(function(state, point) {
					longitude = point.longitude;
					latitude = point.latitude;
					bMap.centerAndZoom(createPoint(longitude, latitude), 15);
					clearOverlays();
					createOverlay(createMarker(createPoint(longitude, latitude), "../image/choice_address.png"));
					searchNearby(longitude, latitude);
				})
			}
			
			//创建覆盖物
			function createMarker(point, icon) {
				if (!bMarker) {
					bMarker = new plus.maps.Marker(point);
				} else {
					bMarker.setPoint(point);
				}
				bMarker.setIcon(icon);
				return bMarker;
			}
			
			//创建地图点
			function createPoint(lng, lat) {
				if (!bPoint) {
					bPoint = new plus.maps.Point(lng, lat);
				} else {
					bPoint.setLng(lng);
					bPoint.setLat(lat);
				}
				return bPoint;
			}
			
			//添加覆盖物
			function createOverlay(marker) {
				setTimeout(function() {
					bMap.addOverlay(marker);
				}, 100)
			}
			
			//清除覆盖物
			function clearOverlays() {
				bMap.clearOverlays();
			}
			
			//搜索附近点
			function searchNearby(lng, lat) {
				if (!bSearch) {
					bSearch = new plus.maps.Search(bMap);
						bSearch.onPoiSearchComplete = function(state, result){
							if ( state == 0 ) {
								if ( result.currentNumber <= 0 ) {
									logs( "没有检索到结果" );
								}
								// logs(result);
								for(var i=0; i < result.currentNumber; i++){
									var pos = result.getPosition(i);
									logs(pos);
								}
							} else {
								logs('检索失败!');
							}
						}
				}
				bSearch.poiSearchNearBy("超市", createPoint(lng, lat), 1000);
			}
		</script>
	</body>
</html>
