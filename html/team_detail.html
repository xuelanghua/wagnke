<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>团队详情</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<style type="text/css">
			.team-detail-header {
				height: 3.97rem;
				/* background: #ffffff url("../image/team-detail-img01.jpg")center top no-repeat; */
				background: #ffffff;
				background-size: contain;
				padding: 0.6rem 0.3rem 0;
				color: #ffffff;
				font-size: 0.4rem;
				position: relative;
				overflow: hidden;
			}

			.team-detail-header .team-bgimg {
				width: 100%;
				position: absolute;
				top: 0;
				left: 0;
				z-index: 1;
			}

			.team-desc {
				z-index: 2;
				position: relative;
			}

			.team-number {
				font-size: 0.24rem;
				color: #ffffff;
				margin-top: 0.18rem;
				z-index: 2;
				position: relative;
			}

			.team-detail-header .mui-pull-left img,
			.title-img {
				width: 0.28rem;
				height: auto;
			}

			team-detail-header {}

			.title-img {
				margin-left: 0.1rem;
			}

			.team-detail-header .mui-pull-right {
				width: 0.42rem;
				height: 0.42rem;
			}

			.notice-cont {
				padding: 0 0.2rem;
				background-color: #ffffff;
			}
			.headline {
				font-size: 0.3rem;
				color: #373737;
				margin: 0;
				line-height: 1.4;
				font-weight: normal;
				padding-top: 0.03rem;
				overflow: hidden;
			}

			.headline:before {
				content: '';
				display: inline-block;
				width: 4px;
				background-color: #2889ff;
				height: 0.3rem;
				margin-right: 0.1rem;
				margin-bottom: -2px;
			}

			.notice-cont p {
				padding: 0.2rem 0 0.4rem;
				font-size: 0.26rem;
				color: #333333;
				text-align: justify;
			}

			.headline p {
				margin: 0;
				padding: 0;
				font-size: 0.3rem;
				display: flex;
				align-items: center;
			}

			.headline .mui-icon {
				margin-top: -0.05rem;
				font-size: 20px;
			}

			.team-members {
				background-color: #FFFFFF;
				padding: 0.3rem 0.2rem;
				width: 100%;
				display: block;
			}

			.team-members span {
				display: flex;
				align-items: center;
			}

			.user-head-img {
				width: 0.82rem;
				height: 0.82rem;
				overflow: hidden;
				border-radius: 50%;
			}

			.user-head-img img {
				width: 100%;
				height: 100%;
			}

			.team-members ul {
				margin: 0;
				padding: 0;
				list-style: none;
				display: flex;
				align-items: center;
				justify-content: flex-start;
				flex-direction: row;
				flex-wrap: wrap;
				width: 100%;
				overflow: hidden;
			}


			.team-members li {
				display: inline-flex;
				position: relative;
				padding-top: 0.1rem;
				padding-right: 0.1rem;
				margin-right: 0.09rem;
				margin-top: 0.2rem;
			}

			.team-members li .mui-icon {
				position: absolute;
				right: 5px;
				top: 5px;
				color: #ffffff;
				background-color: #f42d2d;
				border-radius: 50%;
				padding: 0;
				font-size: 14px;
			}

			.validation-messages {
				margin-top: 0.2rem;
				background-color: #FFFFFF;
				padding: 0.3rem 0.2rem;
			}

			.mui-table-view:before,
			.mui-table-view:after {
				height: 0;
			}

			.mui-table-view-cell {
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding: 0.58rem 0;
			}

			.member-left img {
				width: 0.78rem;
				height: 0.78rem;
				border-radius: 50%;
			}

			.member-left {
				display: flex;
				align-items: center;
			}

			.member-left p {
				margin-left: 0.1rem;
				font-size: 0.24rem;
			}

			.member-left p.name {
				color: #333333;
				font-size: 0.3rem;
			}

			.member-right .mui-btn {
				width: 0.88rem;
				height: 0.59rem;
				padding: 0;
				font-size: 0.24rem;
			}

			.member-right .mui-btn:first-of-type {
				margin-right: 0.2rem;
			}

			.member-right span {
				font-size: 0.24rem;
				color: #999999;
			}

			.quit-the-team {
				width: 7.1rem;
				height: 0.99rem;
				border-radius: 0.1rem;
				background-color: #2289ff;
				padding: 0;
				font-size: 0.3rem;
				margin: 1rem auto 0.5rem;
			}

			.team-setting {
				display: flex;
				align-items: center;
				justify-content: center;
				height: 44px;
				padding: 0 12px;
				z-index: 16;
				position: relative;
				font-size: 24px;
				font-weight: bold;
				color: #333333;
				margin-right: -10px;
			}

			.more-menu {
				width: 90px;
			}

			.more-menu .mui-table-view-cell {
				padding: 10px;
				font-size: 14px;
				display: flex;
				align-items: center;
			}

			.more-menu .mui-table-view-cell::after {
				left: 0;
			}

			.mui-backdrop.mui-active {
				opacity: 0;
			}
			.team-grade-container{
				position: relative;
				z-index: 10;
				height: 1.4rem;
				background-color: #FFFFFF;
			}
			.team-grade-cont {
				position: absolute;
				transform: translateY(-50%);
				width: 7.1rem;
				background-color: #FFFFFF;
				padding: 0.4rem 0.7rem;
				display: flex;
				align-items: center;
				justify-content: space-between;
				box-shadow: 0 0 10px 0 rgba(0, 0, 0, 0.3);
				left: 0.2rem;
				border-radius: 0.1rem;
			}
			.team-grade-cont p{
				margin-bottom: 5px;
				font-size: 0.24rem;
				color: #999999;
			}
			.team-grade-cont span{
				font-size: 0.3rem;
				color: #373737;
			}
			.team-grade-items {
				text-align: center;
			}

			[v-cloak] {
				display: none;
			}
		</style>
		<script>
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<h1 class="mui-title">团队详情</h1>
			<a href="#menu" class="mui-pull-right team-setting">
				···
			</a>
		</header>

		<div id="mui-content" class="mui-content team-detail-container" v-cloak>
			<div class="team-detail-header">
				<div class="mui-clearfix team-desc">
					<div class="mui-pull-left">
						<span class="team-name">{{teamName}}</span>
					</div>
					<img class="mui-pull-right team-qrCode" src="../image/team-detail-img04.png" alt="">
				</div>
				<img class="team-bgimg" src="../image/share/bg-img03.jpg">
				<p class="team-number">{{tid}}</p>
			</div>
			<div class="team-grade-container">
				<div class="team-grade-cont">
					<div class="team-grade-items">
						<p>团队排名</p>
						<span>第3名</span>
					</div>
					<div class="team-grade-items">
						<p>团队活跃度</p>
						<span>99分</span>
					</div>
					<div class="team-grade-items">
						<p>团队总收入</p>
						<span>百万级</span>
					</div>
				</div>
			</div>
			<div class="notice-cont">
				<h2 class="headline">
					团队公告
				</h2>
				<p>{{desc}}</p>
			</div>
			<div class="team-members">
				<h2 class="headline team-member-more">团队成员<p class="more-member mui-pull-right">共{{teamNum}}人<span class="mui-icon mui-icon-arrowright"></span></p>
				</h2>
				<ul>
					<li v-for="(items,index) in teamMember" :key="index">
						<div class="user-head-img">
							<img :src="items.avatar||items.avatarUrl" />
						</div>
					</li>
					<li>
						<div class="user-head-img member-selection">
							<img type="image" src="../image/team-detail-img05.png" />
						</div>
					</li>
				</ul>
			</div>
			<div class="validation-messages" v-if="role">
				<h2 class="headline">验证消息</h2>
				<ul v-if="applyList.length>0" class="mui-table-view">
					<li class="mui-table-view-cell" v-for="(list,index) in applyList" :key="index">
						<div class="member-left">
							<img :src="list.avatar!=null?list.avatar:list.avatarUrl" alt="">
							<div>
								<p class="name">{{list.name!=null?list.name:list.nickName}}</p>
								<p>{{list.remark}}</p>
							</div>
						</div>
						<div class="member-right">
							<button @tap="examine(-1,list.uid)" v-if="list.status==0" type="button" class="mui-btn mui-btn-blue mui-btn-outlined">拒接</button>
							<button @tap="examine(1,list.uid)" v-if="list.status==0" type="button" class="mui-btn mui-btn-blue">同意</button>
							<span v-else-if="list.status==1">已添加</span>
							<span v-else>已拒绝</span>
						</div>
					</li>
				</ul>
				<div v-else style="width: 100%;margin: 0.6rem 0;text-align: center;color: #999999;">
					暂无验证消息
				</div>
			</div>
			<button v-if="!role" type="button" class="mui-btn mui-btn-blue mui-btn-block quit-the-team" @tap="quitTeam">退出团队</button>
		</div>
		<div id="menu" class="mui-popover more-menu">
			<ul class="mui-table-view">
				<li class="mui-table-view-cell delete-team">解散团队</li>
				<li class="mui-table-view-cell team-settings">设置</li>
			</ul>
		</div>
	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/util.js"></script>
	<script src="../js/vue.min.js"></script>
	<script type="text/javascript">
		mui.init();
		var userInfo = getUserInfo();
		var app = new Vue({
			el: "#mui-content",
			data: {
				desc: '',
				teamName: '',
				conts: '',
				role: 1,
				tid: '',
				teamMember: [],
				applyList: [],
				teamNum: 1,
				captain_uid: 0,
				data_status: false
			},
			methods: {
				quitTeam: function() {
					plus.nativeUI.confirm('确认退出团队?', function(e) {
						if (e.index == 0) {
							mui.post($ajaxUrl + 'team&action=quit_team', {
								token: userInfo.token,
								team_id: app.tid,
							}, function(res) {
								if (res.errno == 0) {
									message('退出成功!');
									mui.fire(plus.webview.getWebviewById('team_list'), 'refreshTeamList');
									setTimeout(function() {
										plus.webview.close('team_tetail');
										plus.webview.close('webUrl');
									}, 2000)
								} else {
									message(res.message);
								}
							}, 'json');
						}
					})
				}
			},
			mounted: function() {
				mui.plusReady(function() {
					var self = plus.webview.currentWebview();
					app.tid = self.teamid;
					// alert(self.teamid);
					getInfo();
					getMember();
					getApplyList();
				})
			}
		})

		mui(".mui-content").on("tap", ".team-qrCode", function() {
			openPage('team_qr_code.html', 'team_qr_code', '#f7f7f7', {
				teamId: app.tid,
				teamName: app.teamName
			});
		})
		//团队设置
		mui(".more-menu").on("tap", ".team-settings", function() {
			mui('.more-menu').popover('hide');
			openPage('team_setting.html', 'team_setting', '#f7f7f7', {
				teamId: app.tid,
				teamName: app.teamName,
				desc: app.desc,
				img: "../image/share/bg-img03.jpg"
			});
		})
		//解散团队
		mui(".more-menu").on("tap", ".delete-team", function() {
			mui('.more-menu').popover('hide');
			plus.nativeUI.confirm('确认解散团队吗？该操作不可撤销。', function(e) {
				if (e.index == 1) {
					// mui.toast("取消");
				} else {
					mui.post($ajaxUrl + 'team&action=delete', {
						token: userInfo.token,
						team_id: app.tid
					}, function(res) {
						logs(res);
						if (res.errno == 0) {
							mui.toast("团队已经解散");
						} else {
							mui.toast("操作失败");
						}
					}, 'json');

				}
			})
		})
		// 添加团队成员
		mui(".mui-content").on("tap", ".member-selection", function() {
			openPage('team_member_selection.html', 'team_member_selection', '#f7f7f7', {
				tid: app.tid
			});
		})
		// 更多成员
		mui(".mui-content").on("tap", ".team-member-more", function() {
			// logs(app.tid);
			openPage('team_members.html', 'team_members', '#f7f7f7', {
				tid: app.tid,
				captainUid: app.captain_uid
			});
		})

		// 获取团队信息
		function getInfo() {
			mui.post($ajaxUrl + 'team&action=team_info', {
				token: userInfo.token,
				team_id: app.tid
			}, function(res) {
				if (res.errno == 0) {
					app.teamName = res.data.name;
					app.desc = res.data.notice;
					app.teamNum = res.data.current_number;
					app.captain_uid = res.data.captain_uid;
					var captainId = res.data.captain_uid;
					if (userInfo.id == captainId) {
						app.role = 1;
					} else {
						app.role = 0;
					}
					if (res.data.data_status == 1) {
						app.data_status = true;
					} else {
						app.data_status = false;
					}
				}
			}, 'json');
		}
		// 获取验证信息
		function getApplyList() {
			mui.post($ajaxUrl + 'team&action=apply_list', {
				token: userInfo.token,
				team_id: app.tid
			}, function(res) {
				// logs(res);
				if (res.errno == 0) {
					app.applyList = res.data;
				} else {
					app.applyList = [];
					// message(res.message);
				}
			}, 'json');
		}
		// 获取团队成员
		function getMember() {
			// logs(app.tid);
			mui.post($ajaxUrl + 'team&action=member_list', {
				token: userInfo.token,
				team_id: app.tid
			}, function(res) {
				if (res.errno == 0) {
					app.teamMember = res.data;
				} else {
					app.teamMember = [];
				}
			}, 'json');
		}
		// 添加成员
		window.addEventListener('doit', function(e) {
			getInfo();
			getMember();
			var checkedValues = e.detail.idGroup;
			mui.post($ajaxUrl + 'team&action=add_member', {
				token: userInfo.token,
				team_id: app.tid,
				uids: checkedValues.join(',')
			}, function(res) {
				// logs(res);
				if (res.errno == 0) {
					message("添加成功");
				} else {
					message("添加失败，请稍后重试");
				}
			}, 'json');
		});
		// 删除成员
		window.addEventListener('remove', function(e) {
			getInfo();
			getMember();
		});
	</script>
</html>
