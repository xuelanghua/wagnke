<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>代理</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../css/mui.poppicker.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/vip-page.css" />
		<style>
			.close-button {
				position: absolute;
				top: 60px;
				left: 0.2rem;
				color: #ffffff;
				font-size: 0.30rem;
				z-index: 8888;
			}
			.close-button::before{
				content: "";
				display: inline-block;
				width: 0.21rem;
				height: 0.21rem;
				background: url("../image/close-icon-123.png")center center no-repeat;
				background-size:cover;
				margin-right: 0.1rem;
			}
			.area-desc{
				font-size: 0.24rem;
				padding-right: 15px;
			}
			.area-desc:after{
				font-size: 0.32rem;
				right: 0.15rem;
			}
		</style>
	</head>
	<body class="mui-hidden">
		<div id="vip-container" class="mui-content vip-container">
			<div class="close-button">关闭</div>
			<div class="activation-link">激活码激活</div>
			<div class="mui-card" id="form">
				<form class="mui-input-group">
					<div v-for="(item, index) in group" :key="index" v-if="item.id < 3" class="radio-list" :class="{active: item.id == 1}"
					 :data-id="item.id" :data-fee="item.activation_fee">
						<div class="mui-radio mui-left">
							<label>{{ item.name }}
								<div class="mui-pull-right">
									<span>&yen;{{ item.activation_fee }}</span>
									<span>续费{{ item.annual_fee }}</span>
								</div>
							</label>
							<label>{{ item.rights }}</label>
							<!-- <label>{{ item.rights }}</label>
							<label>{{ item.rights }}</label> -->
							<input name="group" type="radio" value="{{ item.id }}" :checked="item.id == 1">
						</div>
					</div>
					<!-- <div class="radio-list">
						<div class="mui-radio mui-left">
							<label>创客</label>
							<label>推广收益/送50个会员/送9999旺旺</label>
							<input name="radio1" type="radio">
						</div>
						<div class="mui-right">
							<span>&yen;9999</span>
							<span>续费69</span>
						</div>
					</div> -->
				</form>
				<div class="radio-list last">
					<span>代理</span>
					<span class="apply">立即预约<i class="mui-icon mui-icon mui-icon-arrowright" style="font-size: 16px;font-weight: bold;"></i></span>
				</div>
				<ul class="mui-table-view border-top">
					<li class="mui-table-view-cell"><span>应付金额</span><span class="price">&yen;<span id="activation_fee">199</span></span></li>
					<li class="mui-table-view-cell pay-type"><span>支付方式</span><span style="font-weight: normal;" class="pay-title">微信</span></li>
					<!-- <li id="area-select" class="mui-table-view-cell"><span>区域选择</span><span style="font-weight: normal;" id="area-desc" class="area-desc mui-navigate-right">点击选择</span></li> -->
				</ul>
			</div>
			<div class="mui-content-padded">
				<button type="button" class="mui-btn mui-btn-blue mui-btn-block mui-pay">立即支付</button>
				<p>开通即视为同意<a href="agreement.html">《旺客-用户协议》</a></p>
			</div>
			<!-- 创客弹窗开始 -->
			<div class="maker-model-container mui-hidden">
				<div class="maker-cont">
					<h2 class="title">尊贵</h2>
					<h2 class="title">创客</h2>
					<h5>恭喜您升级为创客会员</h5>
					<div class="privilege-container">
						<div class="privilege-items">
							<img src="../image/icon/chuagnke-icon-1.png">
							<span>全功能使用</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/chuagnke-icon-2.png">
							<span>3个商品位</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/chuagnke-icon-3.png">
							<span>推荐奖</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/chuagnke-icon-4.png">
							<span>服务奖</span>
						</div>
					</div>
					<div class="open-btn-container">
						<a class="open-chuangke">开启创客之旅</a>
					</div>
				</div>
			</div>
			<!-- 创客弹窗结束 -->
			<!-- vip弹窗开始 -->
			<div class="vip-model-container mui-hidden">
				<div class="maker-cont vip">
					<h2 class="title">尊贵</h2>
					<h2 class="title">VIP</h2>
					<h5>恭喜您升级为创客会员</h5>
					<div class="privilege-container">
						<div class="privilege-items">
							<img src="../image/icon/vip-ac-icon-01.png">
							<span>全功能使用</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/vip-ac-icon-02.png">
							<span>3个商品位</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/vip-ac-icon-03.png">
							<span>推荐奖</span>
						</div>
					</div>
					<div class="open-btn-container">
						<a class="open-chuangke vip">开启VIP之旅</a>
					</div>
				</div>
			</div>
			<!-- vip弹窗结束 -->
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script src="../js/mui.picker.min.js"></script>
		<script src="../js/mui.poppicker.js"></script>
		<script src="../js/city.data-3.js"></script>

		<script type="text/javascript">
			mui.init({
				swipeBack: false,
			});

			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束

			//vue初始化
			var vm = new Vue({
				el: "#form",
				data: {
					group: []
				}
			});

			var groupId = 0;
			var activationFee = 0;
			var groupData = null;
			var userInfo = getUserInfo();
			var provinceId = 0;
			var cityId = 0;
			var areaId = 0;
			//支付相关变量
			var payType = 'wxpay';
			var wxChannel = null; // 微信支付
			var aliChannel = null; // 支付宝支付
			var channel = null; //支付通道
			var ALIPAYSERVER = $ajaxUrl + 'member&action=activation';
			var WXPAYSERVER = $ajaxUrl + 'member&action=activation';
			mui.plusReady(function() {
				// 获取支付通道  
				plus.payment.getChannels(function(channels) {
					for (var i in channels) {
						if (channels[i].id == "wxpay") {
							wxChannel = channels[i];
						} else {
							aliChannel = channels[i];
						}
					}
				}, function(e) {
					plus.nativeUI.alert("获取支付通道失败：" + e.message, null, '提示');
				});

				eventInit();
				getGroupInfo();
			});

			//事件初始化
			function eventInit() {
				//关闭页面
				mui('.mui-content').on('tap', '.close-button', function() {
					var statusBarStyle = plus.webview.currentWebview().statusBarStyle;
					setStatusBar('', statusBarStyle);
					mui.back();
				})

				//跳转激活码激活
				mui('.mui-content').on('tap', '.activation-link', function() {
					fnOpenWin('activation_code.html', 'activation_code', {
						statusbar: {
							background: '#F7F7F7'
						}
					}, '', 'slid-in-right');
					plus.navigator.setStatusBarStyle('dark');
				})

				//跳转代理申请
				mui('.radio-list').on('tap', '.apply', function() {
					fnOpenWin('agent_apply.html', 'agent_apply', {
						statusbar: {
							background: '#FFF'
						}
					}, {
						groupData: groupData
					}, 'slide-in-right');
					plus.navigator.setStatusBarStyle('dark');
				})

				//选择会员类型
				mui('form').on('tap', '.radio-list', function() {
					mui('.radio-list').each(function() {
						this.classList.remove('active');
					})
					groupId = this.dataset.id;
					activationFee = this.dataset.fee;
					document.getElementById('activation_fee').innerText = activationFee;
					this.classList.add('active');
				})

				//支付方式选择
				mui('.mui-content').on('tap', '.pay-type', function() {
					var picker = new mui.PopPicker({
						layer: 1
					});
					picker.setData([{
						value: 'wxpay',
						text: '微信'
					}, {
						value: 'alipay',
						text: '支付宝'
					}, {
						value: 'unionpay',
						text: '银联'
					}]);
					picker.show(function(selectItems) {
						payType = selectItems[0].value;
						if (payType == 'wxpay') {
							mui('.pay-title')[0].innerText = selectItems[0].text;
						} else {
							message('暂不支持', 'center');
						}
					})
				})

				//支付
				mui('.mui-content').on('tap', '.mui-pay', function() {
					pay(payType);
				})
			}

			//获取会员等级信息
			function getGroupInfo() {
				plus.nativeUI.showWaiting();
				mui.post($ajaxUrl + 'member', {
					action: 'group_info'
				}, function(res) {
					var data = res.data;
					groupData = data;
					mui.each(data, function(index, item) {
						if (index < 2) {
							var rights = item.rights;
							var temp = '';
							for (var i in rights) {
								if (i > 0) {
									temp += '/' + rights[i];
								} else {
									temp += rights[i];
								}
							}
							item.rights = temp;
						}
					})
					groupId = data[0].id;
					activationFee = data[0].activation_fee;
					vm.group = res.data;
					plus.nativeUI.closeWaiting();
					document.querySelector('body').classList.remove('mui-hidden');
				}, 'json');
			}

			// 2. 发起支付请求  
			function pay(id) {
				// 从服务器请求支付订单
				var PAYSERVER = '';
				if (id == 'alipay') {
					message("暂不支持支付宝支付!", 'center');
					return;
					PAYSERVER = ALIPAYSERVER;
					channel = aliChannel;
				} else if (id == 'wxpay') {
					PAYSERVER = WXPAYSERVER;
					channel = wxChannel;
				} else {
					message("不支持此支付通道!", 'center');
					return;
				}

				var waiting = plus.nativeUI.showWaiting();
				mui.post(PAYSERVER, {
					group_id: groupId,
					price: activationFee,
					fee: activationFee,
					pay_type: payType,
					token: userInfo.token,
					province_id: provinceId,
					city_id: cityId,
					area_id: areaId,
					activation_type: 1,
				}, function(res) {
					// console.log(JSON.stringify(res));
					waiting.close();
					if (res.errno == 0) {
						var data = res.data;
						var param = {
							appid: data.appid,
							noncestr: data.nonce_str,
							package: 'Sign=WXPay',
							partnerid: data.mch_id,
							prepayid: data.prepay_id,
							timestamp: data.timeStamp,
							sign: data.paySign
						};

						plus.payment.request(channel, param, function(result) {
							//                  	console.log(JSON.stringify(result));
							plus.nativeUI.alert("激活成功！", function() {
								plus.navigator.setStatusBarStyle('dark');
								mui.fire(plus.webview.getWebviewById('H54F3E71F'), 'activationSuccess');
								mui.fire(plus.webview.getWebviewById('user'), 'activationSuccess');
								mui.back();
							});
						}, function(error) {
							console.log(JSON.stringify(error));
							plus.nativeUI.alert("支付失败：" + error.code);
						});
					} else {
						plus.nativeUI.alert(res.message, null, '提示');
					}
				}, 'json')
			}

			// 城市选择
			// mui.ready(function() {
			// 	var _getParam = function(obj, param) {
			// 		return obj[param] || '';
			// 	};
			// 	var showCityPickerButton = document.getElementById('area-select');
			// 	var cityResult = document.getElementById('area-desc');
			// 	showCityPickerButton.addEventListener('tap', function(event) {
			// 		var cityPicker = new mui.PopPicker({
			// 			layer: 3
			// 		});
			// 		cityPicker.setData(cityData3);
			// 		cityPicker.show(function(items) {
			// 			provinceId = _getParam(items[0], 'value');
			// 			cityId = _getParam(items[1], 'value');
			// 			areaId = _getParam(items[2], 'value');
			// 			cityResult.innerText = _getParam(items[0], 'text') + " " + _getParam(items[1], 'text') + " " + _getParam(
			// 				items[2], 'text');
			// 		});
			// 	}, false);
			// })
		</script>
	</body>
</html>
