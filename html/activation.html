<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<title></title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../css/vip-page.css" />
		<style>
			.close-button {
				position: absolute;
				top: 60px;
				left: 0.2rem;
				color: #ffffff;
				font-size: 0.30rem;
				z-index: 99;
			}
			.close-button::before{
				content: "";
				display: inline-block;
				width: 0.21rem;
				height: 0.21rem;
				background: url("../image/close-icon-123.png")center center no-repeat;
				background-size:cover;
				margin-right: 0.1rem;
			}
			.area-desc{
				font-size: 0.24rem;
				padding-right: 15px;
			}
			.area-desc:after{
				font-size: 0.32rem;
				right: 0.15rem;
			}
			.recommend-person input{
				border: none;
				border-bottom: 1px solid #F2F2F2;
				font-weight: normal;
				padding-bottom: 0;
				padding-left: 0;
				color: #333333;
				border-radius: 0;
				flex-grow: 1;
			}
			.recommend-person .mui-icon.mui-icon-clear{
				font-weight: normal !important;
			}
			.recommend-person span{
				font-weight: normal !important;
				flex-shrink: 0;
				margin-right: 10px;
			}
			.recommend-person.mui-active{
				background-color: #FFFFFF;
			}
			.recommend-person input::-webkit-input-placeholder {
				color: #999999;
				font-size: 0.3rem;
			}
			.mui-icon.mui-icon-clear{
				color: #DDDDDD;
				position: absolute;
				right:10px;
				top: 49%; 
				transform: translateY(-50%);
				-webkit-transform: translateY(-50%);
			}
			.content-paddeds{
				padding: 0.2rem;
				z-index: 16;
			}
			.content-paddeds span{
				color:#2289ff;
			}
			.content-paddeds label{
				width: auto;
				display: inline-block;
				min-width: 0;
				padding: 0;
			}
			.content-paddeds input{
				margin-top: -2px;
			}
			.content-paddeds p{
				display: flex;
				align-items: center;
				justify-content: center;
			}
			.mui-checkbox input[type=checkbox]{
				position: relative;
				top: 0;
				right: auto;
				left: auto;
				transform: scale(0.8);
				-webkit-transform: scale(0.8);
			}
			.vip-container .mui-card{
				padding:0.4rem 0.3rem 0.2rem;
			}
			.mui-input-group .mui-input-row:after{
				display: none;
			}
			.mui-input-row.mui-radio.mui-left{
				margin-bottom: 0.3rem;
				height: auto;
				border-radius: 0.1rem;
				position: relative;
				overflow: hidden;
				height: 1.33rem;
				box-shadow: 0 0 5px 0 rgba(0,0,0,0.2);
			}
			.mui-radio.mui-left label{
				padding: 0;
				margin: 0;
				display: flex;
				height: 100%;
				border-left: 0.1rem solid #89a1ca;
				align-items: center;
				justify-content: space-between;
				padding-left: 0.88rem;
				position: relative;
			}
			.mui-radio.mui-left .label1{
				border-color: #89a1ca;
			}.mui-radio.mui-left .label2{
				border-color: #e4c246;
			}
			.mui-radio.mui-left .label3,
			.mui-radio.mui-left .label4,
			.mui-radio.mui-left .label5{
				border-color: #cf8b47;
			}
			.mui-radio.mui-left input[type=radio]{
				top: 50%;
				margin-top: -14px;
				left: 0.1rem;
			}
			.mui-radio.mui-left label p{
				margin: 0;
			}
			.mui-radio .uni-right-cont .title,.price{
				font-size:0.3rem ;
				color: #333333;
				margin-bottom: 0.05rem;
			}
			.mui-radio .uni-right-cont .price span{
				margin-left: 10px;
				color:#999999;
				font-size:0.24rem;
			}
			.mui-radio.mui-left label0{
				border-left: 0.1rem solid #89a1ca;
			}
			.award-conts{
				position: absolute;
				right: 0;
				height: 100%;
				z-index: 9;
				top: 0;
				/* background-color: #0062CC; */
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 0;
			}
			.award-conts span{
				font-size: 0.24rem;
				color: #999999;
				display: inline-block;
				padding: 0 0.4rem;
				position: relative;
				line-height: 1;
			}
			.award-conts .mui-navigate-right:after{
				right: 5px;
				color: #999999;
				font-size: 0.32rem;
			}
			.vip-container{
				/* padding-bottom: 100px; */
				position: relative;
			}
			.vip-container .mui-card .border-top{
				border-top: none;
			}
			.mui-popover .mui-popover-arrow {
				display: none;
			}
			.mui-popover,.mui-popover.mui-active{
				width: 6.2rem;
				height: 8.3rem;
			}
			.middlePopover-body{
				height: 7.12rem;
				width: 100%;
				background: #FFFFFF url("../image/model-top-bg.png")center top no-repeat;
				background-size: contain;
				border-radius: 0.1rem;
				position: relative;
				overflow: hidden;
				padding-top: 0.63rem;
			}
			.middlePopover-body .rank-sign{
				width: 1.35rem;
				height: 1.35rem;
				display: block;
				margin: 0 auto 0.37rem;
			}
			.middlePopover-body h2{
				text-align: center;
				font-size: 0.35rem;
				color: #FFFFFF;
				margin-bottom: 0.8rem;
			}
			.mui-popover.mui-active ul{
				padding: 0 0.2rem;
				list-style: none; 
			}
			.mui-popover.mui-active ul li{
				position: relative;
				display: flex;
				align-items: center;
				font-size: 0.28rem;
				color: #333333;
				line-height: 1.2;
				margin-bottom: 0.1rem;
				text-align: justify;
			}
			.mui-popover.mui-active ul li::before{
				content: '';
				width: 10px;
				height: 10px;
				background-color: #424242;
				display: inline-flex;
				border-radius: 50%;
				margin-right: 0.1rem;
				flex-shrink: 0;
			}
			.mui-popover .close-model{
				display: block;
				width: 0.72rem;
				height: 0.72rem;
				margin: 0 auto;
				margin-top: 0.4rem;
			}
			#div {
				width: 0px;
				height: 0px;
				background: red;
				position: fixed;
				top: 50%;
				left: 50%;
			}
			
			.mui-backdrop {
			    background-color: rgba(0,0,0,.8);
			}
			
			[v-cloak] {
				display: none;
			}
		</style>
		<script type="text/javascript">
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
		</script>
	</head>
	<body>
		<div id="vip-container" class="mui-content vip-container" v-cloak>
			<div id="div"></div>
			<div class="close-button">关闭</div>
			<div class="activation-link">激活码激活</div>
			<div class="mui-card" id="form">
				<form class="mui-input-group">
					<div class="mui-input-row mui-radio mui-left" v-for="(h,i) in group" :key="i" @tap="changeTc(h.id)">
						<label :class="'label'+h.id">
							<input name="radio1" type="radio" :checked="i==0||false">
							<div class="uni-right-cont">
								<p class="title">{{h.name}}</p>
								<p class="price">&yen;{{h.activation_fee}}<span v-if="h.annual_fee!=0">续费：{{h.annual_fee}}</span></p>
							</div>
						</label>
						<div class="award-conts">
							<span class="mui-navigate-right " @tap="showEquities(h.id)">权益</span>
						</div>
					</div>
				</form>
				<!-- <form class="mui-input-group">
					<div v-for="(item, index) in group" :key="index" v-if="item.id < 3" class="radio-list" :class="{active: item.id == 1}"
					 :data-id="item.id" :data-fee="item.activation_fee">
						<div class="mui-radio mui-left">
							<label>{{ item.name }}
								<div class="mui-pull-right">
									<span>&yen;{{ item.activation_fee }}</span>
									<span>续费{{ item.annual_fee }}</span>
								</div>
							</label>
							<label>{{ item.rights }}</label>
							<!-- <label>{{ item.rights }}</label>
							<label>{{ item.rights }}</label> -->
				<!--<input name="group" type="radio" value="{{ item.id }}" :checked="item.id == 1">
						</div>
					</div>
				</form> -->
				<ul class="mui-table-view border-top">
					<li class="mui-table-view-cell recommend-person" v-if="recommendId==0">
						<!-- <li class="mui-table-view-cell recommend-person"> -->
						<span>推荐人</span>
						<input type="number" class="mui-input mui-input-clear" v-model="recommendPhone" name="recommend_phone"
						 placeholder="输入推荐人手机号码">
						<i v-show="recommendPhone" class="mui-icon mui-icon-clear" @tap="recommendPhone=''"></i>
					</li>
				</ul>
				
				<div class="content-paddeds" style="background-color: #FFFFFF; width: 100%;">
					<button v-if="setMeal==1" type="button" class="mui-btn mui-btn-blue mui-btn-block mui-pay">立即支付</button>
					<button v-else type="button" class="mui-btn mui-btn-blue mui-btn-block action-order-btn">立即预约</button>
					<p style="text-align: center;" class="mui-input-row mui-checkbox">
						<input id="agree" name="checkbox" value="" type="checkbox">
						<label for="agree">开通即视为同意</label>
						<span id="agreement">《旺客-用户协议》</span>
					</p>
				</div>
			</div>
			<!-- <div class="content-paddeds" style="background-color: #FFFFFF; width: 100%;">
				<button v-if="setMeal==1" type="button" class="mui-btn mui-btn-blue mui-btn-block mui-pay">立即支付</button>
				<button v-else type="button" class="mui-btn mui-btn-blue mui-btn-block action-order-btn">立即预约</button>
				<p style="text-align: center;" class="mui-input-row mui-checkbox">
					<input id="agree" name="checkbox" value="" type="checkbox">
					<label for="agree">开通即视为同意</label>
					<span id="agreement">《旺客-用户协议》</span>
				</p>
			</div> -->
			<!-- 创客弹窗开始 -->
			<div class="maker-model-container mui-hidden">
				<div class="maker-cont">
					<h2 class="title">尊贵</h2>
					<h2 class="title">企业</h2>
					<h5>恭喜您升级为企业会员</h5>
					<div class="privilege-container">
						<div class="privilege-items">
							<img src="../image/icon/chuagnke-icon-1.png">
							<span>全功能使用</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/chuagnke-icon-2.png">
							<span>99个商品位</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/chuagnke-icon-3.png">
							<span>推荐奖</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/chuagnke-icon-4.png">
							<span>服务奖</span>
						</div>
					</div>
					<div class="open-btn-container">
						<a class="open-chuangke">开启企业会员之旅</a>
					</div>
				</div>
			</div>
			<!-- 创客弹窗结束 -->
			<!-- vip弹窗开始 -->
			<div class="vip-model-container mui-hidden">
				<div class="maker-cont vip">
					<h2 class="title">尊贵</h2>
					<h2 class="title">个人版</h2>
					<h5>恭喜您升级为个人会员</h5>
					<div class="privilege-container">
						<!-- <div class="privilege-items">
							<img src="../image/icon/vip-ac-icon-01.png">
							<span>全功能使用</span>
						</div> -->
						<div class="privilege-items">
							<img src="../image/icon/vip-ac-icon-02.png">
							<span>5个商品位</span>
						</div>
						<div class="privilege-items">
							<img src="../image/icon/vip-ac-icon-03.png">
							<span>推荐奖</span>
						</div>
					</div>
					<div class="open-btn-container">
						<a class="open-chuangke vip">开启个人会员之旅</a>
					</div>
				</div>
			</div>
			<!-- vip弹窗结束 -->
			<div id="middlePopover" class="mui-popover">
				<div class="middlePopover-body">
					<img class="rank-sign" :src="'../image/huiyuanqy'+(viptype+1)+'.png'">
					<!-- <h2>{{group[viptype].name}}权益</h2> -->
					<h2>{{group[viptype].name}}权益</h2>
					<ul>
						<li v-for="(k,o) in group[viptype].rights" :key="o">{{k}}</li>
					</ul>
				</div>
				<img class="close-model" src="../image/Close.png">
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo();
			var groupId = 0;
			var activationFee = 0;
			var groupData = null;
			var provinceId = 0;
			var cityId = 0;
			var areaId = 0;
			//支付相关变量
			var payType = 'wxpay';
			var wxChannel = null; // 微信支付
			var aliChannel = null; // 支付宝支付
			var channel = null; //支付通道
			var ALIPAYSERVER = $ajaxUrl + 'member&action=activation';
			var WXPAYSERVER = $ajaxUrl + 'member&action=activation';
			//vue初始化
			var vm = new Vue({
				el: "#vip-container",
				data: {
					recommendId: 0,
					recommendPhone: '',
					viptype: 1,
					group: [{"id":"1","uniacid":"6","name":"个人版","status":"1","activation_fee":"199","annual_fee":"69","is_check":"0","rights":["使用软件","拥有5个商品展位","分享收益"],"goods":"5","wang":"0","delete":"disable","recommend_rate_1":"30","recommend_rate_2":"20","team_number":"0","renew_award":"0","booth_award":"0","knowledge_award":"0"},{"id":"2","uniacid":"6","name":"企业版","status":"1","activation_fee":"9999","annual_fee":"69","is_check":"0","rights":["使用软件全部功能","拥有99个商品展位","拥有200个个人版名额","分享收益","会员续费收益10%","会员购买商品展位收益10%","会员知识付费收益10%"],"goods":"10","wang":"39800","delete":"disable","recommend_rate_1":"30","recommend_rate_2":"20","team_number":"100","renew_award":"10","booth_award":"10","knowledge_award":"10"}],
					setMeal: 1
				},
				created: function() {
					getRecommendUser();
				},
				methods: {
					showEquities: function(id) {
						vm.viptype = parseInt(id) - 1;
						// mui.toast(app.vipType);
						mui('#middlePopover').popover("show", document.getElementById("div"));
					},
					// 切换套餐
					changeTc: function(setMeal) {
						this.setMeal = setMeal;
					}
				},
				mounted: function() {
					mui.init({
						swipeBack: true,
					})
					mui.plusReady(function() {
						eventInit();
						getGroupInfo();
						var originalHeight = document.documentElement.clientHeight || document.body.clientHeight;
						window.onresize = function() {
							//软键盘弹起与隐藏  都会引起窗口的高度发生变化
							var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;
							var paddeds = document.querySelector(".content-paddeds");
							if (resizeHeight * 1 < originalHeight * 1) {
								paddeds.style.zIndex = '-1';
								paddeds.style.display = 'none';
								document.querySelector('.vip-container').style.paddingBottom = "0px";
							} else {
								paddeds.style.zIndex = '999';
								paddeds.style.display = 'block';
								document.querySelector('.vip-container').style.paddingBottom = "100px";
							}
						}
						var ws = plus.webview.currentWebview();
						if (mui.os.ios) {
							ws.setStyle({
								softinputMode: "adjustResize"
							});
						}
						// 获取支付通道  
						plus.payment.getChannels(function(channels) {
							for (var i in channels) {
								if (channels[i].id == "wxpay") {
									wxChannel = channels[i];
								} else {
									aliChannel = channels[i];
								}
							}
						}, function(e) {
							plus.nativeUI.alert("获取支付通道失败：" + e.message, null, '提示');
						});
					});

					//事件初始化
					function eventInit() {
						//关闭页面
						mui('.mui-content').on('tap', '.close-button', function() {
							var statusBarStyle = plus.webview.currentWebview().statusBarStyle;
							setStatusBar('', statusBarStyle);
							mui.back();
						})
						mui('.mui-content').on('tap', '#agreement', function() {
							openPage('user_agreement.html', 'user_agreement', '#ffffff', '');
						})
						// 预约服务
						mui('.mui-content').on('tap', '.action-order-btn', function() {
							var inputs = document.querySelector(".mui-input-clear");
							if (inputs) {
								inputs.blur();
							}
							var cheackd = document.getElementById('agree').checked;
							if (vm.recommendId == 0) {
								if (vm.recommendPhone.length == 0) {
									message('请输入推荐人手机号码!');
									return;
								}
								if (!/1[\d]{10}/.test(vm.recommendPhone)) {
									message('推荐人手机号码输入有误!');
									return;
								}
							}
							if (!cheackd) {
								message('需要同意旺客用户协议');
								return;
							}
							mui.post($ajaxUrl + 'member', {
								action: 'agent_apply',
								token: userInfo.token,
								group_id: vm.setMeal, //2345
								type: 1,
								province_id: 0,
								city_id: 0, //0
								area_id: 0, //0
								recommend_phone: vm.recommendPhone //推荐人手机号
							}, function(res) {
								logs(res);
								if (res.errno == 0) {
									mui.alert('申请成功, 等待审核!', '', '', function() {
										plus.webview.close('activation');
									}, 'div');
								} else {
									mui.alert(res.message, '', '', '', 'div')
								}
								showload(1);
							}, 'json');
						})

						//跳转激活码激活
						mui('.mui-content').on('tap', '.activation-link', function() {
							fnOpenWin('activation_code.html', 'activation_code', {
								statusbar: {
									background: '#F7F7F7'
								}
							}, '', 'slid-in-right');
							plus.navigator.setStatusBarStyle('dark');
						})

						//跳转代理申请
						mui('.mui-content').on('tap', '.agent-apply', function() {
							fnOpenWin('agent_apply.html', 'agent_apply', {
								statusbar: {
									background: '#FFF'
								}
							}, {
								groupData: groupData
							}, 'slide-in-right');
							plus.navigator.setStatusBarStyle('dark');
						})

						//支付
						mui('.mui-content').on('tap', '.mui-pay', function() {
							var cheackd = document.getElementById('agree').checked;
							document.activeElement.blur();
							if (vm.recommendId == 0) {
								if (vm.recommendPhone.length == 0) {
									message('请输入推荐人手机号码!');
									return;
								}
								if (!/1[\d]{10}/.test(vm.recommendPhone)) {
									message('推荐人手机号码输入有误!');
									return;
								}
							}
							if (!cheackd) {
								message('需要同意旺客用户协议');
								return;
							}
							pay('wxpay');
						})
					}
				}
			});

			mui('#middlePopover').on('tap', '.close-model', function() {
				mui('#middlePopover').popover("hide", document.getElementById("div"));
			})

			// 2. 发起支付请求  
			function pay(id) {
				// 从服务器请求支付订单
				var PAYSERVER = '';
				if (id == 'wxpay') {
					PAYSERVER = WXPAYSERVER;
					channel = wxChannel;
				} else {
					message("不支持此支付通道!", 'center');
					return;
				}

				showload(0);
				mui.post(PAYSERVER, {
					group_id: groupId,
					price: activationFee,
					fee: activationFee,
					pay_type: payType,
					token: userInfo.token,
					province_id: provinceId,
					city_id: cityId,
					area_id: areaId,
					activation_type: 1,
					recommend_phone: vm.recommendPhone
				}, function(res) {
					// console.log(JSON.stringify(res));
					showload(1);
					if (res.errno == 0) {
						var data = res.data;
						var param = {
							appid: data.appid,
							noncestr: data.nonce_str,
							package: 'Sign=WXPay',
							partnerid: data.mch_id,
							prepayid: data.prepay_id,
							timestamp: data.timeStamp,
							sign: data.paySign
						};

						plus.payment.request(channel, param, function(result) {
							setTimeout(function() {
								console.log('activationSuccess');
								updateUserInfo();
								mui.fire(plus.webview.getWebviewById('user'), 'activationSuccess');
								mui.fire(plus.webview.getWebviewById('media'), 'activationSuccess');
							}, 3000)
							mui.alert("激活成功！", '', '', function() {
								plus.navigator.setStatusBarStyle('dark');
								plus.webview.currentWebview().close();
							}, 'div');
						}, function(error) {
							console.log(JSON.stringify(error));
							// plus.nativeUI.alert("支付失败：" + error.code);
							var message = error.message;
							var regexp = /(\-)?\d+/;
							var code = message.match(regexp);
							if (code.length > 0) {
								code = code[0];
							} else {
								code = "-9";
							}
							mui.alert("支付失败：" + wxpayErrorMessage(code), '', '', '', 'div');
						});
					} else {
						mui.alert(res.message, '', '', '', 'div');
					}
				}, 'json')
			}

			//获取上级推荐id
			function getRecommendUser() {
				mui.get($ajaxUrl + 'member', {
					action: 'recommend_id',
					token: userInfo.token
				}, function(res) {
					vm.recommendId = res.data;
				}, 'json');
			}

			//获取会员等级信息
			function getGroupInfo() {
				showload(0);
				mui.post($ajaxUrl + 'member', {
					action: 'group_info'
				}, function(res) {
					// logs(res);
					var data = res.data;
					groupId = data[0].id;
					activationFee = data[0].activation_fee;
					vm.group = data;
					logs(vm.group);
					showload(1);
				}, 'json');
			}
		</script>
	</body>
</html>
