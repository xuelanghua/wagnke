<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--标准mui.css-->
		<link rel="stylesheet" href="../css/mui.min.css">
		<!--App自定义的css-->
		<!--<link rel="stylesheet" type="text/css" href="../css/app.css"/>-->
		<style>
			.clearfix{
				clear: both;
			}
			.mui-bar,body,.mui-content{
				background-color: #FFFFFF;
			}
			.mui-bar .mui-pull-right{
				font-size: 15px;
				margin-top: 10px;
			}
			
			.your_goal{
				margin: 18px 10px 0 10px;
				font-size: 13px;
				border-radius: 5px;
				box-shadow: 0 0 10px 0 #DDDDDD;
			}
			.your_goal_title{
				padding: 11px 10px;
				border-bottom: 1px solid #F2F2F2;
			}
			.your_goal img{
				width: 18px;
				height: 18px;
				margin-right: 5px;
			}
			.your_goal_content{
				color: #999999;
				padding: 10px 0 20px 33px;
			}
			
			.mui-content-padded{
				margin-top: 20px;
				border-radius: 5px;
				padding: 15px 10px;
				box-shadow: 0 0 15px 0 #DDDDDD;
			}
			.mui-input-row.mui-input-range{
				padding: 0;
			}
			.mui-input-row label{
				padding: 0 0 20px 0;
				color: #999999;
				font-size: 15px;
			}
			.field-contain input[type='text']{
			    width: 40px;
			    height: 30px;
			    padding: 5px 0;
			    float: none;
				font-size: 15px;
				margin-top: -5px;
				float: right;
			    text-align: center;
			}
			
			.goal_setting_money{
				box-shadow: 0 0 15px 0 #DDDDDD;
				background-color: #FFFFFF;
				margin: 18px 10px 0 10px;
				padding: 17px 10px;
				font-size: 15px;
				border-radius: 5px;
			}
			
			.bottom{
				margin-top: 42px;
				font-size: 15px;
				text-align: center;
				color: #999999;
				margin:42px 10px 50px 10px;
			}
			.bottom button{
				width: 100%;
				padding: 17px 0;
				border: none;
				color: #FFFFFF;
				border-radius: 5px;
				background-color: #2489FF;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav ">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<!-- <a class="mui-pull-right">按月计算</a> -->
			<h1 class="mui-title">目标设定</h1>
		</header>
		<div class="mui-content">
			<div class="your_goal">
				<div class="your_goal_title">
					<div class="mui-pull-left">
						<img src="../image/target/your_goal.png">
					</div>
					<div>你的目标是<span id="target_maincontent" style="color: #2289ff"></span>价值<span id="target_price" style="color: #2289ff"></span>你将用<span id="target_total_time" style="color: #2289ff"></span>天来
						完成你的目标 </div>
				</div>
				<div class="your_goal_content">
					<div>根据大数据计算</div>
					<div>1，你需要每天开发<span id="daily_customer_num"></span>个客户</div>
					<div>2，每天平均收款<span id="daily_money_top"></span>元</div>
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row mui-input-range field-contain">
					<div>
						<label>每天曝光</label>
						<input type="text" id='field-range1-input' value='0' readonly="readonly">
					</div>
					<div>
						<input type="range" id='field-range1' value="0" min="0" max="500" />
					</div>
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row mui-input-range field-contain">
					<div>
						<label>每天拓客</label>
						<input type="text" id='field-range2-input' value='0' readonly="readonly">
					</div>
					<div>
						<input type="range" id='field-range2' value="0" min="0" max="500" />
					</div>
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row mui-input-range field-contain">
					<div>
						<label>客户跟进</label>
						<input type="text" id='field-range3-input' value='0' readonly="readonly">
					</div>
					<div>
						<input type="range" id='field-range3' value="0" min="0" max="500" />
					</div>
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row mui-input-range field-contain">
					<div>
						<label>有效沟通</label>
						<input type="text" id='field-range4-input' value='0' readonly="readonly">
					</div>
					<div>
						<input type="range" id='field-range4' value="0" min="0" max="500" />
					</div>
				</div>
			</div>
			<div class="mui-content-padded">
				<div class="mui-input-row mui-input-range field-contain">
					<div>
						<label>每天转介绍</label>
						<input type="text" id='field-range5-input' value='0' readonly="readonly">
					</div>
					<div>
						<input type="range" id='field-range5' value="0" min="0" max="500" />
					</div>
				</div>
			</div>
			<div class="goal_setting_money">
				<span class="mui-pull-left" style="color: #2489FF;">每天平均收款（元）</span>
				<span class="mui-pull-right"><span id="daily_money"></span></span>
				<div class="clearfix"></div>
			</div>
			<div class="bottom">
				<button onclick="addUserTarget();">开干喽</button>
				<div style="margin-top: 20px;">不积跬步无以至千里，让我们现在就开始进步吧</div>
			</div>
		</div>
	</body>
	<script src="../js/mui.js"></script>
	<!-- <script src="../js/jquery-1.11.0.min.js"></script> -->
	<script src="../js/Zepto.min.js"></script>
	<script src="../js/util.js"></script>
	<script>
		mui.init({});
		mui.plusReady(function() {
			var self = plus.webview.currentWebview();
			document.getElementById('target_maincontent').innerHTML = self.user_target_main_content;
			document.getElementById('target_price').innerHTML = self.target_total_money;
			document.getElementById('target_total_time').innerHTML = self.target_time;
			// alert(JSON.stringify(self));
			//获取权重
			getTargetWeight(self.target_total_money, self.target_time);
		});
		//监听input事件，获取range的value值，也可以直接element.value获取该range的值
		//找到所有的range
		var rangeList = document.querySelectorAll('input[type="range"]');
		//根据range的长度得到个数 得到循环查询的次数
		for (var i = 0, len = rangeList.length; i < len; i++) {
			rangeList[i].addEventListener('input', function() {
				if (this.id.indexOf('field') >= 0) {
					document.getElementById(this.id + '-input').value = this.value;
				} else {
					document.getElementById(this.id + '-val').innerHTML = this.value;
				}
			});
		}
		// 		document.getElementById('field-range-input').addEventListener('input', function() {
		// 			document.getElementById('field-range').value = this.value;
		// 		});
		/**
		 * 从后台取到权重数据 并计算出相应对应的数值
		 */
		function getTargetWeight(target_total_money, target_time) {
			var userInfo = getUserInfo();
			var ajax_url = $ajaxUrl + 'target';
			mui.ajax(ajax_url, {
				data: {
					action: 'getTargetWeight',
					token: userInfo.token
				},
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				success: function(ret) {
					console.log(JSON.stringify('成功'));
					console.log(JSON.stringify(ret));
					//开始计算
					//计算每天多少
					var daily_money = target_total_money / target_time;
					daily_money = daily_money.toFixed(0);
					$('#daily_money').html(daily_money);
					$('#daily_money_top').html(daily_money);
					//再根据权重算出相应的数值
					var cardinal_number = ret.data.cardinal_number;
					//计算基数价值
					var cardinal_money = (daily_money / cardinal_number).toFixed(0);
					//计算曝光
					$('#field-range1-input').val((cardinal_money * ret.data.exposure_rate));
					$('#field-range1').attr('max', (cardinal_money * ret.data.exposure_rate * 3));
					$('#field-range1').val((cardinal_money * ret.data.exposure_rate));
					//计算拓客
					$('#field-range2-input').val((cardinal_money * ret.data.new_customer));
					$('#field-range2').attr('max', (cardinal_money * ret.data.new_customer * 3));
					$('#field-range2').val((cardinal_money * ret.data.new_customer));
					$('#daily_customer_num').html((cardinal_money * ret.data.new_customer));
					//计算跟进
					$('#field-range3-input').val((cardinal_money * ret.data.customer_follow));
					$('#field-range3').attr('max', (cardinal_money * ret.data.customer_follow * 3));
					$('#field-range3').val((cardinal_money * ret.data.customer_follow));
					//计算沟通
					$('#field-range4-input').val((cardinal_money * ret.data.communication));
					$('#field-range4').attr('max', (cardinal_money * ret.data.communication * 3));
					$('#field-range4').val((cardinal_money * ret.data.communication));
					//计算转介绍
					$('#field-range5-input').val((cardinal_money * ret.data.share_card));
					$('#field-range5').attr('max', (cardinal_money * ret.data.share_card * 3));
					$('#field-range5').val((cardinal_money * ret.data.share_card));
					console.log(cardinal_money);
					//获取总价值
				},
				error: function(xhr, type, errorThrown) {
					console.log(JSON.stringify('失败'));
					console.log(JSON.stringify(errorThrown));
				}
			});
		}
		/**
		 * 提交所有客户目标信息
		 */
		function addUserTarget() {
			var showwatting = plus.nativeUI.showWaiting();
			var self = plus.webview.currentWebview();
			//封装表单数据
			//目标名称
			var user_target_main_content = self.user_target_main_content;
			//目标录音地址
			var target_record_url = self.target_record_url;
			//目标录音时间
			var target_record_time = self.target_record_time;
			//目标实现金额
			var target_total_money = self.target_total_money;
			//目标描述
			var target_description = self.target_description;
			//目标实现时间
			var target_time = self.target_time;
			//目标曝光量
			var terget_exposure_rate = $('#field-range1-input').val();
			//目标拓客
			var terget_new_customer = $('#field-range2-input').val();
			//目标跟进
			var terget_customer_follow = $('#field-range3-input').val();
			//目标沟通
			var terget_communication = $('#field-range4-input').val();
			//目标转介绍
			var terget_share_card = $('#field-range5-input').val();
			//目标成交额
			var terget_deal = $('#daily_money').html();
			//获取用户信息
			var userInfo = getUserInfo();
			// alert(JSON.stringify(userInfo));
			// return false;
			var ajax_url = $ajaxUrl + 'target';
			// console.log(ajax_url);
			// return false;
			mui.ajax(ajax_url, {
				data: {
					action: 'commitUserTarget',
					//用户token
					token: userInfo.token,
					//用户id
					userId: userInfo.id,
					//目标名称
					user_target_main_content: user_target_main_content,
					//目标录音地址
					target_record_url: target_record_url,
					//目标录音时间
					target_record_time: target_record_time,
					//目标实现金额
					target_total_money: target_total_money,
					//目标描述
					target_description: target_description,
					//目标实现时间
					target_time: target_time,
					//目标曝光量
					terget_exposure_rate: terget_exposure_rate,
					//目标拓客
					terget_new_customer: terget_new_customer,
					//目标跟进
					terget_customer_follow: terget_customer_follow,
					//目标沟通
					terget_communication: terget_communication,
					//目标转介绍
					terget_share_card: terget_share_card,
					//目标成交额
					terget_deal: terget_deal,
				},
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				success: function(ret) {
					logs(ret);
					if (ret.errno == 0) {
						console.log(JSON.stringify('成功'));
						console.log(JSON.stringify(ret));
						message('设置成功！');
						mui.fire(plus.webview.getWebviewById('target'), 'newTarget');
						//添加自定义事件
						plus.webview.close('target_manage_index');
						plus.webview.close('target_detail');
						setTimeout(function() {
							var self = plus.webview.currentWebview();
							self.close();
						}, 2000);
					} else {
						message('参数错误！');
					}
				},
				error: function(xhr, type, errorThrown) {
					console.log(JSON.stringify('失败'));
					console.log(JSON.stringify(xhr));
					console.log(JSON.stringify(type));
					console.log(JSON.stringify(errorThrown));
					message('参数错误！');
				}
			});
			plus.nativeUI.closeWaiting();
		}
	</script>
</html>
