<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>设置</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<style type="text/css">
			.article-part1 {
				padding: 0 0.2rem;
				background-color: #ffffff;
				margin-top: 0.2rem;
				position: relative;
			}

			.article-title {
				border: none;
				border-radius: 0;
				margin: 0;
				padding: 0;
				padding-top: 10px;
			}

			.article-part1:after,
			.section-advertising.line:after {
				content: '';
				display: block;
				position: absolute;
				height: 1px;
				background-color: #dddddd;
				left: 10px;
				right: 10px;
				bottom: 1px;
				transform: scaleY(0.5);
				-ms-transform: scaleY(0.5);
				-moz-transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
				-o-transform: scaleY(0.5);
			}

			.mui-table-view {
				margin-bottom: 0.2rem;
			}

			.mui-table-view:before,
			.mui-table-view:after {
				height: 0;
			}

			.mui-table-view-cell:after {
				background-color: #dddddd;
			}

			.mui-table-view-cell.mui-active {
				background-color: #FFFFFF;
			}

			.add-sm-img {
				width: 2.27rem;
				height: 1.6rem;
				border: 2px dashed #dddddd;
				display: flex;
				align-items: center;
				justify-content: center;
				color: #999999;
				margin: 0.3rem 0;
				font-size: 0.28rem;
			}

			.updata-img-tips {
				margin-bottom: 0.3rem;
				color: #2289FF;
				font-size: 0.28rem;
			}

			.section-advertising {
				padding: 0.55rem 0.2rem;
				background-color: #FFFFFF;
				position: relative;
			}

			.section-advertising p {
				font-size: 0.3rem;
				color: #333333;
			}

			.add-banner {
				background-color: #f5f5f5;
				width: 100%;
				height: 3.05rem;
				margin-bottom: 0.4rem;
				display: flex;
				justify-content: center;
				align-items: center;
				flex-direction: column;
			}

			.add-banner img {
				width: 1rem;
				height: auto;
			}

			.add-banner h3 {
				font-size: 0.3rem;
				color: #333333;
				margin: 0.25rem auto;
			}

			.add-banner p {
				font-size: 0.26rem;
				color: #999999;
				margin-bottom: 0;
			}

			.input-hyperlink.mui-input-row {
				background-color: #f5f5f5;
				border-radius: 0.1rem;
				height: 1rem;
				position: relative;
				padding-right: 0.3rem;
				margin-bottom: 0.1rem;
			}

			.input-hyperlink input {
				border: none;
				width: 100%;
				margin-bottom: 0;
				height: 100%;
				background: transparent;
				padding-left: 0.1rem;
			}

			.mui-input-row .mui-input-clear~.mui-icon-clear {
				top: 0;
				height: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 0.5rem;
			}

			.bottom-operation {
				display: flex;
				justify-content: center;
				padding: 0.5rem 0.2rem 1rem;
			}

			.bottom-operation button {
				border-radius: 0.1rem;
				background-color: #2289ff;
				border-color: #2289ff;
				height: 0.98rem;
				padding: 0;
			}

			.mui-table-view-cell.add-text {
				height: 0.99rem;
				display: flex;
				align-items: center;
				font-size: 0.3rem;
				color: #333333;
			}

			.mui-table-view-cell.add-text .mui-navigate-right:after {
				font-size: 0.48rem;
			}

			#thumbnail-cont {
				width: 2.27rem;
				height: 1.6rem;
				overflow: hidden;
			}

			#thumbnail {
				width: 100%;
				min-height: 100%;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<h1 class="mui-title">发布文章</h1>
		</header>

		<div class="mui-content">
			<div class="article-part1">
				<textarea class="article-title" rows="2" placeholder="请输入文章标题"></textarea>
			</div>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<div id="thumbnail-cont" style="display: none;">
						<img id="thumbnail" src="" alt="">
					</div>
					<div id="add-thumbnail" class="add-sm-img">添加缩略图</div>
					<!-- <p class="updata-img-tips">使用正文首张为缩略图</p> -->
				</li>
				<li class="mui-table-view-cell add-text"><span class="mui-navigate-right" id="edit-article">添加正文内容</span></li>
			</ul>
			<div class="mui-hidden">
				<div class="section-advertising line">
					<p>设置顶部广告位</p>
					<div class="add-banner">
						<img src="../image/icon/add-head-img.png">
						<h3>上传顶部广告位图片</h3>
						<p>尺寸：1000×450</p>
					</div>
					<div class="input-hyperlink mui-input-row">
						<input type="text" name="hyperlink" id="hyperlink" value="" class="mui-input-clear" placeholder="输入跳转连接" />
					</div>
				</div>
				<div class="section-advertising">
					<p>设置底部广告位</p>
					<div class="add-banner">
						<img src="../image/icon/add-head-img.png">
						<h3>上传底部广告位图片</h3>
						<p>尺寸：1000×450</p>
					</div>
					<div class="input-hyperlink mui-input-row">
						<input type="text" name="hyperlink" id="hyperlink" value="" class="mui-input-clear" placeholder="输入跳转连接" />
					</div>
				</div>
			</div>
			<div class="bottom-operation">
				<button type="button" class="mui-btn mui-btn-primary mui-btn-block" id="add_submit">提交</button>
			</div>
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/upload.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true
			});

			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			 
			// 初始化字体大小结束

			var userInfo = getUserInfo();
			var content = '';
			var title = '';
			var thumb = '';
			var articleId = 0;
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				if (self.articleId) {
					articleId = self.articleId;
					getArticleInfo();
				}

				plus.webview.hide('article_operation', 'none');
				plus.webview.close('article_operation', 'none');

				window.addEventListener('editDetail', function(event) {
					content = event.detail.content;
					if (content.length != 0) {
						document.getElementById('edit-article').innerText = '修改正文内容';
					} else {
						document.getElementById('edit-article').innerText = '添加正文内容';
					}
				})

				mui(".mui-content").on('tap', '.add-text', function() {
					openPage('edit_article_detail.html', 'edit_article_detail', '#f7f7f7', {
						content: content
					});
				})

				mui('.mui-content').on('tap', '#add-thumbnail,#thumbnail-cont', function() {
					imageUpload(function(res) {
						if (res.url != '') {
							mui('#thumbnail')[0].src = res.url;
							thumb = res.filename;
							document.getElementById('add-thumbnail').style.display = "none";
							mui('#thumbnail-cont')[0].style.display = "block";
						} else {
							message("上传失败，请重试！")
						}
					});
				})

				mui('.mui-content').on('tap', '#add_submit', function() {
					document.querySelector('textarea').blur();
					title = document.querySelector('textarea').value;
					articleAddSubmit();
				})
			})

			//添加文章提交
			function articleAddSubmit() {
				if (title.length == 0) {
					message('请输入文章标题!', 'center');
					return;
				}
				if (thumb.length == 0) {
					message('请选择文章缩略图!', 'center');
					return;
				}
				if (content.length == 0) {
					message('请添加文章内容!', 'center');
					return;
				}
				mui.post($ajaxUrl + 'article', {
					action: "article_add",
					token: userInfo.token,
					title: title,
					thumb: thumb,
					content: content,
					id: articleId
				}, function(res) {
					if (res.errno == 0) {
						message('操作成功!', 'center');
						var articleList = plus.webview.currentWebview().opener();
						plus.webview.hide('my_article', 'none');
						plus.webview.close('my_article', 'none');
						setTimeout(function() {
							openPage('my_article.html','my_article','#f7f7f7','');
						}, 1200)
					} else {
						message(res.message, 'center');
					}
				}, 'json');
			}

			//获取文章详情
			function getArticleInfo() {
				if (!articleId) {
					return;
				}
				mui.get($ajaxUrl + 'article', {
					token: userInfo.token,
					action: 'article_info',
					id: articleId
				}, function(res) {
					// logs(res);
					if (res.errno == 0) {
						title = res.data.title;
						thumb = res.data.thumb_path;
						content = res.data.content;

						document.querySelector('textarea').value = title;

						mui('#thumbnail')[0].src = res.data.thumb;
						document.getElementById('add-thumbnail').style.display = "none";
						mui('#thumbnail-cont')[0].style.display = "block";

						if (content.length != 0) {
							document.getElementById('edit-article').innerText = '修改正文内容';
						} else {
							document.getElementById('edit-article').innerText = '添加正文内容';
						}
					}
				}, 'json')
			}
		</script>
	</body>

</html>
