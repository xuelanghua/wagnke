<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>激活码</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/vip-page.css" rel="stylesheet" />
		<style type="text/css">
			body {
				touch-action: none;
			}

			.mui-backdrop {
				z-index: 8;
			}

			#middlePopover {
				left: 0 !important;
				top: 84px !important;
				width: 100% !important;
				margin: 0 !important;
				border-radius: 0;
				box-shadow: none;
				background-color: #ffffff;
				text-align: center;
				position: fixed;
				z-index: 9;
			}

			#middlePopover .mui-table-view-cell {
				justify-content: center;
			}

			#middlePopover .mui-table-view-cell:after {
				right: 15px;
			}

			.mui-popover .mui-table-view {
				background-color: #FFFFFF;
			}

			.mui-popover-arrow {
				display: none;
			}

			#middlePopover .mui-table-view-cell.active {
				color: #2289ff;
			}

			#wayMiddlePopover {
				position: fixed;
				width: 6.36rem;
				height: 7.98rem;
				border-radius: 0.1rem;
				left: 50%;
				top: 50%;
				margin: 0;
				padding: 0;
				margin-left: -3.18rem;
				margin-top: -3.99rem;
				background-color: #f2f2f2;
				overflow: hidden;
			}

			#wayMiddlePopover label img {
				width: 0.54rem;
				height: 0.54rem;
				margin-right: 0.2rem;
			}

			#wayMiddlePopover .mui-input-row.mui-radio {
				height: 1.1rem;
			}

			.mui-radio input[type='radio'] {
				top: 50%;
				margin-top: -14px;
				width: 0.28rem;
				height: 0.26rem;
			}

			#wayMiddlePopover .mui-input-row:after {
				right: 15px;
			}

			/* #wayMiddlePopover .mui-input-row:last-of-type:after {
				display: none;
			} */

			.mui-radio label {
				display: flex;
				align-items: center;
				padding: 0 0.2rem;
				height: 1.1rem;
			}

			#wayMiddlePopover .balance {
				font-size: 0.24rem;
				color: #999999;
				margin-left: 0.27rem;
				margin-bottom: -0.1rem;
			}

			#wayMiddlePopover h2 {
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 0.35rem;
				color: #2a2a2a;
				background-color: #ffffff;
				margin-bottom: 0.15rem;
				height: 1.22rem;
				margin-top: 0;
				font-weight: normal;
			}

			#wayMiddlePopover .mui-input-group::after {
				height: 0;
			}

			#wayMiddlePopover .mui-input-group::before {
				height: 0;
			}

			#wayMiddlePopover .surplus-cont {
				display: flex;
				align-items: center;
				flex-direction: column;
				padding: 0.4rem 0.25rem 0;
			}

			.surplus-cont h5 {
				font-size: 0.28rem;
				color: #999999;
				margin: 0;
			}

			#wayMiddlePopover .surplus-cont h3 {
				font-size: 0.5rem;
				color: #000033;
				margin: 0.3rem 0 0.5rem;
			}

			#wayMiddlePopover .mui-btn.mui-btn-blue {
				background-color: #2289ff;
				height: 0.89rem;
				border-radius: 0.1rem;
				line-height: 0.89rem;
				padding: 0;
				font-size: 0.3rem;
				color: #ffffff;
				border: none;
			}

			#item1 .mui-table-view-cell span {
				color: #333333;
			}

			.mui-segmented-control {
				position: fixed;
				z-index: 9;
			}

			#item1 ul,
			#item2 ul {
				overflow-y: scroll;
				padding-top: 44px;
			}

			.exchange-code {
				position: fixed;
				left: 0;
				bottom: 0;
				width: 100%;
				height: 45px;
				line-height: 45px;
				background-color: #2289FF;
				color: #FFF;
				font-size: 16px;
				text-align: center;
			}

			.mui-segmented-control .mui-control-item {
				width: 50%;
			}

			#item1 .mui-table-view-cell .vip,
			#item2 .mui-table-view-cell .vip {
				padding: 3px 8px 2px;
				font-size: 0.2rem;
				color: #FFFFFF;
				margin-left: 0.2rem;
				border-bottom-left-radius: 0.2rem;
				border-top-right-radius: 0.2rem;
				background: linear-gradient(to right, #B7C4DC, #8A9BB9);
			}

			#item1 .mui-table-view-cell .vip2,
			#item2 .mui-table-view-cell .vip2 {
				background: linear-gradient(to right, #F3E3B9, #E9CB7D);
			}

			#item1 .mui-table-view-cell .vip3,
			#item1 .mui-table-view-cell .vip4,
			#item2 .mui-table-view-cell .vip3,
			#item2 .mui-table-view-cell .vip4 {
				background: linear-gradient(to right, #f4dec6, #e3a472);
			}

			[v-cloak] {
				display: none;
			}
		</style>
		<script type="text/javascript">
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav activate-code-header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title"><a id="action-btn" class="action-btn" href="#middlePopover">激活码</a></h1>
		</header>
		<div id="mui-content" class="mui-content activate-container" v-cloak>
			<div class="mui-segmented-control mui-segmented-control-inverted mui-segmented-control-primary">
				<a class="mui-control-item mui-active" href="#item1">未使用（{{unusedNum}}）</a>
				<a class="mui-control-item" href="#item2">已使用（{{usedNum}}）</a>
			</div>
			<div class="segmentedControl-cont">
				<div id="refresh" v-if="keylist" class="mui-slider-group">
					<!-- 第一个选项卡 -->
					<div id="item1" class="mui-control-content mui-active">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell" v-for="(list,index) in keylist" :key="index">
								<span>{{list.code}}<span class="vip" :class="'vip'+list.group_id">{{list.group_name}}</span></span>
								<button type="button" class="mui-btn mui-btn-primary mui-btn-outlined" @tap="copyToClip(list.code)">赠送</button>
							</li>
						</ul>
					</div>
					<!-- 第二个选项卡 -->
					<div id="item2" class="mui-control-content">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell" v-for="(item,serial) in keylist" :key="serial">
								<div class="left-cont">
									<div class="head-img">
										<img :src="item.avtivate_user_avatar">
									</div>
									<div>
										<h5>{{item.avtivate_user_nickname}}<span class="vip" :class="'vip'+item.group_id">{{item.group_name}}</span></h5>
										<p>{{item.activate_time}}</p>
									</div>
								</div>
								<span>{{item.code}}</span>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<div id="middlePopover" class="mui-popover first-popover">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell" v-if="group_id>index+1" v-for="(item,index) in keyType" @tap="getlist(item.id)"
					 :key="index">
						{{item.name}}
					</li>
				</ul>
			</div>
			<div class="exchange-code">
				兑换激活码
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script src="../js/mui.pullToRefresh.js"></script>
		<script src="../js/mui.pullToRefresh.material.js"></script>
		<script src="../js/mui.picker.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo(),
				pageNum = 1,
				selectId = 1,
				status = 1,
				ishow = true,
				codeId = 0;
			// groupInfo = null;
			mui.init({
				pullRefresh: {
					container: "#refresh",
					down: {
						style: 'circle',
						color: '#2289FF',
						height: '50px',
						auto: false,
						callback: function() {
							pageNum = 1;
							getlist(0);
							mui('#refresh').pullRefresh().refresh(true);
						}
					},
					up: {
						style: 'circle',
						color: '#2289FF',
						height: '50px',
						offset: mui.os.ios ? '0px' : '-50px',
						auto: false,
						contentrefresh: "正在加载...",
						contentnomore: '没有更多数据了',
						callback: function() {
							pageNum += 1;
							getlist(selectId);
						}
					}
				}
			})
			var app = new Vue({
				el: "#mui-content",
				data: {
					// 控制显示几个激活码选项
					group_id: 5,
					keylist: [],
					keyDesc: '',
					unusedNum: 0,
					usedNum: 0,
					fee: 0,
					keyType: [
						// {
						// 	name: '服务中心激活码',
						// 	id: 4
						// }, 
						{
							name: '运营商激活码',
							id: 3
						}, 
						{
							name: '企业版激活码',
							id: 2
						},
						{
							name: '个人版激活码',
							id: 1
						}
					]
				},
				mounted: function() {
					mui.plusReady(function() {
						// getGroupInfo();
						getlist(0);
					});
					mui('#middlePopover').on('tap', 'li', function() {
						mui('#middlePopover').popover('hide');
						var btn = mui("#action-btn");
						btn[0].classList.remove('active');
					});
					// 切换选项卡请求接口
					mui('.mui-segmented-control').on('tap', 'a', function() {
						mui('#middlePopover').popover('hide');
						var btn = mui("#action-btn");
						btn[0].classList.remove('active');
						var link = this.getAttribute('href');
						if (link == '#item1') {
							status = 1;
						} else {
							status = 0;
						}
						pageNum = 1;
						getlist(selectId);
						mui('#refresh').pullRefresh().refresh(true);
					});
					// 监听遮罩是否显示 为了让顶部的箭头处于正常位置
					window.addEventListener('tap', function(e) {
						if (e.target.className == 'mui-backdrop mui-active') {
							var btn = mui("#action-btn");
							btn[0].classList.remove('active');
						} else {}
					}, true)
					mui("#middlePopover").on("tap", "li", function() {
						mui("#middlePopover li").each(function() {
							this.classList.remove('active');
						});
						this.classList.add('active');
					});
					mui(".mui-bar").on('tap', '#action-btn', function() {
						this.classList.toggle('active');
					})

					mui('body').on('tap', '.exchange-code', function() {
						openPage('activation_code_collection.html', 'activation_code_collection', '#f7f7f7', '');
					})
				}
			})

			function getlist(id) {
				selectId = id;
				mui.post($ajaxUrl + 'member&action=activation_code', {
					token: userInfo.token,
					group_id: selectId,
					skip: pageNum,
					status: status,
					limit: 10
				}, function(res) {
					logs(res);
					var data = res.data.list;
					if (data.length < 1) {
						if (pageNum == 1) {
							app.keylist = [];
							app.userlist = [];
						}
						mui("#refresh").pullRefresh().endPullupToRefresh(true);
					} else {
						app.unusedNum = res.data.valid;
						app.usedNum = res.data.invalid;
						if (pageNum == 1) {
							app.keylist = data;
							mui("#refresh").pullRefresh().endPulldown();
						} else {
							setTimeout(function() {
								app.keylist = app.keylist.concat(data);
								mui("#refresh").pullRefresh().endPullupToRefresh()
							}, 1500)
						}
					}
				}, 'json');
			}

			// function getGroupInfo() {
			// 	mui.get($ajaxUrl + 'member', {
			// 		action: 'group_info'
			// 	}, function(res) {
			// 		logs(res);
			// 		groupInfo = res.data;
			// 	}, 'json');
			// }

			function copyToClip(text) {
				if (mui.os.android) {
					var Context = plus.android.importClass("android.content.Context");
					var main = plus.android.runtimeMainActivity();
					var clip = main.getSystemService(Context.CLIPBOARD_SERVICE);
					plus.android.invoke(clip, "setText", text);
				} else {
					var UIPasteboard = plus.ios.importClass("UIPasteboard");
					var generalPasteboard = UIPasteboard.generalPasteboard();
					// 设置/获取文本内容:  
					generalPasteboard.setValueforPasteboardType(text, "public.utf8-plain-text");
					var value = generalPasteboard.valueForPasteboardType("public.utf8-plain-text");
				}
				mui.toast("复制激活码成功");
			}
		</script>
	</body>

</html>
