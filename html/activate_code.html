<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>激活码</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/vip-page.css" rel="stylesheet" />
		<style type="text/css">
			body {
				touch-action: none;
			}

			.mui-backdrop {
				z-index: 8;
			}

			#middlePopover {
				left: 0 !important;
				top: 84px !important;
				width: 100% !important;
				margin: 0 !important;
				border-radius: 0;
				box-shadow: none;
				background-color: #ffffff;
				text-align: center;
				position: fixed;
				z-index: 9;
			}

			#middlePopover .mui-table-view-cell {
				justify-content: center;
			}

			#middlePopover .mui-table-view-cell:after {
				right: 15px;
			}

			.mui-popover .mui-table-view {
				background-color: #FFFFFF;
			}

			.mui-popover-arrow {
				display: none;
			}

			#middlePopover .mui-table-view-cell.active {
				color: #2289ff;
			}

			#wayMiddlePopover {
				position: fixed;
				width: 6.36rem;
				height: 7.98rem;
				border-radius: 0.1rem;
				left: 50%;
				top: 50%;
				margin: 0;
				padding: 0;
				margin-left: -3.18rem;
				margin-top: -3.99rem;
				background-color: #f2f2f2;
				overflow: hidden;
			}

			#wayMiddlePopover label img {
				width: 0.54rem;
				height: 0.54rem;
				margin-right: 0.2rem;
			}

			#wayMiddlePopover .mui-input-row.mui-radio {
				height: 1.1rem;
			}

			.mui-radio input[type='radio'] {
				top: 50%;
				margin-top: -14px;
				width: 0.28rem;
				height: 0.26rem;
			}

			#wayMiddlePopover .mui-input-row:after {
				right: 15px;
			}

			/* #wayMiddlePopover .mui-input-row:last-of-type:after {
				display: none;
			} */

			.mui-radio label {
				display: flex;
				align-items: center;
				padding: 0 0.2rem;
				height: 1.1rem;
			}

			#wayMiddlePopover .balance {
				font-size: 0.24rem;
				color: #999999;
				margin-left: 0.27rem;
				margin-bottom: -0.1rem;
			}

			#wayMiddlePopover h2 {
				display: flex;
				align-items: center;
				justify-content: center;
				font-size: 0.35rem;
				color: #2a2a2a;
				background-color: #ffffff;
				margin-bottom: 0.15rem;
				height: 1.22rem;
				margin-top: 0;
				font-weight: normal;
			}

			#wayMiddlePopover .mui-input-group::after {
				height: 0;
			}

			#wayMiddlePopover .mui-input-group::before {
				height: 0;
			}

			#wayMiddlePopover .surplus-cont {
				display: flex;
				align-items: center;
				flex-direction: column;
				padding: 0.4rem 0.25rem 0;
			}

			.surplus-cont h5 {
				font-size: 0.28rem;
				color: #999999;
				margin: 0;
			}

			#wayMiddlePopover .surplus-cont h3 {
				font-size: 0.5rem;
				color: #000033;
				margin: 0.3rem 0 0.5rem;
			}

			#wayMiddlePopover .mui-btn.mui-btn-blue {
				background-color: #2289ff;
				height: 0.89rem;
				border-radius: 0.1rem;
				line-height: 0.89rem;
				padding: 0;
				font-size: 0.3rem;
				color: #ffffff;
				border: none;
			}

			#item1 .mui-table-view-cell span {
				color: #333333;
			}

			.mui-segmented-control {
				position: fixed;
				z-index: 9;
			}

			#item1 ul,
			#item2 ul {
				overflow-y: scroll;
				padding-top: 44px;
			}
		</style>
	</head>

	<body class="mui-hidden">
		<header class="mui-bar mui-bar-nav activate-code-header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title"><a id="action-btn" class="action-btn" href="#middlePopover">激活码</a></h1>
		</header>
		<div id="mui-content" class="mui-content activate-container">
			<div class="mui-segmented-control mui-segmented-control-inverted mui-segmented-control-primary">
				<a class="mui-control-item mui-active" href="#item1">未使用（{{unusedNum}}）</a>
				<a class="mui-control-item" href="#item2">已使用（{{usedNum}}）</a>
			</div>
			<div class="segmentedControl-cont">
				<div class="mui-slider-group">
					<!-- 第一个选项卡 -->
					<div id="item1" class="mui-control-content mui-active">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell" v-for="(list,index) in keylist" :key="index"><span>{{list.code}}</span>
								<button v-if="list.activate_status==1" type="button" class="mui-btn mui-btn-primary mui-btn-outlined">赠送</button>
								<button v-else type="button" class="mui-btn mui-btn-outlined action" @tap="actionKey(list.code,list.id,list.group_id)">激活</button>
							</li>
						</ul>
					</div>
					<!-- 第二个选项卡 -->
					<div id="item2" class="mui-control-content">
						<ul class="mui-table-view">
							<li class="mui-table-view-cell" v-for="(item,serial) in keylist" :key="serial">
								<div class="left-cont">
									<div class="head-img">
										<img :src="item.avtivate_user_avatar">
									</div>
									<div>
										<h5>{{item.avtivate_user_nickname}}</h5>
										<p>{{item.activate_time}}</p>
									</div>
								</div>
								<span>{{item.code}}</span>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<div id="middlePopover" class="mui-popover first-popover">
				<ul class="mui-table-view">
					<li class="mui-table-view-cell" v-if="group_id>index+1" v-for="(item,index) in keyType" @tap="getlist(item.id)"
					 :class="[item.id==1?'active':'']" :key="index">{{item.name}}</li>
				</ul>
			</div>
			<!-- 支付方式选择 -->
			<div id="wayMiddlePopover" class="mui-popover">
				<h2>{{keyDesc}}激活</h2>
				<form class="mui-input-group">
					<!-- <div class="mui-input-row mui-radio">
						<label><img src="../image/Alipay.png"><span>支付宝</span></label>
						<input name="radio1" type="radio" value="alipay" checked="checked">
					</div> -->
					<div class="mui-input-row mui-radio">
						<label><img src="../image/WeChat.png"><span>微信</span></label>
						<input name="radio1" type="radio" checked value="wxpay">
					</div>
					<!-- <div class="mui-input-row mui-radio">
						<label><img src="../image/balance.png"><span>余额</span><span class="balance">&yen;580</span></label>
						<input name="radio1" type="radio" value="3">
					</div> -->
				</form>
				<div class="surplus-cont">
					<h5>合计</h5>
					<h3>&yen;&nbsp;{{ fee }}</h3>
					<button type="button" class="mui-btn mui-btn-blue mui-btn-block mui-pay">确认支付</button>
				</div>
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/vue.min.js"></script>
		<script src="../js/mui.pullToRefresh.js"></script>
		<script src="../js/mui.pullToRefresh.material.js"></script>
		<script src="../js/mui.picker.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo(),
				pageNum = 1,
				selectId = 1,
				status = 1,
				codeId = 0,	
				groupInfo = null,
				//支付相关变量
				payType = 'wxpay',
				wxChannel = null, // 微信支付
				aliChannel = null, // 支付宝支付
				channel = null, //支付通道
				ALIPAYSERVER = $ajaxUrl + 'member&action=code_activate',
				WXPAYSERVER = $ajaxUrl + 'member&action=code_activate';
			mui.init({
				pullRefresh: {
					container: "#mui-content",
					down: {
						style: 'circle',
						color: '#2289FF',
						height: '50px',
						auto: false,
						callback: function() {
							pageNum = 1;
							getlist(selectId);
							mui('#mui-content').pullRefresh().refresh(true);
						}
					},
					up: {
						style: 'circle',
						color: '#2289FF',
						height: '50px',
						auto: false,
						contentrefresh: "正在加载...",
						contentnomore: '没有更多数据了',
						callback: function() {
							pageNum += 1;
							getlist(selectId);
						}
					}
				}
			})
			var app = new Vue({
				el: "#mui-content",
				data() {
					return {
						// 控制显示几个激活码选项
						group_id: 5,
						keylist: [],
						keyDesc: '',
						unusedNum: 0,
						usedNum: 0,
						fee: 0,
						keyType: [{
							name: '服务中心激活码',
							id: 4
						}, {
							name: '服务站激活码',
							id: 3
						}, {
							name: '创客激活码',
							id: 2
						}, {
							name: 'VIP激活码',
							id: 1
						}]
					}
				},
				created: () => {
					var ishow = true;
					// 初始化字体大小
					var viewport = document.documentElement.clientWidth;
					if (viewport > 750) {
						viewport = 750
					}
					document.documentElement.style.fontSize = viewport / 7.5 + "px";
					// 初始化字体大小结束
					mui.plusReady(function() {
						plus.webview.currentWebview().setStyle({
							statusbar: {
								background: '#ff0000'
							},
							top: 0,
							bottom: 0
						});
						getGroupInfo();
						getlist(1);
						// 支付相关
						// 获取支付通道  
						plus.payment.getChannels(function(channels) {
							for (var i in channels) {
								if (channels[i].id == "wxpay") {
									wxChannel = channels[i];
								} else {
									aliChannel = channels[i];
								}
							}
						}, function(e) {
							plus.nativeUI.alert("获取支付通道失败：" + e.message, null, '提示');
						});
					});
				},
				mounted: () => {
					document.querySelector(".mui-hidden").classList.remove("mui-hidden");
					mui('#middlePopover').on('tap', 'li', function() {
						mui('#middlePopover').popover('hide');
						mui('#wayMiddlePopover').popover('hide');
						var btn = mui("#action-btn");
						btn[0].classList.remove('active');
					});
					// 切换选项卡请求接口
					mui('.mui-segmented-control').on('tap', 'a', function() {
						mui('#middlePopover').popover('hide');
						mui('#wayMiddlePopover').popover('hide');
						var btn = mui("#action-btn");
						btn[0].classList.remove('active');
						var link = this.getAttribute('href');
						if (link == '#item1') {
							status = 1;
						} else {
							status = 0;
						}
						pageNum = 1;
						getlist(selectId);
						mui('#mui-content').pullRefresh().refresh(true);
					});
					// 监听遮罩是否显示 为了让顶部的箭头处于正常位置
					window.addEventListener('tap', function(e) {
						if (e.target.className == 'mui-backdrop mui-active') {
							var btn = mui("#action-btn");
							btn[0].classList.remove('active');
						} else {}
					}, true)
					mui("#middlePopover").on("tap", "li", function() {
						mui("#middlePopover li").each(function() {
							this.classList.remove('active');
						});
						this.classList.add('active');
					});
					mui(".mui-bar").on('tap', '#action-btn', function() {
						this.classList.toggle('active');
					})
				}
			})

			function getlist(id) {
				selectId = id;
				mui.post($ajaxUrl + 'member&action=activation_code', {
					token: userInfo.token,
					group_id: selectId,
					skip: pageNum,
					status: status,
					limit: 10
				}, function(res) {
					var data = res.data.list;
					if (res.errno) {
						if (pageNum == 1) {
							app.keylist = [];
						}
						mui("#mui-content").pullRefresh().endPullupToRefresh(true);
					} else {
						app.unusedNum = res.data.valid;
						app.usedNum = res.data.invalid;
						if (pageNum == 1) {
							app.keylist = data;
							mui("#mui-content").pullRefresh().endPulldown();
						} else {
							setTimeout(function() {
								app.keylist = app.keylist.concat(data);
								mui("#mui-content").pullRefresh().endPullupToRefresh()
							}, 1500)
						}
					}
				}, 'json');
			}
			
			// 弹出支付
			function actionKey(key, keyid, group_id) {
				mui('#wayMiddlePopover').popover('show');
				codeId = keyid;
				mui.each(groupInfo, function(index, item) {
					if (item.id == group_id) {
						app.fee = parseFloat((item.activation_fee * 10 / 100));
					}
				})
				app.keyDesc = key;
			}
			// 选择支付方式
			var payTarget = document.getElementsByTagName("mui-radio");
			for (var i = 0; i < payTarget.length; i++) {
				if (payTarget[i].checked) {
					message(payTarget[i].value);
				}
			}
			
			mui('.mui-content').on('tap', '.mui-pay', function() {
				if (payType.length == 0) {
					message('请选择支付方式!');
					return;
				}
				mui('#wayMiddlePopover').popover('hide');
				pay(payType);
			}) 
			// 监听选择的支付方式
			// 2. 发起支付请求  
			function pay(id) {
				// 从服务器请求支付订单
				var PAYSERVER = '';
				if (id == 'alipay') {
					message("暂不支持支付宝支付!", 'center');
					return;
					PAYSERVER = ALIPAYSERVER;
					channel = aliChannel;
				} else if (id == 'wxpay') {
					PAYSERVER = WXPAYSERVER;
					channel = wxChannel;
				} else {
					message("不支持此支付通道!", 'center');
					return;
				}
				var waiting = plus.nativeUI.showWaiting();
				mui.post(PAYSERVER, {
					code_id: codeId,
					fee: app.fee,
					pay_type: payType,
					token: userInfo.token
				}, function(res) {
					console.log(JSON.stringify(res));
					waiting.close();
					if (res.errno == 0) {
						var data = res.data;
						var param = {
							appid: data.appid,
							noncestr: data.nonce_str,
							package: 'Sign=WXPay',
							partnerid: data.mch_id,
							prepayid: data.prepay_id,
							timestamp: data.timeStamp,
							sign: data.paySign
						};

						plus.payment.request(channel, param, function(result) {
							//                  	console.log(JSON.stringify(result));
							plus.nativeUI.alert("支付成功！", function() {
								plus.navigator.setStatusBarStyle('dark');
								mui.fire(plus.webview.getWebviewById('H54F3E71F'), 'activationSuccess');
								mui.back();
							});
						}, function(error) {
							console.log(JSON.stringify(error));
							plus.nativeUI.alert("支付失败：" + error.code);
						});
					} else {
						plus.nativeUI.alert(res.message, null, '提示');
					}
				}, 'json')
			}
			
			function getGroupInfo() {
				mui.get($ajaxUrl + 'member',{
						action: 'group_info'
					}, function(res){
						groupInfo = res.data;
					}, 'json'
				);
			}
		</script>
	</body>

</html>
