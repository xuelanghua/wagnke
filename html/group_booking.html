<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/showLoading.css" rel="stylesheet" />
		<style>
			p{
				color: #333333;
			}
			.mui-bar{
				background-color: #FFFFFF;
			}
			.nr{
				background: #333333;
				color: #FFFFFF;
			}
			.search{
				margin: 0.625rem;
				padding: 0 10px;
				border-radius: 0.3125rem;
				border: 1px solid #DDDDDD;
				background-color: #FFFFFF;
			}
			.mui-icon{
				font-size: 20px;
			}
			.search input{
				width: 90%;
				margin: 0;
				border: none;
				padding: 3px;
				font-size: 0.875rem;
			}
			
			.mui-card .mui-control-content {
				padding: 10px;
			}
			.chart{
				width: 1.6rem;
				height: 1.6rem;
				flex-shrink: 0;
				position: relative;
			}
			.chart img{
				width: 100%;
				height: 100%;
				object-fit: cover;
			}
			.customer_information{
				font-size: 14px;
				width: 5rem;
			}
			.customer-content{
				flex-grow: 1;
				padding-left: 0.36rem;
				line-height: 1.5;
			}
			.genduo{
				background-color: #EAEBED;
				font-size: 20px;
				color: #8F8F8F;
				line-height: 5px;
				padding: 0 8px 10px 8px;
				border-radius: 10px;
				position: absolute;
				right: 0;
				z-index: 8;
			}
			.mui-table-view-cell{
				padding: 15px;
				position: relative;
			}
			.playb{
				width: auto;
				position: absolute;
				padding: 10px 0 5px 0;
				right: 15%;
				border-radius: 5px;
				background-color: rgba(51,51,51,0.85);
				display: none;
				bottom: 25px;
				z-index: 1045;
			}
			.jiao{
				width: 0;
				height: 0;
				border-top: 10px solid transparent;
				border-bottom: 7px solid transparent;
				border-left: 10px solid #515151;
				float: right;
				margin-top: 10px;
				margin-right: -9px;
			}
			.play{
				width: auto;
				color: #FFFFFF;
				font-size: 12px;
				float: left;
				margin-left: 5px;
				text-align: center;
				padding: 0 0.2rem;
				line-height: 1.6;
				position: relative;
			}
			.play:after{
				content: '';
				position: absolute;
				width: 1px;
				height: 50%;
				top: 20%;
				right: 0;
				background-color: #F9F9F9;
				-webkit-transform: scaleX(0.5);
				transform: scaleX(0.5);
				opacity: 0.2;
			}
			.play:last-of-type:after{
				display: none;
			}
			.play img{
				width: 16px;
				margin: 0;
			}
			.add_merchandise{
				width: 100%;
				position: fixed;
				bottom: 0;
				padding: 0;
				height: 1rem;
				border: none;
				border-radius: 0;
				font-size: 16px;
				background-color: #F4CA3A;
				color: #ffffff;
				z-index: 12;
				display: flex;
			}
			.add_merchandise button{
				background-color: transparent;
				border: none;
				color: #FFFFFF;
				width: 100%;
				margin: 0;
				padding: 0;
				display: inline-flex;
				height: 100%;
				font-size: 0.3rem;
				justify-content: center;
				position: relative;
			}
			.add_merchandise button:active{
				background-color: transparent;
			}
			.mui-table-view-cell.mui-active{
				background: #FFFFFF;
			}
			
			.mui-search input {
				background-color: #fff;
				border-radius: 0.3125rem;
				border: 1px solid #DDD;
			}
			
			.mui-table-view::before,.mui-table-view::after{
				height: 0;
			}
			.mui-table-view{
				background: transparent;
			}
			.mui-table-view-cell{
				background-color: #FFFFFF;
				display: flex;
				align-items: center;
			}
			.mui-bar-nav~.mui-content{
				padding-top: 98px;
				padding-bottom: 60px;
			}
			
			.right-bottom-cont{
				display: flex;
				align-items: center;
				position: relative;
				color: #999999;
				font-size: 0.24rem;
			}
			.price-container{
				font-size: 0.24rem;
				padding: 0.1rem 0;
			}
			.right-bottom-cont span:first-of-type,
			.price-container span:first-of-type{
				margin-right: 0.44rem;
			}
			.price-container span:first-of-type{
				color: #F52E20;
			}
			.right-bottom-cont span{
						display: inline-flex;
						align-items: center;
			}
			.right-bottom-cont span img{
				width: 13px;
				height: auto;
				margin-right: 2px;
			}
			.status-mask{
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
				background-color: rgba(0,0,0,0.6);
				display: flex;
				align-items: center;
				justify-content: center;
				color: #FFFFFF;
				font-size: 14px;
			}
			.status-mask.defeated{
				color: #FF0000;
			}
			.mui-backdrop {
				 background-color: rgba(0,0,0,0);
			}
			body{
				-webkit-overflow-scrolling: touch;
			}
			.mui-badge.mui-badge-blue{
				background-color: #fff7dd;
				color: #f5ca3a;
			}
			/* .mui-badge.mui-badge-blue:last-of-type{
				margin-left: 5px;
			} */
			[v-cloak] {
				display: none;
			}
		</style>
		<script type="text/javascript">
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
		</script>
	</head>
	<body id="body_tap">
		<header class="mui-bar mui-bar-nav">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<h1 class="mui-title">拼团</h1>
		</header>
		<div class="mui-content mui-clearfix" id="mui-content" v-cloak>
			<div style="position: fixed;top:44px;z-index: 12;background-color: #F5F6F8;width: 100%;">
				<div class="mui-input-row mui-search" style="margin: 10px 10px -5px 10px;">
					<input type="search" class="mui-input-clear" v-model="goodsName" name="goods_name" placeholder="搜索商品名称">
				</div>
			</div>
			<div id="goods_container" class="goods-container">
				<ul class="mui-table-view" id="item1_list">
					<li class="mui-table-view-cell" :class="lst.check_status==1?'':'lucid-active'" v-for="(lst,i) in on_sale_list"
					 :key="i">
						<div class="chart" @tap="openGoodsDetail(lst.id,lst.is_team_goods)">
							<img :src="lst.cover">
						</div>
						<div class="customer-content">
							<div class="customer_information mui-ellipsis" @tap="openGoodsDetail(lst.id,lst.is_team_goods)">
								{{lst.name}}
							</div>
							<div class="price-container" @tap="openGoodsDetail(lst.id,lst.is_team_goods)">
								<span>&yen;{{lst.price}}</span>
							</div>
							<div class="right-bottom-cont">
								<span @tap="openGoodsDetail(lst.id,lst.is_team_goods)">库存：{{lst.stock}}</span>
								<span v-if="lst.is_team_goods==1" @tap="openGoodsDetail(lst.id,lst.is_team_goods)"><img src="../image/icon/qiyec-icon.png"
									 alt="">企业仓</span>
								<span v-if="lst.is_team_goods==9" @tap="openGoodsDetail(lst.id,lst.is_team_goods)"><img src="../image/icon/wagnkezc-icon.png"
									 alt="">旺客总仓</span>
								<span class="genduo" :data-ids="lst.id">...</span>
							</div>
							<div>
								<span class="mui-badge mui-badge-blue">已拼：{{lst.collage_order}}单</span>
							</div>
							<div class="playb" :class="'playb'+lst.id">
								<div class="jiao"></div>
								<div class="play" @tap="editGroupBooking(lst)">
									<img src="../image/icon/bottom-section-05-white.png" />
									<div>添加规则</div>
								</div>
								<div class="play" @tap="delGroupBooking(i,lst.id)">
									<img src="../image/icon/bottom-section-04-white.png" />
									<div>删除拼团</div>
								</div>
							</div>
						</div>
					</li>
					<div v-if="on_sale_status">
						<img style="width: 60%;display: block;margin: 20% auto 0;" class="no-friends" src="../image/icon/void-goods.png">
						<p style="text-align: center;color:#717171;">暂无商品</p>
					</div>
				</ul>
			</div>
			<div class="add_merchandise" id="group_booking_select">
				<button>创建拼团</button>
			</div>
		</div>
	</body>
</html>
<script src="../js/mui.js"></script>
<script src="../js/util.js"></script>
<script src="../js/vue.min.js"></script>
<script type="text/javascript">
	var userInfo = getUserInfo();
	// 当前产品对象
	var fresh = '';
	var currentIdx = -1;
	var mask = mui.createMask(function() {
		document.querySelector(".playb" + currentId).style.display = 'none';
	});
	var skip = 1,
		limit = 8,
		currentId = '';
	var app = new Vue({
		el: "#mui-content",
		data: {
			goodsName: '',
			on_sale_list: [],
			on_sale_status: false,
		},
		created: function() {
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束	
		},
		methods: {
			openGoodsDetail: function(gid, type) {
				openPage('group_booking_detail.html', 'group_booking_detail', '#f7f7f7', {
					gid: gid
				})
			},
			delGroupBooking: function(i, gid) {
				mask.close();
				plus.nativeUI.confirm("确认删除该拼团？", function(e) {
					if (e.index == 1) {
						return false;
					}
					mui.post($ajaxUrl + 'marketing', {
						action: 'delete_collage_all',
						token: userInfo.token,
						goods_id: gid
					}, function(res) {
						// logs(res);
						if (res.errno == 0) {
							app.on_sale_list.splice(i, 1);
							if (app.on_sale_list.length == 0) {
								app.on_sale_status = true;
							}
							message("删除成功！");
						} else {
							message(res.message);
						}
					}, 'json');
				})
			},
			editGroupBooking: function(e) {
				mask.close();
				openPage("group_booking_create.html", "group_booking_create", "#ffffff", {
					goods: e,
				})
			}
		},
		mounted: function() {
			mui.init({
				swipeBack: false,
				pullRefresh: {
					container: "#goods_container",
					up: {
						height: 50,
						auto: false,
						contentrefresh: "正在加载...",
						contentnomore: '没有更多数据了',
						callback: function() {
							fresh = "up";
							skip += 1;
							getGoodsList('up');
						}
					},
					down: {
						style: 'circle',
						color: '#2289FF',
						height: '50px',
						range: '100px',
						offset: '-50px',
						auto: false,
						callback: function() {
							fresh = "down";
							skip = 1;
							getGoodsList('down');
						}
					}
				}
			});
			mui.plusReady(function() {
				eventInit();
				window.addEventListener('goodsAddSuccess', function() {
					getGoodsList(false);
				})
				getGoodsList(false);
			})
			if (mui.os.ios) {
				document.addEventListener('tap', function() {
					document.querySelector(".playb" + currentId).style.display = 'none';
				})
			} else {
				// 不采取操作
			}
		}
	})

	function eventInit() {
		// 搜索
		document.onkeydown = function(event) {
			var e = event || window.event || arguments.callee.caller.arguments[0];
			if (e && e.keyCode == 13) { // enter 键
				getGoodsList();
			}
		};
		//展示商品弹窗
		mui(".mui-table-view").on('tap', '.genduo', function(e) {
			var glist = document.querySelectorAll(".playb");
			for (i = 0; i < glist.length; i++) {
				glist[i].style.display = "none";
			}
			currentId = this.dataset.ids;
			document.querySelector(".playb" + currentId).style.display = 'block';
			if (mui.os.ios) {
				//不采取操作
			} else {
				mask.show();
			}
			e.stopPropagation();
		})
	}
	//获取商品列表
	function getGoodsList() {
		mui.post($ajaxUrl + 'marketing', {
			action: 'collage_list',
			token: userInfo.token,
			skip: skip,
			limit: 10,
			goods_name: app.goodsName
		}, function(res) {
			// logs(res);
			if (res.errno == 0) {
				if (skip == 1) {
					app.on_sale_list = res.data;
				} else {
					app.on_sale_list = app.on_sale_list.concat(res.data);
				}
				if (fresh == "down") {
					mui('#goods_container').pullRefresh().endPulldownToRefresh();
				} else if (fresh == "up") {
					mui('#goods_container').pullRefresh().endPullupToRefresh(false);
				}
				app.on_sale_status = false;
			} else {
				if (skip == 1) {
					app.on_sale_list = [];
					app.on_sale_status = true;
				}
				mui('#goods_container').pullRefresh().endPullupToRefresh(true);
			}
			if (fresh == "down") {
				mui('#goods_container').pullRefresh().endPulldownToRefresh();
			}
		}, 'json');
	}
	// 取消搜索
	mui('.mui-content').on('tap', '.mui-icon-clear', function() {
		app.goodsName = '';
		getGoodsList();
	})
	// 创建拼团
	mui('.mui-content').on('tap', '#group_booking_select', function() {
		openPage("group_booking_select.html", "group_booking_select", "#FFFFFF")
	})
	// 判断软键盘是否弹起
	var originalHeight = document.documentElement.clientHeight || document.body.clientHeight;
	window.onresize = function() {
		//软键盘弹起与隐藏  都会引起窗口的高度发生变化
		var resizeHeight = document.documentElement.clientHeight || document.body.clientHeight;
		var paddeds = document.querySelector(".add_merchandise");
		var focus = document.querySelector('input:focus');
		if (resizeHeight * 1 < originalHeight * 1 && focus) {
			paddeds.style.display = 'none';
		} else {
			paddeds.style.display = 'flex';
		}
	}
	window.addEventListener('reloadMyself', function() {
		getGoodsList();
		// logs("刷新成功！");
	})
</script>
