<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>二维码名片</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/card_theme.css" rel="stylesheet" />
		<style type="text/css">
			html,
			body {
				height: 100%;
				width: 100%;
				background-color: #2889FF;
				padding-bottom: 0.5rem;
			}

			.mui-content {
				padding: 0;
				min-height: 100%;
				box-sizing: border-box;
				background-color: #2889FF;
			}

			.qr-code-body {
				width: 90%;
				height: auto;
				position: relative;
				border-radius: 5px;
				margin: 60px auto 25px;
				background-size: contain;
				overflow: hidden;
				display: flex;
				flex-direction: column;
				box-sizing: border-box;
				background-color: #FFFFFF;
				padding: 8px;
			}

			.operation-section {
				width: 100%;
				padding: 0 0.53rem 0.5rem;
				display: flex;
			}

			.operation-section .mui-btn,
			.operation-section .mui-btn:active {
				flex-grow: 1;
				margin: 0 0.2rem;
				height: 0.79rem;
				border-radius: 0.1rem;
				color: #333333;
				background-color: #FFFFFF;
				outline: none;
				border: none;
			}

			.setting-card {
				height: 44px;
				position: relative;
				align-items: center;
				justify-content: center;
				padding: 0 10px;
				z-index: 16;
				font-size: 14px;
				color: #333333;
				/* background-color: #007AFF; */
				margin-right: -5px;
				display: none;
			}

			.qr-img {
				width: auto;
				height: auto;
			}

			.qr-code-body .default-user-name {
				font-size: 0.28rem;
				color: #323333;
				font-weight: normal;
				margin-bottom: 0.1rem;
			}

			.qr-code-body .default-desc {
				margin: 0;
				font-size: 0.24rem;
				color: #999999;
			}


			.qr-code-body .qr-img {
				width: 4.2rem;
				height: 4.2rem;
				margin: 0.3rem auto 0.3rem;
				align-self: center;
			}

			.qr-code-body .logo-img {
				width: 1.24rem;
				height: auto;
				align-self: center;
			}

			.linellae {
				height: 0.3rem;
				margin-top: 0.38rem;
				width: 120%;
				margin-left: -15px;
				margin-right: -15px;
				overflow: hidden;
				text-align: justify;
				display: flex;
				align-items: center;
			}

			.team-qr-code {
				position: relative;
			}

			.line {
				border-top: 1px dashed #999999;
				transform: scaleY(0.5);
				-webkit-transform: scaleY(0.5);
				width: 100%;
				height: 0;
			}

			.left-semicircle,
			.right-semicircle {
				width: 0.15rem;
				height: 0.3rem;
				background-color: #2289FF;
				border-radius: 0 0.3rem 0.3rem 0;
				position: absolute;
				z-index: 10;
			}

			.right-semicircle {
				border-radius: 0.3rem 0 0 0.3rem;
				right: 0;
			}

			.left-semicircle {
				left: 0;
			}

			.operation-section .mui-btn,
			.operation-section .mui-btn:active {
				flex-grow: 1;
				margin: 0 0.2rem;
				height: 0.79rem;
				border-radius: 0.1rem;
				color: #333333;
				background-color: #FFFFFF;
				outline: none;
				border: none;
			}

			.operation-section .mui-btn-outlined,
			.operation-section .mui-btn-outlined:active {
				color: #ffffff;
				background-color: rgba(255, 255, 255, 0);
				border: 1px solid #ffffff;
			}

			.qrcode-section {
				display: flex;
				align-items: center;
				padding-left: 0.2rem;
				margin-top: 0.3rem;
			}

			.default-user-head-img {
				width: 0.8rem;
				height: 0.8rem;
				border-radius: 0.1rem;
				margin-right: 0.1rem;
				box-shadow: 0 0 1px 0 rgba(0, 0, 0, 0.3);
				-webkit-box-shadow: 0 0 1px 0 rgba(0, 0, 0, 0.3);
			}

			.change {
				position: absolute;
				top: 0;
			}

			/* 默认主题 */
			.default-theme-container {
				width: 100%;
				height: 450px;
				display: flex;
				flex-direction: column;
				background: #ffffff url("../image/scana-qr-bottom-bg.png")center bottom no-repeat;
				background-size: contain;
				padding: 0.2rem 0.2rem 0;
				margin-bottom: -0.15rem;
			}

			.default-theme-container .qr-img {
				margin: 0.8rem 0 0.5rem;
			}

			/* 第五个样式 */
			.theme5 {
				width: 100%;
				overflow: hidden;
				position: relative;
				font-size: 0;
				line-height: 0;
				background-color: #0062CC;
			}

			.theme5 .bg-img {
				width: 100%;
				height: auto;
				z-index: 1;
			}

			.theme5-container {
				position: absolute;
				top: 0;
				bottom: 0;
				width: 100%;
				z-index: 2;
				display: flex;
				flex-direction: column;
				align-items: center;
				padding: 0.8rem 0.43rem;
				/* background-color: #0062CC; */
				min-height: 10.88rem;
			}

			.theme5-logo {
				width: 60%;
				height: auto;
				margin-bottom: 2.4rem;
			}

			.theme5 .theme5-area {
				width: 100%;
				background: transparent;
				border: none;
				text-align: left;
				color: #FFFFFF;
				padding: 0;
				font-size: 0.3rem;
			}

			.theme5 .theme5-area::-webkit-input-placeholder {
				text-align: left;
				color: #FFFFFF;
				font-size: 0.3rem;
			}

			.theme5 .qrimg {
				width: 1.8rem;
				bottom: 1rem;
				right: 0.4rem;
				position: absolute;
			}

			.theme5 .theme5-timer {
				position: absolute;
				top: 1rem;
				left: 0.6rem;
				color: #FFFFFF;
				font-size: 0.42rem;
				width: 1.94rem;
				color: #ffffff;
				text-shadow: 1px 1px 1px rgba(0, 0, 0, 0.2);
			}

			.theme5 .theme5-timer img {
				width: 100%;
				height: auto;
			}

			.timer-cont {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 0.1rem;
				margin-left: -0.1rem;
			}

			.timer-cont span {
				font-size: 0.92rem;
			}

			.timer-cont h4 {
				font-weight: normal;
				font-size: 0.42rem;
				margin-bottom: 6px;
			}

			.timer-cont p {
				font-size: 0.25rem;
				color: #FFFFFF;
			}

			.theme5 .left-bottom-cont {
				position: absolute;
				left: 0.4rem;
				bottom: 0.8rem;
				width: 4.2rem;
			}

			.theme5 .left-bottom-cont img {
				width: 1.47rem;
				height: auto;
				display: block;
				margin-bottom: 0.4rem;
			}

			.theme5 .left-bottom-cont p {
				font-size: 0.24rem;
				line-height: 1.6;
				width: 3.4rem;
				color: #FFFFFF;
			}

			.theme4 .theme4-qrimg-cont {
				margin-bottom: 10px;
			}

			[v-cloak] {
				display: none;
				transition: all 0.25 ease-in-out;
				-webkit-transition: all 0.25 ease-in-out;
			}
		</style>
		<script type="text/javascript">
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<h1 class="mui-title">二维码名片</h1>
			<div class="mui-pull-right setting-card">
				<span>编辑样式</span>
			</div>
		</header>
		<div class="mui-content" id="mui-content" v-cloak>
			<div class="change" style="position: absolute;top: 60px;left: 44%;color: #FFFFFF;">
				点击切换
			</div>
			<div class="team-qr-code">
				<div id="code-body" class="qr-code-body">
					<!-- 默认主题 -->
					<div v-show="serial==0" class="default-theme-container">
						<div class="qrcode-section">
							<img class="default-user-head-img" :src="userhead||'../image/user_default.jpg'">
							<div>
								<h2 class="default-user-name">{{username}}</h2>
								<p class="default-desc">{{description}}</p>
							</div>
						</div>
						<div class="linellae">
							<!-- <div class="left-semicircle"></div> -->
							<div class="line"></div>
							<!-- <div class="right-semicircle"></div> -->
						</div>
						<img class="qr-img" :src="qrpath||'../image/QR.png'">
						<img class="logo-img" src="../image/wangkelogo.png">
					</div>
					<!-- 主题一 -->
					<div v-show="serial==1" id="theme1" class="theme1">
						<img class="bgimg" :src="bgimg">
						<div class="theme-body theme-body1">
							<img class="user-head-img" :src="userhead">
							<h2>{{username}}</h2>
							<div class="input-section mui-text-center">
								<p>{{card_text}}</p>
							</div>
							<div class="theme1-qrimg-cont">
								<img class="qrimg" :src="qrpath">
							</div>
							<p class="type_desc">{{description}}</p>
							<img class="bottom-logo" src="../image/share/box-shadow-logo.png">
						</div>
					</div>
					<!-- 主题二 -->
					<div v-show="serial==2" id="theme2" class="theme2">
						<div class="head-img-cont">
							<img class="bgimg" :src="bgimg">
							<img class="circular-bead" src="../image/share/circular-bead-bg.png">
							<!-- <span class="radius"></span> -->
						</div>
						<div class="theme-body theme-body2">
							<img class="user-head-img" :src="userhead">
							<h2>{{username}}</h2>
							<div class="input-section mui-text-center">
								<p>{{card_text}}</p>
							</div>
							<div class="qrimg-container">
								<img class="qrimg" :src="qrpath">
							</div>
							<p class="type_desc">{{description}}</p>
							<img class="bottom-logo" src="../image/share/box-shadow-logo.png">
						</div>
					</div>
					<!-- 主题三 -->
					<div v-show="serial==3" id="theme4" class="theme4 mui-clearfix">
						<img class="bgimg" :src="bgimg">
						<img class="user-head-img" :src="userhead">
						<h2>{{username}}</h2>
						<img class="bottom-logo" src="../image/share/box-shadow-logo.png">
						<div class="input-section mui-text-center">
							<p>{{card_text}}</p>
						</div>
						<div class="theme4-qrimg-cont">
							<img class="qrimg" :src="qrpath">
						</div>
						<p class="type_desc">{{description}}</p>
					</div>
					<!-- 主题四 -->
					<div v-show="serial==4" id="theme3" class="theme3">
						<div style="min-height: 200px;">
							<img class="bgimg" :src="bgimg">
						</div>
						<div class="theme-body theme-body3">
							<img class="user-head-img" :src="userhead">
							<h2>{{username}}</h2>
							<div class="input-section mui-text-center">
								<p>{{card_text}}</p>
							</div>
							<div class="qr-cont">
								<img class="qrimg" :src="qrpath">
								<p class="type_desc">{{description}}</p>
							</div>
							<img class="bottom-logo" src="../image/share/box-shadow-logo.png">
						</div>
					</div>
					<!-- 主题五 -->
					<div v-show="serial==5" id="theme5" class="theme5">
						<img class="bg-img" :src="bgimg">
						<div class="theme5-container">
							<div class="theme5-timer">
								<div class="timer-cont">
									<span>{{days}}</span>
									<div style="margin-left: 10px;">
										<h4>{{months}}</h4>
										<p>{{years}}</p>
									</div>
								</div>
								<img src="../image/share/theme5-slimg.png">
							</div>
							<img class="qrimg" :src="qrpath">
							<div class="left-bottom-cont">
								<img src="../image/share/theme5-logo.png">
								<p>{{card_text}}</p>
							</div>
						</div>
					</div>
				</div>
				<div class="operation-section mui-clearfix">
					<button type="button" id="saveImage" class="mui-btn mui-btn-outlined">保存到手机</button>
					<button type="button" id="shareImg" class="mui-btn">分享二维码</button>
				</div>
			</div>
			<!-- <img src="" id="#down1"> -->
		</div>
	</body>
	<script src="../js/mui.js"></script>
	<script src="../js/util.js"></script>
	<script src="../js/Zepto.min.js"></script>
	<script src="../js/canvas2image.js"></script>
	<script src="../js/html2canvas.min.js"></script>
	<script src="../js/vue.min.js"></script>
	<script type="text/javascript">
		var userInfo = getUserInfo();
		// logs(userInfo);
		var qrurl = null;
		var toUid = 0;
		var app = new Vue({
			el: "#mui-content",
			data: {
				userhead: '',
				username: '',
				imgtyp: '',
				description: '',
				serial: 0,
				card_text: '',
				bgimg: '',
				qrpath: '../image/QR.png',
				bgimg1: '../image/share/bg-img01.jpg',
				bgimg2: '../image/share/bg-img02.jpg',
				bgimg3: '../image/share/bg-img03.jpg',
				bgimg4: '../image/share/bg-img04.jpg',
				bgimg5: '../image/share/bg-img05.jpg',
				resultStyle: {},
				month: [
					"January",
					"February",
					"March",
					"April",
					"May",
					"June",
					"July",
					"August",
					"September",
					"October",
					"November",
					"December",
				],
				days: '',
				months: '',
				years: ''
			},
			mounted: function() {
				mui('.mui-content').on('tap', '.change', function() {
					if (app.serial < 5) {
						app.serial += 1;
						app.card_text = app.resultStyle['card_text_' + app.serial];
						app.bgimg = app.resultStyle['background_image_' + app.serial + '_url'];
					} else {
						app.serial = 0;
					}
					app.bgimg = app['bgimg' + app.serial];
				})
				mui.init({
					swipeBack: true,
					beforeback: function() {
						var view = plus.webview.currentWebview().opener();
						if (view.id == "qrcode_setting") {
							setStatusBar('#2289ff', 'light');
						}
					}
				});
				var imgPath = "";
				mui.plusReady(function() {
					var _self = plus.webview.currentWebview();
					if (!_self.toUid || _self.toUid == userInfo.id) {
						document.querySelector(".setting-card").style.display = "flex";
					}
					if (_self.toUid) {
						toUid = _self.toUid;
						getToUserInfo();
					} else {
						app.userhead = userInfo.avatarUrl;
						app.username = userInfo.nickName;
					}

					var bitmap = null;
					var save_area = null;
					// 保存图片
					mui(".mui-content").on("tap", "#saveImage", function() {
						var img = document.getElementById("code-body");
						var wht = img.clientHeight + "px";
						save_area = plus.webview.create("business_card_sub_page.html", "business_card_sub_page", {
							backButtonAutoControl: "close",
							background: "transparent",
							left: "5%",
							top: "132px",
							width: "90%",
							height: wht,
							scrollIndicator: "none"
						}, {
							serial: app.serial,
							resultStyle: app.resultStyle
						});
						save_area.show("none", 300, function() {
							mui.later(function() {
								mui.fire(plus.webview.getWebviewById('business_card_sub_page'), 'clip', {
									serial: app.serial,
									resultStyle: app.resultStyle
								});
							}, 1000)
						}, {

						});
						// if (mui.os.android) {
						// 	generateImg('图片保存成功！');
						// } else {
						// 	// 搬这里
						// 	}, function(e) {
						// 		console.log('截屏绘制图片失败：' + JSON.stringify(e));
						// 		message("loser");
						// 	});
						// }
					})
					// 获取二维码
					getQrcodePic();
					// 获取名片样式
					getCardStyle();
					// 设置名片样式
					mui(".mui-bar").on('tap', '.setting-card', function() {
						openPage('setting_share_card.html', 'setting_share_card', '#f7f7f7', '');
					})
					// 分享
					document.getElementById('shareImg').addEventListener('tap', function() {
						generateImg(false);
					})
				})
				// 生成二维码图片
				function generateImg(tips) {
					showload(0);
					html2canvas(document.getElementById("code-body"), {
						useCORS: true,
					}).then(function(canvas) {
						var imgUrl = canvas.toDataURL("image/jpeg", 1);
						baseImgFile(app.serial + 'codeImg', imgUrl, 100, function(i) {
							imgPath = i.target;
							if (tips) {
								plus.gallery.save(i.target);
								message(tips);
							} else {
								shareQrImg();
							}
							showload(1);
						})
					});
				}
				// 分享二维码
				function shareQrImg() {
					plus.share.getServices(function(list) {
						for (var i = 0; i < list.length; i++) {
							if (list[i].authenticated) {
								shares = list[i];
							}
						}
						if (shares != undefined) {
							var msg = {
								type: 'image',
								pictures: [imgPath], //这里的pictures是要分享的图片 该图片放在项目根目录下
								extra: {
									scene: "WXSceneSession"
								}
							};
							shares.send(msg, function(success) {
								message("分享成功!");
								imgPath = '';
							}, function(error) {
								imgPath = '';
								console.log(JSON.stringify(error))
							});
						}
					}, function(e) {
						alert("获取分享服务列表失败：" + e.message);
					});
				}
				//获取二维码图片
				function getQrcodePic() {
					showload(0);
					mui.post($ajaxUrl + 'userqrcode&action=current_qrcode', {
						token: userInfo.token,
						to_uid: toUid
					}, function(res) {
						logs(res);
						if (res.errno == 0) {
							var type = res.data.type;
							qrurl = res.data.url;
							app.qrpath = $ajaxUrl + 'userqrcode&action=make_qrcode&token=' + userInfo.token + '&url=' + res.data.url;
							if (type == 'redpacket') {
								app.description = '扫二维码领红包';
								if (res.data.share_status == 1 && toUid != userInfo.id) {
									message('双向红包需要VIP及以上级别才有效!', 'center');
								}
							} else if (type == 'card') {
								app.description = '扫二维码加我好友';
							} else if (type == 'link') {
								app.description = '扫二维码了解更多精彩';
							} else if (type == 'pic') {
								app.description = '扫二维码看美图';
							}
							setTimeout(function() {
								showload(1);
							}, 500)
						} else {
							setTimeout(function() {
								mui.back();
							}, 2000)
						}
					}, 'json');
				}
				//刷新二维码
				setInterval(function() {
					refreshQrcode();
				}, 10000);
				//刷新二维码
				function refreshQrcode() {
					mui.post($ajaxUrl + 'userqrcode', {
						action: 'make_share_url',
						token: userInfo.token,
						to_uid: toUid
					}, function(res) {
						if (res.errno == 0) {
							app.qrpath = $ajaxUrl + 'userqrcode&action=make_qrcode&token=' + userInfo.token + '&url=' + res.data.url;
						}
					}, 'json');
				}
				// 监听名片更改
				window.addEventListener('changeCard', function() {
					getCardStyle();
				}, false);
				// 获取当前时间给样式五
				this.days = formatDate('d', '');
				this.years = formatDate('y', '');
				var idx = formatDate('m', '');
				idx = idx.replace(0, '') - 1;
				this.months = this.month[idx];
			}
		})
		// 获取名片样式
		function getCardStyle() {
			mui.post($ajaxUrl + 'userqrcode&action=setting_info', {
				token: userInfo.token,
				user_id: toUid
			}, function(res) {
				if (res.errno == 0) {
					app.resultStyle = res.data;
					app.serial = parseInt(res.data.card_type, 10);
					app.card_text = res.data['card_text_' + res.data.card_type];
					app.bgimg = res.data['background_image_' + res.data.card_type + '_url'];
					if (res.data.background_image_1_url.length > 6) {
						app.bgimg1 = res.data.background_image_1_url;
					}
					if (res.data.background_image_2_url.length > 6) {
						app.bgimg2 = res.data.background_image_2_url;
					}
					if (res.data.background_image_3_url.length > 6) {
						app.bgimg3 = res.data.background_image_3_url;
					}
					if (res.data.background_image_4_url.length > 6) {
						app.bgimg4 = res.data.background_image_4_url;
					}
					if (res.data.background_image_5_url.length > 6) {
						app.bgimg5 = res.data.background_image_5_url;
					}
				}
			}, 'json');
		}

		function getToUserInfo() {
			mui.get($ajaxUrl + 'member', {
				action: 'get_userinfo_by_id',
				token: userInfo.token,
				to_uid: toUid
			}, function(res) {
				if (res.errno == 0) {
					app.userhead = res.data.avatar;
					app.username = res.data.name;
				} else {
					plus.nativeUI.alert('用户不存在', function() {
						mui.back();
					})
				}
			}, 'json');
		}
	</script>
</html>
