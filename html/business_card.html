doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title>二维码名片</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/card_theme.css" rel="stylesheet" />
		<style type="text/css">
			html,
			body {
				height: 100%;
				width: 100%;
				background-color: #2889FF;
				padding-bottom: 0.5rem;
			}

			.mui-content {
				padding: 0;
				min-height: 100%;
				box-sizing: border-box;
				background-color: #2889FF;
			}

			.qr-code-body {
				width: 6.8rem;
				height: auto;
				position: relative;
				border-radius: 0.1rem;
				margin: 0.5rem auto;
				background-size: contain;
				overflow: hidden;
				display: flex;
				flex-direction: column;
				box-sizing: border-box;
				background-color: #FFFFFF;
				padding: 0.15rem;
			}

			.operation-section {
				width: 100%;
				padding: 0 0.53rem 0.5rem;
				display: flex;
			}

			.operation-section .mui-btn,
			.operation-section .mui-btn:active {
				flex-grow: 1;
				margin: 0 0.2rem;
				height: 0.79rem;
				border-radius: 0.1rem;
				color: #333333;
				background-color: #FFFFFF;
				outline: none;
				border: none;
			}

			.operation-section .mui-btn-outlined,
			.operation-section .mui-btn-outlined:active {
				color: #ffffff;
				background-color: rgba(255, 255, 255, 0);
				border: 1px solid #ffffff;
			}

			.setting-card {
				height: 44px;
				position: relative;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 0 10px;
				z-index: 16;
				font-size: 14px;
				color: #333333;
				/* background-color: #007AFF; */
				margin-right: -5px;
			}

			.qr-img {
				width: auto;
				height: auto;
			}

			[v-cloak] {
				display: none;
				transition: all 0.25 ease-in-out;
				-webkit-transition: all 0.25 ease-in-out;
			}
		</style>
		<script type="text/javascript">
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<h1 class="mui-title">二维码名片</h1>
			<div class="mui-pull-right setting-card">
				<span>设置名片</span>
			</div>
		</header>
		<div class="mui-content" id="mui-content" v-cloak>
			<div class="team-qr-code">
				<div class="change" style="position: absolute;top: 60px;left: 44%;color: #FFFFFF;">
					<span>change</span>
				</div>
				<div id="code-body" class="qr-code-body">
					<!-- 主题一 -->
					<div v-show="serial==1" id="theme1" class="theme1">
						<img class="bgimg" :src="bgimg1">
						<div class="theme-body theme-body1">
							<img id="user-head-img" class="user-head-img mui-hidden" src="">
							<img class="user-head-img" src="../image/kaol.jpg">
							<h2 id="user-name">旺客</h2>
							<div class="input-section mui-text-center">
								<p>越努力越幸运,越努力越幸运！</p>
							</div>
							<img class="qrimg" :src="qrpath">
							<p class="type_desc">{{description}}</p>
							<img class="bottom-logo" src="../image/share/box-shadow-logo.png">
						</div>
					</div>
					<!-- 主题二 -->
					<div v-show="serial==2" id="theme2" class="theme2">
						<div class="head-img-cont">
							<img class="bgimg" :src="bgimg2">
							<img class="circular-bead" src="../image/share/circular-bead-bg.png">
							<!-- <span class="radius"></span> -->
						</div>
						<div class="theme-body theme-body2">
							<img id="user-head-img" class="user-head-img mui-hidden" src="">
							<img class="user-head-img" src="../image/kaol.jpg">
							<h2 id="user-name">旺客</h2>
							<div class="input-section mui-text-center">
								<p>越努力越幸运！</p>
							</div>
							<img class="qrimg" :src="qrpath">
							<p class="type_desc">{{description}}</p>
							<img class="bottom-logo" src="../image/share/box-shadow-logo.png">
						</div>
					</div>
					<!-- 主题三 -->
					<div v-show="serial==3" id="theme3" class="theme3">
						<img class="bgimg" :src="bgimg3">
						<div class="theme-body theme-body3">
							<img id="user-head-img" class="user-head-img mui-hidden" src="">
							<img class="user-head-img" src="../image/kaol.jpg">
							<h2 id="user-name">旺客</h2>
							<div class="input-section mui-text-center">
								<p>越努力越幸运！</p>
							</div>
							<div class="qr-cont">
								<img class="qrimg" :src="qrpath">
								<p class="type_desc">{{description}}</p>
							</div>
							<img class="bottom-logo" src="../image/share/box-shadow-logo.png">
						</div>
					</div>
					<!-- 主题四 -->
					<div v-show="serial==4" id="theme4" class="theme4 mui-clearfix">
						<img class="bgimg" :src="bgimg4">
						<img class="user-head-img" src="../image/kaol.jpg">
						<h2 id="user-name">旺客</h2>
						<img class="bottom-logo" src="../image/share/box-shadow-logo.png">
						<div class="input-section mui-text-center">
							<p>越努力越幸运！</p>
						</div>
						<img class="qrimg" :src="qrpath">
						<p class="type_desc">{{description}}</p>
					</div>
				</div>
				<div class="operation-section mui-clearfix">
					<button type="button" id="saveImage" class="mui-btn mui-btn-outlined">保存到手机</button>
					<button type="button" id="shareImg" class="mui-btn">分享二维码</button>
				</div>
			</div>
			<img src="" id="#down1">
		</div>
	</body>
	<script src="../js/mui.js"></script>
	<script src="../js/util.js"></script>
	<script src="../js/Zepto.min.js"></script>
	<script src="../js/canvas2image.js"></script>
	<script src="../js/html2canvas.min.js"></script>
	<script src="../js/vue.min.js"></script>
	<script type="text/javascript">
		var userInfo = getUserInfo();
		var app = new Vue({
			el: "#mui-content",
			data: {
				imgtyp: '',
				description: '',
				serial: 1,
				qrpath: '../image/QR.png',
				bgimg1: '../image/share/bg-img01.jpg',
				bgimg2: '../image/share/bg-img02.jpg',
				bgimg3: '../image/share/bg-img03.jpg',
				bgimg4: '../image/share/bg-img04.jpg'
			},
			mounted: function() {
				mui('.mui-content').on('tap', '.change', function() {
					if (app.serial < 4) {
						app.serial += 1;
						// message(app.serial);
					} else {
						app.serial = 1;
					}
				})
				mui.init({
					swipeBack: true,
					beforeback: function() {
						setStatusBar('#2289ff', 'light');
					}
				});
				var imgPath = "";
				var numbers = Date.parse(new Date());
				mui.plusReady(function() {
					document.getElementById('user-head-img').setAttribute('src', userInfo.avatarUrl);
					document.getElementById('user-name').innerText = userInfo.nickName;
					// 获取二维码
					getQrcodePic();
					// 获取名片样式
					getCardStyle();
					// 保存图片
					document.getElementById('saveImage').addEventListener('tap', function() {
						generateImg('图片保存成功！');
					})
					// 设置名片样式
					mui(".mui-bar").on('tap', '.setting-card', function() {
						openPage('setting_share_card.html', 'setting_share_card', '#f7f7f7', '');
					})
					// 分享
					document.getElementById('shareImg').addEventListener('tap', function() {
						generateImg(false);
						// message(imgPath);
						plus.share.getServices(function(list) {
							for (var i = 0; i < list.length; i++) {
								if (list[i].authenticated) {
									shares = list[i];
								}
							}
							if (shares != undefined) {
								var msg = {
									type: 'image',
									pictures: [imgPath], //这里的pictures是要分享的图片 该图片放在项目根目录下
									extra: {
										scene: "WXSceneSession"
									}
								};
								shares.send(msg, function(success) {
									message("分享成功!");
								}, function(error) {
									console.log(JSON.stringify(error))
								});
							}
						}, function(e) {
							alert("获取分享服务列表失败：" + e.message);
						});
					})
				})
				// 生成二维码图片
				function generateImg(tips) {
					plus.nativeUI.showWaiting();
					html2canvas(document.getElementById("code-body"), {
						useCORS: true
					}).then(function(canvas) {
						var imgUrl = canvas.toDataURL("image/jpeg", 1);
						baseImgFile(numbers + 'codeImg', imgUrl, 100, function(i) {
							if (tips) {
								message(tips);
							}
							imgPath = i.target;
							plus.nativeUI.closeWaiting();
						})
					});
				}
				//获取二维码图片
				function getQrcodePic() {
					plus.nativeUI.showWaiting('', {
						width: 60,
						height: 60,
						background: 'rgba(0, 0, 0, 0.9)'
					});
					mui.post($ajaxUrl + 'userqrcode&action=current_qrcode', {
						token: userInfo.token
					}, function(res) {
						// logs(res);
						if (res.errno == 0) {
							var type = res.data.type;
							app.qrpath = $ajaxUrl + 'userqrcode&action=make_qrcode&token=' + userInfo.token + '&url=' + res.data.url;
							// document.getElementById('qr-img').setAttribute('src', url);
							if (type == 'redpacket') {
								app.description = '扫二维码领红包';
							} else if (type == 'card') {
								app.description = '扫二维码加我好友';
							} else if (type == 'link') {
								app.description = '扫二维码了解更多精彩';
							} else if (type == 'pic') {
								app.description = '扫二维码看美图';
							}
							setTimeout(function() {
								plus.nativeUI.closeWaiting();
							}, 500)
						} else {
							message(res.message);
							setTimeout(function() {
								mui.back();
							}, 2000)
						}
					}, 'json');
				}
				// 监听名片更改
				window.addEventListener('changeCard', function() {
					message('执行了');
				}, false);
			}
		})
		// 获取名片样式
		function getCardStyle() {
			mui.post($ajaxUrl + 'userqrcode&action=setting_info', {
				token: userInfo.token
			}, function(res) {
				logs(res);
				if (res.errno == 0) {}
			}, 'json');
		}
	</script>
</html>
