<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>发布动态</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../css/mui.css" rel="stylesheet" />
		<link href="../css/vip-page.css" rel="stylesheet" />
		<style type="text/css">
		</style>
	</head>

	<body class="mui-hidden">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">发布动态</h1>
			<span class="mui-pull-right issue-dynamics">发布</span>
		</header>
		<div class="mui-content issue-dynamics-container">
			<div class="section-issue">
				<input class="issue-title" id="issue-title" type="text" name="title" placeholder="动态名称" />
				<textarea class="issue-desc" id="issue-desc" rows="3" name="desc" placeholder="填写信息内容"></textarea>
			</div>
			<div class="picture_display">
				<div id="pic-container">
					<div class="picture_display_chear" id="add_pic">
						<img src="../image/icon/upload-img-icon.jpg">
					</div>
					<input type="hidden" name="images" />
				</div>
			</div>
			<!-- <div class="issue-dynamics">发布动态</div> -->
		</div>
		<script src="../js/mui.min.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/mui.previewimage.js"></script>
		<script src="../js/upload.js"></script>
		<script type="text/javascript" src="../js/Zepto.min.js"></script>
		<script type="text/javascript">
			mui.init({
				beforeback: function() {
					//获得列表界面的webview
					var myDynamics = plus.webview.currentWebview().opener();　
					mui.fire(myDynamics, 'refresh');
					//返回true，继续页面关闭逻辑
					return true;
				}
			});
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			userInfo = getUserInfo();
			// 初始化字体大小结束
			var imageId = 0;
			var images = new Array();
			mui.plusReady(function() {})
			//上传图片
			document.getElementById('add_pic').addEventListener('tap', function() {
				imageUpload(function(res) {
					images[imageId] = res.url;
					imageId++;
					var newImgDiv = document.createElement('div');
					newImgDiv.setAttribute('data-id', imageId);
					newImgDiv.classList.add('picture_display_chear');
					var html = '<img src="' + res.url +
						'" data-preview-src="" data-preview-group="1" /><span class="mui-close"><span class="mui-icon mui-icon-closeempty" style="font-size: 20px;"></span></span>';
					newImgDiv.innerHTML = html;
					document.getElementById('pic-container').insertBefore(newImgDiv, document.getElementById('add_pic'));
				});
			})

			//删除图片
			mui('#pic-container').on('tap', '.mui-close', function() {
				var parentDiv = this.parentElement;
				var imgId = parentDiv.dataset.id;
				parentDiv.remove();
				delete images[imgId];
			})
			// 发布按钮居底 防止被输入法顶上去
			var height = document.documentElement.clientHeight || document.body.clientHeight;
			document.querySelector(".mui-hidden").classList.remove("mui-hidden");
			document.querySelector('.issue-dynamics').style.top = height - 50 + "px";
			mui(".mui-bar").on("tap", ".issue-dynamics", function(e) {
				e.preventDefault();
				var titles = document.querySelector('input[name=title]').value;
				var contents = document.querySelector('textarea[name=desc]').value
				mui.post($ajaxUrl + 'timeline&action=add', {
					token: userInfo.token,
					title: titles,
					content: contents,
					cover: images.filter(function(e) {
						return e != null
					}).join(',')
				}, function(res) {
					if (res.errno == 0) {
						message("发布成功");
						plus.key.hideSoftKeybord();
						document.querySelector('input[name=title]').value = "";
						document.querySelector('textarea[name=desc]').value = "";
					}
				}, 'json')
			})
		</script>
	</body>

</html>
