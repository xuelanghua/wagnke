<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>自媒体</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/index.css" rel="stylesheet" />
		<link href="../icomoon/style.css" rel="stylesheet" />
		<link href="../css/showLoading.css" rel="stylesheet" />

		<style>
			* {
				margin: 0;
				padding: 0;
				outline: 0;
			}

			body {
				font-family: Helvetica, Arial, Verdana, sans-serif;
				color: #999;
				font-size: 12px;
			}

			.mui-slider-item {
				max-height: 300px;
				overflow: hidden;
			}

			.inner {
				margin: 0 auto;
				padding: 35px 0;
				font-size: 15px;
				position: relative;
				font-family: 'Open Sans', sans-serif;
			}

			.subMenu {
				position: relative;
				/* position: absolute; */
				/* top: 232px; */
				/* z-index: 10; */
			}

			.subMenu .inner {
				padding: 0;
			}

			ul,
			li {
				list-style: none;
			}

			.clearfix {
				clear: both;
			}

			.Information_list {
				background-color: #FFFFFF;
				/* margin-bottom 50px; */
				/* margin-top: 35px; */
			}

			.list1 {
				padding: 15px 10px 15px 0;
				border-bottom: 1px solid #F2F2F2;
				margin-left: 10px;
			}

			.list1L {
				width: 113px;
				height: 80px;
				float: left;
			}

			.list1L img {
				width: 100%;
				height: 100%;
			}

			.list1R {
				width: 65%;
				color: #999999;
				font-size: 12px;
				float: right;
			}

			.list1R p {
				color: #333333;
				font-size: 15px;
				line-height: 23px;
				text-align: left;
				margin-top: -2px;
			}

			.list1Rl {
				float: left;
				margin-top: 10px;
			}

			.list1Rr {
				float: right;
				margin-top: 10px;
			}

			.list1Rr img {
				width: 19px;
				margin-right: 10px;
			}

			#quick {
				width: 80%;
				margin: 0 auto;
				box-shadow: 0 0 15px 3px #D1D1D3;
				border-radius: 20px;
				background-color: #fff;
				display: none;
				margin-top: -133px;
				z-index: 9999;
			}

			#quick li {
				width: 25%;
				float: left;
				margin-top: 15px;
			}

			#quick li img {
				height: 22px;
			}

			#quick li p {
				font-size: 10px;
				color: #000000;
			}

			.jiandou {
				width: 19px;
				position: absolute;
				margin-left: -12px;
			}

			#back {
				position: fixed;
				top: 0;
				left: 0;
				display: none;
				width: 100%;
				height: 100%;
				opacity: 0.5;
			}

			.mui-slider-item img {
				width: 100%;
				height: auto;
			}

			.mui-plus-pullrefresh .subMenu .mui-scroll {
				position: absolute;
			}

			.mui-plus-pullrefresh .subMenu {
				width: 100%;
				overflow: hidden;
			}

			.mui-slider-group {
				height: auto;
			}

			.publish-article {
				height: 44px;
				width: 80px;
				position: relative;
				display: flex;
				align-items: center;
				justify-content: flex-end;
				padding-right: 10px;
				margin-right: -10px;
				font-size: 14px;
				color: #666666;
				z-index: 12;
			}

			.operation-btn {
				width: 45px;
				height: 45px;
				position: fixed;
				left: 50%;
				margin-left: -22.5px;
				bottom: 0;
				opacity: 0.96;
			}

			.mui-bar.mui-bar-nav {
				background-color: #fff;
				box-shadow: none;
			}

			.subMenu.fixed-cont {
				position: fixed;
				top: 44px;
				z-index: 1045;
			}
		</style>
	</head>
	<body>
		<!-- <div style="margin-bottom: 100px;"> -->
		<header class="mui-bar mui-bar-nav">
			<!-- <img src="../image//index-message-icon.png" alt="" class="mui-pull-left" style="width: 25px;height: 22px;margin-top: 11px;"> -->
			<h1 class="mui-title">自媒体</h1>
			<!-- <span class="publish-article mui-pull-right">
				发布文章
			</span> -->
			<!-- <img src="../image//index-add-icon.png" class="mui-pull-right" style="width: 20px;height: 20px;margin-top: 11px;"> -->
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider">
				<!-- <div class="mui-slider-group mui-slider-loop">
				
				<div class="mui-slider-item mui-slider-item-duplicate">
					<a href="#">
						<img src="../image//rotation_chart.png" alt="">
						<p class="mui-slider-title">幸福就是可以一起睡觉</p>
					</a>
				</div>
				<div class="mui-slider-item">
					<a href="#">
						<img src="../image/bj.jpg" alt="">
						<p class="mui-slider-title">静静的看世界1</p>
					</a>
				</div>
				<div class="mui-slider-item mui-slider-item-duplicate">
					<a href="#">
						<img src="../image//rotation_chart.png" alt="">
						<p class="mui-slider-title">幸福就是可以一起睡觉</p>
					</a>
				</div>
				<div class="mui-slider-item mui-slider-item-duplicate">
					<a href="#">
						<img src="../image/bj.jpg" alt="">
						<p class="mui-slider-title">静静的看世界1</p>
					</a>
				</div>
			</div>
			<div class="mui-slider-indicator mui-text-right">
                <div class="mui-indicator mui-active"></div>
                <div class="mui-indicator"></div>
            </div> -->
			</div>
			<div id="subMenu" class="subMenu">
				<div class=" inner mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted"
				 style="background-color: #F5F6F8;">
					<div class="mui-scroll" style="color: #000000;" id="classification">
						<!-- <a class="mui-control-item mui-active">
						推荐
					</a>
					<a class="mui-control-item">
						热点
					</a>
					<a class="mui-control-item">
						昆明
					</a>
					<a class="mui-control-item">
						社会
					</a>
					<a class="mui-control-item">
						娱乐
					</a>
					<a class="mui-control-item">
						科技
					</a> -->
					</div>
				</div>
			</div>

			<div class="Information_list" id="article_list">
				<!-- <div class="list1">
					<div class="list1L">
						<img src="../image//bj.jpg" >
					</div>
					<div class="list1R">
						<p>京城今儿恍如初非夏，明天将有 弱冷空气撒地方大师傅</p>
						<div class="list1Rl">
							<span>小飞飞 </span>
							<span style="margin-left: 10px;">2018-10-20</span>
						</div>
						<div class="list1Rr">
							<span><img src="../image//eye.png" ></span>
							<span>330</span>
						</div>
						<div class="clearfix"></div>
					</div>
					<div class="clearfix"></div>
				</div> -->
			</div>
			<div id="article_bottom" class="mui-scroll-wrapper"></div>
			<img class="operation-btn" src="../image/icon/plus-sign.svg" alt="">
		</div>
		<!-- </div> -->
	</body>
	<script src="../js/mui.js"></script>
	<script src="../js/util.js"></script>
	<!-- <script src="../js/jquery.min.js"></script> -->
	<!-- <script src="../js/jquery.smint.js"></script> -->
	<script src="../js/showLoading.js"></script>

	<script>
		var recommend = 1;
		var hot = 0;
		var cid = 0;
		var skip = 1;
		var limit = 5;
		var loadding = 0;
		mui.init({
			swipeBack: false, //启用右滑关闭功能【一旦取值为false，左右触控滑动将会失效！】
			keyEventBind: {
				backbutton: false, //Boolean(默认true)关闭back按键监听  
				menubutton: true //Boolean(默认true)关闭menu按键监听  
			},
			pullRefresh: {
				container: "#article_bottom", //待刷新区域标识，querySelector能定位的css选择器均可，比如：id、.class等
				up: {
					height: 50,
					auto: true,
					contentrefresh: "正在加载...",
					contentnomore: '没有更多数据了',
					callback: function() {
						pullfresh_function(true, false)
					}
				},
				down: {
					style: 'circle', //单webview模式的下拉刷新 
					color: '#2289FF', //可选，默认“#2BD009” 下拉刷新控件
					callback: function() {
						pullfresh_function(false, true)
					}
				}
			}
		});
		/* var gallery = mui('.mui-slider');
		gallery.slider({
		interval:1000//自动轮播周期，若为0则不自动播放，默认为0；
		}); */
		// var webviewHeight = 0;
		mui.plusReady(function() {
			// plus.navigator.setStatusBarBackground("#2289FF");
			// plus.navigator.setStatusBarStyle('dark');
			// var self = plus.webview.currentWebview();
			// webviewHeight = self.webviewHeight;
			// self.setStyle({
			// 	bottom: 51
			// })
			// 重写返回
			// var first = null;
			// mui.back = function() {
			// 	var main = plus.android.runtimeMainActivity();
			// 	main.moveTaskToBack(false);
			// 	if (!first) {
			// 		first = (new Date()).getTime();
			// 		// logs(first);
			// 		mui.toast('再按一次退出应用');
			// 		setTimeout(function() {
			// 			first = null;
			// 		}, 1000);
			// 	} else {
			// 		var timer = (new Date()).getTime() - first;
			// 		if (timer < 1000) {
			// 			plus.runtime.quit();
			// 		}
			// 	}
			// };

			mui.showLoading("正在加载..", "div");
			window.addEventListener('scrollTop', function(event) {
				window.scrollTo(0, 0);
			});

			window.addEventListener('advSettingFinish', function() {
				console.log('advSettingFinish');
				window.location.reload();
			})
			slideReady(); //幻灯片
			class_list(); //文章分类

			//监听分类点击事件
			mui("#classification").on('tap', 'a', function() {
				//获取id
				var id = this.getAttribute("data-id");
				//更新分类数据
				update_class(id);
			})
			//监听文章列表
			mui("#article_list").on('tap', '.list1', function() {
				//获取id
				var id = this.getAttribute("data-id");
				// 	var styles = {
				// 		top: 20,
				// 		bottom: 0
				// 	};
				// 	var extras = {
				// 		article_id: id
				// 	};
				// 	var w = plus.webview.create('article.html', 'article.html', styles, extras);
				// 	w.show(); // 显示窗口
				openPage('article.html', 'article', '#ffffff', {
					article_id: id
				})
			})

			// window.addEventListener('resizeWindow', function(e) {
			// 	console.log('resizeWindow');
			// 	console.log(webviewHeight);
			// 	plus.webview.currentWebview().setStyle({
			// 		height: webviewHeight - 0.5
			// 	});
			// })

			// window.onresize = function() {
			// 	//软键盘弹起与隐藏  都会引起窗口的高度发生变化
			// 	var resizeHeight = document.querySelector("body").offsetHeight;
			// 	if (resizeHeight * 1 != webviewHeight * 1) {
			// 		console.log('resetWindowHeight');
			// 		console.log(resizeHeight);
			// 		plus.webview.currentWebview().setStyle({
			// 			height: webviewHeight
			// 		});
			// 	}
			// }


			var headH = document.querySelector('header').offsetHeight,
				tab = document.getElementById("subMenu"),
				list=document.getElementById("article_list")
			window.addEventListener('scroll', function(e) {
				if (list.getBoundingClientRect().top <= 90) {
					tab.classList.add('fixed-cont');
				} else {
					tab.classList.remove('fixed-cont');
				}
			});
		})

		function slideReady() {
			mui.ajax({
				url: $ajaxUrl + 'carousel',
				data: {
					position: 2
				},
				//async: true || false, // 异步 || 同步
				async: true,
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				success: function(data) {
					if (data.errno == '0') {
						var str = '';
						if (data.data == '') {
							str +=
								'<div class="mui-slider-group"><div class="mui-slider-item"><a href="javascript: void(0);"><img src="../image/bj.jpg" alt=""><p class="mui-slider-title">只是精神不滑坡，办法总比困难多</p></a></div></div>';
						} else if (data.data.length == 1) {
							str += '<div class="mui-slider-group"><div class="mui-slider-item"><a href="javascript: void(0);"><img src="' +
								data.data[0].pic + '" alt="">';
							if (data.data[0].show_title == 1 && data.data[0].title.length > 0) {
								str += '<p class="mui-slider-title">' + data.data[0].title + '</p>';
							}
							str += '</a></div></div>';
						} else if (data.data.length > 1) {
							str += '<div class="mui-slider-group mui-slider-loop">';
							var k = data.data.length - 1;
							str += '<div class="mui-slider-item mui-slider-item-duplicate"><a href="javascript: void(0);"><img src="' +
								data.data[k].pic + '" alt="">';
							if (data.data[k].show_title == 1 && data.data[k].title.length > 0) {
								str += '<p class="mui-slider-title">' + data.data[k].title + '</p>';
							}
							str += '</a></div>';
							var i = 0;
							for (i in data.data) {
								str += '<div class="mui-slider-item mui-slider-item-duplicate"><a href="javascript: void(0);"><img src="' +
									data.data[i].pic + '" alt="">';
								if (data.data[i].show_title == 1 && data.data[i].title.length > 0) {
									str += '<p class="mui-slider-title">' + data.data[i].title + '</p>';
								}
								str += '</a></div>';
							}
							str += '<div class="mui-slider-item mui-slider-item-duplicate"><a href="javascript: void(0);"><img src="' +
								data.data[0].pic + '" alt="">';
							if (data.data[0].show_title == 1 && data.data[0].title.length > 0) {
								str += '<p class="mui-slider-title">' + data.data[0].title + '</p>';
							}
							str += '</a></div>';
							str += '</div>';
							str += '<div class="mui-slider-indicator mui-text-right">';
							var j = 0;
							for (j in data.data) {
								if (j == 0) {
									str += '<div class="mui-indicator mui-active"></div>';
								} else {
									str += '<div class="mui-indicator"></div>';
								}
							}
							str += '</div>';
						}
					}
					//console.log(str);
					//console.log(JSON.stringify(data));
					document.getElementById('slider').innerHTML = str;
					slider_play();
				},
				error: function(xhr, type, errorThrown) {
					// 请求失败
				}
			});
		}

		function slider_play() {
			var gallery = mui('.mui-slider');
			gallery.slider({
				interval: 2000 //自动轮播周期，若为0则不自动播放，默认为0；
			});
		}

		function class_list() {
			var str = '';
			var url = $ajaxUrl + 'article';
			mui.post(url, {
				token: 'eaa3242cd05ca923b66b60cbb10d01ad',
				action: 'class_list'
			}, function(data) {
				str +=
					'<a class="mui-control-item mui-active" data-id="-1">推荐</a><a class="mui-control-item" data-id="-2">热点</a>';
				if (data.errno == '0') {
					for (i in data.data) {
						str += '<a class="mui-control-item" data-id="' + data.data[i].id + '">' + data.data[i].name + '</a>';
					}
				}
				document.getElementById('classification').innerHTML = str;

				setTimeout(function() {
					mui.hideLoading();
				}, 500);
			}, 'json');
		}


		function pullfresh_function(up, down) {
			var userInfo = getUserInfo();
			var str = '';
			var url = $ajaxUrl + 'article';
			mui.post(url, {
				token: userInfo.token,
				action: 'article_list',
				recommend: recommend,
				hot: hot,
				cid: cid,
				skip: skip,
				limit: limit
			}, function(data) {
				//console.log(JSON.stringify(data));
				if (data.errno == '0') {
					var str = '';
					for (i in data.data) {
						str += '<div class="list1" data-id="' + data.data[i].id + '"><div class="list1L"><img src="' + data.data[i].thumb +
							'" ></div><div class="list1R"><p class="mui-ellipsis-2">' + data.data[i].title +
							'</p><div class="list1Rl"><span>' + data.data[i].author +
							'</span><span style="margin-left: 10px;">' + data.data[i].add_time +
							'</span></div><div class="list1Rr"><span><img src="../image//eye.png" ></span><span>' + data.data[i].click +
							'</span></div><div class="clearfix"></div></div><div class="clearfix"></div></div>';
					}
					if (skip == 1) {
						document.getElementById('article_list').innerHTML = str;
					} else {
						document.getElementById('article_list').innerHTML += str;
					}
					skip++;
				} else {
					loadding = 1;
				}
				if (loadding == 0 && up) {
					mui('#article_bottom').pullRefresh().endPullupToRefresh(false);
					// this.endPullupToRefresh(false);
				} else if (loadding == 1 && up) {
					mui('#article_bottom').pullRefresh().endPullupToRefresh(true);
					// this.endPullupToRefresh(true);
				} else if (down) {
					mui('#article_bottom').pullRefresh().endPulldownToRefresh();
					// this.pullRefresh().endPulldownToRefresh();
				}
			}, 'json');
		}

		function update_class(id) {
			if (id == '-1') {
				recommend = 1;
				hot = 0;
				cid = 0;
			} else if (id == '-2') {
				recommend = 0;
				hot = 1;
				cid = 0;
			} else {
				recommend = 0;
				hot = 0;
				cid = id;
			}
			skip = 1;
			limit = 5;
			loadding = 0;
			article_list();
			mui('#article_bottom').pullRefresh().refresh(true);
			mui('#article_bottom').pullRefresh().enablePullupToRefresh();
		}

		function article_list() {
			var str = '';
			var url = $ajaxUrl + 'article';
			mui.post(url, {
				token: 'eaa3242cd05ca923b66b60cbb10d01ad',
				action: 'article_list',
				recommend: recommend,
				hot: hot,
				cid: cid,
				skip: skip,
				limit: limit
			}, function(data) {
				console.log(JSON.stringify(data));
				if (data.errno == '0') {
					var str = '';
					for (i in data.data) {
						str += '<div class="list1" data-id="' + data.data[i].id + '"><div class="list1L"><img src="' + data.data[i].thumb +
							'" ></div><div class="list1R"><p>' + data.data[i].title + '</p><div class="list1Rl"><span>' + data.data[i].author +
							'</span><span style="margin-left: 10px;">' + data.data[i].add_time +
							'</span></div><div class="list1Rr"><span><img src="../image//eye.png" ></span><span>' + data.data[i].click +
							'</span></div><div class="clearfix"></div></div><div class="clearfix"></div></div>';
					}
					document.getElementById('article_list').innerHTML = str;
					skip++;
				} else {
					document.getElementById('article_list').innerHTML = '';
					//mui('#article_bottom').endPullupToRefresh(true);
					mui('#article_bottom').pullRefresh().disablePullupToRefresh();
				}
			}, 'json');
		}
		mui(".mui-content").on("tap", ".operation-btn", function() {
			mui.openWindow({
				url: "article_operation.html",
				id: "article_operation",
				styles: {
					bounce: 'none',
					scrollsToTop: true,
					popGesture: 'close',
					background: '#ffffff',
					// background: 'transparent',
					statusbar: {
						background: "#ffffff"
					}
				},
				extras: '',
				createNew: false,
				show: {
					autoShow: true,
					aniShow: 'slide-in-bottom',
					duration: 150,
					event: 'titleUpdate',
					extras: {
						acceleration: 'auto',
						capture: '',
						otherCapture: ''
					}
				},
				waiting: {
					autoShow: false
				}
			})
		})
	</script>
</html>
