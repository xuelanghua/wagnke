<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link rel="stylesheet" href="../css/animate.min.css">
		<link rel="stylesheet" href="../css/swiper.min.css">
		<link rel="stylesheet" href="../css/discover.css">
		<style type="text/css">
			[v-cloak] {
				display: none;
			}

			.swiper-container {
				min-height: 281.5px;
			}

			.swiper-slide {
				color: #FFFFFF;
				display: flex;
				align-items: center;
				justify-content: center;
				height: 281.5px;
				width: 100%;
				background-color: #FFFFFF;
			}

			.swiper-slide img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			.swiper-pagination-bullet.swiper-pagination-bullet-active {
				background-color: #FFFFFF;
				opacity: 0.8;
				transform: scale(1.3);
				-webkit-transform: scale(1.3);
				transition: all 0.25s ease-in-out;
				-webkit-transition: all 0.25s ease-in-out;
			}

			.swiper-pagination-bullet {
				background-color: rgba(255, 255, 255, 1);
				opacity: 0.3;
				transition: all 0.25s ease-in-out;
				-webkit-transition: all 0.25s ease-in-out;
			}

			.user-info .user-info-top {
				margin-bottom: 0;
				padding: 10px 0 5px;
			}

			.user-info p {
				font-size: 12px;
				line-height: 1.2;
			}

			.user-info {
				padding-top: 0;
				padding-left: 5px;
			}

			/* test */
			@import url("https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700");

			canvas {
				position: absolute;
				top: 0px;
				left: 0px;
				z-index: 0;
			}

			#welcome {
				position: relative;
				z-index: 1;
				margin: auto 0;
				margin-left: 0;
				background: -webkit-linear-gradient(to right, #fcb045, #fd1d1d, #833ab4);
				/* Chrome 10-25, Safari 5.1-6 */
				background: linear-gradient(to right, #fcb045, #fd1d1d, #833ab4);
				/* W3C, IE 10+/ Edge, Firefox 16+, Chrome 26+, Opera 12+, Safari 7+ */
			}

			.swiper-pagination.activer {
				opacity: 0;
			}

			.operation-btn {
				width: 45px;
				height: 45px;
				position: fixed;
				left: 50%;
				margin-left: -22.5px;
				bottom: 50px;
				opacity: 0.96;
				z-index: 9999;
			}

			.vip0 {
				padding: 0 0.16rem;
				height: 0.3rem;
				overflow: hidden;
				display: inline-flex;
				line-height: 0.3rem;
				font-size: 0.2rem;
				color: #FFFFFF;
				margin-left: 0.2rem;
				border-bottom-left-radius: 0.2rem;
				border-top-right-radius: 0.2rem;
				background: linear-gradient(to right, #c4c4c4, #6f6f6f);
			}

			.void-team-course {
				width: 100%;
				height: auto;
				padding: 20px;
				text-align: center;
				color: #999999;
			}

			.dy-container {
				padding-left: 40px;
			}

			.to-top {
				width: 45px;
				height: 45px;
				background-color: #0062CC;
				position: fixed;
				z-index: 1045;
				right: 10px;
				bottom: 10px;
				opacity: 0.5;
				border-radius: 50%;
				color: #FFFFFF;
				display: flex;
				align-items: center;
				justify-content: center;
				display: none;
			}

			.to-top .mui-icon {
				font-size: 36px;
			}
		</style>
		<script type="text/javascript">
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
		</script>
	</head>

	<body>
		<div id="mui-content" class="mui-content discover-container" v-cloak>
			<footer class="footer mui-bar mui-bar-footer">
				<!-- 评论 -->
				<div class="comment-container">
					<textarea id="comment_matter" rows="" cols="" maxlength="200"></textarea>
					<span class="send-comment">评论</span>
				</div>
			</footer>
			<div class="to-top">
				<!-- 回到顶部 -->
				<span class="mui-icon mui-icon-arrowthinup"></span>
			</div>
			<img v-show="!menuStatus" class="operation-btn" src="../image/icon/plus-sign.svg" alt="">
			<div class="swiper-container">
				<div class="swiper-wrapper">
					<div class="swiper-slide" v-for="(banner,index) in slider" :key="index">
						<img :src="banner">
					</div>
				</div>
				<div class="swiper-pagination" :class="slider.length==1?'activer':''"></div>
			</div>
			<!-- <div id="welcome" style="width: 750px;height: 300px;">
			</div> -->
			<div class="discover-body">
				<div class="user-part1">
					<div class="user-head-cont" @tap="openDynamically(discover_info.id)">
						<div class="user-head-img">
							<img class="head-img" :src="discover_info.avatar">
						</div>
						<img v-if="discover_info.group_id!=0" class="rank" :src="'../image/discover/rank_icon_'+discover_info.group_id+'.png'">
					</div>
					<div class="user-info">
						<div class="user-info-top">
							<div class="user-name mui-ellipsis">{{discover_info.name}}</div>
							<span :class="'vip'+discover_info.group_id">{{discover_info.group_name}}</span>
						</div>
						<p class="signature mui-ellipsis-2">{{discover_info.personalized_signature||'暂无签名'}}</p>
					</div>
				</div>
				<div id="zhanwei" style="width: 100%;height:58px;position: relative;display: none;">
					<!-- 占位 -->
				</div>
				<ul id="screen-menu" class="screen-menu mui-segmented-control mui-segmented-control-inverted mui-segmented-control-primary">
					<li v-for="(menu,idx) in screen" :class="menu.selected?'active':''" @tap="selectedTj(menu.id,idx)">{{menu.title}}</li>
				</ul>
				<div id="discover-container" class="discover-list-container">
					<div v-show="typeler==1">
						<!-- 自己发布的动态 -->
						<li v-for="(i,m) in dynamic" :key="m" class="mui-table-view-cell my-dynamic-list">
							<div class="dynamic-list-head">
								<div class="dynamic-list-left">
									<img class="user-head-image" :src="i.owner.avatar" @tap="openDynamically(i.user_id)">
									<span class="user-names mui-ellipsis" @tap="openDynamically(i.user_id)">{{i.owner.name}}</span>
									<span class="cretae-timer" @tap="openDynamically(i.user_id)">{{i.create_time}}</span>
									<!-- 如果是自己的动态则显示删除 -->
									<!-- <span v-if="i.is_mine==1" class="delete-list" @tap="deleteDynamics(i.id,m)">删除</span> -->
								</div>
								<div class="mui-pull-right click-heart" @tap="likeThis(i.id,i.user_id,m)">
									<!-- <i class="heart-icon animated" :class="i.is_thumbs==1?'heartBeat':'tada'"></i> -->
									<i class="heart-icon animated" :class="i.is_thumbs==1?'heart-icon'+i.id+' active':'heart-icon'+i.id"></i>
									<span>{{i.thumbs_number}}</span>
								</div>
							</div>
							<!-- 带图片的两行 -->
							<!-- 没图片的三行 mui-ellipsis-3-->
							<div class="dy-container">
								<p class="dynamic-desc" :class="i.cover.length>0?'mui-ellipsis-2':'mui-ellipsis-3'" @tap="dynamicDetail(i.id)">
									{{i.content}}
								</p>
								<ul v-if="i.cover!=''" class="illustrating-picture" @tap="dynamicDetail(i.id)">
									<li v-for="img in i.cover">
										<img class="illustrating" :src="img">
									</li>
								</ul>
								<!-- 评论部分 -->
								<div class="operation-menu">
									<div class="menu-list" :class="'menu-list'+i.id">
										<span class="check-detail" @tap="dynamicDetail(i.id)">查看详情</span>
										<div class="menu-body" :class="'menu-body'+i.id">
											<div class="menu-arrow"></div>
											<div v-if="i.is_mine==1" class="item" @tap="deleteDynamics(i.id,m)">
												<span class="iconfont icon-delete">&#xe603;</span>删除
											</div>
											<div class="item" @tap="shareBtn(i.id,i.content,i.cover[0])"><span class="iconfont icon-share">&#xe604;</span>分享</div>
											<div class="item" @tap="pinglun(i.id,m)"><span class="iconfont icon-comment">&#xe602;</span>评论</div>
										</div>
										<div class="comment-icon-cont" :class="'comment-icon-cont'+i.id" @tap="showMenu(i.id,m)">
											<span class="iconfont comment-icon">&#xe504;</span>
										</div>
									</div>
								</div>
								<div class="dynamic-lists-issue" v-if="i.comment.length>0||i.is_thumbs>0">
									<div class="lan-arrows"></div>
									<p v-if="i.is_thumbs>0">
										<span class="iconfont icon-like">&#xe601;</span>
										<template v-for="(c,idx) in i.thumbs_user" :key="idx">
											{{c}}<template v-if="idx<i.thumbs_user.length-1">、</template>
										</template>
									</p>
									<p class="comment-inside" v-for="(p,idx) in i.comment">
										<span class="user-name">{{p.nickName}}：</span>{{p.content}}
									</p>
								</div>
							</div>
						</li>
					</div>
					<div v-show="typeler==2">
						<!-- 官方文章 -->
						<li class="mui-table-view-cell official-article" v-for="(a,idx) in essay" :key="idx" @tap="articleDetail(a.id)">
							<div class="article-img">
								<img :src="a.thumb">
							</div>
							<div class="article-right">
								<p class="mui-ellipsis-2">
									{{a.title}}{{a.is_top}}
								</p>
								<div v-if="a.is_top" class="stick-sign">
									<img src="../image/discover/stick-sign.png">
								</div>
								<div class="official-article-status">
									<span>{{a.add_time}}</span>
									<span><img src="../image/eye.png">{{a.click}}</span>
									<img src="../image/discover/official-sign.png">
								</div>
							</div>
						</li>
					</div>
					<div v-show="typeler==3">
						<!-- 课程列表列表 -->
						<li class="mui-table-view-cell curriculum-list" v-for="(c,u) in team_course" :key="u">
							<!-- <img style="width: 0.38rem;" src="../image/discover/loading.gif" > -->
							<div class="curriculum-img" @tap="curriculumDetail(c.id,c.state,c.team_id,c.title,c.teacher_id, c.is_silent)">
								<img :src="c.cover_url">
							</div>
							<div class="curriculum-list-right">
								<!-- 官方加stick-sign -->
								<p class="mui-ellipsis-2" @tap="curriculumDetail(c.id,c.state,c.team_id,c.title,c.teacher_id, c.is_silent)">
									{{c.title}}
								</p>
								<div class="status-cont mui-clearfix" @tap="curriculumDetail(c.id,c.state,c.team_id,c.title,c.teacher_id, c.is_silent)">
									<div class="mui-pull-left">
										<span class="ting-ke">主讲人：{{c.teacher_name}}</span>
									</div>
								</div>
								<div>
									<div v-if="c.state==0" class="cretae-timer" @tap="curriculumDetail(c.id,c.state,c.team_id,c.title,c.teacher_id, c.is_silent)">开播：2018-05-18
										18:50</div>
									<div v-else-if="c.state==1" class="train-ing" @tap="curriculumDetail(c.id,c.state,c.team_id,c.title,c.teacher_id, c.is_silent)"><img
										 style="width: 0.38rem;" src="../image/discover/loading.gif">培训中</div>
									<div v-else class="cretae-timer" @tap="curriculumDetail(c.id,c.state,c.team_id,c.title,c.teacher_id, c.is_silent)">结束：2018-05-18
										20:50</div>
									<div class="team-name mui-pull-right" @tap="teamDetail(c.team_id)">
										<img class="team-icon" src="../image/discover/team-icon.png">
										<span class="mui-ellipsis">{{c.team_name}}</span>
									</div>
								</div>
							</div>
						</li>
						<div class="void-team-course" v-show="team_course==''||team_course.length<1">
							亲 暂无团队课程哟~
						</div>
					</div>
					<div v-show="typeler==4">
						<!-- 产品列表 -->
						<li class=" mui-table-view-cell goods-list">
							<div class="goods-img" @tap="goodsDetail('369')">
								<img src="../image/5E0eH.png">
							</div>
							<div class="goods-list-right">
								<!-- 官方加stick-sign -->
								<p class="mui-ellipsis-2 stick-sign" @tap="goodsDetail('369')">塔利班“红队”头目在阿富汗北部被击毙在阿富汗北部被击毙塔利班“红队”头目在阿富汗北部被击毙在阿富汗北部被击毙塔利班“红队”头目在阿富汗北部被击毙在阿富汗北部被击毙</p>
								<div class="goods-nature" @tap="goodsDetail('369')">
									<span>供货价：￥250.00</span>
									<span>销量： 520件</span>
								</div>
								<div class="goods-earnings" @tap="teamDetail('369')">
									<span>利润：￥50</span>
									<!-- 团队 -->
									<!-- <div class="team-name">
											<img class="team-icon" src="../image/discover/team-icon.png">
											<span class="mui-ellipsis">房东的猫猫猫猫猫</span>
										</div> -->
									<!-- <div class="team-name mui-ellipsis">房东的,猫猫猫猫猫猫猫猫猫猫猫猫猫猫猫</div> -->
									<!-- 官方 -->
									<img src="../image/discover/official-sign.png">
								</div>
							</div>
						</li>
					</div>
				</div>
			</div>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/swiper.min.js"></script>
		<!-- <script src="../js/three.min.js"></script> -->
		<!-- <script src="../js/indexs.js"></script> -->
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo(),
				skip = 1,
				limit = 8,
				pullDirection = "",
				mask = mui.createMask(function() {
					app.menuStatus = false;
					document.querySelector(".menu-body" + timeline_id).classList.remove("active");
					document.querySelector(".menu-list" + timeline_id).classList.remove("active");
					document.querySelector(".comment-icon-cont" + timeline_id).classList.remove("active");
					mui('.mui-bar-footer')[0].style.display = "none";
					plus.key.hideSoftKeybord();
				}),
				// 点赞的是第几条
				_idx = 0,
				// 动态id
				timeline_id = '',
				// 发布动态人的id
				to_uid = '';
			var app = new Vue({
				el: "#mui-content",
				data: {
					// 个人消息
					is_self: false,
					discover_info: {
						id: "",
						name: "",
						avatar: "",
						personalized_signature: "",
						group_id: "",
						group_name: "",
						timeline_cover: ""
					},
					// 类型
					typeler: [],
					// 动态
					dynamic: [],
					// 官方文章
					essay: [],
					// 团队课程
					team_course: [],
					slider: [],
					screen: [{
							title: '好友动态',
							id: '1',
							selected: false
						}, {
							title: '旺客头条',
							id: '2',
							selected: false
						}, {
							title: '团队课程',
							id: '3',
							selected: false
						},
						// 	{
						// 	title: '旺客总仓',
						// 	id: '4',
						// 	selected: false
						// }, {
						// 	title: '企业总仓',
						// 	id: '5',
						// 	selected: false
						// }
					],
					like: false,
					// 评论部分
					menuStatus: false
				},
				created: function() {
					// 初始化字体大小
					var viewport = document.documentElement.clientWidth;
					if (viewport > 750) {
						viewport = 750
					}
					document.documentElement.style.fontSize = viewport / 7.5 + "px";
					// 初始化字体大小结束	
				},
				methods: {
					// 选择标签
					selectedTj: function(id, idx) {
						this.screen[idx].selected = !this.screen[idx].selected;
						var stype = this.screen[idx].id;
						var _index=app.typeler.indexOf(stype);
						if(_index==-1){
							app.typeler.push(stype);
						}else{
							app.typeler.splice(idx,1);
						}
						logs(app.typeler);
						
						if (pullDirection == 'up') {
							mui('#mui-content').pullRefresh().refresh(true);
						}
						if (this.typeler == 1) {
							if (app.dynamic.length > 0) {
								//不请求
							} else {
								getDiscoverData(true);
							}
						} else if (this.typeler == 2) {
							if (app.essay.length > 0) {
								// logs("不请求");
								//不请求
							} else {
								getDiscoverData(true);
							}
						} else if (this.typeler == 3) {
							if (app.team_course.length > 0) {
								//不请求
							} else {
								getDiscoverData(true);
							}
						}
					},
					// 跳转好友动态
					openDynamically: function(id) {
						mui.openWindow({
							url: "dynamic_space.html",
							id: 'dynamic_space',
							extras: {
								user_id: id,
							},
							waiting: {
								autoShow: true, //自动显示等待框，默认为true
								options: {
									background: "rgba(0,0,0,0)",
									loading: {
										display: 'block',
										height: '70px',
										icon: "../image/jump.png",
										interval: 25
									}
								}
							}
						})
					},
					// 点赞
					likeThis: function(id, pid, idx) {
						timeline_id = id;
						// 发布动态人的id
						to_uid = pid;
						_idx = idx;
						adoreIt();
						document.querySelector('.heart-icon' + timeline_id).classList.add('heartBeat');
						setTimeout(function() {
							document.querySelector('.heart-icon' + timeline_id).classList.remove('heartBeat');
						}, 500);
					},
					// 打开动态详情
					dynamicDetail: function(id) {
						openPage('dynamics_detail.html', 'dynamics_detail', "#f7f7f7", {
							aid: id,
							user_id: user_id
						})
					},
					// 打开文章
					articleDetail: function(id) {
						// mui.toast("打开文章" + id);
						openPage('article.html', 'article', '#ffffff', {
							article_id: id
						});
					},
					// 打开产品详情
					goodsDetail: function(id) {
						mui.toast("打开产品详情" + id);
					},
					// 打开团队详情
					teamDetail: function(id) {
						openPage('team_detail.html', 'team_detail', '#f7f7f7', {
							teamid: id
						});
					},
					//打开课程详情
					curriculumDetail: function(cid, status, tid, title, teid, silent) {
						if (status == 1 || status == 2) {
							openPage("live_streaming.html", "live_streaming", "#f7f7f7", {
								tid: tid,
								courseId: cid,
								courseTitle: title,
								teacher_id: teid,
								isSilent: silent
							});
						} else {
							// 未开播提示
							openPage("premiere_prompt.html", "premiere_prompt", "#f7f7f7", {
								id: id
							});
						}
						// mui.toast("打开课程详情" + status);
					},
					// 评论
					pinglun: function(t_id, i_idx) {
						document.querySelector(".menu-list" + timeline_id).classList.remove("active");
						document.querySelector(".menu-body" + timeline_id).classList.remove("active");
						document.querySelector(".mui-bar-footer").style.display = "block";
						// mui('.mui-bar-footer')[0].style.display = "block";
						var _self = this;
						setTimeout(function() {
							_self.initNativeObjects();
							_self.showSoftInput();
						}, 100);
					},
					// 弹出键盘
					initNativeObjects: function() {
						if (mui.os.android) {
							var main = plus.android.runtimeMainActivity();
							var Context = plus.android.importClass("android.content.Context");
							InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
							imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
						} else {
							nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
						}
					},
					showSoftInput: function() {
						if (mui.os.android) {
							imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
						} else {
							nativeWebview.plusCallMethod({
								"setKeyboardDisplayRequiresUserAction": false
							});
						}
						setTimeout(function() {
							var inputElem = document.getElementById("comment_matter"); //需要获得焦点的input  
							inputElem.focus();
							// inputElem.parentNode.classList.add('mui-active'); //第一个是search，加上激活样式  
						}, 200);
					},
					// 显示菜单
					showMenu: function(_idd, idx) {
						_idx = idx;
						timeline_id = _idd;
						document.querySelector(".menu-body" + _idd).classList.add("active");
						document.querySelector(".menu-list" + _idd).classList.add("active");
						document.querySelector(".comment-icon-cont" + _idd).classList.add("active");
						if (this.menuStatus) {
							this.menuStatus = false;
							mask.close();
						} else {
							this.menuStatus = true;
							mask.show();
						}
					},
				},
				mounted: function() {
					mui.init({
						keyEventBind: {
							backbutton: false, //Boolean(默认true)关闭back按键监听  
							menubutton: false //Boolean(默认true)关闭menu按键监听  
						},
						pullRefresh: {
							container: "#mui-content",
							up: {
								height: 50,
								auto: false,
								contentrefresh: "正在加载...",
								contentnomore: '没有更多数据了',
								callback: function() {
									pullDirection = "up";
									skip += 1;
									getDiscoverData();
								}
							},
							down: {
								style: 'circle',
								color: '#2289FF',
								callback: function() {
									pullDirection = "down";
									mui('#mui-content').pullRefresh().refresh(true);
									skip = 1;
									getDiscoverData();
									discoverInfo();
								}
							}
						}
					});
					discoverInfo();
					mui.plusReady(function() {
						plus.navigator.setStatusBarStyle("light");
						var ws = plus.webview.currentWebview();
						// 滚动的时候动态修改状态栏颜色
						var statusbarHeight = plus.navigator.getStatusbarHeight();
						var menuBar = document.getElementById('screen-menu');
						var conts = document.getElementById("discover-container");
						var distance = statusbarHeight + 100;
						window.addEventListener('scroll', function() {
							if (conts.getBoundingClientRect().top < distance) {
								document.getElementById("zhanwei").style.display = "block";
								menuBar.classList.add("fixed");
								menuBar.style.top = 44 + statusbarHeight + 'px';
							} else {
								menuBar.style.top = '0';
								document.getElementById("zhanwei").style.display = "none";
								menuBar.classList.remove("fixed");
							}
							if (conts.getBoundingClientRect().top < 280) {
								plus.navigator.setStatusBarStyle("dark");
							} else {
								plus.navigator.setStatusBarStyle("light");
							}
						});
						getDiscoverData();
					})
					// 初始化两次防止页面乱
					// 初始化字体大小
					var viewport = document.documentElement.clientWidth;
					if (viewport > 750) {
						viewport = 750
					}
					document.documentElement.style.fontSize = viewport / 7.5 + "px";
					// 初始化字体大小结束
				}
			})

			function initSlider() {
				// 初始化轮播
				var mySwiper = new Swiper('.swiper-container', {
					//可选选项，自动滑动
					// autoplay:true,
					autoplay: {
						delay: 3000,
						// 用户操作之后不会停止轮播
						disableOnInteraction: false,
					},
					loop: true,
					// 分页器
					pagination: {
						el: '.swiper-pagination',
					},
				})
			}
			// 点击自定义图标
			function shareHref() {
				openPage('issue_dynamics.html', 'issue_dynamics', '#f7f7f7');
				plus.navigator.setStatusBarStyle("dark");
				// mui.openWindow({
				// 	url: 'activation.html',
				// 	id: 'activation'
				// });
			}
			// 数据请求
			function getDiscoverData(lpk) {
				if (lpk) {
					showload();
				}
				mui.post($ajaxUrl + 'discover&action=list', {
					token: userInfo.token,
					type: app.typeler,
					limit: limit,
					skip: skip
				}, function(res) {
					logs(res);
					if (res.errno == 0) {
						if (app.typeler == 1) {
							if (skip == 1) {
								app.dynamic = res.data;
							} else {
								app.dynamic = app.dynamic.concat(res.data);
							}
						} else if (app.typeler == 2) {
							if (skip == 1) {
								app.essay = res.data;
							} else {
								app.essay = app.essay.concat(res.data);
							}
						} else if (app.typeler == 3) {
							if (skip == 1) {
								app.team_course = res.data;
							} else {
								app.team_course = app.team_course.concat(res.data);
							}
						}
						if (pullDirection == "up") {
							mui('#mui-content').pullRefresh().endPullupToRefresh(false);
						} else if (pullDirection == "down") {
							mui('#mui-content').pullRefresh().endPulldownToRefresh();
						}
					} else {
						if (app.typeler == 1 && skip == 1) {
							app.dynamic = [];
						} else if (app.typeler == 2 && skip == 1) {
							app.essay = [];
						} else if (app.typeler == 3 && skip == 1) {
							app.team_course = [];
						}
						if (pullDirection == "up") {
							mui('#mui-content').pullRefresh().endPullupToRefresh(true);
						} else if (pullDirection == "down") {
							mui('#mui-content').pullRefresh().endPulldownToRefresh();
						}
					}
					if (lpk) {
						showload(true, Math.floor(Math.random() * 1000 + 1000));
					}
				}, 'json');
				setTimeout(function() {
					mui('#mui-content').pullRefresh().endPullupToRefresh(true);
					mui('#mui-content').pullRefresh().endPulldownToRefresh();
				}, 10000)
			}
			// 获取用户信息
			function discoverInfo() {
				mui.post($ajaxUrl + 'discover&action=user_info', {
					token: userInfo.token,
					user_id: ''
				}, function(res) {
					if (res.errno == 0) {
						app.discover_info = res.data;
						user_id = res.data.id;
						if (user_id == userInfo.id) {
							app.is_self = true;
						} else {
							app.is_self = false;
						}
						// 初始化轮播
						if (res.data.timeline_cover.length > 0) {
							app.slider = [];
							app.slider = res.data.timeline_cover;
							setTimeout(function() {
								if (res.data.timeline_cover.length > 1) {
									initSlider(true);
								}
							}, 200);
						} else {
							app.slider = ["../image/discover-default-cover.png"]
						}
					} else {
						app.slider = ["../image/discover-default-cover.png"];
					}
				}, 'json');
			}
			// 点赞
			function adoreIt() {
				mui.post($ajaxUrl + 'timeline&action=thumbs', {
					token: userInfo.token,
					timeline_id: timeline_id,
					to_uid: to_uid
				}, function(res) {
					if (res.errno == 0) {
						if (app.dynamic[_idx].is_thumbs == 1) {
							app.$set(app.dynamic[_idx], "is_thumbs", "0");
							app.$set(app.dynamic[_idx], "thumbs_number", parseInt(app.dynamic[_idx].thumbs_number) - 1);
							var idx = app.dynamic[_idx].thumbs_user.indexOf(userInfo.nickName);
							app.dynamic[_idx].thumbs_user.splice(idx, 1);
						} else {
							app.dynamic[_idx].thumbs_user.unshift(userInfo.nickName);
							app.$set(app.dynamic[_idx], "is_thumbs", "1");
							app.$set(app.dynamic[_idx], "thumbs_number", parseInt(app.dynamic[_idx].thumbs_number) + 1);
						}
					} else {
						// app.dynamic = [];
					}
				}, 'json');
			}
			// 删除动态
			function deleteDynamics(tid, ii) {
				mask.close();
				document.querySelector(".menu-body" + timeline_id).classList.remove("active");
				document.querySelector(".menu-list" + timeline_id).classList.remove("active");
				document.querySelector(".comment-icon-cont" + timeline_id).classList.remove("active");
				plus.nativeUI.confirm("确认删除该动态吗？", function(e) {
					if (e.index) {
						// 取消
					} else {
						mui.post($ajaxUrl + 'timeline&action=delete', {
							token: userInfo.token,
							tid: tid,
						}, function(res) {
							if (res.errno == 0) {
								app.dynamic.splice(ii, 1);
								message("删除成功");
							} else {
								message("删除失败，稍后重试");
							}
						}, 'json');
					}
				})
			}
			// 监听发布新动态
			window.addEventListener('doit', function() {
				getDiscoverData();
			}, false);
			// 更换封面
			mui(".mui-content").on("tap", ".swiper-slide", function() {
				if (app.is_self) {
					plus.nativeUI.actionSheet({
						// title: "更换封面照片",
						cancel: "取消",
						buttons: [{
							title: "更换封面照片"
						}]
					}, function(e) {
						var index = e.index;
						switch (index) {
							case 0:
								// text += "取消";
								break;
							case 1:
								openPage('change_cover.html', 'change_cover', '#f7f7f7', {
									cover: app.slider
								});
								break;
						}
					});
				}
			})
			// 监听封面修改
			window.addEventListener('reloadCover', function() {
				location.reload();
				// discoverInfo();
			}, false);
			// 打开写作页面
			mui(".mui-content").on("tap", ".operation-btn", function() {
				mui.openWindow({
					url: "article_operation.html",
					id: "article_operation",
					styles: {
						bounce: 'none',
						scrollsToTop: true,
						popGesture: 'close',
						background: '#ffffff',
						// background: 'transparent',
						statusbar: {
							background: "#ffffff"
						}
					},
					extras: '',
					createNew: false,
					show: {
						autoShow: true,
						aniShow: 'slide-in-bottom',
						duration: 150,
						event: 'titleUpdate',
						extras: {
							acceleration: 'auto',
							capture: '',
							otherCapture: ''
						}
					},
					waiting: {
						autoShow: false
					}
				})
			})
			// 回到顶部
			// document.querySelector('.to-top').addEventListener('tap', function() {
			// 	window.scroll(0, 0);
			// 	// mui.scrollTo(0,80);
			// });
			// window.addEventListener("swipeup", function(event) {
			// 	mask.close();
			// })
			// window.addEventListener("swipedown", function(event) {
			// 	mask.close();
			// })
			// mui(".mui-content").on("tap",".pinglunlo",function(){
			// 	alert("asdfasdf");
			// })
			// 分享
			function shareBtn(id, cont, img) {
				app.isComment = true;
				document.querySelector(".menu-body" + timeline_id).classList.remove("active");
				mask.close();
				var imgs = img.substring(img.lastIndexOf("/"));
				var sd_path = "_downloads" + imgs;
				plus.io.resolveLocalFileSystemURL(sd_path, function(e) {
					shareToMiniprogram({
						title: cont,
						content: cont,
						thumbs: [sd_path],
						miniProgram: {
							id: 'gh_9fa5f42ab939',
							path: '/longbing_card/pages/news/detail/detail?id=' + id + '&isStaff=true',
							webUrl: 'https://app.wangkeapp.cn/'
						}
					}, 'miniProgram');
				}, function(e) {
					showload(0, 0, '图片处理中...', "rgba(0,0,0,0.5)");
					var imgpath = '';
					var imgDtask = plus.downloader.createDownload(img, {
						method: 'GET'
					}, function(d, status) {
						if (status == 200) {
							//图片压缩
							plus.zip.compressImage({
									src: d.filename,
									dst: d.filename,
									overwrite: true,
									width: '500px',
									format: 'jpg',
									quality: 90
								},
								function(e) {
									imgpath = e.target;
									if (imgpath) {
										showload(1);
										shareToMiniprogram({
											title: cont,
											content: cont,
											thumbs: [imgpath],
											miniProgram: {
												id: 'gh_9fa5f42ab939',
												// path: '/longbing_card/pages/news/detail/detail?id=' + id + '&isStaff=true',
												path: '/longbing_card/pages/index/index?currentTabBar=toNews&to_uid=' + userInfo.id,
												webUrl: 'https://app.wangkeapp.cn/'
											}
										}, 'miniProgram');
									}
								},
								function(error) {
									message("Compress error!");
								});
						} else {
							mui.toast('保存失败')
						}
					});
					imgDtask.start()
				});
			}
			// 评论
			mui(".mui-bar-footer").on("tap", ".send-comment", function() {
				var conts = document.getElementById("comment_matter").value;
				if (conts == " " || conts.length < 1) {
					message("评论内容不能为空!");
					return;
				}
				mui.post($ajaxUrl + 'timeline&action=comment', {
					token: userInfo.token,
					timeline_id: timeline_id,
					content: conts
				}, function(res) {
					if (res.errno == 0) {
						var self_comment = {
							user_id: userInfo.id,
							content: conts,
							nickName: userInfo.nickName
						}
						app.dynamic[_idx].comment.unshift(self_comment)
						document.getElementById("comment_matter").value = "";
						document.activeElement.blur();
						mask.close();
						mui('.mui-bar-footer')[0].style.display = "none";
					} else {}
				}, 'json');
			})
		</script>
	</body>

</html>
