<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<title>自媒体</title>
		<link href="../css/mui.min.css" rel="stylesheet" />
		<link href="../css/index.css" rel="stylesheet" />
		<link href="../icomoon/style.css" rel="stylesheet" />
		<link href="../css/showLoading.css" rel="stylesheet" />

		<style>
			* {
				margin: 0;
				padding: 0;
				outline: 0;
			}

			body {
				font-family: Helvetica, Arial, Verdana, sans-serif;
				color: #999;
				font-size: 12px;
			}

			.mui-slider-item {
				max-height: 300px;
				overflow: hidden;
			}

			.inner {
				margin: 0 auto;
				padding: 35px 0;
				font-size: 15px;
				position: relative;
				font-family: 'Open Sans', sans-serif;
			}

			.subMenu {
				position: relative;
				/* position: absolute; */
				/* top: 232px; */
				/* z-index: 10; */
			}

			.subMenu .inner {
				padding: 0;
			}

			ul,
			li {
				list-style: none;
			}

			.clearfix {
				clear: both;
			}

			.Information_list {
				background-color: #FFFFFF;
				/* margin-bottom 50px; */
				/* margin-top: 35px; */
			}

			.list1 {
				padding: 15px 10px 15px 0;
				border-bottom: 1px solid #F2F2F2;
				margin-left: 10px;
			}

			.list1L {
				width: 113px;
				height: 80px;
				float: left;
			}

			.list1L img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			.list1R {
				width: 65%;
				color: #999999;
				font-size: 12px;
				float: right;
			}

			.list1R p {
				color: #333333;
				font-size: 15px;
				line-height: 23px;
				text-align: left;
				margin-top: -2px;
			}

			.list1Rl {
				float: left;
				margin-top: 10px;
			}

			.list1Rr {
				float: right;
				margin-top: 10px;
			}

			.list1Rr img {
				width: 19px;
				margin-right: 10px;
			}

			#quick {
				width: 80%;
				margin: 0 auto;
				box-shadow: 0 0 15px 3px #D1D1D3;
				border-radius: 20px;
				background-color: #fff;
				display: none;
				margin-top: -133px;
				z-index: 9999;
			}

			#quick li {
				width: 25%;
				float: left;
				margin-top: 15px;
			}

			#quick li img {
				height: 22px;
			}

			#quick li p {
				font-size: 10px;
				color: #000000;
			}

			.jiandou {
				width: 19px;
				position: absolute;
				margin-left: -12px;
			}

			#back {
				position: fixed;
				top: 0;
				left: 0;
				display: none;
				width: 100%;
				height: 100%;
				opacity: 0.5;
			}

			.mui-slider-item img {
				width: 100%;
				height: auto;
			}

			.mui-plus-pullrefresh .subMenu .mui-scroll {
				position: absolute;
			}

			.mui-plus-pullrefresh .subMenu {
				width: 100%;
				overflow: hidden;
			}

			.mui-slider-group {
				height: auto;
			}

			.publish-article {
				height: 44px;
				width: 80px;
				position: relative;
				display: flex;
				align-items: center;
				justify-content: flex-end;
				padding-right: 10px;
				margin-right: -10px;
				font-size: 14px;
				color: #666666;
				z-index: 12;
			}

			.operation-btn {
				width: 45px;
				height: 45px;
				position: fixed;
				left: 50%;
				margin-left: -22.5px;
				bottom: 50px;
				opacity: 0.96;
			}

			.mui-bar.mui-bar-nav {
				background-color: #fff;
				box-shadow: none;
			}

			.subMenu {
				background-color: #F5F6F8;
			}

			.subMenu.fixed-cont {
				position: fixed;
				top: 44px;
				z-index: 5;
				color: #FFFFFF;
				transition: all 0.3s ease-in-out;
				-webkit-transition: all 0.3s ease-in-out;
				box-shadow: 0 1px 2px 1px rgba(0, 0, 0, 0.2);
			}

			.subMenu .mui-scroll-wrapper .mui-control-item {
				color: #333333;
			}

			* {
				touch-action: pan-y;
			}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
			<h1 class="mui-title">自媒体</h1>
		</header>
		<div class="mui-content">
			<div id="slider" class="mui-slider">
			</div>
			<!-- 防闪烁占位div -->
			<div id="perch-cont" style="height: 38px;width: 100%;position: relative;display: none;"></div>
			<div id="subMenu" class="subMenu">
				<div class=" inner mui-scroll-wrapper mui-slider-indicator mui-segmented-control mui-segmented-control-inverted">
					<div class="mui-scroll" id="classification">
					</div>
				</div>
			</div>
			<div class="Information_list" id="article_list"></div>
			<div id="article_bottom"></div>
			<img class="operation-btn" src="../image/icon/plus-sign.svg" alt="">
		</div>
	</body>
	<script src="../js/mui.js"></script>
	<script src="../js/util.js"></script>
	<script src="../js/showLoading.js"></script>

	<script>
		var recommend = 1;
		var hot = 0;
		var cid = 0;
		var skip = 1;
		var limit = 8;
		var loadding = 0;
		mui.init({
			swipeBack: false,
			keyEventBind: {
				backbutton: false,
				menubutton: true
			},
			pullRefresh: {
				container: "#article_bottom",
				up: {
					height: 50,
					auto: false,
					contentrefresh: "正在加载...",
					contentnomore: '没有更多数据了',
					callback: function() {
						pullfresh_function(true, false);
					}
				},
				down: {
					style: 'circle',
					color: '#2289FF',
					callback: function() {
						pullfresh_function(false, true);
						class_list();
						slideReady();
						setTimeout(function() {
							mui('#article_bottom').pullRefresh().endPulldownToRefresh();
						}, 10000);
					}
				}
			}
		});
		mui.plusReady(function() {
			mui.showLoading("正在加载..", "div");
			pullfresh_function();
			window.addEventListener('scrollTop', function(event) {
				window.scrollTo(0, 0);
			});

			window.addEventListener('advSettingFinish', function() {
				// console.log('advSettingFinish');
				window.location.reload();
			})
			slideReady(); //幻灯片
			class_list(); //文章分类

			//监听分类点击事件
			mui("#classification").on('tap', 'a', function() {
				//获取id
				var id = this.getAttribute("data-id");
				//更新分类数据
				update_class(id);
			})
			//监听文章列表
			mui("#article_list").on('tap', '.list1', function() {
				//获取id
				var id = this.dataset.id;
				mui.openWindow({
					url: 'article.html',
					id: 'article',
					styles: {
						bounce: 'none',
						scrollsToTop: true,
						popGesture: 'close',
						hardwareAccelerated: false,
						statusbar: {
							background: "#ffffff"
						}
					},
					extras: {
						article_id: id
					},
					createNew: false,
					show: {
						autoShow: true,
						aniShow: 'slide-in-right',
						duration: 300,
						event: 'titleUpdate',
						extras: {
							acceleration: 'auto',
							capture: '',
							otherCapture: ''
						}
					},
					waiting: {
						autoShow: false
					}
				})
			})

			// 固定文章分类在顶部
			var headH = document.querySelector('header').offsetHeight,
				tab = document.getElementById("subMenu"),
				list = document.getElementById("article_list"),
				perch = document.getElementById("perch-cont");
			window.addEventListener('scroll', function(e) {
				if (list.getBoundingClientRect().top <= 79) {
					tab.classList.add('fixed-cont');
					perch.style.display = "block";
				} else {
					perch.style.display = "none";
					tab.classList.remove('fixed-cont');
				}
			});
			setTimeout(function() {
				mui.hideLoading();
			}, 10000);
		})

		function slideReady() {
			mui.ajax({
				url: $ajaxUrl + 'carousel',
				data: {
					position: 2
				},
				//async: true || false, // 异步 || 同步
				async: true,
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				success: function(data) {
					if (data.errno == '0') {
						var str = '';
						if (data.data == '') {
							str +=
								'<div class="mui-slider-group"><div class="mui-slider-item"><a href="javascript: void(0);"><img src="../image/bj.jpg" alt=""><p class="mui-slider-title">只是精神不滑坡，办法总比困难多</p></a></div></div>';
						} else if (data.data.length == 1) {
							str += '<div class="mui-slider-group"><div class="mui-slider-item"><a href="javascript: void(0);"><img src="' +
								data.data[0].pic + '" alt="">';
							if (data.data[0].show_title == 1 && data.data[0].title.length > 0) {
								str += '<p class="mui-slider-title">' + data.data[0].title + '</p>';
							}
							str += '</a></div></div>';
						} else if (data.data.length > 1) {
							str += '<div class="mui-slider-group mui-slider-loop">';
							var k = data.data.length - 1;
							str += '<div class="mui-slider-item mui-slider-item-duplicate"><a href="javascript: void(0);"><img src="' +
								data.data[k].pic + '" alt="">';
							if (data.data[k].show_title == 1 && data.data[k].title.length > 0) {
								str += '<p class="mui-slider-title">' + data.data[k].title + '</p>';
							}
							str += '</a></div>';
							var i = 0;
							for (i in data.data) {
								str += '<div class="mui-slider-item mui-slider-item-duplicate"><a href="javascript: void(0);"><img src="' +
									data.data[i].pic + '" alt="">';
								if (data.data[i].show_title == 1 && data.data[i].title.length > 0) {
									str += '<p class="mui-slider-title">' + data.data[i].title + '</p>';
								}
								str += '</a></div>';
							}
							str += '<div class="mui-slider-item mui-slider-item-duplicate"><a href="javascript: void(0);"><img src="' +
								data.data[0].pic + '" alt="">';
							if (data.data[0].show_title == 1 && data.data[0].title.length > 0) {
								str += '<p class="mui-slider-title">' + data.data[0].title + '</p>';
							}
							str += '</a></div>';
							str += '</div>';
							str += '<div class="mui-slider-indicator mui-text-right">';
							var j = 0;
							for (j in data.data) {
								if (j == 0) {
									str += '<div class="mui-indicator mui-active"></div>';
								} else {
									str += '<div class="mui-indicator"></div>';
								}
							}
							str += '</div>';
						}
					}
					//console.log(str);
					//console.log(JSON.stringify(data));
					document.getElementById('slider').innerHTML = str;
					setTimeout(function() {
						slider_play();
					}, 1000)
				},
				error: function(xhr, type, errorThrown) {
					// 请求失败
				}
			});
		}

		function slider_play() {
			mui('.mui-slider').slider({
				interval: 2500 //自动轮播周期，若为0则不自动播放，默认为0；
			});
		}

		function class_list() {
			var str = '';
			var url = $ajaxUrl + 'article';
			mui.post(url, {
				token: 'eaa3242cd05ca923b66b60cbb10d01ad',
				action: 'class_list'
			}, function(data) {
				logs(data);
				str +=
					'<a class="mui-control-item mui-active" data-id="-1">推荐</a><a class="mui-control-item" data-id="-2">热点</a>';
				if (data.errno == '0') {
					for (i in data.data) {
						str += '<a class="mui-control-item" data-id="' + data.data[i].id + '">' + data.data[i].name + '</a>';
					}
				}
				document.getElementById('classification').innerHTML = str;
				setTimeout(function() {
					mui.hideLoading();
				}, 500);
			}, 'json');
		}


		function pullfresh_function(up, down) {
			var userInfo = getUserInfo();
			var str = '';
			var url = $ajaxUrl + 'article';
			mui.post(url, {
				token: userInfo.token,
				action: 'article_list',
				recommend: recommend,
				hot: hot,
				cid: cid,
				skip: skip,
				limit: limit
			}, function(data) {
				console.log(JSON.stringify(data));
				if (data.errno == '0') {
					var str = '';
					for (i in data.data) {
						str += '<div class="list1" data-id="' + data.data[i].id + '"><div class="list1L"><img src="' + data.data[i].thumb +
							'" ></div><div class="list1R"><p class="mui-ellipsis-2">' + data.data[i].title +
							'</p><div class="list1Rl"><span>' + data.data[i].author +
							'</span><span style="margin-left: 10px;">' + data.data[i].add_time +
							'</span></div><div class="list1Rr"><span><img src="../image//eye.png" ></span><span>' + data.data[i].click +
							'</span></div><div class="clearfix"></div></div><div class="clearfix"></div></div>';
					}
					if (skip == 1) {
						document.getElementById('article_list').innerHTML = str;
					} else {
						document.getElementById('article_list').innerHTML += str;
					}
					skip++;
				} else {
					loadding = 1;
				}
				if (loadding == 0 && up) {
					mui('#article_bottom').pullRefresh().endPullupToRefresh(false);
					// this.endPullupToRefresh(false);
				} else if (loadding == 1 && up) {
					mui('#article_bottom').pullRefresh().endPullupToRefresh(true);
					// this.endPullupToRefresh(true);
				} else if (down) {
					mui('#article_bottom').pullRefresh().endPulldownToRefresh();
					// this.pullRefresh().endPulldownToRefresh();
				}
			}, 'json');
		}

		function update_class(id) {
			if (id == '-1') {
				recommend = 1;
				hot = 0;
				cid = 0;
			} else if (id == '-2') {
				recommend = 0;
				hot = 1;
				cid = 0;
			} else {
				recommend = 0;
				hot = 0;
				cid = id;
			}
			skip = 1;
			limit = 5;
			loadding = 0;
			article_list();
			mui('#article_bottom').pullRefresh().refresh(true);
			mui('#article_bottom').pullRefresh().enablePullupToRefresh();
		}

		function article_list() {
			var str = '';
			var url = $ajaxUrl + 'article';
			mui.post(url, {
				token: 'eaa3242cd05ca923b66b60cbb10d01ad',
				action: 'article_list',
				recommend: recommend,
				hot: hot,
				cid: cid,
				skip: skip,
				limit: limit
			}, function(data) {
				// console.log(JSON.stringify(data));
				if (data.errno == '0') {
					var str = '';
					for (i in data.data) {
						str += '<div class="list1" data-id="' + data.data[i].id + '"><div class="list1L"><img src="' + data.data[i].thumb +
							'" ></div><div class="list1R"><p>' + data.data[i].title + '</p><div class="list1Rl"><span>' + data.data[i].author +
							'</span><span style="margin-left: 10px;">' + data.data[i].add_time +
							'</span></div><div class="list1Rr"><span><img src="../image//eye.png" ></span><span>' + data.data[i].click +
							'</span></div><div class="clearfix"></div></div><div class="clearfix"></div></div>';
					}
					document.getElementById('article_list').innerHTML = str;
					skip++;
				} else {
					document.getElementById('article_list').innerHTML = '';
					//mui('#article_bottom').endPullupToRefresh(true);
					mui('#article_bottom').pullRefresh().disablePullupToRefresh();
				}
			}, 'json');
		}
		// 打开写作页面
		mui(".mui-content").on("tap", ".operation-btn", function() {
			mui.openWindow({
				url: "article_operation.html",
				id: "article_operation",
				styles: {
					bounce: 'none',
					scrollsToTop: true,
					popGesture: 'close',
					background: '#ffffff',
					// background: 'transparent',
					statusbar: {
						background: "#ffffff"
					}
				},
				extras: '',
				createNew: false,
				show: {
					autoShow: true,
					aniShow: 'slide-in-bottom',
					duration: 150,
					event: 'titleUpdate',
					extras: {
						acceleration: 'auto',
						capture: '',
						otherCapture: ''
					}
				},
				waiting: {
					autoShow: false
				}
			})
		})
	</script>
</html>
