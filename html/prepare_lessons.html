<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
		<link href="../css/mui.min.css" rel="stylesheet" />
		<style type="text/css">
			.mui-bar-nav~.mui-content {
				padding: 60px 0.2rem 1rem;
				position: relative;
			}

			.mui-table-view {
				background-color: transparent;
			}

			.mui-table-view-cell {
				/* background-color: #FFFFFF; */
				width: 100%;
				/* height: 4.83rem; */
				margin-bottom: 0.2rem;
				border-radius: 0.1rem;
				padding: 0;
			}

			.mui-table-view-cell:after,
			.mui-table-view:before,
			.mui-table-view:after {
				display: none;
			}

			.mui-slider-handle {
				padding: 0.2rem;
				height: auto;
				border-radius: 0.1rem;
			}


			.data-bank {
				max-width: 3rem;
			}

			.data-bank p {
				font-size: 0.24rem;
				margin-bottom: 0;
			}

			.card-sign-cont {
				width: 0.75rem;
				height: 0.75rem;
				position: absolute;
				top: 0;
				right: 0;
				z-index: 8;
			}

			.mui-slider-right .move-up-btn {
				margin-left: 0.2rem;
				border-top-left-radius: 0.1rem !important;
				border-bottom-left-radius: 0.1rem !important;
			}

			.mui-slider-right .modifier-btn {
				position: relative;
			}

			.mui-table-view-cell>.mui-slider-right>.mui-btn.move-up-btn {
				color: #2289FF !important;
			}

			.mui-table-view-cell>.mui-slider-right>.mui-btn.move-down-btn {
				border-left: 1px solid #f9f9f9 !important;
				color: #2289FF !important;
			}

			.mui-table-view-cell>.mui-slider-right>.mui-btn.modifier-btn {
				border-left: 1px solid #f9f9f9 !important;
			}

			.mui-table-view-cell>.mui-slider-right>.mui-btn.delete-btn {
				border-left: 1px solid #f9f9f9 !important;
				/* color: #FF0000 !important; */
			}

			.mui-table-view-cell>.mui-slider-left>.mui-btn,
			.mui-table-view-cell>.mui-slider-right>.mui-btn {
				padding: 0 12px;
			}

			.mui-table-view-cell>.mui-slider-left>.mui-btn:after,
			.mui-table-view-cell>.mui-slider-right>.mui-btn:after {
				z-index: -66;
			}

			.mui-btn.mui-btn-primary {
				background-color: #FFFFFF;
				color: #333333 !important;
			}

			.add-master {
				height: 44px;
				position: relative;
				display: inline-flex;
				align-items: center;
				justify-content: center;
				width: auto;
				color: #2289ff;
				font-size: 15px;
				text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
				z-index: 12;
				padding: 0 10px;
				margin-right: -5px;
			}

			.mui-table-view-cell,
			.mui-slider-handle {
				touch-action: pan-y;
			}

			.mui-table-view {
				padding-bottom: 50px;
			}

			.remark-info {
				display: flex;
				align-items: flex-start;
				justify-content: space-between;
				padding-bottom: 0.2rem;
			}

			.remark-info .send-msg-btn {
				padding-left: 10px;
				color: #2289FF;
				flex-shrink: 0;
				font-size: 0.28rem;
				display: inline-flex;
				align-items: center;
			}

			.remark-info .send-msg-btn .gray {
				color: #999999;
			}

			.remark-info .send-msg-btn img {
				width: 0.3rem;
				margin-right: 5px;
				height: auto;
			}

			textarea {
				padding: 0.1rem;
				text-align: justify;
				font-size: 0.28rem;
				color: #333333;
				margin-bottom: 0;
			}

			.remake-section {
				display: flex;
				align-items: center;
				position: relative;
			}

			.remake-section img {
				width: 0.27rem;
				height: 0.27rem;
				margin-right: 5px;
				display: inline-block;
				position: absolute;
				left: 0.1rem;
				top: 0.17rem;
			}

			.remake-section p {
				display: inline-block;
				margin-bottom: 0;
			}

			.remake-area {
				color: #999999;
				padding-left: 0.5rem;
				font-size: 0.26rem;
				/* border-width: 0.005rem; */
				/* background-color: #F9F9F9; */
				border: none;
				text-align: justify;
				max-height: 28px;
			}

			.remake-area::-webkit-input-placeholder {
				color: #999999;
				font-size: 0.26rem;
			}

			.text-desc {
				color: #333333;
				font-size: 0.3rem;
				background-color: #F2F2F2;
				padding: 0.1rem;
				border-radius: 5px;
			}

			.public-container {
				position: fixed;
				top: 64px;
				width: 90%;
				left: 5%;
				padding: 0;
				height: auto;
				z-index: 9;
				background-color: #FFFFFF;
				box-sizing: border-box;
				border-radius: 5px;
				overflow: hidden;
				transform: translateY(-150%);
				-webkit-transform: translateY(-150%);
				transition: all 0.2s ease-in-out;
				-webkit-transition: all 0.2s ease-in-out;
			}

			.public-container.active {
				transition: all 0.2s ease-in-out;
				-webkit-transition: all 0.2s ease-in-out;
				transform: translateY(0);
				-webkit-transform: translateY(0);
			}

			.public-container textarea {
				border: none;
				background-color: #F9F9F9;
				font-size: 0.3rem;
			}

			.action-cont {
				display: flex;
				align-items: center;
				justify-content: space-between;
			}

			.action-cont .mui-btn-outlined {
				padding: 0.2rem 0;
				width: 50%;
				font-size: 0.28rem;
				border: none;
				border-radius: 0;
			}

			.action-cont .mui-btn-outlined:last-of-type {
				border-left: 0.005rem solid #DDDDDD;
				margin-left: -1px;
			}

			.action-cont .mui-btn-outlined:active {
				background-color: #f9f9f9;
				color: #999999;
			}

			.mui-backdrop {
				position: fixed;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				z-index: 8;
				background-color: rgba(0, 0, 0, .3);
			}

			.img-cont {
				width: 5rem;
				max-height: 3rem;
				object-fit: cover;
				border-radius: 3px;
				overflow: hidden;
			}

			.img-cont img {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			.choice-item {
				width: auto;
				height: 2.3rem;
			}

			.mui-table-view-cell.mui-active,
			.mui-table-view-cell.mui-active>.mui-slider-handle {
				background-color: #FFFFFF;
			}

			.start-record,
			.play-record {
				background-color: #2289FF;
				color: #FFFFFF;
				font-size: 0.3rem;
				padding: 0.1rem 0.3rem;
				border-radius: 0.1rem;
				display: flex;
				align-items: center;
				position: relative;
			}

			.play-record {
				padding: 0.1rem 0.1rem;
				font-size: 0.28rem;
				width: 140px;
			}

			.play-record.active {
				background-color: #0062CC;
			}

			.record-timer {
				margin-left: 0.2rem;
				font-size: 0.24rem;
				position: absolute;
				right: 5px;
			}

			.video-container {
				width: 5rem;
				max-height: 3rem;
				object-fit: cover;
				border-radius: 3px;
				overflow: hidden;
				position: relative;
			}

			.start-record.hold-active {
				background-color: #005cbf;
				color: #DDDDDD;
			}

			.showArea {
				width: 120px;
				height: 120px;
				background-color: #999999;
				font-size: 15px;
				position: fixed;
				bottom: 55%;
				left: 35%;
				color: #FFFFFF;
				border-radius: 5px;
				display: none;
				text-align: center;
			}

			.showArea img {
				width: 80px;
				display: block;
				margin: 0 auto;
			}

			footer {
				position: fixed;
				width: 100%;
				/* max-height: 120px; */
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				padding: 0px 50px;
				overflow: hidden;
				background-color: #fafafa;
				touch-action: pan-y;
			}

			.footer-left {
				position: absolute;
				width: 50px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 4px;
			}

			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}

			.footer-center {
				height: auto;
				padding: 5px 0px;
				display: flex;
				align-items: center;
				touch-action: pan-y;
			}

			.footer-center .input-text {
				width: 100%;
				height: 40px;
				border-radius: 5px;
				padding: 0.1rem;
				background: #fff;
				border: solid 1px #ddd;
				font-size: 16px !important;
				line-height: 1.4 !important;
				font-family: verdana !important;
				overflow-y: scroll;
				max-height: 120px !important;
				touch-action: pan-y;
			}

			.footer-center .input-sound {
				background-color: #eee;
			}

			footer .mui-icon {
				color: #000;
			}

			footer .mui-icon:active {
				color: #007AFF !important;
			}

			footer .mui-icon-paperplane:before {
				content: "添加";
				font-weight: 600;
			}

			footer .mui-icon-paperplane {
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}

			.footer-center .input-sound {
				background-color: #eee;
				width: 100%;
			}

			.video-cover {
				width: 100%;
				height: 100%;
				object-fit: cover;
			}

			.player-btn {
				width: 60px;
				height: auto;
				position: absolute;
				top: 50%;
				left: 50%;
				-webkit-transform: translate(-50%, -50%);
				transform: translate(-50%, -50%);
			}

			[v-cloak] {
				display: none;
			}
		</style>
		<script>
			// 初始化字体大小
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			// 初始化字体大小结束
		</script>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<div class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></div>
			<h1 class="mui-title">备课</h1>
			<div class="add-master mui-pull-right">
				保存
			</div>
		</header>
		<div id="mui-content" class="mui-content master-container" v-cloak>
			<!-- 公用输入框 -->
			<div class="public-container" :class="is_edit?'active':''">
				<textarea v-model="edit_content" placeholder="请输入内容" rows="5" cols="" id="public_area" @input="adaptiveHeight('public_area')"></textarea>
				<div class="action-cont">
					<button type="button" class="mui-btn mui-btn-outlined" @tap="cancelEdit()">取消</button>
					<button type="button" class="mui-btn mui-btn-outlined" @tap="confirmEdit">确认</button>
				</div>
			</div>
			<div id="OA_task_1">
				<ul class="mui-table-view" v-if="remarkList!=[]&&remarkList!=1">
					<template v-for="(h,i) in remarkList" :key="i" v-if="h.status!=-1">
						<!-- 文字 -->
						<li class="mui-table-view-cell" :id="'master_list_'+i" v-if="h.type=='text'">
							<div class="mui-slider-right mui-disabled">
								<span class="mui-btn mui-btn-primary move-up-btn" @tap="moveIt(h.id,i,'up')">上移</span>
								<span class="mui-btn mui-btn-primary move-down-btn" @tap="moveIt(h.id,i,'down')">下移</span>
								<span class="mui-btn mui-btn-primary modifier-btn" @tap="editMaster(i,h.id,h.type)">修改</span>
								<span class="mui-btn mui-btn-primary delete-btn" @tap="deleteMaster(h.id,i)">删除</span>
							</div>
							<div class="mui-slider-handle">
								<div class="remark-info">
									<p class="text-desc">{{h.content}}</p>
									<div class="send-msg-btn" @tap="sendRemake(h,i)">
										<template v-if="h.status==0">
											<img src="../image/icon/prepare-lessons03.png">
											<span>发送</span>
										</template>
										<template v-else>
											<img src="../image/icon/prepare-lessons02.png">
											<span class="gray">重发</span>
										</template>
									</div>
								</div>
								<div class="remake-section">
									<img src="../image/icon/prepare-lessons04.png">
									<textarea placeholder="添加备注" v-model="remarkList[i].remark" class="remake-area" :id="'textarea_'+h.id" rows="2"
									 cols=""></textarea>
								</div>
							</div>
						</li>
						<!-- 图片 -->
						<li class="mui-table-view-cell" :id="'master_list_'+i" v-else-if="h.type=='img'">
							<div class="mui-slider-right mui-disabled">
								<span class="mui-btn mui-btn-primary move-up-btn" @tap="moveIt(h.id,i,'up')">上移</span>
								<span class="mui-btn mui-btn-primary move-down-btn" @tap="moveIt(h.id,i,'down')">下移</span>
								<span class="mui-btn mui-btn-primary modifier-btn" @tap="editMaster(i,h.id,h.type)">修改</span>
								<span class="mui-btn mui-btn-primary delete-btn" @tap="deleteMaster(h.id,i)">删除</span>
							</div>
							<div class="mui-slider-handle">
								<div class="remark-info">
									<div class="img-cont" v-if="h.content">
										<img :src="h.content" @tap="previewImage(h.content)">
									</div>
									<img v-else class="choice-item" @tap="choiceItem(i)" src="../image/icon/prepare-lessons06.png">
									<div class="send-msg-btn" @tap="sendRemake(h,i)">
										<template v-if="h.status==0">
											<img src="../image/icon/prepare-lessons03.png">
											<span>发送</span>
										</template>
										<template v-else>
											<img src="../image/icon/prepare-lessons02.png">
											<span class="gray">重发</span>
										</template>
									</div>
								</div>
								<div class="remake-section">
									<img src="../image/icon/prepare-lessons04.png">
									<textarea placeholder="添加备注" v-model="remarkList[i].remark" class="remake-area" :id="'textarea_'+h.id" rows="2"
									 cols=""></textarea>
								</div>
							</div>
						</li>
						<!-- 语音 -->
						<li class="mui-table-view-cell" :id="'master_list_'+i" v-else-if="h.type=='audio'">
							<div class="mui-slider-right mui-disabled">
								<span class="mui-btn mui-btn-primary move-up-btn" @tap="moveIt(h.id,i,'up')">上移</span>
								<span class="mui-btn mui-btn-primary move-down-btn" @tap="moveIt(h.id,i,'down')">下移</span>
								<span class="mui-btn mui-btn-primary modifier-btn" @tap="editMaster(i,h.id,h.type)">修改</span>
								<span class="mui-btn mui-btn-primary delete-btn" @tap="deleteMaster(h.id,i)">删除</span>
							</div>
							<div class="mui-slider-handle">
								<div class="remark-info">
									<div v-if="h.content==''" class="start-record" :data-idx="i" :id="'start_record'+h.id">
										开始录音&nbsp;&nbsp;按住说话
									</div>
									<div v-else class="play-record" @tap="playAudio(h)">
										<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
										<span class="play-status" :id="'play_status_'+h.id">点击播放</span>
										<span class="record-timer">{{h.duration_desc}}</span>
									</div>
									<div class="send-msg-btn" @tap="sendRemake(h,i)">
										<template v-if="h.status==0">
											<img src="../image/icon/prepare-lessons03.png">
											<span>发送</span>
										</template>
										<template v-else>
											<img src="../image/icon/prepare-lessons02.png">
											<span class="gray">重发</span>
										</template>
									</div>
								</div>
								<div class="remake-section">
									<img src="../image/icon/prepare-lessons04.png">
									<textarea placeholder="添加备注" v-model="remarkList[i].remark" class="remake-area" :id="'textarea_'+h.id" rows="2"
									 cols=""></textarea>
								</div>
							</div>
						</li>
						<!-- 视频 -->
						<li class="mui-table-view-cell" :id="'master_list_'+i" v-else>
							<div class="mui-slider-right mui-disabled">
								<span class="mui-btn mui-btn-primary move-up-btn" @tap="moveIt(h.id,i,'up')">上移</span>
								<span class="mui-btn mui-btn-primary move-down-btn" @tap="moveIt(h.id,i,'down')">下移</span>
								<span class="mui-btn mui-btn-primary modifier-btn" @tap="editMaster(i,h.id)">修改</span>
								<span class="mui-btn mui-btn-primary delete-btn" @tap="deleteMaster(h.id,i)">删除</span>
							</div>
							<div class="mui-slider-handle">
								<div class="remark-info">
									<div v-if="h.content" class="video-container" @tap="videoPlayer(h.content)">
										<!-- <video width="100%" height="200px" controls="controls" :src="h.content" :poster="h.content+'?spm=a2c4g.11186623.2.1.yjOb8V&x-oss-process=video/snapshot,t_100,f_jpg,m_fast'"></video> -->
										<img class="video-cover" src="https://cdn.wangkeapp.cn/videos/6/2019/08/Wr40Ky45g90zo3Lo7oy8gTf9T553i3.mp4?spm=a2c4g.11186623.2.1.yjOb8V&x-oss-process=video/snapshot,t_100,f_jpg,m_fast">
										<img class="player-btn" src="../image/icon/video-player.png">
									</div>
									<img v-else class="choice-item" @tap="choiceVideo(i)" src="../image/icon/prepare-lessons05.png">
									<div class="send-msg-btn" @tap="sendRemake(h,i)">
										<template v-if="h.status==0">
											<img src="../image/icon/prepare-lessons03.png">
											<span>发送</span>
										</template>
										<template v-else>
											<img src="../image/icon/prepare-lessons02.png">
											<span class="gray">重发</span>
										</template>
									</div>
								</div>
								<div class="remake-section">
									<img src="../image/icon/prepare-lessons04.png">
									<textarea placeholder="添加备注" v-model="remarkList[i].remark" class="remake-area" :id="'textarea_'+h.id" rows="2"
									 cols=""></textarea>
								</div>
							</div>
						</li>
					</template>
				</ul>
			</div>
			<!-- v-if="voidRemarkList" -->
			<div v-if="voidRemarkList" style="padding: 20%;text-align: center;color:#999999;font-size:18px;">
				<img src="../image/icon/void-remark-info.png" style="width:100%;">
				<p>暂无备课~</p>
			</div>
			<div class="showArea" id="sound-alert">
				<img src="../image/luyin.gif">
				<div>松开结束录音</div>
			</div>
			<footer>
				<div class="footer-left">
					<i id="msg-image" class="mui-icon mui-icon-camera" style="font-size: 28px;"></i>
				</div>
				<div class="footer-center">
					<textarea id="msg-text" @input="adaptiveHeight('msg-text')" type="text" row="1" class="input-text"></textarea>
					<button id="msg-sound" type="button" class="input-sound" style="display: none;">按住说话</button>
				</div>
				<label for="" class="footer-right">
					<i id="msg-type" class="mui-icon mui-icon-mic"></i>
				</label>
			</footer>
		</div>
		<script src="../js/mui.js"></script>
		<script src="../js/util.js"></script>
		<script src="../js/upload.js"></script>
		<script src="../js/vue.min.js"></script>
		<script type="text/javascript">
			var userInfo = getUserInfo(),
				MIN_SOUND_TIME = 800,
				// 当前录音的index
				audioIdx = null,
				player = null,
				priorId = '',
				types = 'img',
				// 聊天
				ws = null,
				chatData = null,
				mask = mui.createMask(function() {
					if (app.edit_content.length < 1) {
						message("请输入内容！");
						return false;
					}
					app.is_edit = false;
				}),
				c_index = '';
			var app = new Vue({
				el: "#mui-content",
				data: {
					is_edit: false,
					edit_content: '',
					test: '',
					course_id: '',
					// 记录是否保存
					isSave: true,
					remarkList: [],
					// 是否为空
					voidRemarkList: false,
					course: {}
				},
				methods: {
					// 播放视频
					videoPlayer: function(url) {
						openPage('player_model.html', 'player_model', '#000000', {
							url: url
						}, 'zoom-fade-out');
					},
					// 时间格式化
					format: function(time) {
						var timer = toFixed(time),
							_str = timer / 60,
							_m = _str.substring(_str.lastIndexOf(".") + 1);

					},
					adaptiveHeight: function(_id) {
						var textarea = document.getElementById(_id);
						makeExpandingArea(textarea, _id);
					},
					// 取消
					cancelEdit: function() {
						app.edit_content = app.remarkList[c_index].content;
						mask.close();
					},
					// 确认输入的文字
					confirmEdit: function() {
						if (app.edit_content.length < 1) {
							message("请输入内容！");
							return false;
						}
						mask.close();
						app.remarkList[c_index].content = app.edit_content;
					},
					// 选择照片
					choiceItem: function(i) {
						c_index = i;
						imageUpload(function(res) {
							app.remarkList[i].content = res.url;
						});
					},
					// 选择视频
					choiceVideo: function(idx) {
						if (mui.os.plus) {
							var buttonTitle = [{
								title: "选择视频",
								style: 'default'
							}];
							plus.nativeUI.actionSheet({
								cancel: "取消",
								buttons: buttonTitle
							}, function(b) { /*actionSheet 按钮点击事件*/
								switch (b.index) {
									case 0:
										break;
									case 1:
										videoUpload(function(res) {
											app.remarkList[idx].content = res.url;
										})
										break;
									default:
										break;
								}
							})
						}
					},
					// 播放音频
					playAudio: function(audio) {
						var status = document.getElementById('play_status_' + audio.id);
						var statusTiele = document.querySelectorAll(".play-status");
						for (var i in statusTiele) {
							statusTiele[i].innerText = '点击播放';
						}
						if (audio.id == priorId && player) {
							if (player) {
								player.stop();
								player = null;
							}
							status.innerText = '点击播放';
						} else {
							if (player) {
								player.stop();
								player = null;
							}
							player = plus.audio.createPlayer(audio.content);
							status.innerText = '正在播放...';
							priorId = audio.id;
							player.play(function() {
								player.stop();
								status.innerText = '点击播放';
								player = null;
							}, function(e) {
								player.stop();
								status.innerText = '点击播放';
								player = null;
							});
						}
					},
					// 发送备课内容
					sendRemake: function(msg, idx) {
						if (app.course.state == 0) {
							message("暂未开课！");
							return false;
						}
						if (msg.status == 1) {
							// 重发
							plus.nativeUI.confirm("该消息已发送过，确认重新发送吗？", function(e) {
								if (e.index) {
									// message("取消");
								} else {
									affirm(idx, msg);
								}
							})
						} else {
							// 直接发
							affirm(idx, msg);
							// chatData.content = msg.content;
							// chatData.message_type = msg.type;
							// ws.send(JSON.stringify(chatData));
						}
					}
				},
				mounted: function() {
					var old_back = mui.back;
					mui.back = function() {
						if (app.isSave) {
							old_back();
						} else {
							plus.nativeUI.confirm("还没有保存编辑，确认返回吗？", function(e) {
								if (e.index == 0) {
									old_back();
								} else {
									return false;
								}
							})
						}
					}
					var ui = {
						footer: document.querySelector('footer'),
						footerRight: document.querySelector('.footer-right'),
						footerLeft: document.querySelector('.footer-left'),
						btnMsgType: document.querySelector('#msg-type'),
						boxMsgText: document.querySelector('#msg-text'),
						boxMsgSound: document.querySelector('#msg-sound'),
						btnMsgImage: document.querySelector('#msg-image'),
						boxSoundAlert: document.querySelector('#sound-alert'),
						content: document.querySelector('.mui-content')
					};
					mui.init({
						keyEventBind: {
							backbutton: true,
							menubutton: true
						},
						beforeback: function() {
							plus.navigator.setStatusBarStyle("dark");
						},
						gestureConfig: {
							tap: true, //默认为true
							doubletap: false, //默认为false
							longtap: false, //默认为false
							swipe: true, //默认为true
							drag: true, //默认为true
							hold: true, //默认为false，不监听
							release: true //默认为false，不监听
						}
					})
					// 防止滚动穿透
					mui('.public-container')[0].addEventListener("touchmove", mui.preventDefault);
					mui('.input-text')[0].addEventListener("swipeup", mui.preventDefault);
					mui('.input-text')[0].addEventListener("swipedown", mui.preventDefault);
					mui.plusReady(function() {
						var self = plus.webview.currentWebview();
						if (mui.os.ios) {
							self.setStyle({
								softinputMode: "adjustResize"
							});
						}
						app.course = self.course;
						chatData = {
							team_id: app.course.team_id,
							course_id: app.course.id,
							user_id: userInfo.id,
							uniacid: userInfo.uniacid,
							type: 2,
							content: '',
							message_type: '',
						}
						app.course_id = app.course.id;
						getRemarkList();
						WebSocketInit();
						// 录音相关
						var recordCancel = false,
							recorder = null,
							startTimestamp = null,
							stopTimestamp = null,
							stopTimer = null;
						// 开始录音
						mui('.mui-content').on('hold', '.start-record', function() {
							audioIdx = this.dataset.idx;
							this.classList.add("hold-active");
							startRecord();
							document.querySelector(".showArea").style.display = "block";
						})
						// 松开
						mui('.mui-content').on('release', '.start-record', function() {
							this.classList.remove("hold-active");
							document.querySelector(".showArea").style.display = "none";
							stopTimestamp = (new Date()).getTime();
							if (stopTimestamp - startTimestamp < MIN_SOUND_TIME) {
								message("录音时间太短请重新录制！");
								recordCancel = true;
							} else {

							}
							recorder.stop();
						})
						// 录音方法
						function startRecord(creat) {
							recorder = plus.audio.getRecorder();
							if (recorder == null) {
								plus.nativeUI.toast("不能获取录音对象");
								return;
							}
							startTimestamp = (new Date()).getTime();
							recorder.record({
								filename: "_doc/audio/",
								format: "mp3"
							}, function(path) {
								if (recordCancel) return;
								voiceUpload(path, creat);
							}, function(e) {
								plus.nativeUI.toast("录音时出现异常: " + e.message);
							});
						}
						//----------------------------------------------->//
						function msgTextFocus() {
							ui.boxMsgText.focus();
							setTimeout(function() {
								ui.boxMsgText.focus();
							}, 150);
						}
						// 监听输入框获得焦点
						ui.boxMsgText.addEventListener('input', function(event) {
							ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'remove' : 'add']('mui-icon-paperplane');
							ui.btnMsgType.setAttribute("for", ui.boxMsgText.value == '' ? '' : 'msg-text');
						});
						//解决长按“发送”按钮，导致键盘关闭的问题；
						ui.footerRight.addEventListener('touchstart', function(event) {
							if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
								msgTextFocus();
								event.preventDefault();
							}
						});

						//解决长按“发送”按钮，导致键盘关闭的问题；
						ui.footerRight.addEventListener('touchmove', function(event) {
							if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
								msgTextFocus();
								event.preventDefault();
							}
						});
						// 录音对象的创建
						ui.boxMsgSound.addEventListener('hold', function(event) {
							startRecord('creat');
							document.querySelector(".showArea").style.display = "block";
						}, false);
						// 放手
						ui.boxMsgSound.addEventListener('release', function(event) {
							document.querySelector(".showArea").style.display = "none";
							stopTimestamp = (new Date()).getTime();
							if (stopTimestamp - startTimestamp < MIN_SOUND_TIME) {
								message("录音时间太短请重新录制！");
								recordCancel = true;
							} else {

							}
							recorder.stop();
						}, false);
						var bindMsgList = function() {
							var areaMsgList = document.querySelector('#OA_task_1');
							// logs(areaMsgList.scrollHeight);
							// logs(areaMsgList.offsetHeight);
							// areaMsgList.scrollTop = areaMsgList.scrollHeight + areaMsgList.offsetHeight;
							areaMsgList.scrollTop = 1686;
						};
						// 发送
						ui.footerRight.addEventListener('release', function(event) {
							if (ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
								ui.boxMsgText.focus();
								setTimeout(function() {
									ui.boxMsgText.focus();
								}, 150);
								creatItem('text', ui.boxMsgText.value);
								bindMsgList();
								ui.boxMsgText.value = '';
								mui.trigger(ui.boxMsgText, 'input', null);
							} else if (ui.btnMsgType.classList.contains('mui-icon-mic')) {
								ui.btnMsgType.classList.add('mui-icon-compose');
								ui.btnMsgType.classList.remove('mui-icon-mic');
								ui.boxMsgText.style.display = 'none';
								ui.boxMsgSound.style.display = 'block';
								ui.boxMsgText.blur();
								document.body.focus();
							} else if (ui.btnMsgType.classList.contains('mui-icon-compose')) {
								ui.btnMsgType.classList.add('mui-icon-mic');
								ui.btnMsgType.classList.remove('mui-icon-compose');
								ui.boxMsgSound.style.display = 'none';
								ui.boxMsgText.style.display = 'block';
								ui.boxMsgText.focus();
								setTimeout(function() {
									ui.boxMsgText.focus();
								}, 150);
							}
						}, false);

						// 上传视频
						ui.footerLeft.addEventListener('tap', function(event) {
							plus.nativeUI.actionSheet({
								// title: "上传图片",
								cancel: "取消",
								buttons: [{
									title: "拍照",
									style: 'default'
								}, {
									title: "从手机相册选择",
									style: 'default'
								}]
							}, function(b) { /*actionSheet 按钮点击事件*/
								switch (b.index) {
									case 0:
										break;
									case 1:
										getImg(function(res) {
											creatItem('img', res.url);
										}); /*拍照*/
										break;
									case 2:
										uploadVideo(function(res) {
											if (types == "img") {
												creatItem('img', res.url);
											} else {
												creatItem('video', res.url);
												types = "img";
											}
										})
										break;
									default:
										break;
								}
							})
						}, false);

						function uploadVideo(cb) {
							plus.gallery.pick(function(e) {
								var file = e;
								var format = file.substring(file.lastIndexOf(".") + 1);
								if (format == 'jpg' || format == 'png' || format == 'gif' || format == 'webp') {
									imageResize(file, cb);
								} else {
									types = 'video';
									plus.io.getVideoInfo({
										filePath: file,
										success: function(res) {
											if (res.size < $videoMaxSize) {
												showload(false, false, '视频上传中...', "rgba(0,0,0,0.5)");
												var task = plus.uploader.createUpload($videoUrl, {
														method: "POST",
														blocksize: 614400,
														priority: 100
													},
													function(t, status) { //上传完成
														if (status == 200) {
															var res = JSON.parse(t.responseText);
															if (res.error) {
																plus.nativeUI.alert(res.error.message, showload(1), '提示', 'OK');
															} else {
																showload(1);
																cb(res);
															}
														} else {
															console.log("上传失败：" + status);
															plus.nativeUI.alert('上传失败!', showload(1), '提示', 'OK');
														}
													}
												);
												// 页面中要上传的 图片路径
												task.addFile(file, {
													key: 'file'
												});
												task.start();
												setTimeout(function() {
													showload(1);
												}, 10000);
											} else {
												plus.nativeUI.alert('选择视频文件过大!', '', '提示', 'OK');
											}
										},
										fail: function(error) {
											plus.nativeUI.alert(error.message, '', '提示', 'OK');
										}
									});
								}

							}, function(e) {
								console.log("取消选择");
							}, {
								filter: "none",
								multiple: false,
								maximum: 5,
								system: false,
								onmaxed: function() {
									plus.nativeUI.alert('最多只能选择1个');
								}
							});
						}
						// 创建新的条目
						function creatItem(type, cont, duration, duration_desc) {
							var item = {
								id: '',
								type: type,
								content: cont,
								remark: '',
								status: 0,
								duration: duration || 0,
								duration_desc: duration_desc || ''
							};
							app.remarkList.push(item);
							app.voidRemarkList = false;
							// logs(app.remarkList);
						}

						//音频文件上传
						function voiceUpload(file, creat) {
							var duration = 0;
							showload(false, false, '音频上传中...', "rgba(0,0,0,0.5)");
							plus.io.getAudioInfo({
								filePath: file,
								success: function(res) {
									duration = Math.round(res.duration);
								}
							});
							var task = plus.uploader.createUpload($voiceUrl, {
									method: "POST",
									blocksize: 614400,
									priority: 100
								},
								function(t, status) { //上传完成
									if (status == 200) {
										var res = JSON.parse(t.responseText);
										if (res.errno == 1) {
											message(res.message);
										} else {
											if (creat) {
												creatItem('audio', res.data.path, duration, formatSeconds(duration));
											} else {
												app.remarkList[audioIdx].content = res.data.path;
												app.remarkList[audioIdx].duration = duration;
												app.remarkList[audioIdx].duration_desc = formatSeconds(duration);
											}
										}
										showload(1);
									} else {
										message('发送失败!');
										showload(1);
									}
								}
							);
							// 页面中要上传的
							task.addFile(file, {
								key: 'upfile'
							});
							task.start();
						}
					})
				}
			})
			// 获取列表
			function getRemarkList() {
				mui.post($ajaxUrl + 'team&action=course_draft_list', {
					token: userInfo.token,
					course_id: app.course_id
				}, function(res) {
					// logs(res);
					if (res.errno == 0) {
						app.remarkList = res.data;
					} else {
						app.voidRemarkList = true;
					}
				}, 'json');
			}
			// 选择视频
			function choiceVideo() {
				plus.gallery.pick(function(e) {
					var direction = null;
					// 选择成功执行
					plus.io.getVideoInfo({
						filePath: e,
						success: function(res) {
							var size = res.size;
							if (size == 0) {
								message('请重新选择视频！');
							} else if (size > 10000000) {
								message('视频文件须小于10MB！');
							} else {
								message('选择成功！');
								// logs(e);
							}
						}
					});
				}, function(e) {
					console.log("取消选择图片");
				}, {
					filter: "video",
					multiple: false,
					system: false,
					onmaxed: function() {
						plus.nativeUI.alert('最多只能选择1张图片');
					}
				});
			}
			// 删除
			function deleteMaster(s_id, i) {
				var _this_dom = document.getElementById('master-list' + s_id);
				plus.nativeUI.confirm("确认删除该条备课吗？", function(e) {
					if (e.index) {
						// 取消
						message("取消");
						mui.swipeoutClose(_this_dom);
					} else {
						mui.swipeoutClose(_this_dom);
						app.remarkList[i].status = '-1';
						message("已删除");
						for (var j = 0; j < app.remarkList.length; j++) {
							if (app.remarkList[j].status != -1) {
								app.voidRemarkList = false;
								break;
							} else {
								app.voidRemarkList = true;
							}
						}
					}
				})
			}
			// 上移或者下移
			function moveIt(_id, idx, status) {
				var _this_dom = document.getElementById('master_list_' + idx);
				var _this = app.remarkList[idx];
				if (status == 'up') {
					mui.swipeoutClose(_this_dom);
					if (idx == 0) {
						mui.toast("第一个不允许上移！");
						return false;
					}
					app.remarkList.splice(idx, 1);
					app.remarkList.splice(idx - 1, 0, _this);
				} else {
					mui.swipeoutClose(_this_dom);
					if (idx == app.remarkList.length - 1) {
						mui.toast("最后一个不允许下移！");
						return false;
					}
					app.remarkList.splice(idx, 1);
					app.remarkList.splice(idx + 1, 0, _this);
				}
			}
			// 修改
			function editMaster(idx, _id, type) {
				var _this_dom = document.getElementById('master_list_' + idx);
				mui.swipeoutClose(_this_dom);
				if (type == "text") {
					app.is_edit = true;
					mask.show();
					setTimeout(function() {
						document.getElementById("public_area").focus();
					}, 300)
					c_index = idx;
					app.edit_content = app.remarkList[c_index].content;
				} else if (type == "img") {
					app.remarkList[idx].content = '';
				} else {
					app.remarkList[idx].content = '';
				}
			}
			// 文本框自适应高度
			function makeExpandingArea(el, eleId) {
				var timer = null;
				var setStyle = function(el, auto) {
					if (auto) el.style.height = 'auto';
					el.style.height = el.scrollHeight + 'px';
				}
				var delayedResize = function(el) {
					if (timer) {
						clearTimeout(timer);
						timer = null;
					}
					timer = setTimeout(function() {
						setStyle(el)
					}, 200);
				}
				if (el.addEventListener) {
					el.addEventListener('input', function() {
						if (eleId == 'public_area') {
							setStyle(el, 1);
						} else {
							setStyle(el);
						}
					}, false);
					setStyle(el)
				} else if (el.attachEvent) {
					el.attachEvent('onpropertychange', function() {
						setStyle(el)
					})
					setStyle(el)
				}
				if (window.VBArray && window.addEventListener) { //IE9
					el.attachEvent("onkeydown", function() {
						var key = window.event.keyCode;
						if (key == 8 || key == 46) delayedResize(el);
					});
					el.attachEvent("oncut", function() {
						delayedResize(el);
					}); //处理粘贴
				}
			}
			// 图片预览
			function previewImage(urls) {
				var url = [];
				url.push(urls);
				plus.nativeUI.previewImage(url, {
					current: 0,
					loop: true,
					indicator: 'default',
					onLongPress: function(event) {
						message("图片很漂亮！");
					}
				});
			}
			// 编辑完成,保存
			mui('.mui-bar').on('tap', '.add-master', function() {
				mui.post($ajaxUrl + 'team&action=create_course_draft', {
					token: userInfo.token,
					course_id: app.course_id,
					data: app.remarkList
				}, function(res) {
					// logs(res);
					if (res.errno == 0) {
						message("保存成功！");
					} else {
						message("保存失败，请稍后重试！");
					}
				}, 'json');
			})
			// 转换时分秒
			function formatSeconds(value) {
				var secondTime = value;
				var minuteTime = 0;
				var hourTime = 0;
				if (secondTime > 60) {
					minuteTime = parseInt(secondTime / 60);
					secondTime = parseInt(secondTime % 60);
					if (minuteTime > 60) {
						hourTime = parseInt(minuteTime / 60);
						minuteTime = parseInt(minuteTime % 60);
					}
				}
				var result = "" + parseInt(secondTime) + "″";
				if (minuteTime > 0) {
					result = "" + parseInt(minuteTime) + "′" + result;
				}
				if (hourTime > 0) {
					result = "" + parseInt(hourTime) + ":" + result;
				}
				return result;
			}
			//---------------------------------------------------------------------
			//websocket 心跳检测
			var timer = 0
			var heartCheck = {
				timeout: 3e3,
				timeoutObj: null,
				serverTimeoutObj: null,
				reset: function() {
					clearTimeout(timer);
					clearTimeout(this.serverTimeoutObj);
					clearTimeout(this.timeoutObj);
					// console.log("heartCheck.reset.timer");
					return;
				},
				start: function() {
					this.timeoutObj = setTimeout(function() {
						var t = {
							ping: !0,
							user_id: userInfo.id,
							uniacid: userInfo.uniacid,
							type: 2
						};
						ws.send(JSON.stringify(t));
					}, this.timeout);
				},
			};
			// 聊天初始化
			function WebSocketInit() {
				if ("WebSocket" in window) {
					// 打开一个 web socket
					ws = new WebSocket("wss://app.wangkeapp.cn/wss");
					ws.onopen = function() {
						if (ws.readyState == WebSocket.OPEN) {
							heartCheck.reset();
							heartCheck.start();
						}
					};
					ws.onmessage = function(event) {
						var data = event.data;
						if (data == 'pong') {
							heartCheck.reset();
							heartCheck.start();
						} else {
							data = JSON.parse(data);
							if (data.error == 0) {
								msgData = data.data;
								mui.fire(plus.webview.getWebviewById("live_streaming"), "reloadList", {
									msgData: msgData
								});
							} else if (data.error == -2) {
								message(data.message);
							}
						}
					};
					ws.onclose = function(e) {
						// 关闭 websocket
						console.log("连接已关闭...");
					};
					ws.onerror = function(e) {
						logs(e);
					}
				} else {
					message("您的手机不支持 WebSocket!");
				}
			}
			// 发送确认
			function affirm(idx, msg) {
				mui.post($ajaxUrl + 'team&action=change_course_draft_status', {
					token: userInfo.token,
					draft_id:msg.id,
					status:1,
				}, function(res) {
					logs(res);
					if (res.errno == 0) {
						// 成功
						message("发送成功！");
						app.remarkList[idx].status=1;
						chatData.content = msg.content;
						chatData.message_type = msg.type;
						ws.send(JSON.stringify(chatData));
					} else {
						message("发送失败，请稍后重试！");
					}
				}, 'json');
			}
		</script>
	</body>

</html>
