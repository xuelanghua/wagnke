<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
		<link href="icomoon/style.css" rel="stylesheet" />
		<style>
			.mui-bar-tab img{
				display: block;
				margin: 0 auto;
				width: 0.44rem;
			}
			.mui-tab-label{
				font-size: 0.22rem;
			}
			.mui-bar-tab .mui-tab-item{
				position: relative;
				line-height: 1.1;
				padding: 0;
				width: auto;
				flex-grow: 1;
				color: #535353;
			}
			.mui-bar.mui-bar-tab{
				z-index: 1045;
				background-color: #FFFFFF;
			}
			.mui-bar-tab .mui-tab-item .mui-badge{
				position: absolute;
				top: 5px;
				right: 31%;
				width: 8px;
				height: 8px;
				background-color: #FF435F;
				border-radius: 100%;
				padding: 0;
			}
			 *{ touch-action: pan-y; }
			 .mui-tab-item p{
				margin: 0;
				padding: 0;
			  }
			  .mui-tab-item.mui-active span{
				  color: #2289ff;
			  }
			  .mui-tab-item {
				position: relative;
			}

			.mui-tab-item .mui-badge {
				position: absolute;
				top: 2px;
				right: 20px;
				padding: 2px 3px 0;
				background-color: rgba(255, 0, 0, 0.8);
				color: #FFFFFF;
				font-size: 10px;
				z-index: 9999;
			}
		</style>
	</head>

	<body>
		<div id="index">
			<nav class="mui-bar mui-bar-tab">
				<!-- <a :data-index="index" :id="index==0?'defaultTab':nav.id" class="mui-tab-item" @tap="changetab(index)" :class="nav.selected?'mui-active':''" -->
				<a :data-index="index" :id="index==0?'defaultTab':nav.id" class="mui-tab-item" @tap="changetab(index)" :class="nav.selected?'mui-active':''"
				 :href="nav.href" v-for="(nav,index) in nav" :key="index">
					<p>
						<span :class="nav.selected?nav.icon+'-s':nav.icon" style="font-size: 18px;margin-top: 2px;"></span>
						<span v-if="nav.id=='chat'" class="mui-badge" id="message_tip" style="display: none;">0</span>
					</p>
					<span class="mui-tab-label">{{nav.title}}</span>
				</a>
			</nav>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/vue.min.js"></script>
		<script src="js/util.js"></script>
		<script type="text/javascript" charset="utf-8">
			//mui初始化
			var viewport = document.documentElement.clientWidth;
			if (viewport > 750) {
				viewport = 750
			}
			document.documentElement.style.fontSize = viewport / 7.5 + "px";
			var app = new Vue({
				el: "#index",
				data: {
					nav: [{
						title: "首页",
						id: 'home',
						icon: 'icon-home-page',
						selected: 'icon-home-page-s',
						href: "html/home.html",
						selected: true
					}, {
						title: "人脉",
						id: 'chat',
						icon: 'icon-chat',
						selected: 'icon-chat-s',
						href: "html/chat.html",
						selected: false
					}, {
						title: "快捷",
						id: 'shortcut',
						icon: 'icon-quick',
						selected: 'icon-quick-s',
						href: "html/shortcut.html",
						selected: false
					}, {
						title: "自媒体",
						id: 'media',
						icon: 'icon-selfmedia',
						selected: 'icon-selfmedia-s',
						href: "html/self_media.html",
						selected: false
					}, {
						title: "我的",
						id: 'user',
						icon: 'icon-my',
						selected: 'icon-my-s',
						href: "html/my.html",
						selected: false
					}]
				},
				methods: {
					changetab: function(e) {
						for (let i = 0; i < this.nav.length; i++) {
							this.nav[i].selected = false;
						}
						this.nav[e].selected = true;
					}
				},
				mounted: function() {
					mui.init();
					var subpages = [{
							url: 'html/home.html',
							ids: 'home',
							background: '#ffffff',
							style: 'dark',
							styles: {
								top: '0',
								bottom: '51px',
								background: '#ffffff',
								statusbar: {
									background: '#ffffff'
								}
							}
						}, {
							url: 'html/chat.html',
							ids: 'chat',
							background: '#cccccc',
							style: 'light',
							styles: {
								top: '0',
								bottom: '51px',
								background: '#ffffff',
								statusbar: {
									background: '#2289FF'
								}
							}
						}, {
							url: 'html/shortcut.html',
							ids: 'shortcut',
							background: 'transparent',
							style: 'dark',
							styles: {
								top: '0',
								bottom: '51px',
								background: 'transparent',
								statusbar: {
									background: '#ffffff'
								}
							}
						}, {
							url: 'html/self_media.html',
							ids: 'self_media',
							background: '#ffffff',
							style: 'dark',
							styles: {
								top: '0',
								bottom: '51px',
								background: '#ffffff',
								statusbar: {
									background: '#ffffff'
								}
							}
						},
						{
							url: 'html/my.html',
							ids: 'my',
							background: '#2289ff',
							style: 'light',
							styles: {
								top: '0',
								bottom: '51px',
								background: '#ffffff',
								statusbar: {
									background: '#2289ff'
								}
							}
						}
					];
					var aniShow = {};
					//创建子页面，首个选项卡页面显示，其它均隐藏；
					mui.plusReady(function() {
						plus.navigator.setStatusBarStyle("dark");
						plus.navigator.setStatusBarBackground('#FFFFFF');
						var self = plus.webview.currentWebview();
						for (var i = 0; i < 5; i++) {
							var temp = {};
							var sub = plus.webview.create(subpages[i].url, subpages[i].id, subpages[i].styles);
							if (i > 0) {
								sub.hide();
							} else {
								temp[subpages[i]] = "true";
								mui.extend(aniShow, temp);
							}
							self.append(sub);
						}
					});
					//当前激活选项
					var activeTab = subpages[0];
					//选项卡点击事件
					mui('.mui-bar-tab').on('tap', 'a', function(e) {
						var targetTab = this.getAttribute('href');
						if (targetTab == activeTab) {
							return;
						}
						//显示目标选项卡
						//若为iOS平台或非首次显示，则直接显示
						if (mui.os.ios || aniShow[targetTab]) {
							plus.webview.show(targetTab);
						} else {
							//否则，使用fade-in动画，且保存变量
							var temp = {};
							temp[targetTab] = "true";
							mui.extend(aniShow, temp);
							plus.webview.show(targetTab, "fade-in", 300);
						}
						//隐藏当前;
						plus.webview.hide(activeTab);
						//更改当前活跃的选项卡
						activeTab = targetTab;
						setStatusBar(subpages[this.dataset.index].background, subpages[this.dataset.index].style);
					});
					//自定义事件，模拟点击“首页选项卡”
					document.addEventListener('gohome', function() {
						var defaultTab = document.getElementById("home");
						//模拟首页点击
						mui.trigger(defaultTab, 'tap');
						//切换选项卡高亮
						var current = document.querySelector(".mui-bar-tab>.mui-tab-item.mui-active");
						if (defaultTab !== current) {
							current.classList.remove('mui-active');
							defaultTab.classList.add('mui-active');
						}
					});

					//自定义事件监听-首页新增客户点击
					window.addEventListener('newCustomer', function() {
						mui.trigger(document.getElementById('chat'), 'tap');
						document.querySelector('div[data-id=home]').classList.remove('mui-active');
						document.getElementById('chat').classList.add('mui-active');
					})

					window.addEventListener('changeMy', function() {
						mui.trigger(document.getElementById('user.html'), 'tap');
					})

					document.addEventListener('netchange', onNetChange, false);

					//自定义事件-登录成功
					window.addEventListener('loginSuccess', function() {
						userInfo = getUserInfo();
						bindClientId();
						getUnreadMessage();
					})

					//自定义事件-绑定成功
					window.addEventListener('bindMobileSuccess', function() {
						userInfo = getUserInfo();
						bindClientId();
						getUnreadMessage();
					})

					window.addEventListener('showChat', function() {
						mui.trigger(document.getElementById('chat'), 'tap');
					})

					window.addEventListener('refreshNotice', function() {
						getUnreadMessage();
					})
					var nt = plus.networkinfo.getCurrentType();
					if (nt == 1) {
						fnOpenWin('/html/network_outage.html', 'network_outage', {
							statusbar: {
								background: '#FFFFFF'
							}
						}, '', 'slide-in-bottom');
					}

					plus.screen.lockOrientation("portrait-primary");

					userInfo = getUserInfo();
					if (!userInfo) {
						login();
					} else if (userInfo.mobile.length == 0) {
						bindMobile();
					} else {
						bindClientId();
						getUnreadMessage();
					}

					function login() {
						if (plus.os.name == "iOS") {
							mui.get($ajaxUrl + 'member', {
								action: 'login_type',
							}, function(res) {
								if (res.data == 1) {
									fnOpenWin('html/login.html', 'login', {
										statusbar: {
											background: '#122c9a'
										}
									}, '', 'slide-in-bottom');
								} else {
									fnOpenWin('html/mobile_login.html', 'mobile_login', {
										statusbar: {
											background: '#2289FF'
										}
									}, '', 'slide-in-bottom');
								}
							}, 'json');
						} else {
							fnOpenWin('html/login.html', 'login', {
								statusbar: {
									background: '#122c9a'
								}
							}, '', 'slide-in-bottom');
						}
					}

					function bindMobile() {
						fnOpenWin('html/mobile_bind.html', 'mobile_bind', {
							statusbar: {
								background: '#2289ff'
							},
						}, '', 'slide-in-bottom');
					}

					//获取未读消息
					function getUnreadMessage() {
						if (!userInfo) return;
						mui.get($ajaxUrl + 'member', {
							action: 'unread_message',
							token: userInfo.token
						}, function(res) {
							var tipsObj = document.getElementById('message_tip');
							if (res.data > 0) {
								tipsObj.innerText = res.data;
								getFriendApply();
							} else {
								tipsObj.innerText = 0;
								getFriendApply();
							}
						}, 'json');
					}

					//获取好友申请条目
					function getFriendApply() {
						if (!userInfo) return;
						mui.post($ajaxUrl + 'customer', {
							action: 'friend_apply_count',
							token: userInfo.token,
						}, function(res) {
							var tipsObj = document.getElementById('message_tip');
							var number = tipsObj.innerText;
							var total = parseInt(res.data) + parseInt(number);
							if (total > 0) {
								tipsObj.innerText = total;
								tipsObj.style.display = 'block';
								setBadge(total);
							} else {
								tipsObj.innerText = 0;
								tipsObj.style.display = 'none';
								clearBadge();
							}
						}, 'json')
					}
				}
			})
		</script>
	</body>

</html>
