<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>首页</title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="icomoon/style.css" rel="stylesheet" />
		<style>
			.mui-tab-item {
				position: relative;
			}

			.mui-tab-item .mui-badge {
				position: absolute;
				top: 2px;
				right: 20px;
				padding: 2px 3px 0;
				background-color: rgba(255, 0, 0, 0.8);
				color: #FFFFFF;
				font-size: 10px;
				z-index: 9999;
			}

			* {
				touch-action: pan-y;
			}
		</style>
	</head>
	<body>
		<div class="mui-content">
			<nav id="bar" class="mui-bar mui-bar-tab" style="background-color: #FFFFFF;box-shadow: 0 0 5px 3px #DDDDDD;z-index: 99999;">
				<div class="mui-tab-item mui-active tab-item" data-id="home">
					<span class="mui-icon icon-home-page-s" style="font-size: 18px;margin-top: 2px;"></span>
					<span class="mui-tab-label">首页</span>
				</div>
				<div class="mui-tab-item tab-item" data-id="chat" id="chat">
					<span class="mui-icon icon-chat" style="font-size: 18px;margin-top: 2px;"></span>
					<span class="mui-tab-label">人脉</span>
					<span class="mui-badge" id="message_tip" style="display: none;">0</span>
				</div>
				<div class="mui-tab-item" id="short_cut" data-status='0'>
					<span class="mui-icon icon-quick" style="font-size: 18px;margin-top: 2px;"></span>
					<span class="mui-tab-label">快捷</span>
				</div>
				<div class="mui-tab-item tab-item" data-id="media">
					<span class="mui-icon icon-selfmedia" style="font-size: 18px;margin-top: 2px;"></span>
					<span class="mui-tab-label">自媒体</span>
				</div>
				<div class="mui-tab-item tab-item" data-id="user" id="user">
					<span class="mui-icon icon-my" style="font-size: 18px;margin-top: 2px;"></span>
					<span class="mui-tab-label">我的</span>
				</div>
			</nav>
		</div>
	</body>
	<script src="js/mui.js"></script>
	<script src="js/util.js"></script>
	<script>
		mui.init({
			swipeBack: false
		});

		var self = null;
		var shortcutWebview = null;
		var currentTab = null;
		var current = '';
		var tabs = {};
		var winHeight = document.documentElement.clientHeight || document.body.clientHeight;
		var webviewHeight = winHeight - 51;
		var userInfo = null;
		var tabsConfig = {
			home: {
				url: 'html/home.html',
				default: true,
				icon: 'icon-home-page',
				selected: 'icon-home-page-s',
				background: '#FFFFFF',
				style: 'dark',
				styles: {
					top: '0px',
					bottom: '51px',
					scrollIndicator: 'none',
					statusbar: {
						background: '#FFFFFF'
					}
				}
			},
			chat: {
				url: 'html/chat.html',
				icon: 'icon-chat',
				selected: 'icon-chat-s',
				background: '#CCC',
				style: 'light',
				styles: {
					top: '0px',
					bottom: '51px',
					scrollIndicator: 'none',
					statusbar: {
						background: '#2289FF'
					}
				}
			},
			media: {
				url: 'html/self_media.html',
				icon: 'icon-selfmedia',
				selected: 'icon-selfmedia-s',
				background: '#FFFFFF',
				style: 'dark',
				styles: {
					top: '0px',
					bottom: '51px',
					scrollIndicator: 'none',
					statusbar: {
						background: '#FFFFFF'
					}
				}
			},
			user: {
				url: 'html/my.html',
				icon: 'icon-my',
				selected: 'icon-my-s',
				background: '#CCC',
				style: 'light',
				styles: {
					top: '0px',
					bottom: '51px',
					scrollIndicator: 'none',
					statusbar: {
						background: '#2289FF'
					}
				}
			}
		};

		mui.plusReady(function() {
			pushInit();
			// document.getElementById('bar').style.top = (plus.display.resolutionHeight - 75) + "px";
			//自定义事件监听快捷菜单页面点击
			window.addEventListener('closeShortcut', function() {
				document.getElementById('short_cut').dataset.status = 0;
				shortcutWebview.hide();
				//修改选中颜色样式
				mui.trigger(currentTab, 'tap');
				document.getElementById('short_cut').classList.remove('mui-active');
				currentTab.classList.add('mui-active');
			})

			// 固定底部的菜单栏
			if (plus.os.name == 'iOS') {
				document.getElementById('bar').style.top = (plus.display.resolutionHeight - 50) + "px";
				document.getElementById('bar').style.height = 50 + "px";
			}

			//自定义事件监听-首页新增客户点击
			window.addEventListener('newCustomer', function() {
				mui.trigger(document.getElementById('chat'), 'tap');
				document.querySelector('div[data-id=home]').classList.remove('mui-active');
				document.getElementById('chat').classList.add('mui-active');
			})

			window.addEventListener('changeMy', function() {
				// console.log('打印');
				mui.trigger(document.getElementById('user'), 'tap');
			})

			//自定义事件-登录成功
			window.addEventListener('loginSuccess', function() {
				userInfo = getUserInfo();
				bindClientId();
				initIndexView();
				getUnreadMessage();
			})

			//自定义事件-绑定成功
			window.addEventListener('bindMobileSuccess', function() {
				console.log('bindMobileSuccess');
				userInfo = getUserInfo();
				bindClientId();
				initIndexView();
				getUnreadMessage();
				// updateUserInfo();
				// initIndexView();
			})

			window.addEventListener('showChat', function() {
				mui.trigger(document.getElementById('chat'), 'tap');
				// currentTab.children[0].classList.remove(tabsConfig[current].icon);
				// currentTab.children[0].classList.add(tabsConfig[current].selected);
			})

			window.addEventListener('refreshNotice', function() {
				getUnreadMessage();
			})

			//设置currentTab
			currentTab = mui('#bar .tab-item')[0];
			//获取当前webview
			self = plus.webview.currentWebview();
			//设置只支持竖屏幕显示
			plus.screen.lockOrientation("portrait-primary"); 

			// localStorage.removeItem('user');
			userInfo = getUserInfo();
			if (!userInfo) {
				login();
			} else if (userInfo.mobile.length == 0) {
				bindMobile();
			} else {
				bindClientId();
				initIndexView();
				getUnreadMessage();
			}
			//判断是否已经登陆,若没有登陆将预加载登陆页面
			// judgeLogin();
			//初始化与index有关的页面
			// initIndexView();
		});

		//初始化
		function initIndexView() {
			//初始化所有bar页面
			initTabitemWebviews();
			//添加bar点击事件接受
			tapBaritem();
		}

		//初始化所有bar页面
		function initTabitemWebviews() {
			plus.nativeUI.showWaiting();
			for (var id in tabsConfig) {
				tabs[id] = plus.webview.create(tabsConfig[id].url, id, tabsConfig[id].styles, {
					webviewHeight: webviewHeight
				});
				// tabs[id] = plus.webview.create(tabsConfig[id].url, id, tabsConfig[id].styles);
				if (tabsConfig[id]['default']) {
					self.append(tabs[id]);
					current = id;
					setStatusBar(tabsConfig[id].background, tabsConfig[id].style);
				}
			}
			shortcutWebview = plus.webview.create('html/shortcut.html', 'shortcut', {
				top: '0px',
				bottom: '51px',
				background: 'transparent'
			});
		}

		//底部导航点击
		function tapBaritem() {
			mui('#bar').on('tap', '#short_cut', function() {
				var status = this.dataset.status;
				if (status == 0) {
					this.dataset.status = 1;
					shortcutWebview.show();
					this.children[0].classList.remove('icon-quick');
					this.children[0].classList.add('icon-quick-s');
					currentTab.children[0].classList.remove(tabsConfig[current].selected);
					currentTab.children[0].classList.add(tabsConfig[current].icon);
				}
				// 			else {
				// 				mui.trigger(currentTab, 'tap');
				// 				this.classList.remove('mui-active');
				// 				this.children[0].classList.remove('icon-quick-s');
				// 				this.children[0].classList.add('icon-quick');
				// 				currentTab.children[0].classList.remove(tabsConfig[current].icon);
				// 				currentTab.children[0].classList.add(tabsConfig[current].selected);
				// 				currentTab.classList.add('mui-active');
				// 				this.dataset.status = 0;
				// 				shortcutWebview.hide();
				// 			}
			});

			mui('#bar').on('tap', '.tab-item', function(e) {
				document.getElementById('short_cut').children[0].classList.remove('icon-quick-s');
				document.getElementById('short_cut').children[0].classList.add('icon-quick');
				this.children[0].classList.remove(tabsConfig[this.dataset.id].icon);
				this.children[0].classList.add(tabsConfig[this.dataset.id].selected);
				document.getElementById('short_cut').dataset.status = 0;
				shortcutWebview.hide();
				if (current == this.dataset.id) {
					mui.fire(tabs[current], 'scrollTop');
					return;
				}
				tabs[this.dataset.id].show();
				setStatusBar(tabsConfig[this.dataset.id].background, tabsConfig[this.dataset.id].style);
				tabs[current].hide();
				currentTab.children[0].classList.remove(tabsConfig[current].selected);
				currentTab.children[0].classList.add(tabsConfig[current].icon);
				current = this.dataset.id;
				currentTab = this;

				// 				//向聊天页面传递清除定时器自定义事件
				// 				if (current == 'chat') {
				// 					mui.fire(plus.webview.getWebviewById('chat'), 'addInterval');
				// 				} else {
				// 					mui.fire(plus.webview.getWebviewById('chat'), 'clearInterval');
				// 				}
				mui.fire(plus.webview.getWebviewById(current), 'resizeWindow');
			});
		}

		function login() {
			if (plus.os.name == "iOS") {
				mui.get($ajaxUrl + 'member', {
					action: 'login_type',
				}, function(res) {
					if (res.data == 1) {
						fnOpenWin('html/login.html', 'login', {
							statusbar: {
								background: '#122c9a'
							}
						}, '', 'slide-in-bottom');
					} else {
						fnOpenWin('html/mobile_login.html', 'mobile_login', {
							statusbar: {
								background: '#2289FF'
							}
						}, '', 'slide-in-bottom');
					}
				}, 'json');
			} else {
				fnOpenWin('html/login.html', 'login', {
					statusbar: {
						background: '#122c9a'
					}
				}, '', 'slide-in-bottom');
			}
		}

		function bindMobile() {
			fnOpenWin('html/mobile_bind.html', 'mobile_bind', {
				statusbar: {
					background: '#2289ff'
				},
			}, '', 'slide-in-bottom');
		}

		//获取未读消息
		function getUnreadMessage() {
			if (!userInfo) return;
			mui.get($ajaxUrl + 'member', {
				action: 'unread_message',
				token: userInfo.token
			}, function(res) {
				var tipsObj = document.getElementById('message_tip');
				if (res.data > 0) {
					tipsObj.innerText = res.data;
					getFriendApply();
				} else {
					tipsObj.innerText = 0;
					getFriendApply();
				}
			}, 'json');
		}

		//获取好友申请条目
		function getFriendApply() {
			if (!userInfo) return;
			mui.post($ajaxUrl + 'customer', {
				action: 'friend_apply_count',
				token: userInfo.token,
			}, function(res) {
				var tipsObj = document.getElementById('message_tip');
				var number = tipsObj.innerText;
				var total = parseInt(res.data) + parseInt(number);
				if (total > 0) {
					tipsObj.innerText = total;
					tipsObj.style.display = 'block';
					setBadge(total);
				} else {
					tipsObj.innerText = 0;
					tipsObj.style.display = 'none';
					clearBadge();
				}
			}, 'json')
		}
	</script>
</html>
